require('source-map-support').install();

'use strict';

var _createClass = require('babel-runtime/helpers/create-class')['default'];

var _classCallCheck = require('babel-runtime/helpers/class-call-check')['default'];

var _defineProperty = require('babel-runtime/helpers/define-property')['default'];

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _net = require('net');

var _net2 = _interopRequireDefault(_net);

var _bplistCreator = require('bplist-creator');

var _bplistCreator2 = _interopRequireDefault(_bplistCreator);

var _bplistParser = require('bplist-parser');

var _bplistParser2 = _interopRequireDefault(_bplistParser);

var _bufferpack = require('bufferpack');

var _bufferpack2 = _interopRequireDefault(_bufferpack);

var _bluebird = require('bluebird');

var _bluebird2 = _interopRequireDefault(_bluebird);

var _appiumSupport = require('appium-support');

var log = _appiumSupport.logger.getLogger('RemoteDebugger');

var DEVICE_INFO = {
  name: 'iPhone Simulator',
  build: 'WP42FJ'
};

var APP_INFO = {
  'PID:42': {
    id: 'PID:42',
    name: 'app',
    bundleId: 'io.appium.bundle',
    isProxy: false,
    hostId: '',
    isActive: '1',
    isAutomationEnabled: false
  }
};

// a bunch of new app info structures to simulate
// the app getting proxied through other apps
var UPDATED_APP_INFO = [{
  id: 'PID:44',
  name: 'proxy app 1',
  bundleId: 'io.appium.bundle.proxy1',
  isProxy: true,
  hostId: 'PID:42',
  isActive: '1'
}, {
  id: 'PID:46',
  name: 'proxy app 1',
  bundleId: 'io.appium.bundle.proxy1',
  isProxy: true,
  hostId: 'PID:44',
  isActive: '1'
}, {
  id: 'PID:48',
  name: 'proxy app 1',
  bundleId: 'io.appium.bundle.proxy1',
  isProxy: true,
  hostId: 'PID:46',
  isActive: '1'
}, {
  id: 'PID:50',
  name: 'proxy app 1',
  bundleId: 'io.appium.bundle.proxy1',
  isProxy: true,
  hostId: 'PID:48',
  isActive: '1'
}];

/*
 * A fake remote debugger server that can be told to send certain
 * messages back to the client, and to return certain values.
 * Used for testing the client.
 */

var RemoteDebuggerServer = (function () {
  function RemoteDebuggerServer() {
    _classCallCheck(this, RemoteDebuggerServer);

    this.server = null;
    this.client = null;
    this.pendingAppChange = false;
    this.appIdKey = 'PID:42';
    this.destinationKey = '2';
    this.app = 1;
    this.dataResponseValue = [];
  }

  _createClass(RemoteDebuggerServer, [{
    key: '_getConnectedApplicationList',
    value: function _getConnectedApplicationList(num) {
      var data = {
        __selector: '_rpc_reportConnectedApplicationList:',
        __argument: {
          WIRApplicationDictionaryKey: [{
            WIRApplicationIdentifierKey: APP_INFO['PID:42'].id,
            WIRApplicationNameKey: APP_INFO['PID:42'].name,
            WIRApplicationBundleIdentifierKey: APP_INFO['PID:42'].bundleId,
            WIRIsApplicationProxyKey: APP_INFO['PID:42'].isProxy,
            WIRHostApplicationIdentifierKey: APP_INFO['PID:42'].hostId,
            WIRIsApplicationActiveKey: APP_INFO['PID:42'].isActive
          }]
        }
      };

      // add more
      if (num > UPDATED_APP_INFO + 1) {
        // we only have so many to give!
        num = UPDATED_APP_INFO + 1;
      }
      for (var i = 0; i < num - 1; i++) {
        var entry = UPDATED_APP_INFO[i];
        data.__argument.WIRApplicationDictionaryKey.push(_defineProperty({}, entry.id, entry));
      }

      return data;
    }
  }, {
    key: 'handleReportIdentifier',
    value: function handleReportIdentifier() {
      var data = {
        __selector: '_rpc_reportSetup:',
        __argument: {
          WIRSimulatorNameKey: DEVICE_INFO.name,
          WIRSimulatorBuildKey: DEVICE_INFO.build
        }
      };
      this.send(data);

      if (this.dataResponseError) {
        data = {
          __selector: '_rpc_reportConnectedApplicationList:',
          __argument: {
            type: 'string',
            value: this.dataResponseError
          },
          wasThrown: true
        };
        this.dataResponseError = null;
      } else {
        data = this._getConnectedApplicationList(1);
      }
      this.send(data);
    }
  }, {
    key: 'handleGetListing',
    value: function handleGetListing() {
      // if we have pending app change events, send them
      if (this.pendingAppChange) {
        this.changeApp(this.pendingAppChange, true);
        this.pendingAppChange = 0;
      }

      // need to send an app dictionary back
      var data = {
        __selector: '_rpc_applicationSentListing:',
        __argument: {
          WIRApplicationIdentifierKey: 'PID:42',
          WIRListingKey: {
            '1': {
              WIRTypeKey: 'WIRTypeWeb',
              WIRPageIdentifierKey: 1,
              WIRTitleKey: '',
              WIRURLKey: 'about:blank'
            }
          }
        }
      };
      this.send(data);
    }
  }, {
    key: 'handleSocketData',
    value: function handleSocketData(plist) {
      var plistData = JSON.parse(plist.__argument.WIRSocketDataKey.toString('utf8'));

      var result = {};
      if (this.dataResponseError) {
        result = {
          result: {
            type: 'string',
            value: this.dataResponseError
          },
          wasThrown: true
        };
        this.dataResponseError = null;
      } else if (this.dataResponseValue.length > 0) {
        // add the response value
        result = {
          result: {
            type: 'string',
            value: this.dataResponseValue.shift()
          },
          wasThrown: false
        };
      }

      var dataKey = {
        result: result,
        id: plistData.id
      };
      dataKey = Buffer.from(JSON.stringify(dataKey));
      var data = {
        __selector: '_rpc_applicationSentData:',
        __argument: {
          WIRDestinationKey: plist.__argument.WIRSenderKey,
          WIRApplicationIdentifierKey: plist.__argument.WIRApplicationIdentifierKey,
          WIRMessageDataKey: dataKey
        }
      };
      this.send(data);
    }
  }, {
    key: 'changeApp',
    value: function changeApp() {
      var num = arguments.length <= 0 || arguments[0] === undefined ? 1 : arguments[0];
      var immediate = arguments.length <= 1 || arguments[1] === undefined ? true : arguments[1];

      if (immediate) {
        if (num > UPDATED_APP_INFO.length - 1) {
          // we only have a certain number of info to send
          num = UPDATED_APP_INFO.length - 1;
        }
        for (var i = 0; i < num; i++) {
          var data = {
            __selector: '_rpc_applicationConnected:',
            __argument: {
              WIRApplicationIdentifierKey: UPDATED_APP_INFO[this.app - 1].id,
              WIRApplicationNameKey: UPDATED_APP_INFO[this.app - 1].name,
              WIRApplicationBundleIdentifierKey: UPDATED_APP_INFO[this.app - 1].bundleId,
              WIRIsApplicationProxyKey: UPDATED_APP_INFO[this.app - 1].isProxy,
              WIRHostApplicationIdentifierKey: UPDATED_APP_INFO[this.app - 1].hostId,
              WIRIsApplicationActiveKey: UPDATED_APP_INFO[this.app - 1].isActive
            }
          };
          this.send(data);

          this.app++;
        }
      } else {
        this.pendingAppChange = num;
      }
    }
  }, {
    key: 'sendPageInfoMessage',
    value: function sendPageInfoMessage(appIdKey) {
      var data = {
        __selector: '_rpc_applicationSentListing:',
        __argument: {
          WIRApplicationIdentifierKey: appIdKey,
          WIRListingKey: {
            '1': {
              WIRTypeKey: 'WIRTypeWeb',
              WIRPageIdentifierKey: 1,
              WIRTitleKey: '',
              WIRURLKey: 'about:blank'
            }
          }
        }
      };
      this.send(data);
    }
  }, {
    key: 'sendFrameNavigationMessage',
    value: function sendFrameNavigationMessage() {
      var dataKey = {
        method: 'Page.frameNavigated',
        result: {},
        id: 1
      };
      dataKey = Buffer.from(JSON.stringify(dataKey));
      var data = {
        __selector: '_rpc_applicationSentData:',
        __argument: {
          WIRDestinationKey: this.destinationKey,
          WIRApplicationIdentifierKey: this.appIdKey,
          WIRMessageDataKey: dataKey
        }
      };
      this.send(data);
    }
  }, {
    key: 'setDataResponseError',
    value: function setDataResponseError(error) {
      this.dataResponseError = error;
    }
  }, {
    key: 'setDataResponseValue',
    value: function setDataResponseValue(value) {
      this.dataResponseValue.push(value);
    }
  }, {
    key: 'start',
    value: function start() {
      return _regeneratorRuntime.async(function start$(context$2$0) {
        var _this = this;

        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            return context$2$0.abrupt('return', new _bluebird2['default'](function (resolve, reject) {
              _this.server = _net2['default'].createServer(function (c) {
                _this.client = c;
                c.on('end', function () {
                  log.debug('client disconnected');
                });
                c.on('data', function (data) {
                  var plist = _bplistParser2['default'].parseBuffer(data.slice(4));

                  if (!plist[0].__selector) {
                    reject(new Error('Unable to decipher plist: ' + plist));
                    return;
                  }

                  switch (plist[0].__selector) {
                    case '_rpc_reportIdentifier:':
                      _this.handleReportIdentifier(plist[0]);
                      break;
                    case '_rpc_forwardGetListing:':
                      _this.handleGetListing(plist[0]);
                      break;
                    case '_rpc_forwardSocketSetup:':
                      // do nothing
                      break;
                    case '_rpc_forwardSocketData:':
                      _this.handleSocketData(plist[0]);
                      break;
                    case '_rpc_forwardIndicateWebView:':
                      reject(new Error('NOT YET IMPLEMENTED: ' + plist[0].__selector));
                      break;
                    default:
                      _this.client.write('do not compute');
                  }
                });
              });

              // don't use the real port, or any open sims will break the tests
              _this.server.listen(27754, '::1', function () {
                log.info('server bound: ' + JSON.stringify(_this.server.address()));
                resolve();
              });
            }));

          case 1:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'stop',
    value: function stop() {
      return _regeneratorRuntime.async(function stop$(context$2$0) {
        var _this2 = this;

        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            return context$2$0.abrupt('return', new _bluebird2['default'](function (resolve) {
              if (_this2.server) {
                if (_this2.client) {
                  _this2.client.end();
                }
                _this2.server.close(function (err) {
                  // eslint-disable-line promise/prefer-await-to-callbacks
                  resolve('Stopped listening: ' + err);
                });
              } else {
                resolve('Not listening.');
              }
            }));

          case 1:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'send',
    value: function send(data) {
      var buf = (0, _bplistCreator2['default'])(data);
      var length = _bufferpack2['default'].pack('L', [buf.length]);
      this.client.write(Buffer.concat([length, buf]));
    }
  }]);

  return RemoteDebuggerServer;
})();

exports.RemoteDebuggerServer = RemoteDebuggerServer;
exports.APP_INFO = APP_INFO;
exports.DEVICE_INFO = DEVICE_INFO;
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInRlc3QvaGVscGVycy9yZW1vdGUtZGVidWdnZXItc2VydmVyLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7OzttQkFFZ0IsS0FBSzs7Ozs2QkFDSSxnQkFBZ0I7Ozs7NEJBQ2pCLGVBQWU7Ozs7MEJBQ2hCLFlBQVk7Ozs7d0JBQ2YsVUFBVTs7Ozs2QkFDUCxnQkFBZ0I7O0FBRXZDLElBQU0sR0FBRyxHQUFHLHNCQUFPLFNBQVMsQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDOztBQUcvQyxJQUFNLFdBQVcsR0FBRztBQUNsQixNQUFJLEVBQUUsa0JBQWtCO0FBQ3hCLE9BQUssRUFBRSxRQUFRO0NBQ2hCLENBQUM7O0FBRUYsSUFBTSxRQUFRLEdBQUc7QUFDZixVQUFRLEVBQUU7QUFDUixNQUFFLEVBQUUsUUFBUTtBQUNaLFFBQUksRUFBRSxLQUFLO0FBQ1gsWUFBUSxFQUFFLGtCQUFrQjtBQUM1QixXQUFPLEVBQUUsS0FBSztBQUNkLFVBQU0sRUFBRSxFQUFFO0FBQ1YsWUFBUSxFQUFFLEdBQUc7QUFDYix1QkFBbUIsRUFBRSxLQUFLO0dBQzNCO0NBQ0YsQ0FBQzs7OztBQUlGLElBQU0sZ0JBQWdCLEdBQUcsQ0FDdkI7QUFDRSxJQUFFLEVBQUUsUUFBUTtBQUNaLE1BQUksRUFBRSxhQUFhO0FBQ25CLFVBQVEsRUFBRSx5QkFBeUI7QUFDbkMsU0FBTyxFQUFFLElBQUk7QUFDYixRQUFNLEVBQUUsUUFBUTtBQUNoQixVQUFRLEVBQUUsR0FBRztDQUNkLEVBQ0Q7QUFDRSxJQUFFLEVBQUUsUUFBUTtBQUNaLE1BQUksRUFBRSxhQUFhO0FBQ25CLFVBQVEsRUFBRSx5QkFBeUI7QUFDbkMsU0FBTyxFQUFFLElBQUk7QUFDYixRQUFNLEVBQUUsUUFBUTtBQUNoQixVQUFRLEVBQUUsR0FBRztDQUNkLEVBQ0Q7QUFDRSxJQUFFLEVBQUUsUUFBUTtBQUNaLE1BQUksRUFBRSxhQUFhO0FBQ25CLFVBQVEsRUFBRSx5QkFBeUI7QUFDbkMsU0FBTyxF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Q25CO0FBQ0QsdUJBQUssTUFBTSxDQUFDLEtBQUssQ0FBQyxVQUFDLEdBQUcsRUFBSzs7QUFDekIseUJBQU8seUJBQXVCLEdBQUcsQ0FBRyxDQUFDO2lCQUN0QyxDQUFDLENBQUM7ZUFDSixNQUFNO0FBQ0wsdUJBQU8sQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDO2VBQzNCO2FBQ0YsQ0FBQzs7Ozs7OztLQUNIOzs7V0FFSSxjQUFDLElBQUksRUFBRTtBQUNWLFVBQUksR0FBRyxHQUFHLGdDQUFhLElBQUksQ0FBQyxDQUFDO0FBQzdCLFVBQUksTUFBTSxHQUFHLHdCQUFXLElBQUksQ0FBQyxHQUFHLEVBQUUsQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQztBQUNoRCxVQUFJLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLENBQUMsTUFBTSxFQUFFLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQztLQUNqRDs7O1NBelFHLG9CQUFvQjs7O1FBNFFqQixvQkFBb0IsR0FBcEIsb0JBQW9CO1FBQUUsUUFBUSxHQUFSLFFBQVE7UUFBRSxXQUFXLEdBQVgsV0FBVyIsImZpbGUiOiJ0ZXN0L2hlbHBlcnMvcmVtb3RlLWRlYnVnZ2VyLXNlcnZlci5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8vIHRyYW5zcGlsZTptYWluXG5cbmltcG9ydCBuZXQgZnJvbSAnbmV0JztcbmltcG9ydCBicGxpc3RDcmVhdGUgZnJvbSAnYnBsaXN0LWNyZWF0b3InO1xuaW1wb3J0IGJwbGlzdFBhcnNlIGZyb20gJ2JwbGlzdC1wYXJzZXInO1xuaW1wb3J0IGJ1ZmZlcnBhY2sgZnJvbSAnYnVmZmVycGFjayc7XG5pbXBvcnQgUHJvbWlzZSBmcm9tICdibHVlYmlyZCc7XG5pbXBvcnQgeyBsb2dnZXIgfSBmcm9tICdhcHBpdW0tc3VwcG9ydCc7XG5cbmNvbnN0IGxvZyA9IGxvZ2dlci5nZXRMb2dnZXIoJ1JlbW90ZURlYnVnZ2VyJyk7XG5cblxuY29uc3QgREVWSUNFX0lORk8gPSB7XG4gIG5hbWU6ICdpUGhvbmUgU2ltdWxhdG9yJyxcbiAgYnVpbGQ6ICdXUDQyRkonXG59O1xuXG5jb25zdCBBUFBfSU5GTyA9IHtcbiAgJ1BJRDo0Mic6IHtcbiAgICBpZDogJ1BJRDo0MicsXG4gICAgbmFtZTogJ2FwcCcsXG4gICAgYnVuZGxlSWQ6ICdpby5hcHBpdW0uYnVuZGxlJyxcbiAgICBpc1Byb3h5OiBmYWxzZSxcbiAgICBob3N0SWQ6ICcnLFxuICAgIGlzQWN0aXZlOiAnMScsXG4gICAgaXNBdXRvbWF0aW9uRW5hYmxlZDogZmFsc2VcbiAgfVxufTtcblxuLy8gYSBidW5jaCBvZiBuZXcgYXBwIGluZm8gc3RydWN0dXJlcyB0byBzaW11bGF0ZVxuLy8gdGhlIGFwcCBnZXR0aW5nIHByb3hpZWQgdGhyb3VnaCBvdGhlciBhcHBzXG5jb25zdCBVUERBVEVEX0FQUF9JTkZPID0gW1xuICB7XG4gICAgaWQ6ICdQSUQ6NDQnLFxuICAgIG5hbWU6ICdwcm94eSBhcHAgMScsXG4gICAgYnVuZGxlSWQ6ICdpby5hcHBpdW0uYnVuZGxlLnByb3h5MScsXG4gICAgaXNQcm94eTogdHJ1ZSxcbiAgICBob3N0SWQ6ICdQSUQ6NDInLFxuICAgIGlzQWN0aXZlOiAnMSdcbiAgfSxcbiAge1xuICAgIGlkOiAnUElEOjQ2JyxcbiAgICBuYW1lOiAncHJveHkgYXBwIDEnLFxuICAgIGJ1bmRsZUlkOiAnaW8uYXBwaXVtLmJ1bmRsZS5wcm94eTEnLFxuICAgIGlzUHJveHk6IHRydWUsXG4gICAgaG9zdElkOiAnUElEOjQ0JyxcbiAgICBpc0FjdGl2ZTogJzEnXG4gIH0sXG4gIHtcbiAgICBpZDogJ1BJRDo0OCcsXG4gICAgbmFtZTogJ3Byb3h5IGFwcCAxJyxcbiAgICBidW5kbGVJZDogJ2lvLmFwcGl1bS5idW5kbGUucHJveHkxJyxcbiAgICBpc1Byb3h5OiB0cnVlLFxuICAgIGhvc3RJZDogJ1BJRDo0NicsXG4gICAgaXNBY3RpdmU6ICcxJ1xuICB9LFxuICB7XG4gICAgaWQ6ICdQSUQ6NTAnLFxuICAgIG5hbWU6ICdwcm94eSBhcHAgMScsXG4gICAgYnVuZGxlSWQ6ICdpby5hcHBpdW0uYnVuZGxlLnByb3h5MScsXG4gICAgaXNQcm94eTogdHJ1ZSxcbiAgICBob3N0SWQ6ICdQSUQ6NDgnLFxuICAgIGlzQWN0aXZlOiAnMSdcbiAgfVxuXTtcblxuXG4vKlxuICogQSBmYWtlIHJlbW90ZSBkZWJ1Z2dlciBzZXJ2ZXIgdGhhdCBjYW4gYmUgdG9sZCB0byBzZW5kIGNlcnRhaW5cbiAqIG1lc3NhZ2VzIGJhY2sgdG8gdGhlIGNsaWVudCwgYW5kIHRvIHJldHVybiBjZXJ0YWluIHZhbHVlcy5cbiAqIFVzZWQgZm9yIHRlc3RpbmcgdGhlIGNsaWVudC5cbiAqL1xuY2xhc3MgUmVtb3RlRGVidWdnZXJTZXJ2ZXIge1xuICBjb25zdHJ1Y3RvciAoKSB7XG4gICAgdGhpcy5zZXJ2ZXIgPSBudWxsO1xuICAgIHRoaXMuY2xpZW50ID0gbnVsbDtcbiAgICB0aGlzLnBlbmRpbmdBcHBDaGFuZ2UgPSBmYWxzZTtcbiAgICB0aGlzLmFwcElkS2V5ID0gJ1BJRDo0Mic7XG4gICAgdGhpcy5kZXN0aW5hdGlvbktleSA9ICcyJztcbiAgICB0aGlzLmFwcCA9IDE7XG4gICAgdGhpcy5kYXRhUmVzcG9uc2VWYWx1ZSA9IFtdO1xuICB9XG5cbiAgX2dldENvbm5lY3RlZEFwcGxpY2F0aW9uTGlzdCAobnVtKSB7XG4gICAgbGV0IGRhdGEgPSB7XG4gICAgICBfX3NlbGVjdG9yOiAnX3JwY19yZXBvcnRDb25uZWN0ZWRBcHBsaWNhdGlvbkxpc3Q6JyxcbiAgICAgIF9fYXJndW1lbnQ6IHtcbiAgICAgICAgV0lSQXBwbGljYXRpb25EaWN0aW9uYXJ5S2V5OiBbe1xuICAgICAgICAgIFdJUkFwcGxpY2F0aW9uSWRlbnRpZmllcktleTogQVBQX0lORk9bJ1BJRDo0MiddLmlkLFxuICAgICAgICAgIFdJUkFwcGxpY2F0aW9uTmFtZUtleTogQVBQX0lORk9bJ1BJRDo0MiddLm5hbWUsXG4gICAgICAgICAgV0lSQXBwbGljYXRpb25CdW5kbGVJZGVudGlmaWVyS2V5OiBBUFBfSU5GT1snUElEOjQyJ10uYnVuZGxlSWQsXG4gICAgICAgICAgV0lSSXNBcHBsaWNhdGlvblByb3h5S2V5OiBBUFBfSU5GT1snUElEOjQyJ10uaXNQcm94eSxcbiAgICAgICAgICBXSVJIb3N0QXBwbGljYXRpb25JZGVudGlmaWVyS2V5OiBBUFBfSU5GT1snUElEOjQyJ10uaG9zdElkLFxuICAgICAgICAgIFdJUklzQXBwbGljYXRpb25BY3RpdmVLZXk6IEFQUF9JTkZPWydQSUQ6NDInXS5pc0FjdGl2ZVxuICAgICAgICB9XVxuICAgICAgfVxuICAgIH07XG5cbiAgICAvLyBhZGQgbW9yZVxuICAgIGlmIChudW0gPiBVUERBVEVEX0FQUF9JTkZPKzEpIHtcbiAgICAgIC8vIHdlIG9ubHkgaGF2ZSBzbyBtYW55IHRvIGdpdmUhXG4gICAgICBudW0gPSBVUERBVEVEX0FQUF9JTkZPICsgMTtcbiAgICB9XG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBudW0tMTsgaSsrKSB7XG4gICAgICBsZXQgZW50cnkgPSBVUERBVEVEX0FQUF9JTkZPW2ldO1xuICAgICAgZGF0YS5fX2FyZ3VtZW50LldJUkFwcGxpY2F0aW9uRGljdGlvbmFyeUtleS5wdXNoKHtbZW50cnkuaWRdOiBlbnRyeX0pO1xuICAgIH1cblxuICAgIHJldHVybiBkYXRhO1xuICB9XG5cbiAgaGFuZGxlUmVwb3J0SWRlbnRpZmllciAoKSB7XG4gICAgbGV0IGRhdGEgPSB7XG4gICAgICBfX3NlbGVjdG9yOiAnX3JwY19yZXBvcnRTZXR1cDonLFxuICAgICAgX19hcmd1bWVudDoge1xuICAgICAgICBXSVJTaW11bGF0b3JOYW1lS2V5OiBERVZJQ0VfSU5GTy5uYW1lLFxuICAgICAgICBXSVJTaW11bGF0b3JCdWlsZEtleTogREVWSUNFX0lORk8uYnVpbGRcbiAgICAgIH1cbiAgICB9O1xuICAgIHRoaXMuc2VuZChkYXRhKTtcblxuICAgIGlmICh0aGlzLmRhdGFSZXNwb25zZUVycm9yKSB7XG4gICAgICBkYXRhID0ge1xuICAgICAgICBfX3NlbGVjdG9yOiAnX3JwY19yZXBvcnRDb25uZWN0ZWRBcHBsaWNhdGlvbkxpc3Q6JyxcbiAgICAgICAgX19hcmd1bWVudDoge1xuICAgICAgICAgIHR5cGU6ICdzdHJpbmcnLFxuICAgICAgICAgIHZhbHVlOiB0aGlzLmRhdGFSZXNwb25zZUVycm9yXG4gICAgICAgIH0sXG4gICAgICAgIHdhc1Rocm93bjogdHJ1ZVxuICAgICAgfTtcbiAgICAgIHRoaXMuZGF0YVJlc3BvbnNlRXJyb3IgPSBudWxsO1xuICAgIH0gZWxzZSB7XG4gICAgICBkYXRhID0gdGhpcy5fZ2V0Q29ubmVjdGVkQXBwbGljYXRpb25MaXN0KDEpO1xuICAgIH1cbiAgICB0aGlzLnNlbmQoZGF0YSk7XG4gIH1cblxuICBoYW5kbGVHZXRMaXN0aW5nICgpIHtcbiAgICAvLyBpZiB3ZSBoYXZlIHBlbmRpbmcgYXBwIGNoYW5nZSBldmVudHMsIHNlbmQgdGhlbVxuICAgIGlmICh0aGlzLnBlbmRpbmdBcHBDaGFuZ2UpIHtcbiAgICAgIHRoaXMuY2hhbmdlQXBwKHRoaXMucGVuZGluZ0FwcENoYW5nZSwgdHJ1ZSk7XG4gICAgICB0aGlzLnBlbmRpbmdBcHBDaGFuZ2UgPSAwO1xuICAgIH1cblxuICAgIC8vIG5lZWQgdG8gc2VuZCBhbiBhcHAgZGljdGlvbmFyeSBiYWNrXG4gICAgbGV0IGRhdGEgPSB7XG4gICAgICBfX3NlbGVjdG9yOiAnX3JwY19hcHBsaWNhdGlvblNlbnRMaXN0aW5nOicsXG4gICAgICBfX2FyZ3VtZW50OiB7XG4gICAgICAgIFdJUkFwcGxpY2F0aW9uSWRlbnRpZmllcktleTogJ1BJRDo0MicsXG4gICAgICAgIFdJUkxpc3RpbmdLZXk6IHtcbiAgICAgICAgICAnMSc6IHtcbiAgICAgICAgICAgIFdJUlR5cGVLZXk6ICdXSVJUeXBlV2ViJyxcbiAgICAgICAgICAgIFdJUlBhZ2VJZGVudGlmaWVyS2V5OiAxLFxuICAgICAgICAgICAgV0lSVGl0bGVLZXk6ICcnLFxuICAgICAgICAgICAgV0lSVVJMS2V5OiAnYWJvdXQ6YmxhbmsnXG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfTtcbiAgICB0aGlzLnNlbmQoZGF0YSk7XG4gIH1cblxuICBoYW5kbGVTb2NrZXREYXRhIChwbGlzdCkge1xuICAgIGxldCBwbGlzdERhdGEgPSBKU09OLnBhcnNlKHBsaXN0Ll9fYXJndW1lbnQuV0lSU29ja2V0RGF0YUtleS50b1N0cmluZygndXRmOCcpKTtcblxuICAgIGxldCByZXN1bHQgPSB7fTtcbiAgICBpZiAodGhpcy5kYXRhUmVzcG9uc2VFcnJvcikge1xuICAgICAgcmVzdWx0ID0ge1xuICAgICAgICByZXN1bHQ6IHtcbiAgICAgICAgICB0eXBlOiAnc3RyaW5nJyxcbiAgICAgICAgICB2YWx1ZTogdGhpcy5kYXRhUmVzcG9uc2VFcnJvclxuICAgICAgICB9LFxuICAgICAgICB3YXNUaHJvd246IHRydWVcbiAgICAgIH07XG4gICAgICB0aGlzLmRhdGFSZXNwb25zZUVycm9yID0gbnVsbDtcbiAgICB9IGVsc2UgaWYgKHRoaXMuZGF0YVJlc3BvbnNlVmFsdWUubGVuZ3RoID4gMCkge1xuICAgICAgLy8gYWRkIHRoZSByZXNwb25zZSB2YWx1ZVxuICAgICAgcmVzdWx0ID0ge1xuICAgICAgICByZXN1bHQ6IHtcbiAgICAgICAgICB0eXBlOiAnc3RyaW5nJyxcbiAgICAgICAgICB2YWx1ZTogdGhpcy5kYXRhUmVzcG9uc2VWYWx1ZS5zaGlmdCgpXG4gICAgICAgIH0sXG4gICAgICAgIHdhc1Rocm93bjogZmFsc2VcbiAgICAgIH07XG4gICAgfVxuXG4gICAgbGV0IGRhdGFLZXkgPSB7XG4gICAgICByZXN1bHQsXG4gICAgICBpZDogcGxpc3REYXRhLmlkXG4gICAgfTtcbiAgICBkYXRhS2V5ID0gQnVmZmVyLmZyb20oSlNPTi5zdHJpbmdpZnkoZGF0YUtleSkpO1xuICAgIGxldCBkYXRhID0ge1xuICAgICAgX19zZWxlY3RvcjogJ19ycGNfYXBwbGljYXRpb25TZW50RGF0YTonLFxuICAgICAgX19hcmd1bWVudDoge1xuICAgICAgICBXSVJEZXN0aW5hdGlvbktleTogcGxpc3QuX19hcmd1bWVudC5XSVJTZW5kZXJLZXksXG4gICAgICAgIFdJUkFwcGxpY2F0aW9uSWRlbnRpZmllcktleTogcGxpc3QuX19hcmd1bWVudC5XSVJBcHBsaWNhdGlvbklkZW50aWZpZXJLZXksXG4gICAgICAgIFdJUk1lc3NhZ2VEYXRhS2V5OiBkYXRhS2V5XG4gICAgICB9XG4gICAgfTtcbiAgICB0aGlzLnNlbmQoZGF0YSk7XG4gIH1cblxuICBjaGFuZ2VBcHAgKG51bSA9IDEsIGltbWVkaWF0ZSA9IHRydWUpIHtcbiAgICBpZiAoaW1tZWRpYXRlKSB7XG4gICAgICBpZiAobnVtID4gVVBEQVRFRF9BUFBfSU5GTy5sZW5ndGgtMSkge1xuICAgICAgICAvLyB3ZSBvbmx5IGhhdmUgYSBjZXJ0YWluIG51bWJlciBvZiBpbmZvIHRvIHNlbmRcbiAgICAgICAgbnVtID0gVVBEQVRFRF9BUFBfSU5GTy5sZW5ndGggLSAxO1xuICAgICAgfVxuICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBudW07IGkrKykge1xuICAgICAgICBsZXQgZGF0YSA9IHtcbiAgICAgICAgICBfX3NlbGVjdG9yOiAnX3JwY19hcHBsaWNhdGlvbkNvbm5lY3RlZDonLFxuICAgICAgICAgIF9fYXJndW1lbnQ6IHtcbiAgICAgICAgICAgIFdJUkFwcGxpY2F0aW9uSWRlbnRpZmllcktleTogVVBEQVRFRF9BUFBfSU5GT1t0aGlzLmFwcC0xXS5pZCxcbiAgICAgICAgICAgIFdJUkFwcGxpY2F0aW9uTmFtZUtleTogVVBEQVRFRF9BUFBfSU5GT1t0aGlzLmFwcC0xXS5uYW1lLFxuICAgICAgICAgICAgV0lSQXBwbGljYXRpb25CdW5kbGVJZGVudGlmaWVyS2V5OiBVUERBVEVEX0FQUF9JTkZPW3RoaXMuYXBwLTFdLmJ1bmRsZUlkLFxuICAgICAgICAgICAgV0lSSXNBcHBsaWNhdGlvblByb3h5S2V5OiBVUERBVEVEX0FQUF9JTkZPW3RoaXMuYXBwLTFdLmlzUHJveHksXG4gICAgICAgICAgICBXSVJIb3N0QXBwbGljYXRpb25JZGVudGlmaWVyS2V5OiBVUERBVEVEX0FQUF9JTkZPW3RoaXMuYXBwLTFdLmhvc3RJZCxcbiAgICAgICAgICAgIFdJUklzQXBwbGljYXRpb25BY3RpdmVLZXk6IFVQREFURURfQVBQX0lORk9bdGhpcy5hcHAtMV0uaXNBY3RpdmVcbiAgICAgICAgICB9XG4gICAgICAgIH07XG4gICAgICAgIHRoaXMuc2VuZChkYXRhKTtcblxuICAgICAgICB0aGlzLmFwcCsrO1xuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLnBlbmRpbmdBcHBDaGFuZ2UgPSBudW07XG4gICAgfVxuICB9XG5cbiAgc2VuZFBhZ2VJbmZvTWVzc2FnZSAoYXBwSWRLZXkpIHtcbiAgICBsZXQgZGF0YSA9IHtcbiAgICAgIF9fc2VsZWN0b3I6ICdfcnBjX2FwcGxpY2F0aW9uU2VudExpc3Rpbmc6JyxcbiAgICAgIF9fYXJndW1lbnQ6IHtcbiAgICAgICAgV0lSQXBwbGljYXRpb25JZGVudGlmaWVyS2V5OiBhcHBJZEtleSxcbiAgICAgICAgV0lSTGlzdGluZ0tleToge1xuICAgICAgICAgICcxJzoge1xuICAgICAgICAgICAgV0lSVHlwZUtleTogJ1dJUlR5cGVXZWInLFxuICAgICAgICAgICAgV0lSUGFnZUlkZW50aWZpZXJLZXk6IDEsXG4gICAgICAgICAgICBXSVJUaXRsZUtleTogJycsXG4gICAgICAgICAgICBXSVJVUkxLZXk6ICdhYm91dDpibGFuaydcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9O1xuICAgIHRoaXMuc2VuZChkYXRhKTtcbiAgfVxuXG4gIHNlbmRGcmFtZU5hdmlnYXRpb25NZXNzYWdlICgpIHtcbiAgICBsZXQgZGF0YUtleSA9IHtcbiAgICAgIG1ldGhvZDogJ1BhZ2UuZnJhbWVOYXZpZ2F0ZWQnLFxuICAgICAgcmVzdWx0OiB7fSxcbiAgICAgIGlkOiAxXG4gICAgfTtcbiAgICBkYXRhS2V5ID0gQnVmZmVyLmZyb20oSlNPTi5zdHJpbmdpZnkoZGF0YUtleSkpO1xuICAgIGxldCBkYXRhID0ge1xuICAgICAgX19zZWxlY3RvcjogJ19ycGNfYXBwbGljYXRpb25TZW50RGF0YTonLFxuICAgICAgX19hcmd1bWVudDoge1xuICAgICAgICBXSVJEZXN0aW5hdGlvbktleTogdGhpcy5kZXN0aW5hdGlvbktleSxcbiAgICAgICAgV0lSQXBwbGljYXRpb25JZGVudGlmaWVyS2V5OiB0aGlzLmFwcElkS2V5LFxuICAgICAgICBXSVJNZXNzYWdlRGF0YUtleTogZGF0YUtleVxuICAgICAgfVxuICAgIH07XG4gICAgdGhpcy5zZW5kKGRhdGEpO1xuICB9XG5cbiAgc2V0RGF0YVJlc3BvbnNlRXJyb3IgKGVycm9yKSB7XG4gICAgdGhpcy5kYXRhUmVzcG9uc2VFcnJvciA9IGVycm9yO1xuICB9XG5cbiAgc2V0RGF0YVJlc3BvbnNlVmFsdWUgKHZhbHVlKSB7XG4gICAgdGhpcy5kYXRhUmVzcG9uc2VWYWx1ZS5wdXNoKHZhbHVlKTtcbiAgfVxuXG4gIGFzeW5jIHN0YXJ0ICgpIHtcbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgdGhpcy5zZXJ2ZXIgPSBuZXQuY3JlYXRlU2VydmVyKChjKSA9PiB7XG4gICAgICAgIHRoaXMuY2xpZW50ID0gYztcbiAgICAgICAgYy5vbignZW5kJywgKCkgPT4ge1xuICAgICAgICAgIGxvZy5kZWJ1ZygnY2xpZW50IGRpc2Nvbm5lY3RlZCcpO1xuICAgICAgICB9KTtcbiAgICAgICAgYy5vbignZGF0YScsIChkYXRhKSA9PiB7XG4gICAgICAgICAgbGV0IHBsaXN0ID0gYnBsaXN0UGFyc2UucGFyc2VCdWZmZXIoZGF0YS5zbGljZSg0KSk7XG5cbiAgICAgICAgICBpZiAoIXBsaXN0WzBdLl9fc2VsZWN0b3IpIHtcbiAgICAgICAgICAgIHJlamVjdChuZXcgRXJyb3IoYFVuYWJsZSB0byBkZWNpcGhlciBwbGlzdDogJHtwbGlzdH1gKSk7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgc3dpdGNoIChwbGlzdFswXS5fX3NlbGVjdG9yKSB7XG4gICAgICAgICAgICBjYXNlICdfcnBjX3JlcG9ydElkZW50aWZpZXI6JzpcbiAgICAgICAgICAgICAgdGhpcy5oYW5kbGVSZXBvcnRJZGVudGlmaWVyKHBsaXN0WzBdKTtcbiAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICBjYXNlICdfcnBjX2ZvcndhcmRHZXRMaXN0aW5nOic6XG4gICAgICAgICAgICAgIHRoaXMuaGFuZGxlR2V0TGlzdGluZyhwbGlzdFswXSk7XG4gICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgY2FzZSAnX3JwY19mb3J3YXJkU29ja2V0U2V0dXA6JzpcbiAgICAgICAgICAgICAgLy8gZG8gbm90aGluZ1xuICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIGNhc2UgJ19ycGNfZm9yd2FyZFNvY2tldERhdGE6JzpcbiAgICAgICAgICAgICAgdGhpcy5oYW5kbGVTb2NrZXREYXRhKHBsaXN0WzBdKTtcbiAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICBjYXNlICdfcnBjX2ZvcndhcmRJbmRpY2F0ZVdlYlZpZXc6JzpcbiAgICAgICAgICAgICAgcmVqZWN0KG5ldyBFcnJvcihgTk9UIFlFVCBJTVBMRU1FTlRFRDogJHtwbGlzdFswXS5fX3NlbGVjdG9yfWApKTtcbiAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICBkZWZhdWx0OlxuICAgICAgICAgICAgICB0aGlzLmNsaWVudC53cml0ZSgnZG8gbm90IGNvbXB1dGUnKTtcbiAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgfSk7XG5cbiAgICAgIC8vIGRvbid0IHVzZSB0aGUgcmVhbCBwb3J0LCBvciBhbnkgb3BlbiBzaW1zIHdpbGwgYnJlYWsgdGhlIHRlc3RzXG4gICAgICB0aGlzLnNlcnZlci5saXN0ZW4oMjc3NTQsICc6OjEnLCAoKSA9PiB7XG4gICAgICAgIGxvZy5pbmZvKGBzZXJ2ZXIgYm91bmQ6ICR7SlNPTi5zdHJpbmdpZnkodGhpcy5zZXJ2ZXIuYWRkcmVzcygpKX1gKTtcbiAgICAgICAgcmVzb2x2ZSgpO1xuICAgICAgfSk7XG4gICAgfSk7XG4gIH1cblxuICBhc3luYyBzdG9wICgpIHtcbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHtcbiAgICAgIGlmICh0aGlzLnNlcnZlcikge1xuICAgICAgICBpZiAodGhpcy5jbGllbnQpIHtcbiAgICAgICAgICB0aGlzLmNsaWVudC5lbmQoKTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLnNlcnZlci5jbG9zZSgoZXJyKSA9PiB7IC8vIGVzbGludC1kaXNhYmxlLWxpbmUgcHJvbWlzZS9wcmVmZXItYXdhaXQtdG8tY2FsbGJhY2tzXG4gICAgICAgICAgcmVzb2x2ZShgU3RvcHBlZCBsaXN0ZW5pbmc6ICR7ZXJyfWApO1xuICAgICAgICB9KTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJlc29sdmUoJ05vdCBsaXN0ZW5pbmcuJyk7XG4gICAgICB9XG4gICAgfSk7XG4gIH1cblxuICBzZW5kIChkYXRhKSB7XG4gICAgbGV0IGJ1ZiA9IGJwbGlzdENyZWF0ZShkYXRhKTtcbiAgICBsZXQgbGVuZ3RoID0gYnVmZmVycGFjay5wYWNrKCdMJywgW2J1Zi5sZW5ndGhdKTtcbiAgICB0aGlzLmNsaWVudC53cml0ZShCdWZmZXIuY29uY2F0KFtsZW5ndGgsIGJ1Zl0pKTtcbiAgfVxufVxuXG5leHBvcnQgeyBSZW1vdGVEZWJ1Z2dlclNlcnZlciwgQVBQX0lORk8sIERFVklDRV9JTkZPIH07XG4iXSwic291cmNlUm9vdCI6Ii4uLy4uLy4uIn0=

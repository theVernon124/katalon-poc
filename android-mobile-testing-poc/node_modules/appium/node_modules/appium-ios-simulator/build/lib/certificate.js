'use strict';

var _createClass = require('babel-runtime/helpers/create-class')['default'];

var _classCallCheck = require('babel-runtime/helpers/class-call-check')['default'];

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _crypto = require('crypto');

var _crypto2 = _interopRequireDefault(_crypto);

var _bluebird = require('bluebird');

var _bluebird2 = _interopRequireDefault(_bluebird);

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

var _appiumSupport = require('appium-support');

var _utils = require('./utils');

var openssl = _bluebird2['default'].promisify(require('openssl-wrapper').exec);

var tset = '<?xml version="1.0" encoding="UTF-8"?>\n\n    <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">\n    <plist version="1.0">\n    <array/>\n</plist>';

/**
 * Library for programatically adding certificates
 */

var Certificate = (function () {
  function Certificate(pemFilename) {
    _classCallCheck(this, Certificate);

    this.pemFilename = pemFilename;
  }

  /**
   * Interface for adding and removing records to TrustStore.sqlite3 databases that Keychains use
   */

  /**
   * Add a certificate to the TrustStore
   */

  _createClass(Certificate, [{
    key: 'add',
    value: function add(dir) {
      var data, subject, sha1, trustStore;
      return _regeneratorRuntime.async(function add$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.next = 2;
            return _regeneratorRuntime.awrap(this.getDerData(this.pemFilename));

          case 2:
            data = context$2$0.sent.toString('hex');
            context$2$0.next = 5;
            return _regeneratorRuntime.awrap(this.getSubject(this.pemFilename));

          case 5:
            subject = context$2$0.sent;
            context$2$0.next = 8;
            return _regeneratorRuntime.awrap(this.getFingerPrint(this.data));

          case 8:
            sha1 = context$2$0.sent.toString('hex');
            trustStore = new TrustStore(dir);
            context$2$0.next = 12;
            return _regeneratorRuntime.awrap(trustStore.addRecord(sha1, tset, subject, data));

          case 12:
            return context$2$0.abrupt('return', context$2$0.sent);

          case 13:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }

    /**
     * Checks if keychain at given directory has this certificate
     */
  }, {
    key: 'has',
    value: function has(dir) {
      var subject, trustStore, previousFingerprint, currentFingerprint;
      return _regeneratorRuntime.async(function has$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.next = 2;
            return _regeneratorRuntime.awrap(this.getSubject(this.pemFilename));

          case 2:
            subject = context$2$0.sent;
            trustStore = new TrustStore(dir);
            context$2$0.next = 6;
            return _regeneratorRuntime.awrap(trustStore.hasRecords(subject));

          case 6:
            if (context$2$0.sent) {
              context$2$0.next = 8;
              break;
            }

            return context$2$0.abrupt('return', false);

          case 8:
            context$2$0.next = 10;
            return _regeneratorRuntime.awrap(trustStore.getFingerPrintFromRecord(subject));

          case 10:
            previousFingerprint = context$2$0.sent;
            context$2$0.next = 13;
            return _regeneratorRuntime.awrap(this.getFingerPrint());

          case 13:
            currentFingerprint = context$2$0.sent;
            return context$2$0.abrupt('return', previousFingerprint.toString() === currentFingerprint.toString());

          case 15:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }

    /**
     * Remove certificate from the TrustStore
     */
  }, {
    key: 'remove',
    value: function remove(dir) {
      var subject, trustStore;
      return _regeneratorRuntime.async(function remove$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.next = 2;
            return _regeneratorRuntime.awrap(this.getSubject(this.pemFilename));

          case 2:
            subject = context$2$0.sent;
            trustStore = new TrustStore(dir);
            context$2$0.next = 6;
            return _regeneratorRuntime.awrap(trustStore.removeRecord(subject));

          case 6:
            return context$2$0.abrupt('return', context$2$0.sent);

          case 7:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }

    /**
     * Translate PEM file to DER buffer
     */
  }, {
    key: 'getDerData',
    value: function getDerData() {
      return _regeneratorRuntime.async(function getDerData$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            if (!this.data) {
              context$2$0.next = 2;
              break;
            }

            return context$2$0.abrupt('return', this.data);

          case 2:
            context$2$0.next = 4;
            return _regeneratorRuntime.awrap(openssl('x509', {
              outform: 'der',
              'in': this.pemFilename
            }));

          case 4:
            this.data = context$2$0.sent;
            return context$2$0.abrupt('return', this.data);

          case 6:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }

    /**
     * Get SHA1 fingerprint from der data before
     */
  }, {
    key: 'getFingerPrint',
    value: function getFingerPrint() {
      var data, shasum;
      return _regeneratorRuntime.async(function getFingerPrint$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            if (!this.fingerprint) {
              context$2$0.next = 2;
              break;
            }

            return context$2$0.abrupt('return', this.fingerprint);

          case 2:
            context$2$0.next = 4;
            return _regeneratorRuntime.awrap(this.getDerData());

          case 4:
            data = context$2$0.sent;
            shasum = _crypto2['default'].createHash('sha1');

            shasum.update(data);
            this.fingerprint = shasum.digest();
            return context$2$0.abrupt('return', this.fingerprint);

          case 9:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }

    /**
     * Parse the subject from the der data
     */
  }, {
    key: 'getSubject',
    value: function getSubject() {
      var subject, subRegex;
      return _regeneratorRuntime.async(function getSubject$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            if (!this.subject) {
              context$2$0.next = 2;
              break;
            }

            return context$2$0.abrupt('return', this.subject);

          case 2:
            context$2$0.next = 4;
            return _regeneratorRuntime.awrap(openssl('x509', {
              noout: true,
              subject: true,
              'in': this.pemFilename
            }));

          case 4:
            subject = context$2$0.sent;
            subRegex = /^subject[\w\W]*\/CN=([\w\W]*)(\n)?/;

            this.subject = subject.toString().match(subRegex)[1];
            return context$2$0.abrupt('return', this.subject);

          case 8:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }]);

  return Certificate;
})();

var TrustStore = (function () {
  function TrustStore(sharedResourceDir) {
    _classCallCheck(this, TrustStore);

    this.sharedResourceDir = sharedResourceDir;
  }

  /**
   * Get TrustStore database associated with this simulator
   */

  _createClass(TrustStore, [{
    key: 'getDB',
    value: function getDB() {
      var keychainsPath;
      return _regeneratorRuntime.async(function getDB$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            if (!this.db) {
              context$2$0.next = 2;
              break;
            }

            return context$2$0.abrupt('return', this.db);

          case 2:
            keychainsPath = _path2['default'].resolve(this.sharedResourceDir, 'Library', 'Keychains');
            context$2$0.next = 5;
            return _regeneratorRuntime.awrap(_appiumSupport.fs.exists(keychainsPath));

          case 5:
            if (context$2$0.sent) {
              context$2$0.next = 8;
              break;
            }

            context$2$0.next = 8;
            return _regeneratorRuntime.awrap((0, _appiumSupport.mkdirp)(keychainsPath));

          case 8:

            // Open sqlite database
            this.db = _path2['default'].resolve(keychainsPath, 'TrustStore.sqlite3');

            // If it doesn't have a tsettings table, create one
            context$2$0.next = 11;
            return _regeneratorRuntime.awrap((0, _utils.execSQLiteQuery)(this.db, 'CREATE TABLE IF NOT EXISTS tsettings (sha1 BLOB NOT NULL DEFAULT \'\', subj BLOB NOT NULL DEFAULT \'\', tset BLOB, data BLOB, PRIMARY KEY(sha1));'));

          case 11:
            context$2$0.prev = 11;
            context$2$0.next = 14;
            return _regeneratorRuntime.awrap((0, _utils.execSQLiteQuery)(this.db, 'CREATE INDEX isubj ON tsettings(subj);'));

          case 14:
            context$2$0.next = 18;
            break;

          case 16:
            context$2$0.prev = 16;
            context$2$0.t0 = context$2$0['catch'](11);

          case 18:
            return context$2$0.abrupt('return', this.db);

          case 19:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this, [[11, 16]]);
    }

    /**
     * Add record to tsettings
     */
  }, {
    key: 'addRecord',
    value: function addRecord(sha1, tset, subj, data) {
      var db;
      return _regeneratorRuntime.async(function addRecord$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.next = 2;
            return _regeneratorRuntime.awrap(this.getDB());

          case 2:
            db = context$2$0.sent;
            context$2$0.next = 5;
            return _regeneratorRuntime.awrap(this.hasRecords(subj));

          case 5:
            if (!context$2$0.sent) {
              context$2$0.next = 11;
              break;
            }

            context$2$0.next = 8;
            return _regeneratorRuntime.awrap((0, _utils.execSQLiteQuery)(db, 'UPDATE tsettings SET sha1=x\'?\', tset=\'?\', data=x\'?\' WHERE subj=\'?\'', sha1, tset, data, subj));

          case 8:
            return context$2$0.abrupt('return', context$2$0.sent);

          case 11:
            context$2$0.next = 13;
            return _regeneratorRuntime.awrap((0, _utils.execSQLiteQuery)(db, 'INSERT INTO tsettings (sha1, subj, tset, data) VALUES (x\'?\', \'?\', \'?\', x\'?\')', sha1, subj, tset, data));

          case 13:
            return context$2$0.abrupt('return', context$2$0.sent);

          case 14:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }

    /**
     * Remove record from tsettings that matches the subject
     * @param {string} subj
     */
  }, {
    key: 'removeRecord',
    value: function removeRecord(subj) {
      return _regeneratorRuntime.async(function removeRecord$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.t0 = _regeneratorRuntime;
            context$2$0.next = 3;
            return _regeneratorRuntime.awrap(this.getDB());

          case 3:
            context$2$0.t1 = context$2$0.sent;
            context$2$0.t2 = subj;
            context$2$0.t3 = (0, _utils.execSQLiteQuery)(context$2$0.t1, 'DELETE FROM tsettings WHERE subj = \'?\'', context$2$0.t2);
            context$2$0.next = 8;
            return context$2$0.t0.awrap.call(context$2$0.t0, context$2$0.t3);

          case 8:
            return context$2$0.abrupt('return', context$2$0.sent);

          case 9:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }

    /**
     * Get a record from tsettings that matches the subj
     * @param {string} subj
     */
  }, {
    key: 'hasRecords',
    value: function hasRecords(subj) {
      return _regeneratorRuntime.async(function hasRecords$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.next = 2;
            return _regeneratorRuntime.awrap(this.getRecordCount(subj));

          case 2:
            context$2$0.t0 = context$2$0.sent;
            return context$2$0.abrupt('return', context$2$0.t0 > 0);

          case 4:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }

    /**
     * Get count of how many records have this subject
     * @param {string} subj
     */
  }, {
    key: 'getRecordCount',
    value: function getRecordCount(subj) {
      var result;
      return _regeneratorRuntime.async(function getRecordCount$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.t0 = _regeneratorRuntime;
            context$2$0.next = 3;
            return _regeneratorRuntime.awrap(this.getDB());

          case 3:
            context$2$0.t1 = context$2$0.sent;
            context$2$0.t2 = subj;
            context$2$0.t3 = (0, _utils.execSQLiteQuery)(context$2$0.t1, 'SELECT count(*) FROM tsettings WHERE subj = \'?\'', context$2$0.t2);
            context$2$0.next = 8;
            return context$2$0.t0.awrap.call(context$2$0.t0, context$2$0.t3);

          case 8:
            result = context$2$0.sent.stdout;
            return context$2$0.abrupt('return', parseInt(result.split('=')[1], 10));

          case 10:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }

    /**
     * Get the SHA1 fingerprint for the record that has this subject
     * @param {string} subj
     */
  }, {
    key: 'getFingerPrintFromRecord',
    value: function getFingerPrintFromRecord(subj) {
      var result;
      return _regeneratorRuntime.async(function getFingerPrintFromRecord$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.t0 = _regeneratorRuntime;
            context$2$0.next = 3;
            return _regeneratorRuntime.awrap(this.getDB());

          case 3:
            context$2$0.t1 = context$2$0.sent;
            context$2$0.t2 = subj;
            context$2$0.t3 = (0, _utils.execSQLiteQuery)(context$2$0.t1, 'SELECT sha1 FROM tsettings WHERE subj=\'?\'', context$2$0.t2);
            context$2$0.next = 8;
            return context$2$0.t0.awrap.call(context$2$0.t0, context$2$0.t3);

          case 8:
            result = context$2$0.sent.stdout;

            if (!result) {
              context$2$0.next = 11;
              break;
            }

            return context$2$0.abrupt('return', Buffer.from(result.split('=')[1].trim()));

          case 11:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }]);

  return TrustStore;
})();

exports['default'] = Certificate;
exports.Certificate = Certificate;
exports.TrustStore = TrustStore;

// Return false if record with this subject is not found

// If record is found, check fingerprints to verify that they didn't change

// Convert 'pem' file to 'der'

// Convert 'pem' file to 'der'

// If the sim doesn't have a keychains directory, create one
//# sourceMappingURL=data:application/json;charset=utf8;base64,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Q0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLEVBQUUsQ0FBQzs7Ozs7OztLQUVsRDs7O1NBOUVHLFVBQVU7OztxQkFpRkQsV0FBVztRQUNqQixXQUFXLEdBQVgsV0FBVztRQUFFLFVBQVUsR0FBVixVQUFVIiwiZmlsZSI6ImxpYi9jZXJ0aWZpY2F0ZS5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBjcnlwdG8gZnJvbSAnY3J5cHRvJztcbmltcG9ydCBCIGZyb20gJ2JsdWViaXJkJztcbmltcG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IHsgZnMsIG1rZGlycCB9IGZyb20gJ2FwcGl1bS1zdXBwb3J0JztcbmltcG9ydCB7IGV4ZWNTUUxpdGVRdWVyeSB9IGZyb20gJy4vdXRpbHMnO1xuXG5jb25zdCBvcGVuc3NsID0gQi5wcm9taXNpZnkocmVxdWlyZSgnb3BlbnNzbC13cmFwcGVyJykuZXhlYyk7XG5cbmNvbnN0IHRzZXQgPSBgPD94bWwgdmVyc2lvbj1cIjEuMFwiIGVuY29kaW5nPVwiVVRGLThcIj8+XFxuXG4gICAgPCFET0NUWVBFIHBsaXN0IFBVQkxJQyBcIi0vL0FwcGxlLy9EVEQgUExJU1QgMS4wLy9FTlwiIFwiaHR0cDovL3d3dy5hcHBsZS5jb20vRFREcy9Qcm9wZXJ0eUxpc3QtMS4wLmR0ZFwiPlxuICAgIDxwbGlzdCB2ZXJzaW9uPVwiMS4wXCI+XG4gICAgPGFycmF5Lz5cbjwvcGxpc3Q+YDtcblxuLyoqXG4gKiBMaWJyYXJ5IGZvciBwcm9ncmFtYXRpY2FsbHkgYWRkaW5nIGNlcnRpZmljYXRlc1xuICovXG5jbGFzcyBDZXJ0aWZpY2F0ZSB7XG5cbiAgY29uc3RydWN0b3IgKHBlbUZpbGVuYW1lKSB7XG4gICAgdGhpcy5wZW1GaWxlbmFtZSA9IHBlbUZpbGVuYW1lO1xuICB9XG5cbiAgLyoqXG4gICAqIEFkZCBhIGNlcnRpZmljYXRlIHRvIHRoZSBUcnVzdFN0b3JlXG4gICAqL1xuICBhc3luYyBhZGQgKGRpcikge1xuICAgIGxldCBkYXRhID0gKGF3YWl0IHRoaXMuZ2V0RGVyRGF0YSh0aGlzLnBlbUZpbGVuYW1lKSkudG9TdHJpbmcoJ2hleCcpO1xuICAgIGxldCBzdWJqZWN0ID0gKGF3YWl0IHRoaXMuZ2V0U3ViamVjdCh0aGlzLnBlbUZpbGVuYW1lKSk7XG4gICAgbGV0IHNoYTEgPSAoYXdhaXQgdGhpcy5nZXRGaW5nZXJQcmludCh0aGlzLmRhdGEpKS50b1N0cmluZygnaGV4Jyk7XG5cbiAgICBsZXQgdHJ1c3RTdG9yZSA9IG5ldyBUcnVzdFN0b3JlKGRpcik7XG4gICAgcmV0dXJuIGF3YWl0IHRydXN0U3RvcmUuYWRkUmVjb3JkKHNoYTEsIHRzZXQsIHN1YmplY3QsIGRhdGEpO1xuICB9XG5cbiAgLyoqXG4gICAqIENoZWNrcyBpZiBrZXljaGFpbiBhdCBnaXZlbiBkaXJlY3RvcnkgaGFzIHRoaXMgY2VydGlmaWNhdGVcbiAgICovXG4gIGFzeW5jIGhhcyAoZGlyKSB7XG4gICAgbGV0IHN1YmplY3QgPSBhd2FpdCB0aGlzLmdldFN1YmplY3QodGhpcy5wZW1GaWxlbmFtZSk7XG4gICAgbGV0IHRydXN0U3RvcmUgPSBuZXcgVHJ1c3RTdG9yZShkaXIpO1xuXG4gICAgLy8gUmV0dXJuIGZhbHNlIGlmIHJlY29yZCB3aXRoIHRoaXMgc3ViamVjdCBpcyBub3QgZm91bmRcbiAgICBpZiAoIWF3YWl0IHRydXN0U3RvcmUuaGFzUmVjb3JkcyhzdWJqZWN0KSkge1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cblxuICAgIC8vIElmIHJlY29yZCBpcyBmb3VuZCwgY2hlY2sgZmluZ2VycHJpbnRzIHRvIHZlcmlmeSB0aGF0IHRoZXkgZGlkbid0IGNoYW5nZVxuICAgIGxldCBwcmV2aW91c0ZpbmdlcnByaW50ID0gYXdhaXQgdHJ1c3RTdG9yZS5nZXRGaW5nZXJQcmludEZyb21SZWNvcmQoc3ViamVjdCk7XG4gICAgbGV0IGN1cnJlbnRGaW5nZXJwcmludCA9IGF3YWl0IHRoaXMuZ2V0RmluZ2VyUHJpbnQoKTtcbiAgICByZXR1cm4gcHJldmlvdXNGaW5nZXJwcmludC50b1N0cmluZygpID09PSBjdXJyZW50RmluZ2VycHJpbnQudG9TdHJpbmcoKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZW1vdmUgY2VydGlmaWNhdGUgZnJvbSB0aGUgVHJ1c3RTdG9yZVxuICAgKi9cbiAgYXN5bmMgcmVtb3ZlIChkaXIpIHtcbiAgICBsZXQgc3ViamVjdCA9IGF3YWl0IHRoaXMuZ2V0U3ViamVjdCh0aGlzLnBlbUZpbGVuYW1lKTtcbiAgICBsZXQgdHJ1c3RTdG9yZSA9IG5ldyBUcnVzdFN0b3JlKGRpcik7XG4gICAgcmV0dXJuIGF3YWl0IHRydXN0U3RvcmUucmVtb3ZlUmVjb3JkKHN1YmplY3QpO1xuICB9XG5cbiAgLyoqXG4gICAqIFRyYW5zbGF0ZSBQRU0gZmlsZSB0byBERVIgYnVmZmVyXG4gICAqL1xuICBhc3luYyBnZXREZXJEYXRhICgpIHtcbiAgICBpZiAodGhpcy5kYXRhKSB7XG4gICAgICByZXR1cm4gdGhpcy5kYXRhO1xuICAgIH1cblxuICAgIC8vIENvbnZlcnQgJ3BlbScgZmlsZSB0byAnZGVyJ1xuICAgIHRoaXMuZGF0YSA9IGF3YWl0IG9wZW5zc2woJ3g1MDknLCB7XG4gICAgICBvdXRmb3JtOiAnZGVyJyxcbiAgICAgIGluOiB0aGlzLnBlbUZpbGVuYW1lXG4gICAgfSk7XG5cbiAgICByZXR1cm4gdGhpcy5kYXRhO1xuICB9XG5cbiAgLyoqXG4gICAqIEdldCBTSEExIGZpbmdlcnByaW50IGZyb20gZGVyIGRhdGEgYmVmb3JlXG4gICAqL1xuICBhc3luYyBnZXRGaW5nZXJQcmludCAoKSB7XG4gICAgaWYgKHRoaXMuZmluZ2VycHJpbnQpIHtcbiAgICAgIHJldHVybiB0aGlzLmZpbmdlcnByaW50O1xuICAgIH1cblxuICAgIGxldCBkYXRhID0gYXdhaXQgdGhpcy5nZXREZXJEYXRhKCk7XG4gICAgbGV0IHNoYXN1bSA9IGNyeXB0by5jcmVhdGVIYXNoKCdzaGExJyk7XG4gICAgc2hhc3VtLnVwZGF0ZShkYXRhKTtcbiAgICB0aGlzLmZpbmdlcnByaW50ID0gc2hhc3VtLmRpZ2VzdCgpO1xuICAgIHJldHVybiB0aGlzLmZpbmdlcnByaW50O1xuICB9XG5cbiAgLyoqXG4gICAqIFBhcnNlIHRoZSBzdWJqZWN0IGZyb20gdGhlIGRlciBkYXRhXG4gICAqL1xuICBhc3luYyBnZXRTdWJqZWN0ICgpIHtcbiAgICBpZiAodGhpcy5zdWJqZWN0KSB7XG4gICAgICByZXR1cm4gdGhpcy5zdWJqZWN0O1xuICAgIH1cblxuICAgIC8vIENvbnZlcnQgJ3BlbScgZmlsZSB0byAnZGVyJ1xuICAgIGxldCBzdWJqZWN0ID0gYXdhaXQgb3BlbnNzbCgneDUwOScsIHtcbiAgICAgIG5vb3V0OiB0cnVlLFxuICAgICAgc3ViamVjdDogdHJ1ZSxcbiAgICAgIGluOiB0aGlzLnBlbUZpbGVuYW1lXG4gICAgfSk7XG4gICAgbGV0IHN1YlJlZ2V4ID0gL15zdWJqZWN0W1xcd1xcV10qXFwvQ049KFtcXHdcXFddKikoXFxuKT8vO1xuICAgIHRoaXMuc3ViamVjdCA9IHN1YmplY3QudG9TdHJpbmcoKS5tYXRjaChzdWJSZWdleClbMV07XG4gICAgcmV0dXJuIHRoaXMuc3ViamVjdDtcbiAgfVxuXG59XG5cbi8qKlxuICogSW50ZXJmYWNlIGZvciBhZGRpbmcgYW5kIHJlbW92aW5nIHJlY29yZHMgdG8gVHJ1c3RTdG9yZS5zcWxpdGUzIGRhdGFiYXNlcyB0aGF0IEtleWNoYWlucyB1c2VcbiAqL1xuY2xhc3MgVHJ1c3RTdG9yZSB7XG4gIGNvbnN0cnVjdG9yIChzaGFyZWRSZXNvdXJjZURpcikge1xuICAgIHRoaXMuc2hhcmVkUmVzb3VyY2VEaXIgPSBzaGFyZWRSZXNvdXJjZURpcjtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXQgVHJ1c3RTdG9yZSBkYXRhYmFzZSBhc3NvY2lhdGVkIHdpdGggdGhpcyBzaW11bGF0b3JcbiAgICovXG4gIGFzeW5jIGdldERCICgpIHtcbiAgICBpZiAodGhpcy5kYikge1xuICAgICAgcmV0dXJuIHRoaXMuZGI7XG4gICAgfVxuXG4gICAgLy8gSWYgdGhlIHNpbSBkb2Vzbid0IGhhdmUgYSBrZXljaGFpbnMgZGlyZWN0b3J5LCBjcmVhdGUgb25lXG4gICAgbGV0IGtleWNoYWluc1BhdGggPSBwYXRoLnJlc29sdmUodGhpcy5zaGFyZWRSZXNvdXJjZURpciwgJ0xpYnJhcnknLCAnS2V5Y2hhaW5zJyk7XG4gICAgaWYgKCEoYXdhaXQgZnMuZXhpc3RzKGtleWNoYWluc1BhdGgpKSkge1xuICAgICAgYXdhaXQgbWtkaXJwKGtleWNoYWluc1BhdGgpO1xuICAgIH1cblxuICAgIC8vIE9wZW4gc3FsaXRlIGRhdGFiYXNlXG4gICAgdGhpcy5kYiA9IHBhdGgucmVzb2x2ZShrZXljaGFpbnNQYXRoLCAnVHJ1c3RTdG9yZS5zcWxpdGUzJyk7XG5cbiAgICAvLyBJZiBpdCBkb2Vzbid0IGhhdmUgYSB0c2V0dGluZ3MgdGFibGUsIGNyZWF0ZSBvbmVcbiAgICBhd2FpdCBleGVjU1FMaXRlUXVlcnkodGhpcy5kYiwgYENSRUFURSBUQUJMRSBJRiBOT1QgRVhJU1RTIHRzZXR0aW5ncyAoc2hhMSBCTE9CIE5PVCBOVUxMIERFRkFVTFQgJycsIHN1YmogQkxPQiBOT1QgTlVMTCBERUZBVUxUICcnLCB0c2V0IEJMT0IsIGRhdGEgQkxPQiwgUFJJTUFSWSBLRVkoc2hhMSkpO2ApO1xuICAgIHRyeSB7XG4gICAgICBhd2FpdCBleGVjU1FMaXRlUXVlcnkodGhpcy5kYiwgJ0NSRUFURSBJTkRFWCBpc3ViaiBPTiB0c2V0dGluZ3Moc3Viaik7Jyk7XG4gICAgfSBjYXRjaCAoZSkgeyB9XG5cblxuICAgIHJldHVybiB0aGlzLmRiO1xuICB9XG5cbiAgLyoqXG4gICAqIEFkZCByZWNvcmQgdG8gdHNldHRpbmdzXG4gICAqL1xuICBhc3luYyBhZGRSZWNvcmQgKHNoYTEsIHRzZXQsIHN1YmosIGRhdGEpIHtcbiAgICBsZXQgZGIgPSBhd2FpdCB0aGlzLmdldERCKCk7XG4gICAgaWYgKGF3YWl0IHRoaXMuaGFzUmVjb3JkcyhzdWJqKSkge1xuICAgICAgcmV0dXJuIGF3YWl0IGV4ZWNTUUxpdGVRdWVyeShkYiwgYFVQREFURSB0c2V0dGluZ3MgU0VUIHNoYTE9eCc/JywgdHNldD0nPycsIGRhdGE9eCc/JyBXSEVSRSBzdWJqPSc/J2AsIHNoYTEsIHRzZXQsIGRhdGEsIHN1YmopO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gYXdhaXQgZXhlY1NRTGl0ZVF1ZXJ5KGRiLCBgSU5TRVJUIElOVE8gdHNldHRpbmdzIChzaGExLCBzdWJqLCB0c2V0LCBkYXRhKSBWQUxVRVMgKHgnPycsICc/JywgJz8nLCB4Jz8nKWAsIHNoYTEsIHN1YmosIHRzZXQsIGRhdGEpO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBSZW1vdmUgcmVjb3JkIGZyb20gdHNldHRpbmdzIHRoYXQgbWF0Y2hlcyB0aGUgc3ViamVjdFxuICAgKiBAcGFyYW0ge3N0cmluZ30gc3VialxuICAgKi9cbiAgYXN5bmMgcmVtb3ZlUmVjb3JkIChzdWJqKSB7XG4gICAgcmV0dXJuIGF3YWl0IGV4ZWNTUUxpdGVRdWVyeShhd2FpdCB0aGlzLmdldERCKCksIGBERUxFVEUgRlJPTSB0c2V0dGluZ3MgV0hFUkUgc3ViaiA9ICc/J2AsIHN1YmopO1xuICB9XG5cbiAgLyoqXG4gICAqIEdldCBhIHJlY29yZCBmcm9tIHRzZXR0aW5ncyB0aGF0IG1hdGNoZXMgdGhlIHN1YmpcbiAgICogQHBhcmFtIHtzdHJpbmd9IHN1YmpcbiAgICovXG4gIGFzeW5jIGhhc1JlY29yZHMgKHN1YmopIHtcbiAgICByZXR1cm4gKGF3YWl0IHRoaXMuZ2V0UmVjb3JkQ291bnQoc3ViaikpID4gMDtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXQgY291bnQgb2YgaG93IG1hbnkgcmVjb3JkcyBoYXZlIHRoaXMgc3ViamVjdFxuICAgKiBAcGFyYW0ge3N0cmluZ30gc3VialxuICAgKi9cbiAgYXN5bmMgZ2V0UmVjb3JkQ291bnQgKHN1YmopIHtcbiAgICBsZXQgcmVzdWx0ID0gIChhd2FpdCBleGVjU1FMaXRlUXVlcnkoYXdhaXQgdGhpcy5nZXREQigpLCBgU0VMRUNUIGNvdW50KCopIEZST00gdHNldHRpbmdzIFdIRVJFIHN1YmogPSAnPydgLCBzdWJqKSkuc3Rkb3V0O1xuICAgIHJldHVybiBwYXJzZUludChyZXN1bHQuc3BsaXQoJz0nKVsxXSwgMTApO1xuICB9XG5cbiAgLyoqXG4gICAqIEdldCB0aGUgU0hBMSBmaW5nZXJwcmludCBmb3IgdGhlIHJlY29yZCB0aGF0IGhhcyB0aGlzIHN1YmplY3RcbiAgICogQHBhcmFtIHtzdHJpbmd9IHN1YmpcbiAgICovXG4gIGFzeW5jIGdldEZpbmdlclByaW50RnJvbVJlY29yZCAoc3Viaikge1xuICAgIGxldCByZXN1bHQgPSAoYXdhaXQgZXhlY1NRTGl0ZVF1ZXJ5KGF3YWl0IHRoaXMuZ2V0REIoKSwgYFNFTEVDVCBzaGExIEZST00gdHNldHRpbmdzIFdIRVJFIHN1Ymo9Jz8nYCwgc3ViaikpLnN0ZG91dDtcbiAgICBpZiAocmVzdWx0KSB7XG4gICAgICByZXR1cm4gQnVmZmVyLmZyb20ocmVzdWx0LnNwbGl0KCc9JylbMV0udHJpbSgpKTtcbiAgICB9XG4gIH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgQ2VydGlmaWNhdGU7XG5leHBvcnQgeyBDZXJ0aWZpY2F0ZSwgVHJ1c3RTdG9yZSB9O1xuIl0sInNvdXJjZVJvb3QiOiIuLi8uLiJ9

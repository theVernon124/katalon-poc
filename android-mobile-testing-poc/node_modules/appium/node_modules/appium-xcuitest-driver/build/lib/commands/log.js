'use strict';

var _Object$assign = require('babel-runtime/core-js/object/assign')['default'];

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _this = this;

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _appiumBaseDriver = require('appium-base-driver');

var _appiumIosDriver = require('appium-ios-driver');

var _deviceLogIosCrashLog = require('../device-log/ios-crash-log');

var _deviceLogIosLog = require('../device-log/ios-log');

var _logger = require('../logger');

var _logger2 = _interopRequireDefault(_logger);

var _ws = require('ws');

var _ws2 = _interopRequireDefault(_ws);

var _deviceLogSafariConsoleLog = require('../device-log/safari-console-log');

var extensions = {};

var WEBSOCKET_ENDPOINT = function WEBSOCKET_ENDPOINT(sessionId) {
  return _appiumBaseDriver.DEFAULT_WS_PATHNAME_PREFIX + '/session/' + sessionId + '/appium/device/syslog';
};

_Object$assign(extensions, _appiumIosDriver.iosCommands.logging);

extensions.supportedLogTypes.safariConsole = {
  description: 'Safari Console Logs - data written to the JS console in Safari',
  getter: function getter(self) {
    return _regeneratorRuntime.async(function getter$(context$1$0) {
      while (1) switch (context$1$0.prev = context$1$0.next) {
        case 0:
          context$1$0.next = 2;
          return _regeneratorRuntime.awrap(self.extractLogs('safariConsole', self.logs));

        case 2:
          return context$1$0.abrupt('return', context$1$0.sent);

        case 3:
        case 'end':
          return context$1$0.stop();
      }
    }, null, _this);
  }
};

extensions.startLogCapture = function callee$0$0() {
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        this.logs = this.logs || {};

        if (!(!_lodash2['default'].isUndefined(this.logs.syslog) && this.logs.syslog.isCapturing)) {
          context$1$0.next = 4;
          break;
        }

        _logger2['default'].warn('Trying to start iOS log capture but it has already started!');
        return context$1$0.abrupt('return', true);

      case 4:
        if (_lodash2['default'].isUndefined(this.logs.syslog)) {
          this.logs.crashlog = new _deviceLogIosCrashLog.IOSCrashLog({
            sim: this.opts.device,
            udid: this.isRealDevice() ? this.opts.udid : undefined
          });
          this.logs.syslog = new _deviceLogIosLog.IOSLog({
            sim: this.opts.device,
            udid: this.isRealDevice() ? this.opts.udid : undefined,
            showLogs: this.opts.showIOSLog,
            realDeviceLogger: this.opts.realDeviceLogger,
            xcodeVersion: this.xcodeVersion
          });
          this.logs.safariConsole = new _deviceLogSafariConsoleLog.SafariConsoleLog(!!this.opts.showSafariConsoleLog);
        }
        context$1$0.prev = 5;
        context$1$0.next = 8;
        return _regeneratorRuntime.awrap(this.logs.syslog.startCapture());

      case 8:
        context$1$0.next = 14;
        break;

      case 10:
        context$1$0.prev = 10;
        context$1$0.t0 = context$1$0['catch'](5);

        _logger2['default'].warn('Continuing without capturing device logs: ' + context$1$0.t0.message);
        return context$1$0.abrupt('return', false);

      case 14:
        context$1$0.next = 16;
        return _regeneratorRuntime.awrap(this.logs.crashlog.startCapture());

      case 16:
        context$1$0.next = 18;
        return _regeneratorRuntime.awrap(this.logs.safariConsole.startCapture());

      case 18:
        return context$1$0.abrupt('return', true);

      case 19:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[5, 10]]);
};

/**
 * Starts iOS system logs broadcast websocket on the same host and port
 * where Appium server is running at `/ws/session/:sessionId:/appium/syslog` endpoint. The method
 * will return immediately if the web socket is already listening.
 *
 * Each connected webcoket listener will receive syslog lines
 * as soon as they are visible to Appium.
 */
extensions.mobileStartLogsBroadcast = function callee$0$0() {
  var pathname, wss;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    var _this2 = this;

    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        pathname = WEBSOCKET_ENDPOINT(this.sessionId);
        context$1$0.t0 = _lodash2['default'];
        context$1$0.next = 4;
        return _regeneratorRuntime.awrap(this.server.getWebSocketHandlers(pathname));

      case 4:
        context$1$0.t1 = context$1$0.sent;

        if (context$1$0.t0.isEmpty.call(context$1$0.t0, context$1$0.t1)) {
          context$1$0.next = 8;
          break;
        }

        _logger2['default'].debug('The system logs broadcasting web socket server is already listening at ' + pathname);
        return context$1$0.abrupt('return');

      case 8:

        _logger2['default'].info('Assigning system logs broadcasting web socket server to ' + pathname);
        // https://github.com/websockets/ws/blob/master/doc/ws.md
        wss = new _ws2['default'].Server({
          noServer: true
        });

        wss.on('connection', function (ws, req) {
          if (req) {
            var remoteIp = _lodash2['default'].isEmpty(req.headers['x-forwarded-for']) ? req.connection.remoteAddress : req.headers['x-forwarded-for'];
            _logger2['default'].debug('Established a new system logs listener web socket connection from ' + remoteIp);
          } else {
            _logger2['default'].debug('Established a new system logs listener web socket connection');
          }

          if (_lodash2['default'].isEmpty(_this2._syslogWebsocketListener)) {
            _this2._syslogWebsocketListener = function (logRecord) {
              if (ws && ws.readyState === _ws2['default'].OPEN) {
                ws.send(logRecord.message);
              }
            };
          }
          _this2.logs.syslog.on('output', _this2._syslogWebsocketListener);

          ws.on('close', function (code, reason) {
            if (!_lodash2['default'].isEmpty(_this2._syslogWebsocketListener)) {
              _this2.logs.syslog.removeListener('output', _this2._syslogWebsocketListener);
              _this2._syslogWebsocketListener = null;
            }

            var closeMsg = 'System logs listener web socket is closed.';
            if (!_lodash2['default'].isEmpty(code)) {
              closeMsg += ' Code: ' + code + '.';
            }
            if (!_lodash2['default'].isEmpty(reason)) {
              closeMsg += ' Reason: ' + reason + '.';
            }
            _logger2['default'].debug(closeMsg);
          });
        });
        context$1$0.next = 13;
        return _regeneratorRuntime.awrap(this.server.addWebSocketHandler(pathname, wss));

      case 13:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

/**
 * Stops the previously started syslog broadcasting wesocket server.
 * This method will return immediately if no server is running.
 */
extensions.mobileStopLogsBroadcast = function callee$0$0() {
  var pathname;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        pathname = WEBSOCKET_ENDPOINT(this.sessionId);
        context$1$0.t0 = _lodash2['default'];
        context$1$0.next = 4;
        return _regeneratorRuntime.awrap(this.server.getWebSocketHandlers(pathname));

      case 4:
        context$1$0.t1 = context$1$0.sent;

        if (!context$1$0.t0.isEmpty.call(context$1$0.t0, context$1$0.t1)) {
          context$1$0.next = 7;
          break;
        }

        return context$1$0.abrupt('return');

      case 7:

        _logger2['default'].debug('Stopping the system logs broadcasting web socket server');
        context$1$0.next = 10;
        return _regeneratorRuntime.awrap(this.server.removeWebSocketHandler(pathname));

      case 10:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

exports['default'] = extensions;
module.exports = exports['default'];
//# sourceMappingURL=data:application/json;charset=utf8;base64,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QzdDLHFCQUFLLElBQUksQ0FBQyxNQUFNLENBQUMsY0FBYyxDQUFDLFFBQVEsRUFBRSxPQUFLLHdCQUF3QixDQUFDLENBQUM7QUFDekUscUJBQUssd0JBQXdCLEdBQUcsSUFBSSxDQUFDO2FBQ3RDOztBQUVELGdCQUFJLFFBQVEsR0FBRyw0Q0FBNEMsQ0FBQztBQUM1RCxnQkFBSSxDQUFDLG9CQUFFLE9BQU8sQ0FBQyxJQUFJLENBQUMsRUFBRTtBQUNwQixzQkFBUSxnQkFBYyxJQUFJLE1BQUcsQ0FBQzthQUMvQjtBQUNELGdCQUFJLENBQUMsb0JBQUUsT0FBTyxDQUFDLE1BQU0sQ0FBQyxFQUFFO0FBQ3RCLHNCQUFRLGtCQUFnQixNQUFNLE1BQUcsQ0FBQzthQUNuQztBQUNELGdDQUFJLEtBQUssQ0FBQyxRQUFRLENBQUMsQ0FBQztXQUNyQixDQUFDLENBQUM7U0FDSixDQUFDLENBQUM7O3lDQUNHLElBQUksQ0FBQyxNQUFNLENBQUMsbUJBQW1CLENBQUMsUUFBUSxFQUFFLEdBQUcsQ0FBQzs7Ozs7OztDQUNyRCxDQUFDOzs7Ozs7QUFNRixVQUFVLENBQUMsdUJBQXVCLEdBQUc7TUFDN0IsUUFBUTs7OztBQUFSLGdCQUFRLEdBQUcsa0JBQWtCLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQzs7O3lDQUMvQixJQUFJLENBQUMsTUFBTSxDQUFDLG9CQUFvQixDQUFDLFFBQVEsQ0FBQzs7Ozs7NEJBQXhELE9BQU87Ozs7Ozs7OztBQUliLDRCQUFJLEtBQUssQ0FBQyx5REFBeUQsQ0FBQyxDQUFDOzt5Q0FDL0QsSUFBSSxDQUFDLE1BQU0sQ0FBQyxzQkFBc0IsQ0FBQyxRQUFRLENBQUM7Ozs7Ozs7Q0FDbkQsQ0FBQzs7cUJBRWEsVUFBVSIsImZpbGUiOiJsaWIvY29tbWFuZHMvbG9nLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCB7IERFRkFVTFRfV1NfUEFUSE5BTUVfUFJFRklYIH0gZnJvbSAnYXBwaXVtLWJhc2UtZHJpdmVyJztcbmltcG9ydCB7IGlvc0NvbW1hbmRzIH0gZnJvbSAnYXBwaXVtLWlvcy1kcml2ZXInO1xuaW1wb3J0IHsgSU9TQ3Jhc2hMb2cgfSBmcm9tICcuLi9kZXZpY2UtbG9nL2lvcy1jcmFzaC1sb2cnO1xuaW1wb3J0IHsgSU9TTG9nIH0gZnJvbSAnLi4vZGV2aWNlLWxvZy9pb3MtbG9nJztcbmltcG9ydCBsb2cgZnJvbSAnLi4vbG9nZ2VyJztcbmltcG9ydCBXZWJTb2NrZXQgZnJvbSAnd3MnO1xuaW1wb3J0IHsgU2FmYXJpQ29uc29sZUxvZyB9IGZyb20gJy4uL2RldmljZS1sb2cvc2FmYXJpLWNvbnNvbGUtbG9nJztcblxuXG5sZXQgZXh0ZW5zaW9ucyA9IHt9O1xuXG5jb25zdCBXRUJTT0NLRVRfRU5EUE9JTlQgPSAoc2Vzc2lvbklkKSA9PiBgJHtERUZBVUxUX1dTX1BBVEhOQU1FX1BSRUZJWH0vc2Vzc2lvbi8ke3Nlc3Npb25JZH0vYXBwaXVtL2RldmljZS9zeXNsb2dgO1xuXG5PYmplY3QuYXNzaWduKGV4dGVuc2lvbnMsIGlvc0NvbW1hbmRzLmxvZ2dpbmcpO1xuXG5leHRlbnNpb25zLnN1cHBvcnRlZExvZ1R5cGVzLnNhZmFyaUNvbnNvbGUgPSB7XG4gIGRlc2NyaXB0aW9uOiAnU2FmYXJpIENvbnNvbGUgTG9ncyAtIGRhdGEgd3JpdHRlbiB0byB0aGUgSlMgY29uc29sZSBpbiBTYWZhcmknLFxuICBnZXR0ZXI6IGFzeW5jIChzZWxmKSA9PiBhd2FpdCBzZWxmLmV4dHJhY3RMb2dzKCdzYWZhcmlDb25zb2xlJywgc2VsZi5sb2dzKSxcbn07XG5cbmV4dGVuc2lvbnMuc3RhcnRMb2dDYXB0dXJlID0gYXN5bmMgZnVuY3Rpb24gKCkge1xuICB0aGlzLmxvZ3MgPSB0aGlzLmxvZ3MgfHwge307XG4gIGlmICghXy5pc1VuZGVmaW5lZCh0aGlzLmxvZ3Muc3lzbG9nKSAmJiB0aGlzLmxvZ3Muc3lzbG9nLmlzQ2FwdHVyaW5nKSB7XG4gICAgbG9nLndhcm4oJ1RyeWluZyB0byBzdGFydCBpT1MgbG9nIGNhcHR1cmUgYnV0IGl0IGhhcyBhbHJlYWR5IHN0YXJ0ZWQhJyk7XG4gICAgcmV0dXJuIHRydWU7XG4gIH1cbiAgaWYgKF8uaXNVbmRlZmluZWQodGhpcy5sb2dzLnN5c2xvZykpIHtcbiAgICB0aGlzLmxvZ3MuY3Jhc2hsb2cgPSBuZXcgSU9TQ3Jhc2hMb2coe1xuICAgICAgc2ltOiB0aGlzLm9wdHMuZGV2aWNlLFxuICAgICAgdWRpZDogdGhpcy5pc1JlYWxEZXZpY2UoKSA/IHRoaXMub3B0cy51ZGlkIDogdW5kZWZpbmVkLFxuICAgIH0pO1xuICAgIHRoaXMubG9ncy5zeXNsb2cgPSBuZXcgSU9TTG9nKHtcbiAgICAgIHNpbTogdGhpcy5vcHRzLmRldmljZSxcbiAgICAgIHVkaWQ6IHRoaXMuaXNSZWFsRGV2aWNlKCkgPyB0aGlzLm9wdHMudWRpZCA6IHVuZGVmaW5lZCxcbiAgICAgIHNob3dMb2dzOiB0aGlzLm9wdHMuc2hvd0lPU0xvZyxcbiAgICAgIHJlYWxEZXZpY2VMb2dnZXI6IHRoaXMub3B0cy5yZWFsRGV2aWNlTG9nZ2VyLFxuICAgICAgeGNvZGVWZXJzaW9uOiB0aGlzLnhjb2RlVmVyc2lvbixcbiAgICB9KTtcbiAgICB0aGlzLmxvZ3Muc2FmYXJpQ29uc29sZSA9IG5ldyBTYWZhcmlDb25zb2xlTG9nKCEhdGhpcy5vcHRzLnNob3dTYWZhcmlDb25zb2xlTG9nKTtcbiAgfVxuICB0cnkge1xuICAgIGF3YWl0IHRoaXMubG9ncy5zeXNsb2cuc3RhcnRDYXB0dXJlKCk7XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIGxvZy53YXJuKGBDb250aW51aW5nIHdpdGhvdXQgY2FwdHVyaW5nIGRldmljZSBsb2dzOiAke2Vyci5tZXNzYWdlfWApO1xuICAgIHJldHVybiBmYWxzZTtcbiAgfVxuICBhd2FpdCB0aGlzLmxvZ3MuY3Jhc2hsb2cuc3RhcnRDYXB0dXJlKCk7XG4gIGF3YWl0IHRoaXMubG9ncy5zYWZhcmlDb25zb2xlLnN0YXJ0Q2FwdHVyZSgpO1xuXG4gIHJldHVybiB0cnVlO1xufTtcblxuLyoqXG4gKiBTdGFydHMgaU9TIHN5c3RlbSBsb2dzIGJyb2FkY2FzdCB3ZWJzb2NrZXQgb24gdGhlIHNhbWUgaG9zdCBhbmQgcG9ydFxuICogd2hlcmUgQXBwaXVtIHNlcnZlciBpcyBydW5uaW5nIGF0IGAvd3Mvc2Vzc2lvbi86c2Vzc2lvbklkOi9hcHBpdW0vc3lzbG9nYCBlbmRwb2ludC4gVGhlIG1ldGhvZFxuICogd2lsbCByZXR1cm4gaW1tZWRpYXRlbHkgaWYgdGhlIHdlYiBzb2NrZXQgaXMgYWxyZWFkeSBsaXN0ZW5pbmcuXG4gKlxuICogRWFjaCBjb25uZWN0ZWQgd2ViY29rZXQgbGlzdGVuZXIgd2lsbCByZWNlaXZlIHN5c2xvZyBsaW5lc1xuICogYXMgc29vbiBhcyB0aGV5IGFyZSB2aXNpYmxlIHRvIEFwcGl1bS5cbiAqL1xuZXh0ZW5zaW9ucy5tb2JpbGVTdGFydExvZ3NCcm9hZGNhc3QgPSBhc3luYyBmdW5jdGlvbiAoKSB7XG4gIGNvbnN0IHBhdGhuYW1lID0gV0VCU09DS0VUX0VORFBPSU5UKHRoaXMuc2Vzc2lvbklkKTtcbiAgaWYgKCFfLmlzRW1wdHkoYXdhaXQgdGhpcy5zZXJ2ZXIuZ2V0V2ViU29ja2V0SGFuZGxlcnMocGF0aG5hbWUpKSkge1xuICAgIGxvZy5kZWJ1ZyhgVGhlIHN5c3RlbSBsb2dzIGJyb2FkY2FzdGluZyB3ZWIgc29ja2V0IHNlcnZlciBpcyBhbHJlYWR5IGxpc3RlbmluZyBhdCAke3BhdGhuYW1lfWApO1xuICAgIHJldHVybjtcbiAgfVxuXG4gIGxvZy5pbmZvKGBBc3NpZ25pbmcgc3lzdGVtIGxvZ3MgYnJvYWRjYXN0aW5nIHdlYiBzb2NrZXQgc2VydmVyIHRvICR7cGF0aG5hbWV9YCk7XG4gIC8vIGh0dHBzOi8vZ2l0aHViLmNvbS93ZWJzb2NrZXRzL3dzL2Jsb2IvbWFzdGVyL2RvYy93cy5tZFxuICBjb25zdCB3c3MgPSBuZXcgV2ViU29ja2V0LlNlcnZlcih7XG4gICAgbm9TZXJ2ZXI6IHRydWUsXG4gIH0pO1xuICB3c3Mub24oJ2Nvbm5lY3Rpb24nLCAod3MsIHJlcSkgPT4ge1xuICAgIGlmIChyZXEpIHtcbiAgICAgIGNvbnN0IHJlbW90ZUlwID0gXy5pc0VtcHR5KHJlcS5oZWFkZXJzWyd4LWZvcndhcmRlZC1mb3InXSlcbiAgICAgICAgPyByZXEuY29ubmVjdGlvbi5yZW1vdGVBZGRyZXNzXG4gICAgICAgIDogcmVxLmhlYWRlcnNbJ3gtZm9yd2FyZGVkLWZvciddO1xuICAgICAgbG9nLmRlYnVnKGBFc3RhYmxpc2hlZCBhIG5ldyBzeXN0ZW0gbG9ncyBsaXN0ZW5lciB3ZWIgc29ja2V0IGNvbm5lY3Rpb24gZnJvbSAke3JlbW90ZUlwfWApO1xuICAgIH0gZWxzZSB7XG4gICAgICBsb2cuZGVidWcoJ0VzdGFibGlzaGVkIGEgbmV3IHN5c3RlbSBsb2dzIGxpc3RlbmVyIHdlYiBzb2NrZXQgY29ubmVjdGlvbicpO1xuICAgIH1cblxuICAgIGlmIChfLmlzRW1wdHkodGhpcy5fc3lzbG9nV2Vic29ja2V0TGlzdGVuZXIpKSB7XG4gICAgICB0aGlzLl9zeXNsb2dXZWJzb2NrZXRMaXN0ZW5lciA9IChsb2dSZWNvcmQpID0+IHtcbiAgICAgICAgaWYgKHdzICYmIHdzLnJlYWR5U3RhdGUgPT09IFdlYlNvY2tldC5PUEVOKSB7XG4gICAgICAgICAgd3Muc2VuZChsb2dSZWNvcmQubWVzc2FnZSk7XG4gICAgICAgIH1cbiAgICAgIH07XG4gICAgfVxuICAgIHRoaXMubG9ncy5zeXNsb2cub24oJ291dHB1dCcsIHRoaXMuX3N5c2xvZ1dlYnNvY2tldExpc3RlbmVyKTtcblxuICAgIHdzLm9uKCdjbG9zZScsIChjb2RlLCByZWFzb24pID0+IHtcbiAgICAgIGlmICghXy5pc0VtcHR5KHRoaXMuX3N5c2xvZ1dlYnNvY2tldExpc3RlbmVyKSkge1xuICAgICAgICB0aGlzLmxvZ3Muc3lzbG9nLnJlbW92ZUxpc3RlbmVyKCdvdXRwdXQnLCB0aGlzLl9zeXNsb2dXZWJzb2NrZXRMaXN0ZW5lcik7XG4gICAgICAgIHRoaXMuX3N5c2xvZ1dlYnNvY2tldExpc3RlbmVyID0gbnVsbDtcbiAgICAgIH1cblxuICAgICAgbGV0IGNsb3NlTXNnID0gJ1N5c3RlbSBsb2dzIGxpc3RlbmVyIHdlYiBzb2NrZXQgaXMgY2xvc2VkLic7XG4gICAgICBpZiAoIV8uaXNFbXB0eShjb2RlKSkge1xuICAgICAgICBjbG9zZU1zZyArPSBgIENvZGU6ICR7Y29kZX0uYDtcbiAgICAgIH1cbiAgICAgIGlmICghXy5pc0VtcHR5KHJlYXNvbikpIHtcbiAgICAgICAgY2xvc2VNc2cgKz0gYCBSZWFzb246ICR7cmVhc29ufS5gO1xuICAgICAgfVxuICAgICAgbG9nLmRlYnVnKGNsb3NlTXNnKTtcbiAgICB9KTtcbiAgfSk7XG4gIGF3YWl0IHRoaXMuc2VydmVyLmFkZFdlYlNvY2tldEhhbmRsZXIocGF0aG5hbWUsIHdzcyk7XG59O1xuXG4vKipcbiAqIFN0b3BzIHRoZSBwcmV2aW91c2x5IHN0YXJ0ZWQgc3lzbG9nIGJyb2FkY2FzdGluZyB3ZXNvY2tldCBzZXJ2ZXIuXG4gKiBUaGlzIG1ldGhvZCB3aWxsIHJldHVybiBpbW1lZGlhdGVseSBpZiBubyBzZXJ2ZXIgaXMgcnVubmluZy5cbiAqL1xuZXh0ZW5zaW9ucy5tb2JpbGVTdG9wTG9nc0Jyb2FkY2FzdCA9IGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgY29uc3QgcGF0aG5hbWUgPSBXRUJTT0NLRVRfRU5EUE9JTlQodGhpcy5zZXNzaW9uSWQpO1xuICBpZiAoXy5pc0VtcHR5KGF3YWl0IHRoaXMuc2VydmVyLmdldFdlYlNvY2tldEhhbmRsZXJzKHBhdGhuYW1lKSkpIHtcbiAgICByZXR1cm47XG4gIH1cblxuICBsb2cuZGVidWcoJ1N0b3BwaW5nIHRoZSBzeXN0ZW0gbG9ncyBicm9hZGNhc3Rpbmcgd2ViIHNvY2tldCBzZXJ2ZXInKTtcbiAgYXdhaXQgdGhpcy5zZXJ2ZXIucmVtb3ZlV2ViU29ja2V0SGFuZGxlcihwYXRobmFtZSk7XG59O1xuXG5leHBvcnQgZGVmYXVsdCBleHRlbnNpb25zO1xuIl0sInNvdXJjZVJvb3QiOiIuLi8uLi8uLiJ9

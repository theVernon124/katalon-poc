'use strict';

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _Object$assign = require('babel-runtime/core-js/object/assign')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _appiumSupport = require('appium-support');

var _appiumIosDriver = require('appium-ios-driver');

var _appiumBaseDriver = require('appium-base-driver');

var _nodeSimctl = require('node-simctl');

var _asyncbox = require('asyncbox');

var _bluebird = require('bluebird');

var _bluebird2 = _interopRequireDefault(_bluebird);

var _logger = require('../logger');

var _logger2 = _interopRequireDefault(_logger);

var _os = require('os');

var _os2 = _interopRequireDefault(_os);

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

var _uuidJs = require('uuid-js');

var _uuidJs2 = _interopRequireDefault(_uuidJs);

var _teen_process = require('teen_process');

var extensions = {},
    commands = {};

var CONFIG_EXTENSION = 'mobileconfig';

function extractCommonName(certBuffer) {
  var tempCert, _ref, stdout, cnMatch;

  return _regeneratorRuntime.async(function extractCommonName$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.next = 2;
        return _regeneratorRuntime.awrap(_appiumSupport.tempDir.open({
          prefix: 'cert',
          suffix: '.cer'
        }));

      case 2:
        tempCert = context$1$0.sent;
        context$1$0.prev = 3;
        context$1$0.next = 6;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.writeFile(tempCert.path, certBuffer.toString('latin-1'), 'latin-1'));

      case 6:
        context$1$0.next = 8;
        return _regeneratorRuntime.awrap((0, _teen_process.exec)('openssl', ['x509', '-noout', '-subject', '-in', tempCert.path]));

      case 8:
        _ref = context$1$0.sent;
        stdout = _ref.stdout;
        cnMatch = /\/CN=([^\s,]+)/.exec(stdout);

        if (!cnMatch) {
          context$1$0.next = 13;
          break;
        }

        return context$1$0.abrupt('return', cnMatch[1]);

      case 13:
        throw new Error('There is no common name value in \'' + stdout + '\' output');

      case 16:
        context$1$0.prev = 16;
        context$1$0.t0 = context$1$0['catch'](3);
        throw new Error('Cannot parse common name value from the certificate. Is it valid and base64-encoded? ' + ('Original error: ' + context$1$0.t0.message));

      case 19:
        context$1$0.prev = 19;
        context$1$0.next = 22;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.rimraf(tempCert.path));

      case 22:
        return context$1$0.finish(19);

      case 23:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[3, 16, 19, 23]]);
}

/**
 * Generates Apple's over-the-air configuration profile
 * for certificate deployment based on the given PEM certificate content.
 * Read https://developer.apple.com/library/content/documentation/NetworkingInternet/Conceptual/iPhoneOTAConfiguration/Introduction/Introduction.html
 * for more details on such profiles.
 *
 * @param {Buffer} certBuffer - The actual content of PEM certificate encoded into NodeJS buffer
 * @param {string} commonName - Certificate's common name
 * @returns {Object} The encoded structure of the given certificate, which is ready to be passed
 * as an argument to plist builder
 * @throws {Error} If the given certificate cannot be parsed
 */
function toMobileConfig(certBuffer, commonName) {
  var getUUID = function getUUID() {
    return _uuidJs2['default'].create().hex.toUpperCase();
  };
  var contentUuid = getUUID();
  return {
    PayloadContent: [{
      PayloadCertificateFileName: commonName + '.cer',
      PayloadContent: certBuffer,
      PayloadDescription: 'Adds a CA root certificate',
      PayloadDisplayName: commonName,
      PayloadIdentifier: 'com.apple.security.root.' + contentUuid,
      PayloadType: 'com.apple.security.root',
      PayloadUUID: contentUuid,
      PayloadVersion: 1
    }],
    PayloadDisplayName: commonName,
    PayloadIdentifier: _os2['default'].hostname().split('.')[0] + '.' + getUUID(),
    PayloadRemovalDisallowed: false,
    PayloadType: 'Configuration',
    PayloadUUID: getUUID(),
    PayloadVersion: 1
  };
}

function clickElement(driver, locator) {
  var options = arguments.length <= 2 || arguments[2] === undefined ? {} : arguments[2];

  var element, _options$timeout, timeout, _options$skipIfInvisible, skipIfInvisible, lookupDelay;

  return _regeneratorRuntime.async(function clickElement$(context$1$0) {
    var _this = this;

    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        element = null;
        _options$timeout = options.timeout;
        timeout = _options$timeout === undefined ? 5000 : _options$timeout;
        _options$skipIfInvisible = options.skipIfInvisible;
        skipIfInvisible = _options$skipIfInvisible === undefined ? false : _options$skipIfInvisible;
        lookupDelay = 500;
        context$1$0.prev = 6;
        context$1$0.next = 9;
        return _regeneratorRuntime.awrap((0, _asyncbox.retryInterval)(timeout / lookupDelay, lookupDelay, function callee$1$0() {
          return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
            while (1) switch (context$2$0.prev = context$2$0.next) {
              case 0:
                context$2$0.next = 2;
                return _regeneratorRuntime.awrap(driver.findNativeElementOrElements(locator.type, locator.value, false));

              case 2:
                return context$2$0.abrupt('return', context$2$0.sent);

              case 3:
              case 'end':
                return context$2$0.stop();
            }
          }, null, _this);
        }));

      case 9:
        element = context$1$0.sent;
        context$1$0.next = 17;
        break;

      case 12:
        context$1$0.prev = 12;
        context$1$0.t0 = context$1$0['catch'](6);

        if (!skipIfInvisible) {
          context$1$0.next = 16;
          break;
        }

        return context$1$0.abrupt('return', false);

      case 16:
        throw new Error('Cannot find ' + JSON.stringify(locator) + ' within ' + timeout + 'ms timeout');

      case 17:
        context$1$0.next = 19;
        return _regeneratorRuntime.awrap(driver.nativeClick(element));

      case 19:
        return context$1$0.abrupt('return', true);

      case 20:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[6, 12]]);
}

function installCertificateInPreferences(driver) {
  return _regeneratorRuntime.async(function installCertificateInPreferences$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.next = 2;
        return _regeneratorRuntime.awrap(clickElement(driver, {
          type: 'accessibility id',
          value: 'Allow'
        }));

      case 2:
        context$1$0.next = 4;
        return _regeneratorRuntime.awrap(_bluebird2['default'].delay(2000));

      case 4:
        context$1$0.next = 6;
        return _regeneratorRuntime.awrap(clickElement(driver, {
          type: 'accessibility id',
          value: 'Install'
        }));

      case 6:
        context$1$0.next = 8;
        return _regeneratorRuntime.awrap(_bluebird2['default'].delay(1500));

      case 8:
        context$1$0.next = 10;
        return _regeneratorRuntime.awrap(clickElement(driver, {
          type: 'accessibility id',
          value: 'Install'
        }));

      case 10:
        context$1$0.next = 12;
        return _regeneratorRuntime.awrap(clickElement(driver, {
          type: '-ios class chain',
          value: '**/XCUIElementTypeSheet/**/XCUIElementTypeButton[`label == \'Install\'`]'
        }));

      case 12:
        context$1$0.next = 14;
        return _regeneratorRuntime.awrap(clickElement(driver, {
          type: 'accessibility id',
          value: 'Done'
        }));

      case 14:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

function trustCertificateInPreferences(driver, name) {
  return _regeneratorRuntime.async(function trustCertificateInPreferences$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.next = 2;
        return _regeneratorRuntime.awrap(clickElement(driver, {
          type: 'accessibility id',
          value: 'Return to Settings'
        }));

      case 2:
        context$1$0.next = 4;
        return _regeneratorRuntime.awrap(clickElement(driver, {
          type: 'accessibility id',
          value: 'General'
        }));

      case 4:
        context$1$0.next = 6;
        return _regeneratorRuntime.awrap(clickElement(driver, {
          type: 'accessibility id',
          value: 'About'
        }));

      case 6:
        context$1$0.next = 8;
        return _regeneratorRuntime.awrap(_bluebird2['default'].delay(300));

      case 8:
        context$1$0.t0 = _regeneratorRuntime;
        context$1$0.t1 = driver;
        context$1$0.next = 12;
        return _regeneratorRuntime.awrap(this.findNativeElementOrElements('class name', 'XCUIElementTypeTable', false));

      case 12:
        context$1$0.t2 = context$1$0.sent;
        context$1$0.t3 = {
          element: context$1$0.t2,
          direction: 'up'
        };
        context$1$0.t4 = context$1$0.t1.mobileSwipe.call(context$1$0.t1, context$1$0.t3);
        context$1$0.next = 17;
        return context$1$0.t0.awrap.call(context$1$0.t0, context$1$0.t4);

      case 17:
        context$1$0.next = 19;
        return _regeneratorRuntime.awrap(clickElement(driver, {
          type: 'accessibility id',
          value: 'Certificate Trust Settings'
        }));

      case 19:
        context$1$0.next = 21;
        return _regeneratorRuntime.awrap(clickElement(driver, {
          type: '-ios class chain',
          value: '**/XCUIElementTypeCell[`label == \'' + name + '\'`]/**/XCUIElementTypeSwitch[`value == \'0\'`]',
          options: {
            timeout: 1000,
            skipIfInvisible: true
          }
        }));

      case 21:
        if (!context$1$0.sent) {
          context$1$0.next = 24;
          break;
        }

        context$1$0.next = 24;
        return _regeneratorRuntime.awrap(driver.postAcceptAlert());

      case 24:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

/**
 * @typedef {Object} CertificateInstallationOptions
 *
 * @property {!string} content - Base64-encoded content of the public certificate
 * @property {?string} commonName - Common name of the certificate. If this is not set
 *                                  then the script will try to parse it from the given
 *                                  certificate content.
 */

/**
 * Installs a custom certificate onto the device.
 * Since Apple provides no official way to do it via command line,
 * this method tries to wrap the certificate into .mobileconfig format
 * and then deploys the wrapped file to the internal HTTP server,
 * so one can open it with mobile Safari.
 * Then the algorithm goes through the profile installation procedure by
 * clicking the necessary buttons using WebDriverAgent.
 *
 * @param {CertificateInstallationOptions} opts
 * @returns {string} The content of the generated .mobileconfig file as
 * base64-encoded string. This config might be useful for debugging purposes.
 */
commands.mobileInstallCertificate = function callee$0$0() {
  var opts = arguments.length <= 0 || arguments[0] === undefined ? {} : arguments[0];

  var content, commonName, configName, configPath, certBuffer, cn, mobileConfig, _server$address, address, port, certUrl;

  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        content = opts.content;
        commonName = opts.commonName;

        if (!_lodash2['default'].isEmpty(content)) {
          context$1$0.next = 4;
          break;
        }

        throw new Error('Certificate content should not be empty');

      case 4:
        context$1$0.next = 6;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.exists(_appiumBaseDriver.STATIC_DIR));

      case 6:
        if (context$1$0.sent) {
          context$1$0.next = 8;
          break;
        }

        throw new Error('The static content root \'' + _appiumBaseDriver.STATIC_DIR + '\' ' + 'does not exist or is not accessible');

      case 8:
        configName = (Math.random() * 0x100000000 + 1).toString(36) + '.' + CONFIG_EXTENSION;
        configPath = _path2['default'].resolve(_appiumBaseDriver.STATIC_DIR, configName);
        certBuffer = Buffer.from(content, 'base64');
        context$1$0.t0 = commonName;

        if (context$1$0.t0) {
          context$1$0.next = 16;
          break;
        }

        context$1$0.next = 15;
        return _regeneratorRuntime.awrap(extractCommonName(certBuffer));

      case 15:
        context$1$0.t0 = context$1$0.sent;

      case 16:
        cn = context$1$0.t0;
        mobileConfig = toMobileConfig(certBuffer, cn);
        context$1$0.prev = 18;
        context$1$0.next = 21;
        return _regeneratorRuntime.awrap(_appiumSupport.plist.updatePlistFile(configPath, mobileConfig, false, false));

      case 21:
        context$1$0.next = 26;
        break;

      case 23:
        context$1$0.prev = 23;
        context$1$0.t1 = context$1$0['catch'](18);
        throw new Error('Cannot store the generated config as \'' + configPath + '\'. ' + ('Original error: ' + context$1$0.t1.message));

      case 26:
        context$1$0.prev = 26;
        _server$address = this.server.address();
        address = _server$address.address;
        port = _server$address.port;
        certUrl = 'http://' + (address ? address : _os2['default'].hostname()) + (':' + (port ? port : 4723) + '/' + configName);
        context$1$0.prev = 31;

        if (!this.isRealDevice()) {
          context$1$0.next = 48;
          break;
        }

        context$1$0.prev = 33;
        context$1$0.next = 36;
        return _regeneratorRuntime.awrap(this.proxyCommand('/url', 'POST', { url: certUrl }));

      case 36:
        context$1$0.next = 46;
        break;

      case 38:
        context$1$0.prev = 38;
        context$1$0.t2 = context$1$0['catch'](33);

        if (!this.isWebContext()) {
          context$1$0.next = 45;
          break;
        }

        context$1$0.next = 43;
        return _regeneratorRuntime.awrap(_appiumIosDriver.iosCommands.general.setUrl.call(this, certUrl));

      case 43:
        context$1$0.next = 46;
        break;

      case 45:
        throw context$1$0.t2;

      case 46:
        context$1$0.next = 50;
        break;

      case 48:
        context$1$0.next = 50;
        return _regeneratorRuntime.awrap((0, _nodeSimctl.openUrl)(this.opts.udid || this.sim.udid, certUrl));

      case 50:
        context$1$0.next = 52;
        return _regeneratorRuntime.awrap(installCertificateInPreferences(this));

      case 52:
        context$1$0.next = 54;
        return _regeneratorRuntime.awrap(trustCertificateInPreferences(this, commonName));

      case 54:
        context$1$0.prev = 54;
        context$1$0.prev = 55;
        context$1$0.next = 58;
        return _regeneratorRuntime.awrap(this.activateApp(this.opts.bundleId));

      case 58:
        context$1$0.next = 63;
        break;

      case 60:
        context$1$0.prev = 60;
        context$1$0.t3 = context$1$0['catch'](55);

        _logger2['default'].warn('Cannot restore the application \'' + this.opts.bundleId + '\'. ' + ('Original error: ' + context$1$0.t3.message));

      case 63:
        return context$1$0.finish(54);

      case 64:
        context$1$0.next = 66;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.readFile(configPath));

      case 66:
        return context$1$0.abrupt('return', context$1$0.sent.toString('base64'));

      case 67:
        context$1$0.prev = 67;
        context$1$0.next = 70;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.rimraf(configPath));

      case 70:
        return context$1$0.finish(67);

      case 71:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[18, 23], [26,, 67, 71], [31,, 54, 64], [33, 38], [55, 60]]);
};

_Object$assign(extensions, commands);
exports.commands = commands;
exports['default'] = extensions;

// Accept Safari alert

// Wait until Preferences are opened

// Go through Preferences wizard

// We need to click Install button on two different tabs
// The second one confirms the previous

// Accept sheet alert

// Finish adding certificate

// The command above does not always work on real devices
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9jb21tYW5kcy9jZXJ0aWZpY2F0ZS5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7c0JBQWMsUUFBUTs7Ozs2QkFDYSxnQkFBZ0I7OytCQUN2QixtQkFBbUI7O2dDQUNwQixvQkFBb0I7OzBCQUN2QixhQUFhOzt3QkFDUCxVQUFVOzt3QkFDMUIsVUFBVTs7OztzQkFDUixXQUFXOzs7O2tCQUNaLElBQUk7Ozs7b0JBQ0YsTUFBTTs7OztzQkFDTixTQUFTOzs7OzRCQUNMLGNBQWM7O0FBRW5DLElBQUksVUFBVSxHQUFHLEVBQUU7SUFBRSxRQUFRLEdBQUcsRUFBRSxDQUFDOztBQUVuQyxJQUFNLGdCQUFnQixHQUFHLGNBQWMsQ0FBQzs7QUFHeEMsU0FBZSxpQkFBaUIsQ0FBRSxVQUFVO01BQ3BDLFFBQVEsUUFNTCxNQUFNLEVBQ1AsT0FBTzs7Ozs7O3lDQVBRLHVCQUFRLElBQUksQ0FBQztBQUNsQyxnQkFBTSxFQUFFLE1BQU07QUFDZCxnQkFBTSxFQUFFLE1BQU07U0FDZixDQUFDOzs7QUFISSxnQkFBUTs7O3lDQUtOLGtCQUFHLFNBQVMsQ0FBQyxRQUFRLENBQUMsSUFBSSxFQUFFLFVBQVUsQ0FBQyxRQUFRLENBQUMsU0FBUyxDQUFDLEVBQUUsU0FBUyxDQUFDOzs7O3lDQUNyRCx3QkFBSyxTQUFTLEVBQUUsQ0FBQyxNQUFNLEVBQUUsUUFBUSxFQUFFLFVBQVUsRUFBRSxLQUFLLEVBQUUsUUFBUSxDQUFDLElBQUksQ0FBQyxDQUFDOzs7O0FBQXJGLGNBQU0sUUFBTixNQUFNO0FBQ1AsZUFBTyxHQUFHLGdCQUFnQixDQUFDLElBQUksQ0FBQyxNQUFNLENBQUM7O2FBQ3pDLE9BQU87Ozs7OzRDQUNGLE9BQU8sQ0FBQyxDQUFDLENBQUM7OztjQUViLElBQUksS0FBSyx5Q0FBc0MsTUFBTSxlQUFXOzs7OztjQUVoRSxJQUFJLEtBQUssQ0FBQyxnSEFDbUIsZUFBSSxPQUFPLENBQUUsQ0FBQzs7Ozs7eUNBRTNDLGtCQUFHLE1BQU0s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LE1BQU0sRUFBRSxNQUFNLEVBQUUsRUFBQyxHQUFHLEVBQUUsT0FBTyxFQUFDLENBQUM7Ozs7Ozs7Ozs7YUFFbkQsSUFBSSxDQUFDLFlBQVksRUFBRTs7Ozs7O3lDQUVmLDZCQUFZLE9BQU8sQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksRUFBRSxPQUFPLENBQUM7Ozs7Ozs7Ozs7Ozs7Ozt5Q0FNbEQseUJBQVEsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLElBQUksSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLEVBQUUsT0FBTyxDQUFDOzs7O3lDQUduRCwrQkFBK0IsQ0FBQyxJQUFJLENBQUM7Ozs7eUNBQ3JDLDZCQUE2QixDQUFDLElBQUksRUFBRSxVQUFVLENBQUM7Ozs7Ozt5Q0FHN0MsSUFBSSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQzs7Ozs7Ozs7OztBQUUxQyw0QkFBSSxJQUFJLENBQUMsc0NBQW1DLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxrQ0FDbEMsZUFBRSxPQUFPLENBQUUsQ0FBQyxDQUFDOzs7Ozs7O3lDQUkvQixrQkFBRyxRQUFRLENBQUMsVUFBVSxDQUFDOzs7NkRBQUUsUUFBUSxDQUFDLFFBQVE7Ozs7O3lDQUVsRCxrQkFBRyxNQUFNLENBQUMsVUFBVSxDQUFDOzs7Ozs7Ozs7O0NBRTlCLENBQUM7O0FBRUYsZUFBYyxVQUFVLEVBQUUsUUFBUSxDQUFDLENBQUM7UUFDM0IsUUFBUSxHQUFSLFFBQVE7cUJBQ0YsVUFBVSIsImZpbGUiOiJsaWIvY29tbWFuZHMvY2VydGlmaWNhdGUuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IHsgZnMsIHBsaXN0LCB0ZW1wRGlyIH0gZnJvbSAnYXBwaXVtLXN1cHBvcnQnO1xuaW1wb3J0IHsgaW9zQ29tbWFuZHMgfSBmcm9tICdhcHBpdW0taW9zLWRyaXZlcic7XG5pbXBvcnQgeyBTVEFUSUNfRElSIH0gZnJvbSAnYXBwaXVtLWJhc2UtZHJpdmVyJztcbmltcG9ydCB7IG9wZW5VcmwgfSBmcm9tICdub2RlLXNpbWN0bCc7XG5pbXBvcnQgeyByZXRyeUludGVydmFsIH0gZnJvbSAnYXN5bmNib3gnO1xuaW1wb3J0IEIgZnJvbSAnYmx1ZWJpcmQnO1xuaW1wb3J0IGxvZyBmcm9tICcuLi9sb2dnZXInO1xuaW1wb3J0IG9zIGZyb20gJ29zJztcbmltcG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IFVVSUQgZnJvbSAndXVpZC1qcyc7XG5pbXBvcnQgeyBleGVjIH0gZnJvbSAndGVlbl9wcm9jZXNzJztcblxubGV0IGV4dGVuc2lvbnMgPSB7fSwgY29tbWFuZHMgPSB7fTtcblxuY29uc3QgQ09ORklHX0VYVEVOU0lPTiA9ICdtb2JpbGVjb25maWcnO1xuXG5cbmFzeW5jIGZ1bmN0aW9uIGV4dHJhY3RDb21tb25OYW1lIChjZXJ0QnVmZmVyKSB7XG4gIGNvbnN0IHRlbXBDZXJ0ID0gYXdhaXQgdGVtcERpci5vcGVuKHtcbiAgICBwcmVmaXg6ICdjZXJ0JyxcbiAgICBzdWZmaXg6ICcuY2VyJ1xuICB9KTtcbiAgdHJ5IHtcbiAgICBhd2FpdCBmcy53cml0ZUZpbGUodGVtcENlcnQucGF0aCwgY2VydEJ1ZmZlci50b1N0cmluZygnbGF0aW4tMScpLCAnbGF0aW4tMScpO1xuICAgIGNvbnN0IHtzdGRvdXR9ID0gYXdhaXQgZXhlYygnb3BlbnNzbCcsIFsneDUwOScsICctbm9vdXQnLCAnLXN1YmplY3QnLCAnLWluJywgdGVtcENlcnQucGF0aF0pO1xuICAgIGNvbnN0IGNuTWF0Y2ggPSAvXFwvQ049KFteXFxzLF0rKS8uZXhlYyhzdGRvdXQpO1xuICAgIGlmIChjbk1hdGNoKSB7XG4gICAgICByZXR1cm4gY25NYXRjaFsxXTtcbiAgICB9XG4gICAgdGhyb3cgbmV3IEVycm9yKGBUaGVyZSBpcyBubyBjb21tb24gbmFtZSB2YWx1ZSBpbiAnJHtzdGRvdXR9JyBvdXRwdXRgKTtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKGBDYW5ub3QgcGFyc2UgY29tbW9uIG5hbWUgdmFsdWUgZnJvbSB0aGUgY2VydGlmaWNhdGUuIElzIGl0IHZhbGlkIGFuZCBiYXNlNjQtZW5jb2RlZD8gYCArXG4gICAgICAgICAgICAgICAgICAgIGBPcmlnaW5hbCBlcnJvcjogJHtlcnIubWVzc2FnZX1gKTtcbiAgfSBmaW5hbGx5IHtcbiAgICBhd2FpdCBmcy5yaW1yYWYodGVtcENlcnQucGF0aCk7XG4gIH1cbn1cblxuLyoqXG4gKiBHZW5lcmF0ZXMgQXBwbGUncyBvdmVyLXRoZS1haXIgY29uZmlndXJhdGlvbiBwcm9maWxlXG4gKiBmb3IgY2VydGlmaWNhdGUgZGVwbG95bWVudCBiYXNlZCBvbiB0aGUgZ2l2ZW4gUEVNIGNlcnRpZmljYXRlIGNvbnRlbnQuXG4gKiBSZWFkIGh0dHBzOi8vZGV2ZWxvcGVyLmFwcGxlLmNvbS9saWJyYXJ5L2NvbnRlbnQvZG9jdW1lbnRhdGlvbi9OZXR3b3JraW5nSW50ZXJuZXQvQ29uY2VwdHVhbC9pUGhvbmVPVEFDb25maWd1cmF0aW9uL0ludHJvZHVjdGlvbi9JbnRyb2R1Y3Rpb24uaHRtbFxuICogZm9yIG1vcmUgZGV0YWlscyBvbiBzdWNoIHByb2ZpbGVzLlxuICpcbiAqIEBwYXJhbSB7QnVmZmVyfSBjZXJ0QnVmZmVyIC0gVGhlIGFjdHVhbCBjb250ZW50IG9mIFBFTSBjZXJ0aWZpY2F0ZSBlbmNvZGVkIGludG8gTm9kZUpTIGJ1ZmZlclxuICogQHBhcmFtIHtzdHJpbmd9IGNvbW1vbk5hbWUgLSBDZXJ0aWZpY2F0ZSdzIGNvbW1vbiBuYW1lXG4gKiBAcmV0dXJucyB7T2JqZWN0fSBUaGUgZW5jb2RlZCBzdHJ1Y3R1cmUgb2YgdGhlIGdpdmVuIGNlcnRpZmljYXRlLCB3aGljaCBpcyByZWFkeSB0byBiZSBwYXNzZWRcbiAqIGFzIGFuIGFyZ3VtZW50IHRvIHBsaXN0IGJ1aWxkZXJcbiAqIEB0aHJvd3Mge0Vycm9yfSBJZiB0aGUgZ2l2ZW4gY2VydGlmaWNhdGUgY2Fubm90IGJlIHBhcnNlZFxuICovXG5mdW5jdGlvbiB0b01vYmlsZUNvbmZpZyAoY2VydEJ1ZmZlciwgY29tbW9uTmFtZSkge1xuICBjb25zdCBnZXRVVUlEID0gKCkgPT4gVVVJRC5jcmVhdGUoKS5oZXgudG9VcHBlckNhc2UoKTtcbiAgY29uc3QgY29udGVudFV1aWQgPSBnZXRVVUlEKCk7XG4gIHJldHVybiB7XG4gICAgUGF5bG9hZENvbnRlbnQ6IFt7XG4gICAgICBQYXlsb2FkQ2VydGlmaWNhdGVGaWxlTmFtZTogYCR7Y29tbW9uTmFtZX0uY2VyYCxcbiAgICAgIFBheWxvYWRDb250ZW50OiBjZXJ0QnVmZmVyLFxuICAgICAgUGF5bG9hZERlc2NyaXB0aW9uOiAnQWRkcyBhIENBIHJvb3QgY2VydGlmaWNhdGUnLFxuICAgICAgUGF5bG9hZERpc3BsYXlOYW1lOiBjb21tb25OYW1lLFxuICAgICAgUGF5bG9hZElkZW50aWZpZXI6IGBjb20uYXBwbGUuc2VjdXJpdHkucm9vdC4ke2NvbnRlbnRVdWlkfWAsXG4gICAgICBQYXlsb2FkVHlwZTogJ2NvbS5hcHBsZS5zZWN1cml0eS5yb290JyxcbiAgICAgIFBheWxvYWRVVUlEOiBjb250ZW50VXVpZCxcbiAgICAgIFBheWxvYWRWZXJzaW9uOiAxXG4gICAgfV0sXG4gICAgUGF5bG9hZERpc3BsYXlOYW1lOiBjb21tb25OYW1lLFxuICAgIFBheWxvYWRJZGVudGlmaWVyOiBgJHtvcy5ob3N0bmFtZSgpLnNwbGl0KCcuJylbMF19LiR7Z2V0VVVJRCgpfWAsXG4gICAgUGF5bG9hZFJlbW92YWxEaXNhbGxvd2VkOiBmYWxzZSxcbiAgICBQYXlsb2FkVHlwZTogJ0NvbmZpZ3VyYXRpb24nLFxuICAgIFBheWxvYWRVVUlEOiBnZXRVVUlEKCksXG4gICAgUGF5bG9hZFZlcnNpb246IDFcbiAgfTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gY2xpY2tFbGVtZW50IChkcml2ZXIsIGxvY2F0b3IsIG9wdGlvbnMgPSB7fSkge1xuICBsZXQgZWxlbWVudCA9IG51bGw7XG4gIGNvbnN0IHtcbiAgICB0aW1lb3V0ID0gNTAwMCxcbiAgICBza2lwSWZJbnZpc2libGUgPSBmYWxzZVxuICB9ID0gb3B0aW9ucztcbiAgY29uc3QgbG9va3VwRGVsYXkgPSA1MDA7XG4gIHRyeSB7XG4gICAgZWxlbWVudCA9IGF3YWl0IHJldHJ5SW50ZXJ2YWwodGltZW91dCAvIGxvb2t1cERlbGF5LCBsb29rdXBEZWxheSxcbiAgICAgICBhc3luYyAoKSA9PiBhd2FpdCBkcml2ZXIuZmluZE5hdGl2ZUVsZW1lbnRPckVsZW1lbnRzKGxvY2F0b3IudHlwZSwgbG9jYXRvci52YWx1ZSwgZmFsc2UpXG4gICAgKTtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgaWYgKHNraXBJZkludmlzaWJsZSkge1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgICB0aHJvdyBuZXcgRXJyb3IoYENhbm5vdCBmaW5kICR7SlNPTi5zdHJpbmdpZnkobG9jYXRvcil9IHdpdGhpbiAke3RpbWVvdXR9bXMgdGltZW91dGApO1xuICB9XG4gIGF3YWl0IGRyaXZlci5uYXRpdmVDbGljayhlbGVtZW50KTtcbiAgcmV0dXJuIHRydWU7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGluc3RhbGxDZXJ0aWZpY2F0ZUluUHJlZmVyZW5jZXMgKGRyaXZlcikge1xuICAvLyBBY2NlcHQgU2FmYXJpIGFsZXJ0XG4gIGF3YWl0IGNsaWNrRWxlbWVudChkcml2ZXIsIHtcbiAgICB0eXBlOiAnYWNjZXNzaWJpbGl0eSBpZCcsXG4gICAgdmFsdWU6ICdBbGxvdydcbiAgfSk7XG4gIC8vIFdhaXQgdW50aWwgUHJlZmVyZW5jZXMgYXJlIG9wZW5lZFxuICBhd2FpdCBCLmRlbGF5KDIwMDApO1xuXG4gIC8vIEdvIHRocm91Z2ggUHJlZmVyZW5jZXMgd2l6YXJkXG4gIGF3YWl0IGNsaWNrRWxlbWVudChkcml2ZXIsIHtcbiAgICB0eXBlOiAnYWNjZXNzaWJpbGl0eSBpZCcsXG4gICAgdmFsdWU6ICdJbnN0YWxsJ1xuICB9KTtcbiAgLy8gV2UgbmVlZCB0byBjbGljayBJbnN0YWxsIGJ1dHRvbiBvbiB0d28gZGlmZmVyZW50IHRhYnNcbiAgLy8gVGhlIHNlY29uZCBvbmUgY29uZmlybXMgdGhlIHByZXZpb3VzXG4gIGF3YWl0IEIuZGVsYXkoMTUwMCk7XG4gIGF3YWl0IGNsaWNrRWxlbWVudChkcml2ZXIsIHtcbiAgICB0eXBlOiAnYWNjZXNzaWJpbGl0eSBpZCcsXG4gICAgdmFsdWU6ICdJbnN0YWxsJ1xuICB9KTtcbiAgLy8gQWNjZXB0IHNoZWV0IGFsZXJ0XG4gIGF3YWl0IGNsaWNrRWxlbWVudChkcml2ZXIsIHtcbiAgICB0eXBlOiAnLWlvcyBjbGFzcyBjaGFpbicsXG4gICAgdmFsdWU6ICcqKi9YQ1VJRWxlbWVudFR5cGVTaGVldC8qKi9YQ1VJRWxlbWVudFR5cGVCdXR0b25bYGxhYmVsID09IFxcJ0luc3RhbGxcXCdgXSdcbiAgfSk7XG4gIC8vIEZpbmlzaCBhZGRpbmcgY2VydGlmaWNhdGVcbiAgYXdhaXQgY2xpY2tFbGVtZW50KGRyaXZlciwge1xuICAgIHR5cGU6ICdhY2Nlc3NpYmlsaXR5IGlkJyxcbiAgICB2YWx1ZTogJ0RvbmUnXG4gIH0pO1xufVxuXG5hc3luYyBmdW5jdGlvbiB0cnVzdENlcnRpZmljYXRlSW5QcmVmZXJlbmNlcyAoZHJpdmVyLCBuYW1lKSB7XG4gIGF3YWl0IGNsaWNrRWxlbWVudChkcml2ZXIsIHtcbiAgICB0eXBlOiAnYWNjZXNzaWJpbGl0eSBpZCcsXG4gICAgdmFsdWU6ICdSZXR1cm4gdG8gU2V0dGluZ3MnXG4gIH0pO1xuICBhd2FpdCBjbGlja0VsZW1lbnQoZHJpdmVyLCB7XG4gICAgdHlwZTogJ2FjY2Vzc2liaWxpdHkgaWQnLFxuICAgIHZhbHVlOiAnR2VuZXJhbCdcbiAgfSk7XG4gIGF3YWl0IGNsaWNrRWxlbWVudChkcml2ZXIsIHtcbiAgICB0eXBlOiAnYWNjZXNzaWJpbGl0eSBpZCcsXG4gICAgdmFsdWU6ICdBYm91dCdcbiAgfSk7XG4gIGF3YWl0IEIuZGVsYXkoMzAwKTtcbiAgYXdhaXQgZHJpdmVyLm1vYmlsZVN3aXBlKHtcbiAgICBlbGVtZW50OiBhd2FpdCB0aGlzLmZpbmROYXRpdmVFbGVtZW50T3JFbGVtZW50cygnY2xhc3MgbmFtZScsICdYQ1VJRWxlbWVudFR5cGVUYWJsZScsIGZhbHNlKSxcbiAgICBkaXJlY3Rpb246ICd1cCdcbiAgfSk7XG4gIGF3YWl0IGNsaWNrRWxlbWVudChkcml2ZXIsIHtcbiAgICB0eXBlOiAnYWNjZXNzaWJpbGl0eSBpZCcsXG4gICAgdmFsdWU6ICdDZXJ0aWZpY2F0ZSBUcnVzdCBTZXR0aW5ncydcbiAgfSk7XG4gIGlmIChhd2FpdCBjbGlja0VsZW1lbnQoZHJpdmVyLCB7XG4gICAgdHlwZTogJy1pb3MgY2xhc3MgY2hhaW4nLFxuICAgIHZhbHVlOiBgKiovWENVSUVsZW1lbnRUeXBlQ2VsbFtcXGBsYWJlbCA9PSAnJHtuYW1lfSdcXGBdLyoqL1hDVUlFbGVtZW50VHlwZVN3aXRjaFtcXGB2YWx1ZSA9PSAnMCdcXGBdYCxcbiAgICBvcHRpb25zOiB7XG4gICAgICB0aW1lb3V0OiAxMDAwLFxuICAgICAgc2tpcElmSW52aXNpYmxlOiB0cnVlXG4gICAgfVxuICB9KSkge1xuICAgIGF3YWl0IGRyaXZlci5wb3N0QWNjZXB0QWxlcnQoKTtcbiAgfVxufVxuXG4vKipcbiAqIEB0eXBlZGVmIHtPYmplY3R9IENlcnRpZmljYXRlSW5zdGFsbGF0aW9uT3B0aW9uc1xuICpcbiAqIEBwcm9wZXJ0eSB7IXN0cmluZ30gY29udGVudCAtIEJhc2U2NC1lbmNvZGVkIGNvbnRlbnQgb2YgdGhlIHB1YmxpYyBjZXJ0aWZpY2F0ZVxuICogQHByb3BlcnR5IHs/c3RyaW5nfSBjb21tb25OYW1lIC0gQ29tbW9uIG5hbWUgb2YgdGhlIGNlcnRpZmljYXRlLiBJZiB0aGlzIGlzIG5vdCBzZXRcbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoZW4gdGhlIHNjcmlwdCB3aWxsIHRyeSB0byBwYXJzZSBpdCBmcm9tIHRoZSBnaXZlblxuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2VydGlmaWNhdGUgY29udGVudC5cbiAqL1xuXG4vKipcbiAqIEluc3RhbGxzIGEgY3VzdG9tIGNlcnRpZmljYXRlIG9udG8gdGhlIGRldmljZS5cbiAqIFNpbmNlIEFwcGxlIHByb3ZpZGVzIG5vIG9mZmljaWFsIHdheSB0byBkbyBpdCB2aWEgY29tbWFuZCBsaW5lLFxuICogdGhpcyBtZXRob2QgdHJpZXMgdG8gd3JhcCB0aGUgY2VydGlmaWNhdGUgaW50byAubW9iaWxlY29uZmlnIGZvcm1hdFxuICogYW5kIHRoZW4gZGVwbG95cyB0aGUgd3JhcHBlZCBmaWxlIHRvIHRoZSBpbnRlcm5hbCBIVFRQIHNlcnZlcixcbiAqIHNvIG9uZSBjYW4gb3BlbiBpdCB3aXRoIG1vYmlsZSBTYWZhcmkuXG4gKiBUaGVuIHRoZSBhbGdvcml0aG0gZ29lcyB0aHJvdWdoIHRoZSBwcm9maWxlIGluc3RhbGxhdGlvbiBwcm9jZWR1cmUgYnlcbiAqIGNsaWNraW5nIHRoZSBuZWNlc3NhcnkgYnV0dG9ucyB1c2luZyBXZWJEcml2ZXJBZ2VudC5cbiAqXG4gKiBAcGFyYW0ge0NlcnRpZmljYXRlSW5zdGFsbGF0aW9uT3B0aW9uc30gb3B0c1xuICogQHJldHVybnMge3N0cmluZ30gVGhlIGNvbnRlbnQgb2YgdGhlIGdlbmVyYXRlZCAubW9iaWxlY29uZmlnIGZpbGUgYXNcbiAqIGJhc2U2NC1lbmNvZGVkIHN0cmluZy4gVGhpcyBjb25maWcgbWlnaHQgYmUgdXNlZnVsIGZvciBkZWJ1Z2dpbmcgcHVycG9zZXMuXG4gKi9cbmNvbW1hbmRzLm1vYmlsZUluc3RhbGxDZXJ0aWZpY2F0ZSA9IGFzeW5jIGZ1bmN0aW9uIChvcHRzID0ge30pIHtcbiAgY29uc3Qge2NvbnRlbnQsIGNvbW1vbk5hbWV9ID0gb3B0cztcbiAgaWYgKF8uaXNFbXB0eShjb250ZW50KSkge1xuICAgIHRocm93IG5ldyBFcnJvcignQ2VydGlmaWNhdGUgY29udGVudCBzaG91bGQgbm90IGJlIGVtcHR5Jyk7XG4gIH1cblxuICBpZiAoIWF3YWl0IGZzLmV4aXN0cyhTVEFUSUNfRElSKSkge1xuICAgIHRocm93IG5ldyBFcnJvcihgVGhlIHN0YXRpYyBjb250ZW50IHJvb3QgJyR7U1RBVElDX0RJUn0nIGAgK1xuICAgICAgICAgICAgICAgICAgICBgZG9lcyBub3QgZXhpc3Qgb3IgaXMgbm90IGFjY2Vzc2libGVgKTtcbiAgfVxuICBjb25zdCBjb25maWdOYW1lID0gYCR7KE1hdGgucmFuZG9tKCkgKiAweDEwMDAwMDAwMCArIDEpLnRvU3RyaW5nKDM2KX0uJHtDT05GSUdfRVhURU5TSU9OfWA7XG4gIGNvbnN0IGNvbmZpZ1BhdGggPSBwYXRoLnJlc29sdmUoU1RBVElDX0RJUiwgY29uZmlnTmFtZSk7XG4gIGNvbnN0IGNlcnRCdWZmZXIgPSBCdWZmZXIuZnJvbShjb250ZW50LCAnYmFzZTY0Jyk7XG4gIGNvbnN0IGNuID0gY29tbW9uTmFtZSB8fCBhd2FpdCBleHRyYWN0Q29tbW9uTmFtZShjZXJ0QnVmZmVyKTtcbiAgY29uc3QgbW9iaWxlQ29uZmlnID0gdG9Nb2JpbGVDb25maWcoY2VydEJ1ZmZlciwgY24pO1xuICB0cnkge1xuICAgIGF3YWl0IHBsaXN0LnVwZGF0ZVBsaXN0RmlsZShjb25maWdQYXRoLCBtb2JpbGVDb25maWcsIGZhbHNlLCBmYWxzZSk7XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIHRocm93IG5ldyBFcnJvcihgQ2Fubm90IHN0b3JlIHRoZSBnZW5lcmF0ZWQgY29uZmlnIGFzICcke2NvbmZpZ1BhdGh9Jy4gYCArXG4gICAgICAgICAgICAgICAgICAgIGBPcmlnaW5hbCBlcnJvcjogJHtlcnIubWVzc2FnZX1gKTtcbiAgfVxuICB0cnkge1xuICAgIGNvbnN0IHthZGRyZXNzLCBwb3J0fSA9IHRoaXMuc2VydmVyLmFkZHJlc3MoKTtcbiAgICBjb25zdCBjZXJ0VXJsID0gYGh0dHA6Ly8ke2FkZHJlc3MgPyBhZGRyZXNzIDogb3MuaG9zdG5hbWUoKX1gICtcbiAgICAgICAgICAgICAgICAgICAgYDoke3BvcnQgPyBwb3J0IDogNDcyM30vJHtjb25maWdOYW1lfWA7XG4gICAgdHJ5IHtcbiAgICAgIGlmICh0aGlzLmlzUmVhbERldmljZSgpKSB7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgYXdhaXQgdGhpcy5wcm94eUNvbW1hbmQoJy91cmwnLCAnUE9TVCcsIHt1cmw6IGNlcnRVcmx9KTtcbiAgICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgICAgaWYgKHRoaXMuaXNXZWJDb250ZXh0KCkpIHtcbiAgICAgICAgICAgIC8vIFRoZSBjb21tYW5kIGFib3ZlIGRvZXMgbm90IGFsd2F5cyB3b3JrIG9uIHJlYWwgZGV2aWNlc1xuICAgICAgICAgICAgYXdhaXQgaW9zQ29tbWFuZHMuZ2VuZXJhbC5zZXRVcmwuY2FsbCh0aGlzLCBjZXJ0VXJsKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhyb3cgZXJyO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgYXdhaXQgb3BlblVybCh0aGlzLm9wdHMudWRpZCB8fCB0aGlzLnNpbS51ZGlkLCBjZXJ0VXJsKTtcbiAgICAgIH1cblxuICAgICAgYXdhaXQgaW5zdGFsbENlcnRpZmljYXRlSW5QcmVmZXJlbmNlcyh0aGlzKTtcbiAgICAgIGF3YWl0IHRydXN0Q2VydGlmaWNhdGVJblByZWZlcmVuY2VzKHRoaXMsIGNvbW1vbk5hbWUpO1xuICAgIH0gZmluYWxseSB7XG4gICAgICB0cnkge1xuICAgICAgICBhd2FpdCB0aGlzLmFjdGl2YXRlQXBwKHRoaXMub3B0cy5idW5kbGVJZCk7XG4gICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgIGxvZy53YXJuKGBDYW5ub3QgcmVzdG9yZSB0aGUgYXBwbGljYXRpb24gJyR7dGhpcy5vcHRzLmJ1bmRsZUlkfScuIGAgK1xuICAgICAgICAgICAgICAgICBgT3JpZ2luYWwgZXJyb3I6ICR7ZS5tZXNzYWdlfWApO1xuICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiAoYXdhaXQgZnMucmVhZEZpbGUoY29uZmlnUGF0aCkpLnRvU3RyaW5nKCdiYXNlNjQnKTtcbiAgfSBmaW5hbGx5IHtcbiAgICBhd2FpdCBmcy5yaW1yYWYoY29uZmlnUGF0aCk7XG4gIH1cbn07XG5cbk9iamVjdC5hc3NpZ24oZXh0ZW5zaW9ucywgY29tbWFuZHMpO1xuZXhwb3J0IHsgY29tbWFuZHMgfTtcbmV4cG9ydCBkZWZhdWx0IGV4dGVuc2lvbnM7XG4iXSwic291cmNlUm9vdCI6Ii4uLy4uLy4uIn0=

require('source-map-support').install();

'use strict';

var _get = require('babel-runtime/helpers/get')['default'];

var _inherits = require('babel-runtime/helpers/inherits')['default'];

var _createClass = require('babel-runtime/helpers/create-class')['default'];

var _classCallCheck = require('babel-runtime/helpers/class-call-check')['default'];

var _slicedToArray = require('babel-runtime/helpers/sliced-to-array')['default'];

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _getIterator = require('babel-runtime/core-js/get-iterator')['default'];

var _Symbol$iterator = require('babel-runtime/core-js/symbol/iterator')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _events = require('events');

var _events2 = _interopRequireDefault(_events);

var _appiumBaseDriver = require('appium-base-driver');

var _child_process = require('child_process');

var _child_process2 = _interopRequireDefault(_child_process);

var _appiumSupport = require('appium-support');

var _asyncbox = require('asyncbox');

var _teen_process = require('teen_process');

var _bluebird = require('bluebird');

var _bluebird2 = _interopRequireDefault(_bluebird);

var _install = require('./install');

var _utils = require('./utils');

var _semver = require('semver');

var _semver2 = _interopRequireDefault(_semver);

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var log = _appiumSupport.logger.getLogger('Chromedriver');

var DEFAULT_HOST = '127.0.0.1';
var DEFAULT_PORT = 9515;
var CHROMEDRIVER_CHROME_MAPPING = {
  '2.38': '65.0.3325',
  '2.37': '64.0.3282',
  '2.36': '63.0.3239',
  '2.35': '62.0.3202',
  '2.34': '61.0.3163',
  '2.33': '60.0.3112',
  '2.32': '59.0.3071',
  '2.31': '58.0.3029',
  '2.30': '58.0.3029',
  '2.29': '57.0.2987',
  '2.28': '55.0.2883',
  '2.27': '54.0.2840',
  '2.26': '53.0.2785',
  '2.25': '53.0.2785',
  '2.24': '52.0.2743',
  '2.23': '51.0.2704',
  '2.22': '49.0.2623',
  '2.21': '46.0.2490',
  '2.20': '43.0.2357',
  '2.19': '43.0.2357',
  '2.18': '43.0.2357',
  '2.17': '42.0.2311',
  '2.16': '42.0.2311',
  '2.15': '40.0.2214',
  '2.14': '39.0.2171',
  '2.13': '38.0.2125',
  '2.12': '36.0.1985',
  '2.11': '36.0.1985',
  '2.10': '33.0.1751',
  '2.9': '31.0.1650',
  '2.8': '30.0.1573',
  '2.7': '30.0.1573',
  '2.6': '29.0.1545',
  '2.5': '29.0.1545',
  '2.4': '29.0.1545',
  '2.3': '28.0.1500',
  '2.2': '27.0.1453',
  '2.1': '27.0.1453',
  '2.0': '27.0.1453'
};
var CHROME_BUNDLE_ID = 'com.android.chrome';
var WEBVIEW_BUNDLE_IDS = ['com.google.android.webview', 'com.android.webview'];

var Chromedriver = (function (_events$EventEmitter) {
  _inherits(Chromedriver, _events$EventEmitter);

  function Chromedriver() {
    var args = arguments.length <= 0 || arguments[0] === undefined ? {} : arguments[0];

    _classCallCheck(this, Chromedriver);

    _get(Object.getPrototypeOf(Chromedriver.prototype), 'constructor', this).call(this);

    var _args$host = args.host;
    var host = _args$host === undefined ? DEFAULT_HOST : _args$host;
    var _args$port = args.port;
    var port = _args$port === undefined ? DEFAULT_PORT : _args$port;
    var executable = args.executable;
    var _args$executableDir = args.executableDir;
    var executableDir = _args$executableDir === undefined ? (0, _install.getChromedriverDir)() : _args$executableDir;
    var bundleId = args.bundleId;
    var mappingPath = args.mappingPath;
    var cmdArgs = args.cmdArgs;
    var adb = args.adb;
    var verbose = args.verbose;
    var logPath = args.logPath;

    this.proxyHost = host;
    this.proxyPort = port;
    this.adb = adb;
    this.cmdArgs = cmdArgs;
    this.proc = null;
    this.chromedriver = executable;
    this.executableDir = executableDir;
    this.mappingPath = mappingPath;
    this.bundleId = bundleId;
    this.executableVerified = false;
    this.state = Chromedriver.STATE_STOPPED;
    this.jwproxy = new _appiumBaseDriver.JWProxy({ server: this.proxyHost, port: this.proxyPort });
    this.verbose = verbose;
    this.logPath = logPath;
  }

  _createClass(Chromedriver, [{
    key: 'getMapping',
    value: function getMapping() {
      var mapping, _iteratorNormalCompletion, _didIteratorError, _iteratorError, _iterator, _step, _step$value, cdVersion, chromeVersion;

      return _regeneratorRuntime.async(function getMapping$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            mapping = CHROMEDRIVER_CHROME_MAPPING;

            if (!this.mappingPath) {
              context$2$0.next = 21;
              break;
            }

            log.debug('Attempting to use Chromedriver-Chrome mapping from \'' + this.mappingPath + '\'');
            context$2$0.next = 5;
            return _regeneratorRuntime.awrap(_appiumSupport.fs.exists(this.mappingPath));

          case 5:
            if (context$2$0.sent) {
              context$2$0.next = 9;
              break;
            }

            log.warn('No file found at \'' + this.mappingPath + '\'. Using default mapping');
            context$2$0.next = 21;
            break;

          case 9:
            context$2$0.prev = 9;
            context$2$0.t0 = JSON;
            context$2$0.next = 13;
            return _regeneratorRuntime.awrap(_appiumSupport.fs.readFile(this.mappingPath));

          case 13:
            context$2$0.t1 = context$2$0.sent;
            mapping = context$2$0.t0.parse.call(context$2$0.t0, context$2$0.t1);
            context$2$0.next = 21;
            break;

          case 17:
            context$2$0.prev = 17;
            context$2$0.t2 = context$2$0['catch'](9);

            log.error('Error parsing mapping from \'' + this.mappingPath + '\': ' + context$2$0.t2.message);
            log.warn('Using default mapping');

          case 21:
            _iteratorNormalCompletion = true;
            _didIteratorError = false;
            _iteratorError = undefined;
            context$2$0.prev = 24;

            // make sure that the values for minimum chrome version are semver compliant
            for (_iterator = _getIterator(_lodash2['default'].toPairs(mapping)); !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {
              _step$value = _slicedToArray(_step.value, 2);
              cdVersion = _step$value[0];
              chromeVersion = _step$value[1];

              mapping[cdVersion] = _semver2['default'].coerce(chromeVersion);
            }
            context$2$0.next = 32;
            break;

          case 28:
            context$2$0.prev = 28;
            context$2$0.t3 = context$2$0['catch'](24);
            _didIteratorError = true;
            _iteratorError = context$2$0.t3;

          case 32:
            context$2$0.prev = 32;
            context$2$0.prev = 33;

            if (!_iteratorNormalCompletion && _iterator['return']) {
              _iterator['return']();
            }

          case 35:
            context$2$0.prev = 35;

            if (!_didIteratorError) {
              context$2$0.next = 38;
              break;
            }

            throw _iteratorError;

          case 38:
            return context$2$0.finish(35);

          case 39:
            return context$2$0.finish(32);

          case 40:
            return context$2$0.abrupt('return', mapping);

          case 41:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this, [[9, 17], [24, 28, 32, 40], [33,, 35, 39]]);
    }
  }, {
    key: 'getChromedrivers',
    value: function getChromedrivers(mapping) {
      var executables, cds, _iteratorNormalCompletion2, _didIteratorError2, _iteratorError2, _iterator2, _step2, cd;

      return _regeneratorRuntime.async(function getChromedrivers$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.next = 2;
            return _regeneratorRuntime.awrap(_appiumSupport.fs.glob(this.executableDir + '/*'));

          case 2:
            executables = context$2$0.sent;
            context$2$0.next = 5;
            return _regeneratorRuntime.awrap((0, _asyncbox.asyncmap)(executables, function callee$2$0(executable) {
              var _ref, stdout, match, version;

              return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
                while (1) switch (context$3$0.prev = context$3$0.next) {
                  case 0:
                    context$3$0.prev = 0;
                    context$3$0.next = 3;
                    return _regeneratorRuntime.awrap((0, _teen_process.exec)(executable, ['--version']));

                  case 3:
                    _ref = context$3$0.sent;
                    stdout = _ref.stdout;
                    match = /ChromeDriver\s(\d+\.\d+)\.\d+\s/.exec(stdout);

                    if (!match) {
                      context$3$0.next = 9;
                      break;
                    }

                    version = match[1];
                    return context$3$0.abrupt('return', {
                      executable: executable,
                      version: version,
                      minCDVersion: mapping[version]
                    });

                  case 9:
                    context$3$0.next = 13;
                    break;

                  case 11:
                    context$3$0.prev = 11;
                    context$3$0.t0 = context$3$0['catch'](0);

                  case 13:
                  case 'end':
                    return context$3$0.stop();
                }
              }, null, this, [[0, 11]]);
            }));

          case 5:
            context$2$0.t0 = function (cd) {
              return !!cd;
            };

            context$2$0.t1 = function (a, b) {
              return _semver2['default'].gte(_semver2['default'].coerce(b.version), _semver2['default'].coerce(a.version)) ? 1 : -1;
            };

            cds = context$2$0.sent.filter(context$2$0.t0).sort(context$2$0.t1);

            if (_lodash2['default'].isEmpty(cds)) {
              log.errorAndThrow('No Chromedriver found');
            }
            log.debug('The following Chromedriver executables were found:');
            _iteratorNormalCompletion2 = true;
            _didIteratorError2 = false;
            _iteratorError2 = undefined;
            context$2$0.prev = 13;
            for (_iterator2 = _getIterator(cds); !(_iteratorNormalCompletion2 = (_step2 = _iterator2.next()).done); _iteratorNormalCompletion2 = true) {
              cd = _step2.value;

              log.debug('    ' + cd.executable + ' (minimum Chrome version \'' + (cd.minCDVersion ? cd.minCDVersion : 'Unknown') + '\')');
            }
            context$2$0.next = 21;
            break;

          case 17:
            context$2$0.prev = 17;
            context$2$0.t2 = context$2$0['catch'](13);
            _didIteratorError2 = true;
            _iteratorError2 = context$2$0.t2;

          case 21:
            context$2$0.prev = 21;
            context$2$0.prev = 22;

            if (!_iteratorNormalCompletion2 && _iterator2['return']) {
              _iterator2['return']();
            }

          case 24:
            context$2$0.prev = 24;

            if (!_didIteratorError2) {
              context$2$0.next = 27;
              break;
            }

            throw _iteratorError2;

          case 27:
            return context$2$0.finish(24);

          case 28:
            return context$2$0.finish(21);

          case 29:
            return context$2$0.abrupt('return', cds);

          case 30:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this, [[13, 17, 21, 29], [22,, 24, 28]]);
    }
  }, {
    key: 'getChromeVersion',
    value: function getChromeVersion() {
      var chromeVersion, _iteratorNormalCompletion3, _didIteratorError3, _iteratorError3, _iterator3, _step3, bundleId;

      return _regeneratorRuntime.async(function getChromeVersion$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            chromeVersion = undefined;

            if (this.bundleId) {
              context$2$0.next = 33;
              break;
            }

            // default to the generic Chrome bundle
            this.bundleId = CHROME_BUNDLE_ID;

            // we have a webview of some sort, so try to find the bundle version
            _iteratorNormalCompletion3 = true;
            _didIteratorError3 = false;
            _iteratorError3 = undefined;
            context$2$0.prev = 6;
            _iterator3 = _getIterator(WEBVIEW_BUNDLE_IDS);

          case 8:
            if (_iteratorNormalCompletion3 = (_step3 = _iterator3.next()).done) {
              context$2$0.next = 19;
              break;
            }

            bundleId = _step3.value;
            context$2$0.next = 12;
            return _regeneratorRuntime.awrap((0, _utils.getChromeVersion)(this.adb, bundleId));

          case 12:
            chromeVersion = context$2$0.sent;

            if (!chromeVersion) {
              context$2$0.next = 16;
              break;
            }

            this.bundleId = bundleId;
            return context$2$0.abrupt('break', 19);

          case 16:
            _iteratorNormalCompletion3 = true;
            context$2$0.next = 8;
            break;

          case 19:
            context$2$0.next = 25;
            break;

          case 21:
            context$2$0.prev = 21;
            context$2$0.t0 = context$2$0['catch'](6);
            _didIteratorError3 = true;
            _iteratorError3 = context$2$0.t0;

          case 25:
            context$2$0.prev = 25;
            context$2$0.prev = 26;

            if (!_iteratorNormalCompletion3 && _iterator3['return']) {
              _iterator3['return']();
            }

          case 28:
            context$2$0.prev = 28;

            if (!_didIteratorError3) {
              context$2$0.next = 31;
              break;
            }

            throw _iteratorError3;

          case 31:
            return context$2$0.finish(28);

          case 32:
            return context$2$0.finish(25);

          case 33:
            if (chromeVersion) {
              context$2$0.next = 37;
              break;
            }

            context$2$0.next = 36;
            return _regeneratorRuntime.awrap((0, _utils.getChromeVersion)(this.adb, this.bundleId));

          case 36:
            chromeVersion = context$2$0.sent;

          case 37:

            // make sure it is semver, so later checks won't fail
            chromeVersion = chromeVersion ? _semver2['default'].coerce(chromeVersion) : null;

          case 38:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this, [[6, 21, 25, 33], [26,, 28, 32]]);
    }
  }, {
    key: 'getCompatibleChromedriver',
    value: function getCompatibleChromedriver() {
      var mapping, cds, chromeVersion, _iteratorNormalCompletion4, _didIteratorError4, _iteratorError4, _iterator4, _step4, bundleId, cd, workingCds, binPath;

      return _regeneratorRuntime.async(function getCompatibleChromedriver$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            if (this.adb) {
              context$2$0.next = 4;
              break;
            }

            context$2$0.next = 3;
            return _regeneratorRuntime.awrap((0, _install.getChromedriverBinaryPath)());

          case 3:
            return context$2$0.abrupt('return', context$2$0.sent);

          case 4:
            context$2$0.next = 6;
            return _regeneratorRuntime.awrap(this.getMapping());

          case 6:
            mapping = context$2$0.sent;
            context$2$0.next = 9;
            return _regeneratorRuntime.awrap(this.getChromedrivers(mapping));

          case 9:
            cds = context$2$0.sent;
            chromeVersion = undefined;

            if (!this.bundleId) {
              context$2$0.next = 17;
              break;
            }

            context$2$0.next = 14;
            return _regeneratorRuntime.awrap((0, _utils.getChromeVersion)(this.adb, this.bundleId));

          case 14:
            chromeVersion = context$2$0.sent;
            context$2$0.next = 47;
            break;

          case 17:
            _iteratorNormalCompletion4 = true;
            _didIteratorError4 = false;
            _iteratorError4 = undefined;
            context$2$0.prev = 20;
            _iterator4 = _getIterator(WEBVIEW_BUNDLE_IDS);

          case 22:
            if (_iteratorNormalCompletion4 = (_step4 = _iterator4.next()).done) {
              context$2$0.next = 33;
              break;
            }

            bundleId = _step4.value;
            context$2$0.next = 26;
            return _regeneratorRuntime.awrap((0, _utils.getChromeVersion)(this.adb, bundleId));

          case 26:
            chromeVersion = context$2$0.sent;

            if (!chromeVersion) {
              context$2$0.next = 30;
              break;
            }

            this.bundleId = bundleId;
            return context$2$0.abrupt('break', 33);

          case 30:
            _iteratorNormalCompletion4 = true;
            context$2$0.next = 22;
            break;

          case 33:
            context$2$0.next = 39;
            break;

          case 35:
            context$2$0.prev = 35;
            context$2$0.t0 = context$2$0['catch'](20);
            _didIteratorError4 = true;
            _iteratorError4 = context$2$0.t0;

          case 39:
            context$2$0.prev = 39;
            context$2$0.prev = 40;

            if (!_iteratorNormalCompletion4 && _iterator4['return']) {
              _iterator4['return']();
            }

          case 42:
            context$2$0.prev = 42;

            if (!_didIteratorError4) {
              context$2$0.next = 45;
              break;
            }

            throw _iteratorError4;

          case 45:
            return context$2$0.finish(42);

          case 46:
            return context$2$0.finish(39);

          case 47:
            chromeVersion = chromeVersion ? _semver2['default'].coerce(chromeVersion) : null;

            if (chromeVersion) {
              context$2$0.next = 52;
              break;
            }

            cd = cds[0];

            log.warn('Unable to discover Chrome version. Using Chromedriver ' + cd.version + ' at \'' + cd.executable + '\'');
            return context$2$0.abrupt('return', cd.executable);

          case 52:

            log.debug('Found Chrome bundle \'' + this.bundleId + '\' version \'' + chromeVersion + '\'');

            if (!(_semver2['default'].gt(chromeVersion, _lodash2['default'].values(mapping)[0]) && !_lodash2['default'].isUndefined(cds[0]) && _lodash2['default'].isUndefined(cds[0].minCDVersion))) {
              context$2$0.next = 57;
              break;
            }

            cd = cds[0];

            log.warn('No known Chromedriver available to automate Chrome version \'' + chromeVersion + '\'.\n' + ('Using Chromedriver version \'' + cd.version + '\', which has not been tested with Appium.'));
            return context$2$0.abrupt('return', cd.executable);

          case 57:
            workingCds = cds.filter(function (cd) {
              return !_lodash2['default'].isUndefined(cd.minCDVersion) && _semver2['default'].gte(chromeVersion, cd.minCDVersion);
            });

            if (_lodash2['default'].isEmpty(workingCds)) {
              log.errorAndThrow('No Chromedriver found that can automate Chrome \'' + chromeVersion + '\'. ' + 'See https://github.com/appium/appium/blob/master/docs/en/writing-running-appium/web/chromedriver.md ' + 'for more details.');
            }

            binPath = workingCds[0].executable;

            log.debug('Found ' + workingCds.length + ' Chromedriver executable' + (workingCds.length === 1 ? '' : 's') + ' ' + ('capable of automating Chrome \'' + chromeVersion + '\'.\n') + ('Choosing the most recent, \'' + binPath + '\'.'));
            log.debug('If a specific version is required, specify it with the `chromedriverExecutable`' + 'desired capability.');
            return context$2$0.abrupt('return', binPath);

          case 63:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this, [[20, 35, 39, 47], [40,, 42, 46]]);
    }
  }, {
    key: 'initChromedriverPath',
    value: function initChromedriverPath() {
      return _regeneratorRuntime.async(function initChromedriverPath$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            if (!this.executableVerified) {
              context$2$0.next = 2;
              break;
            }

            return context$2$0.abrupt('return');

          case 2:
            context$2$0.t0 = this.chromedriver;

            if (context$2$0.t0) {
              context$2$0.next = 7;
              break;
            }

            context$2$0.next = 6;
            return _regeneratorRuntime.awrap(this.getCompatibleChromedriver());

          case 6:
            context$2$0.t0 = context$2$0.sent;

          case 7:
            this.chromedriver = context$2$0.t0;
            context$2$0.next = 10;
            return _regeneratorRuntime.awrap(_appiumSupport.fs.exists(this.chromedriver));

          case 10:
            if (context$2$0.sent) {
              context$2$0.next = 12;
              break;
            }

            throw new Error('Trying to use a chromedriver binary at the path ' + (this.chromedriver + ', but it doesn\'t exist!'));

          case 12:
            this.executableVerified = true;
            log.info('Set chromedriver binary as: ' + this.chromedriver);

          case 14:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'start',
    value: function start(caps) {
      var emitStartingState = arguments.length <= 1 || arguments[1] === undefined ? true : arguments[1];
      var args, startDetector, processIsAlive, webviewVersion;
      return _regeneratorRuntime.async(function start$(context$2$0) {
        var _this = this;

        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            this.capabilities = caps;
            if (emitStartingState) {
              this.changeState(Chromedriver.STATE_STARTING);
            }

            args = ["--url-base=wd/hub", '--port=' + this.proxyPort];

            if (this.adb && this.adb.adbPort) {
              args = args.concat(['--adb-port=' + this.adb.adbPort]);
            }
            if (this.cmdArgs) {
              args = args.concat(this.cmdArgs);
            }
            if (this.logPath) {
              args = args.concat(['--log-path=' + this.logPath]);
            }
            args = args.concat(['--verbose']);
            // what are the process stdout/stderr conditions wherein we know that
            // the process has started to our satisfaction?

            startDetector = function startDetector(stdout) {
              return stdout.indexOf('Starting ') === 0;
            };

            processIsAlive = false;
            webviewVersion = undefined;
            context$2$0.prev = 10;
            context$2$0.next = 13;
            return _regeneratorRuntime.awrap(this.initChromedriverPath());

          case 13:
            context$2$0.next = 15;
            return _regeneratorRuntime.awrap(this.killAll());

          case 15:

            // set up our subprocess object
            this.proc = new _teen_process.SubProcess(this.chromedriver, args);
            processIsAlive = true;

            // handle log output
            this.proc.on('output', function (stdout, stderr) {
              // if the cd output is not printed, find the chrome version and print
              // will get a response like
              //   DevTools response: {
              //      "Android-Package": "io.appium.sampleapp",
              //      "Browser": "Chrome/55.0.2883.91",
              //      "Protocol-Version": "1.2",
              //      "User-Agent": "...",
              //      "WebKit-Version": "537.36"
              //   }
              var out = stdout + stderr;
              var match = /"Browser": "(.*)"/.exec(out);
              if (match) {
                webviewVersion = match[1];
                log.debug('Webview version: \'' + webviewVersion + '\'');
              }

              // also print chromedriver version to logs
              // will output something like
              //  Starting ChromeDriver 2.33.506106 (8a06c39c4582fbfbab6966dbb1c38a9173bfb1a2) on port 9515
              match = /Starting ChromeDriver ([\.\d]+)/.exec(out);
              if (match) {
                log.debug('Chromedriver version: \'' + match[1] + '\'');
              }

              // give the output if it is requested
              if (_this.verbose) {
                var _iteratorNormalCompletion5 = true;
                var _didIteratorError5 = false;
                var _iteratorError5 = undefined;

                try {
                  for (var _iterator5 = _getIterator((stdout || '').trim().split('\n')), _step5; !(_iteratorNormalCompletion5 = (_step5 = _iterator5.next()).done); _iteratorNormalCompletion5 = true) {
                    var line = _step5.value;

                    if (!line.trim().length) continue; // eslint-disable-line curly
                    log.debug('[STDOUT] ' + line);
                  }
                } catch (err) {
                  _didIteratorError5 = true;
                  _iteratorError5 = err;
                } finally {
                  try {
                    if (!_iteratorNormalCompletion5 && _iterator5['return']) {
                      _iterator5['return']();
                    }
                  } finally {
                    if (_didIteratorError5) {
                      throw _iteratorError5;
                    }
                  }
                }

                var _iteratorNormalCompletion6 = true;
                var _didIteratorError6 = false;
                var _iteratorError6 = undefined;

                try {
                  for (var _iterator6 = _getIterator((stderr || '').trim().split('\n')), _step6; !(_iteratorNormalCompletion6 = (_step6 = _iterator6.next()).done); _iteratorNormalCompletion6 = true) {
                    var line = _step6.value;

                    if (!line.trim().length) continue; // eslint-disable-line curly
                    log.error('[STDERR] ' + line);
                  }
                } catch (err) {
                  _didIteratorError6 = true;
                  _iteratorError6 = err;
                } finally {
                  try {
                    if (!_iteratorNormalCompletion6 && _iterator6['return']) {
                      _iterator6['return']();
                    }
                  } finally {
                    if (_didIteratorError6) {
                      throw _iteratorError6;
                    }
                  }
                }
              }
            });

            // handle out-of-bound exit by simply emitting a stopped state
            this.proc.on('exit', function (code, signal) {
              processIsAlive = false;
              if (_this.state !== Chromedriver.STATE_STOPPED && _this.state !== Chromedriver.STATE_STOPPING && _this.state !== Chromedriver.STATE_RESTARTING) {
                var msg = 'Chromedriver exited unexpectedly with code ' + code + ', ' + ('signal ' + signal);
                log.error(msg);
                _this.changeState(Chromedriver.STATE_STOPPED);
              }
            });
            log.info('Spawning chromedriver with: ' + this.chromedriver + ' ' + ('' + args.join(' ')));
            // start subproc and wait for startDetector
            context$2$0.next = 22;
            return _regeneratorRuntime.awrap(this.proc.start(startDetector));

          case 22:
            context$2$0.next = 24;
            return _regeneratorRuntime.awrap(this.waitForOnline());

          case 24:
            context$2$0.next = 26;
            return _regeneratorRuntime.awrap(this.startSession());

          case 26:
            context$2$0.next = 36;
            break;

          case 28:
            context$2$0.prev = 28;
            context$2$0.t0 = context$2$0['catch'](10);

            this.emit(Chromedriver.EVENT_ERROR, context$2$0.t0);
            // just because we had an error doesn't mean the chromedriver process
            // finished; we should clean up if necessary

            if (!processIsAlive) {
              context$2$0.next = 34;
              break;
            }

            context$2$0.next = 34;
            return _regeneratorRuntime.awrap(this.proc.stop());

          case 34:

            // often the user's Chrome version is too low for the version of Chromedriver
            if (context$2$0.t0.message.indexOf('Chrome version must be') !== -1) {
              log.error('Unable to automate Chrome version because it is too old for this version of Chromedriver.');
              if (webviewVersion) {
                log.error('Chrome version on device: ' + webviewVersion);
              }
              log.error('Please see \'https://github.com/appium/appium/blob/master/docs/en/writing-running-appium/web/chromedriver.md\'');
            }
            log.errorAndThrow(context$2$0.t0);

          case 36:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this, [[10, 28]]);
    }
  }, {
    key: 'sessionId',
    value: function sessionId() {
      if (this.state !== Chromedriver.STATE_ONLINE) {
        return null;
      }

      return this.jwproxy.sessionId;
    }
  }, {
    key: 'restart',
    value: function restart() {
      return _regeneratorRuntime.async(function restart$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            log.info("Restarting chromedriver");

            if (!(this.state !== Chromedriver.STATE_ONLINE)) {
              context$2$0.next = 3;
              break;
            }

            throw new Error("Can't restart when we're not online");

          case 3:
            this.changeState(Chromedriver.STATE_RESTARTING);
            context$2$0.next = 6;
            return _regeneratorRuntime.awrap(this.stop(false));

          case 6:
            context$2$0.next = 8;
            return _regeneratorRuntime.awrap(this.start(this.capabilities, false));

          case 8:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'waitForOnline',
    value: function waitForOnline() {
      var chromedriverStopped;
      return _regeneratorRuntime.async(function waitForOnline$(context$2$0) {
        var _this2 = this;

        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            chromedriverStopped = false;
            context$2$0.next = 3;
            return _regeneratorRuntime.awrap((0, _asyncbox.retryInterval)(20, 200, function callee$2$0() {
              return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
                while (1) switch (context$3$0.prev = context$3$0.next) {
                  case 0:
                    if (!(this.state === Chromedriver.STATE_STOPPED)) {
                      context$3$0.next = 3;
                      break;
                    }

                    // we are either stopped or stopping, so something went wrong
                    chromedriverStopped = true;
                    return context$3$0.abrupt('return');

                  case 3:
                    context$3$0.next = 5;
                    return _regeneratorRuntime.awrap(this.getStatus());

                  case 5:
                  case 'end':
                    return context$3$0.stop();
                }
              }, null, _this2);
            }));

          case 3:
            if (!chromedriverStopped) {
              context$2$0.next = 5;
              break;
            }

            throw new Error('ChromeDriver crashed during startup.');

          case 5:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'getStatus',
    value: function getStatus() {
      return _regeneratorRuntime.async(function getStatus$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.next = 2;
            return _regeneratorRuntime.awrap(this.jwproxy.command('/status', 'GET'));

          case 2:
            return context$2$0.abrupt('return', context$2$0.sent);

          case 3:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'startSession',
    value: function startSession() {
      return _regeneratorRuntime.async(function startSession$(context$2$0) {
        var _this3 = this;

        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.next = 2;
            return _regeneratorRuntime.awrap((0, _asyncbox.retryInterval)(4, 200, function callee$2$0() {
              var res;
              return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
                while (1) switch (context$3$0.prev = context$3$0.next) {
                  case 0:
                    context$3$0.prev = 0;
                    context$3$0.next = 3;
                    return _regeneratorRuntime.awrap(this.jwproxy.command('/session', 'POST', { desiredCapabilities: this.capabilities }));

                  case 3:
                    res = context$3$0.sent;

                    if (!res.status) {
                      context$3$0.next = 6;
                      break;
                    }

                    throw new Error(res.value.message);

                  case 6:
                    context$3$0.next = 11;
                    break;

                  case 8:
                    context$3$0.prev = 8;
                    context$3$0.t0 = context$3$0['catch'](0);

                    log.errorAndThrow('Failed to start Chromedriver session: ' + context$3$0.t0.message);

                  case 11:
                  case 'end':
                    return context$3$0.stop();
                }
              }, null, _this3, [[0, 8]]);
            }));

          case 2:
            this.changeState(Chromedriver.STATE_ONLINE);

          case 3:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'stop',
    value: function stop() {
      var emitStates = arguments.length <= 0 || arguments[0] === undefined ? true : arguments[0];
      return _regeneratorRuntime.async(function stop$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            if (emitStates) {
              this.changeState(Chromedriver.STATE_STOPPING);
            }
            context$2$0.prev = 1;
            context$2$0.next = 4;
            return _regeneratorRuntime.awrap(this.jwproxy.command('', 'DELETE'));

          case 4:
            context$2$0.next = 6;
            return _regeneratorRuntime.awrap(this.proc.stop('SIGTERM', 20000));

          case 6:
            if (emitStates) {
              this.changeState(Chromedriver.STATE_STOPPED);
            }
            context$2$0.next = 12;
            break;

          case 9:
            context$2$0.prev = 9;
            context$2$0.t0 = context$2$0['catch'](1);

            log.error(context$2$0.t0);

          case 12:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this, [[1, 9]]);
    }
  }, {
    key: 'changeState',
    value: function changeState(state) {
      this.state = state;
      log.debug('Changed state to \'' + state + '\'');
      this.emit(Chromedriver.EVENT_CHANGED, { state: state });
    }
  }, {
    key: 'sendCommand',
    value: function sendCommand(url, method, body) {
      return _regeneratorRuntime.async(function sendCommand$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.next = 2;
            return _regeneratorRuntime.awrap(this.jwproxy.command(url, method, body));

          case 2:
            return context$2$0.abrupt('return', context$2$0.sent);

          case 3:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'proxyReq',
    value: function proxyReq(req, res) {
      return _regeneratorRuntime.async(function proxyReq$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.next = 2;
            return _regeneratorRuntime.awrap(this.jwproxy.proxyReqRes(req, res));

          case 2:
            return context$2$0.abrupt('return', context$2$0.sent);

          case 3:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'killAll',
    value: function killAll() {
      var cmd, _iteratorNormalCompletion7, _didIteratorError7, _iteratorError7, _iterator7, _step7, conn, params;

      return _regeneratorRuntime.async(function killAll$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            cmd = undefined;

            if (_appiumSupport.system.isWindows()) {
              // js hint cannot handle backticks, even escaped, within template literals
              cmd = "FOR /F \"usebackq tokens=5\" %a in (`netstat -nao ^| " + "findstr /R /C:\"" + this.proxyPort + " \"`) do (" + "FOR /F \"usebackq\" %b in (`TASKLIST /FI \"PID eq %a\" ^| " + "findstr /I chromedriver.exe`) do (IF NOT %b==\"\" TASKKILL " + "/F /PID %a))";
            } else {
              cmd = 'pkill -15 -f "' + this.chromedriver + '.*--port=' + this.proxyPort + '"';
            }
            log.debug('Killing any old chromedrivers, running: ' + cmd);
            context$2$0.prev = 3;
            context$2$0.next = 6;
            return _regeneratorRuntime.awrap(_bluebird2['default'].promisify(_child_process2['default'].exec)(cmd));

          case 6:
            log.debug("Successfully cleaned up old chromedrivers");
            context$2$0.next = 12;
            break;

          case 9:
            context$2$0.prev = 9;
            context$2$0.t0 = context$2$0['catch'](3);

            log.warn("No old chromedrivers seemed to exist");

          case 12:
            if (!this.adb) {
              context$2$0.next = 52;
              break;
            }

            log.debug('Cleaning any old adb forwarded port socket connections');
            context$2$0.prev = 14;
            _iteratorNormalCompletion7 = true;
            _didIteratorError7 = false;
            _iteratorError7 = undefined;
            context$2$0.prev = 18;
            context$2$0.next = 21;
            return _regeneratorRuntime.awrap(this.adb.getForwardList());

          case 21:
            context$2$0.t1 = _Symbol$iterator;
            _iterator7 = context$2$0.sent[context$2$0.t1]();

          case 23:
            if (_iteratorNormalCompletion7 = (_step7 = _iterator7.next()).done) {
              context$2$0.next = 33;
              break;
            }

            conn = _step7.value;

            if (!(conn.indexOf('webview_devtools') !== -1)) {
              context$2$0.next = 30;
              break;
            }

            params = conn.split(/\s+/);

            if (!(params.length > 1)) {
              context$2$0.next = 30;
              break;
            }

            context$2$0.next = 30;
            return _regeneratorRuntime.awrap(this.adb.removePortForward(params[1].replace(/[\D]*/, '')));

          case 30:
            _iteratorNormalCompletion7 = true;
            context$2$0.next = 23;
            break;

          case 33:
            context$2$0.next = 39;
            break;

          case 35:
            context$2$0.prev = 35;
            context$2$0.t2 = context$2$0['catch'](18);
            _didIteratorError7 = true;
            _iteratorError7 = context$2$0.t2;

          case 39:
            context$2$0.prev = 39;
            context$2$0.prev = 40;

            if (!_iteratorNormalCompletion7 && _iterator7['return']) {
              _iterator7['return']();
            }

          case 42:
            context$2$0.prev = 42;

            if (!_didIteratorError7) {
              context$2$0.next = 45;
              break;
            }

            throw _iteratorError7;

          case 45:
            return context$2$0.finish(42);

          case 46:
            return context$2$0.finish(39);

          case 47:
            context$2$0.next = 52;
            break;

          case 49:
            context$2$0.prev = 49;
            context$2$0.t3 = context$2$0['catch'](14);

            log.warn('Unable to clean forwarded ports. Error: \'' + context$2$0.t3.message + '\'. Continuing.');

          case 52:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this, [[3, 9], [14, 49], [18, 35, 39, 47], [40,, 42, 46]]);
    }
  }, {
    key: 'hasWorkingWebview',
    value: function hasWorkingWebview() {
      return _regeneratorRuntime.async(function hasWorkingWebview$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.prev = 0;
            context$2$0.next = 3;
            return _regeneratorRuntime.awrap(this.jwproxy.command('/url', 'GET'));

          case 3:
            return context$2$0.abrupt('return', true);

          case 6:
            context$2$0.prev = 6;
            context$2$0.t0 = context$2$0['catch'](0);
            return context$2$0.abrupt('return', false);

          case 9:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this, [[0, 6]]);
    }
  }]);

  return Chromedriver;
})(_events2['default'].EventEmitter);

Chromedriver.EVENT_ERROR = 'chromedriver_error';
Chromedriver.EVENT_CHANGED = 'stateChanged';
Chromedriver.STATE_STOPPED = 'stopped';
Chromedriver.STATE_STARTING = 'starting';
Chromedriver.STATE_ONLINE = 'online';
Chromedriver.STATE_STOPPING = 'stopping';
Chromedriver.STATE_RESTARTING = 'restarting';

exports['default'] = Chromedriver;
module.exports = exports['default'];

// go through the versions available

// try out webviews when no bundle id is sent in

// if we do not have a chrome version, it must not be a webview

// we have a webview of some sort, so try to find the bundle version

// unable to get the chrome version

// this is a chrome above the latest version we know about,
// and we have a chromedriver that is beyond what we know,
// so use the most recent chromedriver that we found
//eslint-disable-line curly

// we need to make sure that CD hasn't crashed

// retry session start 4 times, sometimes this fails due to adb

// ChromeDriver can return a positive status despite failing

// chromedriver will ask ADB to forward a port like "deviceId tcp:port localabstract:webview_devtools_remote_port"

// sometimes chromedriver stops automating webviews. this method runs a
// simple command to determine our state, and responds accordingly
//# sourceMappingURL=data:application/json;charset=utf8;base64,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QVksQ0FBQyxhQUFhLEdBQUcsU0FBUyxDQUFDO0FBQ3ZDLFlBQVksQ0FBQyxjQUFjLEdBQUcsVUFBVSxDQUFDO0FBQ3pDLFlBQVksQ0FBQyxZQUFZLEdBQUcsUUFBUSxDQUFDO0FBQ3JDLFlBQVksQ0FBQyxjQUFjLEdBQUcsVUFBVSxDQUFDO0FBQ3pDLFlBQVksQ0FBQyxnQkFBZ0IsR0FBRyxZQUFZLENBQUM7O3FCQUU5QixZQUFZIiwiZmlsZSI6ImxpYi9jaHJvbWVkcml2ZXIuanMiLCJzb3VyY2VzQ29udGVudCI6WyIvLyB0cmFuc3BpbGU6bWFpblxuXG5pbXBvcnQgZXZlbnRzIGZyb20gJ2V2ZW50cyc7XG5pbXBvcnQgeyBKV1Byb3h5IH0gZnJvbSAnYXBwaXVtLWJhc2UtZHJpdmVyJztcbmltcG9ydCBjcCBmcm9tICdjaGlsZF9wcm9jZXNzJztcbmltcG9ydCB7IHN5c3RlbSwgZnMsIGxvZ2dlciB9IGZyb20gJ2FwcGl1bS1zdXBwb3J0JztcbmltcG9ydCB7IHJldHJ5SW50ZXJ2YWwsIGFzeW5jbWFwIH0gZnJvbSAnYXN5bmNib3gnO1xuaW1wb3J0IHsgU3ViUHJvY2VzcywgZXhlYyB9IGZyb20gJ3RlZW5fcHJvY2Vzcyc7XG5pbXBvcnQgQiBmcm9tICdibHVlYmlyZCc7XG5pbXBvcnQgeyBnZXRDaHJvbWVkcml2ZXJCaW5hcnlQYXRoLCBnZXRDaHJvbWVkcml2ZXJEaXIgfSBmcm9tICcuL2luc3RhbGwnO1xuaW1wb3J0IHsgZ2V0Q2hyb21lVmVyc2lvbiB9IGZyb20gJy4vdXRpbHMnO1xuaW1wb3J0IHNlbXZlciBmcm9tICdzZW12ZXInO1xuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcblxuXG5jb25zdCBsb2cgPSBsb2dnZXIuZ2V0TG9nZ2VyKCdDaHJvbWVkcml2ZXInKTtcblxuY29uc3QgREVGQVVMVF9IT1NUID0gJzEyNy4wLjAuMSc7XG5jb25zdCBERUZBVUxUX1BPUlQgPSA5NTE1O1xuY29uc3QgQ0hST01FRFJJVkVSX0NIUk9NRV9NQVBQSU5HID0ge1xuICAnMi4zOCc6ICc2NS4wLjMzMjUnLFxuICAnMi4zNyc6ICc2NC4wLjMyODInLFxuICAnMi4zNic6ICc2My4wLjMyMzknLFxuICAnMi4zNSc6ICc2Mi4wLjMyMDInLFxuICAnMi4zNCc6ICc2MS4wLjMxNjMnLFxuICAnMi4zMyc6ICc2MC4wLjMxMTInLFxuICAnMi4zMic6ICc1OS4wLjMwNzEnLFxuICAnMi4zMSc6ICc1OC4wLjMwMjknLFxuICAnMi4zMCc6ICc1OC4wLjMwMjknLFxuICAnMi4yOSc6ICc1Ny4wLjI5ODcnLFxuICAnMi4yOCc6ICc1NS4wLjI4ODMnLFxuICAnMi4yNyc6ICc1NC4wLjI4NDAnLFxuICAnMi4yNic6ICc1My4wLjI3ODUnLFxuICAnMi4yNSc6ICc1My4wLjI3ODUnLFxuICAnMi4yNCc6ICc1Mi4wLjI3NDMnLFxuICAnMi4yMyc6ICc1MS4wLjI3MDQnLFxuICAnMi4yMic6ICc0OS4wLjI2MjMnLFxuICAnMi4yMSc6ICc0Ni4wLjI0OTAnLFxuICAnMi4yMCc6ICc0My4wLjIzNTcnLFxuICAnMi4xOSc6ICc0My4wLjIzNTcnLFxuICAnMi4xOCc6ICc0My4wLjIzNTcnLFxuICAnMi4xNyc6ICc0Mi4wLjIzMTEnLFxuICAnMi4xNic6ICc0Mi4wLjIzMTEnLFxuICAnMi4xNSc6ICc0MC4wLjIyMTQnLFxuICAnMi4xNCc6ICczOS4wLjIxNzEnLFxuICAnMi4xMyc6ICczOC4wLjIxMjUnLFxuICAnMi4xMic6ICczNi4wLjE5ODUnLFxuICAnMi4xMSc6ICczNi4wLjE5ODUnLFxuICAnMi4xMCc6ICczMy4wLjE3NTEnLFxuICAnMi45JzogJzMxLjAuMTY1MCcsXG4gICcyLjgnOiAnMzAuMC4xNTczJyxcbiAgJzIuNyc6ICczMC4wLjE1NzMnLFxuICAnMi42JzogJzI5LjAuMTU0NScsXG4gICcyLjUnOiAnMjkuMC4xNTQ1JyxcbiAgJzIuNCc6ICcyOS4wLjE1NDUnLFxuICAnMi4zJzogJzI4LjAuMTUwMCcsXG4gICcyLjInOiAnMjcuMC4xNDUzJyxcbiAgJzIuMSc6ICcyNy4wLjE0NTMnLFxuICAnMi4wJzogJzI3LjAuMTQ1MycsXG59O1xuY29uc3QgQ0hST01FX0JVTkRMRV9JRCA9ICdjb20uYW5kcm9pZC5jaHJvbWUnO1xuY29uc3QgV0VCVklFV19CVU5ETEVfSURTID0gW1xuICAnY29tLmdvb2dsZS5hbmRyb2lkLndlYnZpZXcnLFxuICAnY29tLmFuZHJvaWQud2VidmlldycsXG5dO1xuXG5jbGFzcyBDaHJvbWVkcml2ZXIgZXh0ZW5kcyBldmVudHMuRXZlbnRFbWl0dGVyIHtcbiAgY29uc3RydWN0b3IgKGFyZ3MgPSB7fSkge1xuICAgIHN1cGVyKCk7XG5cbiAgICBjb25zdCB7XG4gICAgICBob3N0ID0gREVGQVVMVF9IT1NULFxuICAgICAgcG9ydCA9IERFRkFVTFRfUE9SVCxcbiAgICAgIGV4ZWN1dGFibGUsXG4gICAgICBleGVjdXRhYmxlRGlyID0gZ2V0Q2hyb21lZHJpdmVyRGlyKCksXG4gICAgICBidW5kbGVJZCxcbiAgICAgIG1hcHBpbmdQYXRoLFxuICAgICAgY21kQXJncyxcbiAgICAgIGFkYixcbiAgICAgIHZlcmJvc2UsXG4gICAgICBsb2dQYXRoLFxuICAgIH0gPSBhcmdzO1xuXG4gICAgdGhpcy5wcm94eUhvc3QgPSBob3N0O1xuICAgIHRoaXMucHJveHlQb3J0ID0gcG9ydDtcbiAgICB0aGlzLmFkYiA9IGFkYjtcbiAgICB0aGlzLmNtZEFyZ3MgPSBjbWRBcmdzO1xuICAgIHRoaXMucHJvYyA9IG51bGw7XG4gICAgdGhpcy5jaHJvbWVkcml2ZXIgPSBleGVjdXRhYmxlO1xuICAgIHRoaXMuZXhlY3V0YWJsZURpciA9IGV4ZWN1dGFibGVEaXI7XG4gICAgdGhpcy5tYXBwaW5nUGF0aCA9IG1hcHBpbmdQYXRoO1xuICAgIHRoaXMuYnVuZGxlSWQgPSBidW5kbGVJZDtcbiAgICB0aGlzLmV4ZWN1dGFibGVWZXJpZmllZCA9IGZhbHNlO1xuICAgIHRoaXMuc3RhdGUgPSBDaHJvbWVkcml2ZXIuU1RBVEVfU1RPUFBFRDtcbiAgICB0aGlzLmp3cHJveHkgPSBuZXcgSldQcm94eSh7c2VydmVyOiB0aGlzLnByb3h5SG9zdCwgcG9ydDogdGhpcy5wcm94eVBvcnR9KTtcbiAgICB0aGlzLnZlcmJvc2UgPSB2ZXJib3NlO1xuICAgIHRoaXMubG9nUGF0aCA9IGxvZ1BhdGg7XG4gIH1cblxuICBhc3luYyBnZXRNYXBwaW5nICgpIHtcbiAgICBsZXQgbWFwcGluZyA9IENIUk9NRURSSVZFUl9DSFJPTUVfTUFQUElORztcbiAgICBpZiAodGhpcy5tYXBwaW5nUGF0aCkge1xuICAgICAgbG9nLmRlYnVnKGBBdHRlbXB0aW5nIHRvIHVzZSBDaHJvbWVkcml2ZXItQ2hyb21lIG1hcHBpbmcgZnJvbSAnJHt0aGlzLm1hcHBpbmdQYXRofSdgKTtcbiAgICAgIGlmICghYXdhaXQgZnMuZXhpc3RzKHRoaXMubWFwcGluZ1BhdGgpKSB7XG4gICAgICAgIGxvZy53YXJuKGBObyBmaWxlIGZvdW5kIGF0ICcke3RoaXMubWFwcGluZ1BhdGh9Jy4gVXNpbmcgZGVmYXVsdCBtYXBwaW5nYCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0cnkge1xuICAgICAgICAgIG1hcHBpbmcgPSBKU09OLnBhcnNlKGF3YWl0IGZzLnJlYWRGaWxlKHRoaXMubWFwcGluZ1BhdGgpKTtcbiAgICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgICAgbG9nLmVycm9yKGBFcnJvciBwYXJzaW5nIG1hcHBpbmcgZnJvbSAnJHt0aGlzLm1hcHBpbmdQYXRofSc6ICR7ZXJyLm1lc3NhZ2V9YCk7XG4gICAgICAgICAgbG9nLndhcm4oJ1VzaW5nIGRlZmF1bHQgbWFwcGluZycpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuXG4gICAgLy8gbWFrZSBzdXJlIHRoYXQgdGhlIHZhbHVlcyBmb3IgbWluaW11bSBjaHJvbWUgdmVyc2lvbiBhcmUgc2VtdmVyIGNvbXBsaWFudFxuICAgIGZvciAoY29uc3QgW2NkVmVyc2lvbiwgY2hyb21lVmVyc2lvbl0gb2YgXy50b1BhaXJzKG1hcHBpbmcpKSB7XG4gICAgICBtYXBwaW5nW2NkVmVyc2lvbl0gPSBzZW12ZXIuY29lcmNlKGNocm9tZVZlcnNpb24pO1xuICAgIH1cbiAgICByZXR1cm4gbWFwcGluZztcbiAgfVxuXG4gIGFzeW5jIGdldENocm9tZWRyaXZlcnMgKG1hcHBpbmcpIHtcbiAgICAvLyBnbyB0aHJvdWdoIHRoZSB2ZXJzaW9ucyBhdmFpbGFibGVcbiAgICBjb25zdCBleGVjdXRhYmxlcyA9IGF3YWl0IGZzLmdsb2IoYCR7dGhpcy5leGVjdXRhYmxlRGlyfS8qYCk7XG4gICAgY29uc3QgY2RzID0gKGF3YWl0IGFzeW5jbWFwKGV4ZWN1dGFibGVzLCBhc3luYyBmdW5jdGlvbiAoZXhlY3V0YWJsZSkge1xuICAgICAgdHJ5IHtcbiAgICAgICAgY29uc3Qge3N0ZG91dH0gPSBhd2FpdCBleGVjKGV4ZWN1dGFibGUsIFsnLS12ZXJzaW9uJ10pO1xuICAgICAgICBjb25zdCBtYXRjaCA9IC9DaHJvbWVEcml2ZXJcXHMoXFxkK1xcLlxcZCspXFwuXFxkK1xccy8uZXhlYyhzdGRvdXQpO1xuICAgICAgICBpZiAobWF0Y2gpIHtcbiAgICAgICAgICBjb25zdCB2ZXJzaW9uID0gbWF0Y2hbMV07XG4gICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIGV4ZWN1dGFibGUsXG4gICAgICAgICAgICB2ZXJzaW9uLFxuICAgICAgICAgICAgbWluQ0RWZXJzaW9uOiBtYXBwaW5nW3ZlcnNpb25dLFxuICAgICAgICAgIH07XG4gICAgICAgIH1cbiAgICAgIH0gY2F0Y2ggKGlnbikge31cbiAgICB9KSlcbiAgICAgIC5maWx0ZXIoKGNkKSA9PiAhIWNkKVxuICAgICAgLnNvcnQoKGEsIGIpID0+IHNlbXZlci5ndGUoc2VtdmVyLmNvZXJjZShiLnZlcnNpb24pLCBzZW12ZXIuY29lcmNlKGEudmVyc2lvbikpID8gMSA6IC0xKTtcbiAgICBpZiAoXy5pc0VtcHR5KGNkcykpIHtcbiAgICAgIGxvZy5lcnJvckFuZFRocm93KGBObyBDaHJvbWVkcml2ZXIgZm91bmRgKTtcbiAgICB9XG4gICAgbG9nLmRlYnVnKGBUaGUgZm9sbG93aW5nIENocm9tZWRyaXZlciBleGVjdXRhYmxlcyB3ZXJlIGZvdW5kOmApO1xuICAgIGZvciAoY29uc3QgY2Qgb2YgY2RzKSB7XG4gICAgICBsb2cuZGVidWcoYCAgICAke2NkLmV4ZWN1dGFibGV9IChtaW5pbXVtIENocm9tZSB2ZXJzaW9uICcke2NkLm1pbkNEVmVyc2lvbiA/IGNkLm1pbkNEVmVyc2lvbiA6ICdVbmtub3duJ30nKWApO1xuICAgIH1cbiAgICByZXR1cm4gY2RzO1xuICB9XG5cbiAgYXN5bmMgZ2V0Q2hyb21lVmVyc2lvbiAoKSB7XG4gICAgbGV0IGNocm9tZVZlcnNpb247XG5cbiAgICAvLyB0cnkgb3V0IHdlYnZpZXdzIHdoZW4gbm8gYnVuZGxlIGlkIGlzIHNlbnQgaW5cbiAgICBpZiAoIXRoaXMuYnVuZGxlSWQpIHtcbiAgICAgIC8vIGRlZmF1bHQgdG8gdGhlIGdlbmVyaWMgQ2hyb21lIGJ1bmRsZVxuICAgICAgdGhpcy5idW5kbGVJZCA9IENIUk9NRV9CVU5ETEVfSUQ7XG5cbiAgICAgIC8vIHdlIGhhdmUgYSB3ZWJ2aWV3IG9mIHNvbWUgc29ydCwgc28gdHJ5IHRvIGZpbmQgdGhlIGJ1bmRsZSB2ZXJzaW9uXG4gICAgICBmb3IgKGNvbnN0IGJ1bmRsZUlkIG9mIFdFQlZJRVdfQlVORExFX0lEUykge1xuICAgICAgICBjaHJvbWVWZXJzaW9uID0gYXdhaXQgZ2V0Q2hyb21lVmVyc2lvbih0aGlzLmFkYiwgYnVuZGxlSWQpO1xuICAgICAgICBpZiAoY2hyb21lVmVyc2lvbikge1xuICAgICAgICAgIHRoaXMuYnVuZGxlSWQgPSBidW5kbGVJZDtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cblxuICAgIC8vIGlmIHdlIGRvIG5vdCBoYXZlIGEgY2hyb21lIHZlcnNpb24sIGl0IG11c3Qgbm90IGJlIGEgd2Vidmlld1xuICAgIGlmICghY2hyb21lVmVyc2lvbikge1xuICAgICAgY2hyb21lVmVyc2lvbiA9IGF3YWl0IGdldENocm9tZVZlcnNpb24odGhpcy5hZGIsIHRoaXMuYnVuZGxlSWQpO1xuICAgIH1cblxuICAgIC8vIG1ha2Ugc3VyZSBpdCBpcyBzZW12ZXIsIHNvIGxhdGVyIGNoZWNrcyB3b24ndCBmYWlsXG4gICAgY2hyb21lVmVyc2lvbiA9IGNocm9tZVZlcnNpb24gPyBzZW12ZXIuY29lcmNlKGNocm9tZVZlcnNpb24pIDogbnVsbDtcbiAgfVxuXG4gIGFzeW5jIGdldENvbXBhdGlibGVDaHJvbWVkcml2ZXIgKCkge1xuICAgIGlmICghdGhpcy5hZGIpIHtcbiAgICAgIHJldHVybiBhd2FpdCBnZXRDaHJvbWVkcml2ZXJCaW5hcnlQYXRoKCk7XG4gICAgfVxuXG4gICAgY29uc3QgbWFwcGluZyA9IGF3YWl0IHRoaXMuZ2V0TWFwcGluZygpO1xuICAgIGNvbnN0IGNkcyA9IGF3YWl0IHRoaXMuZ2V0Q2hyb21lZHJpdmVycyhtYXBwaW5nKTtcblxuICAgIGxldCBjaHJvbWVWZXJzaW9uO1xuICAgIGlmICh0aGlzLmJ1bmRsZUlkKSB7XG4gICAgICBjaHJvbWVWZXJzaW9uID0gYXdhaXQgZ2V0Q2hyb21lVmVyc2lvbih0aGlzLmFkYiwgdGhpcy5idW5kbGVJZCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIC8vIHdlIGhhdmUgYSB3ZWJ2aWV3IG9mIHNvbWUgc29ydCwgc28gdHJ5IHRvIGZpbmQgdGhlIGJ1bmRsZSB2ZXJzaW9uXG4gICAgICBmb3IgKGNvbnN0IGJ1bmRsZUlkIG9mIFdFQlZJRVdfQlVORExFX0lEUykge1xuICAgICAgICBjaHJvbWVWZXJzaW9uID0gYXdhaXQgZ2V0Q2hyb21lVmVyc2lvbih0aGlzLmFkYiwgYnVuZGxlSWQpO1xuICAgICAgICBpZiAoY2hyb21lVmVyc2lvbikge1xuICAgICAgICAgIHRoaXMuYnVuZGxlSWQgPSBidW5kbGVJZDtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgICBjaHJvbWVWZXJzaW9uID0gY2hyb21lVmVyc2lvbiA/IHNlbXZlci5jb2VyY2UoY2hyb21lVmVyc2lvbikgOiBudWxsO1xuXG4gICAgaWYgKCFjaHJvbWVWZXJzaW9uKSB7XG4gICAgICAvLyB1bmFibGUgdG8gZ2V0IHRoZSBjaHJvbWUgdmVyc2lvblxuICAgICAgbGV0IGNkID0gY2RzWzBdO1xuICAgICAgbG9nLndhcm4oYFVuYWJsZSB0byBkaXNjb3ZlciBDaHJvbWUgdmVyc2lvbi4gVXNpbmcgQ2hyb21lZHJpdmVyICR7Y2QudmVyc2lvbn0gYXQgJyR7Y2QuZXhlY3V0YWJsZX0nYCk7XG4gICAgICByZXR1cm4gY2QuZXhlY3V0YWJsZTtcbiAgICB9XG5cbiAgICBsb2cuZGVidWcoYEZvdW5kIENocm9tZSBidW5kbGUgJyR7dGhpcy5idW5kbGVJZH0nIHZlcnNpb24gJyR7Y2hyb21lVmVyc2lvbn0nYCk7XG5cbiAgICBpZiAoc2VtdmVyLmd0KGNocm9tZVZlcnNpb24sIF8udmFsdWVzKG1hcHBpbmcpWzBdKSAmJlxuICAgICAgICAhXy5pc1VuZGVmaW5lZChjZHNbMF0pICYmIF8uaXNVbmRlZmluZWQoY2RzWzBdLm1pbkNEVmVyc2lvbikpIHtcbiAgICAgIC8vIHRoaXMgaXMgYSBjaHJvbWUgYWJvdmUgdGhlIGxhdGVzdCB2ZXJzaW9uIHdlIGtub3cgYWJvdXQsXG4gICAgICAvLyBhbmQgd2UgaGF2ZSBhIGNocm9tZWRyaXZlciB0aGF0IGlzIGJleW9uZCB3aGF0IHdlIGtub3csXG4gICAgICAvLyBzbyB1c2UgdGhlIG1vc3QgcmVjZW50IGNocm9tZWRyaXZlciB0aGF0IHdlIGZvdW5kXG4gICAgICBsZXQgY2QgPSBjZHNbMF07XG4gICAgICBsb2cud2FybihgTm8ga25vd24gQ2hyb21lZHJpdmVyIGF2YWlsYWJsZSB0byBhdXRvbWF0ZSBDaHJvbWUgdmVyc2lvbiAnJHtjaHJvbWVWZXJzaW9ufScuXFxuYCArXG4gICAgICAgICAgICAgICBgVXNpbmcgQ2hyb21lZHJpdmVyIHZlcnNpb24gJyR7Y2QudmVyc2lvbn0nLCB3aGljaCBoYXMgbm90IGJlZW4gdGVzdGVkIHdpdGggQXBwaXVtLmApO1xuICAgICAgcmV0dXJuIGNkLmV4ZWN1dGFibGU7XG4gICAgfVxuXG4gICAgY29uc3Qgd29ya2luZ0NkcyA9IGNkcy5maWx0ZXIoKGNkKSA9PiB7XG4gICAgICByZXR1cm4gIV8uaXNVbmRlZmluZWQoY2QubWluQ0RWZXJzaW9uKSAmJiBzZW12ZXIuZ3RlKGNocm9tZVZlcnNpb24sIGNkLm1pbkNEVmVyc2lvbik7XG4gICAgfSk7XG5cbiAgICBpZiAoXy5pc0VtcHR5KHdvcmtpbmdDZHMpKSB7XG4gICAgICBsb2cuZXJyb3JBbmRUaHJvdyhgTm8gQ2hyb21lZHJpdmVyIGZvdW5kIHRoYXQgY2FuIGF1dG9tYXRlIENocm9tZSAnJHtjaHJvbWVWZXJzaW9ufScuIGAgK1xuICAgICAgICAgICAgICAgICAgICAgICAgYFNlZSBodHRwczovL2dpdGh1Yi5jb20vYXBwaXVtL2FwcGl1bS9ibG9iL21hc3Rlci9kb2NzL2VuL3dyaXRpbmctcnVubmluZy1hcHBpdW0vd2ViL2Nocm9tZWRyaXZlci5tZCBgICtcbiAgICAgICAgICAgICAgICAgICAgICAgIGBmb3IgbW9yZSBkZXRhaWxzLmApO1xuICAgIH1cblxuICAgIGNvbnN0IGJpblBhdGggPSB3b3JraW5nQ2RzWzBdLmV4ZWN1dGFibGU7XG4gICAgbG9nLmRlYnVnKGBGb3VuZCAke3dvcmtpbmdDZHMubGVuZ3RofSBDaHJvbWVkcml2ZXIgZXhlY3V0YWJsZSR7d29ya2luZ0Nkcy5sZW5ndGggPT09IDEgPyAnJyA6ICdzJ30gYCArXG4gICAgICAgICAgICAgIGBjYXBhYmxlIG9mIGF1dG9tYXRpbmcgQ2hyb21lICcke2Nocm9tZVZlcnNpb259Jy5cXG5gICtcbiAgICAgICAgICAgICAgYENob29zaW5nIHRoZSBtb3N0IHJlY2VudCwgJyR7YmluUGF0aH0nLmApO1xuICAgIGxvZy5kZWJ1ZygnSWYgYSBzcGVjaWZpYyB2ZXJzaW9uIGlzIHJlcXVpcmVkLCBzcGVjaWZ5IGl0IHdpdGggdGhlIGBjaHJvbWVkcml2ZXJFeGVjdXRhYmxlYCcgK1xuICAgICAgICAgICAgICAnZGVzaXJlZCBjYXBhYmlsaXR5LicpO1xuICAgIHJldHVybiBiaW5QYXRoO1xuICB9XG5cbiAgYXN5bmMgaW5pdENocm9tZWRyaXZlclBhdGggKCkge1xuICAgIGlmICh0aGlzLmV4ZWN1dGFibGVWZXJpZmllZCkgcmV0dXJuOyAvL2VzbGludC1kaXNhYmxlLWxpbmUgY3VybHlcblxuICAgIHRoaXMuY2hyb21lZHJpdmVyID0gdGhpcy5jaHJvbWVkcml2ZXIgfHwgYXdhaXQgdGhpcy5nZXRDb21wYXRpYmxlQ2hyb21lZHJpdmVyKCk7XG4gICAgaWYgKCFhd2FpdCBmcy5leGlzdHModGhpcy5jaHJvbWVkcml2ZXIpKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYFRyeWluZyB0byB1c2UgYSBjaHJvbWVkcml2ZXIgYmluYXJ5IGF0IHRoZSBwYXRoIGAgK1xuICAgICAgICAgICAgICAgICAgICAgIGAke3RoaXMuY2hyb21lZHJpdmVyfSwgYnV0IGl0IGRvZXNuJ3QgZXhpc3QhYCk7XG4gICAgfVxuICAgIHRoaXMuZXhlY3V0YWJsZVZlcmlmaWVkID0gdHJ1ZTtcbiAgICBsb2cuaW5mbyhgU2V0IGNocm9tZWRyaXZlciBiaW5hcnkgYXM6ICR7dGhpcy5jaHJvbWVkcml2ZXJ9YCk7XG4gIH1cblxuICBhc3luYyBzdGFydCAoY2FwcywgZW1pdFN0YXJ0aW5nU3RhdGUgPSB0cnVlKSB7XG4gICAgdGhpcy5jYXBhYmlsaXRpZXMgPSBjYXBzO1xuICAgIGlmIChlbWl0U3RhcnRpbmdTdGF0ZSkge1xuICAgICAgdGhpcy5jaGFuZ2VTdGF0ZShDaHJvbWVkcml2ZXIuU1RBVEVfU1RBUlRJTkcpO1xuICAgIH1cblxuICAgIGxldCBhcmdzID0gW1wiLS11cmwtYmFzZT13ZC9odWJcIiwgYC0tcG9ydD0ke3RoaXMucHJveHlQb3J0fWBdO1xuICAgIGlmICh0aGlzLmFkYiAmJiB0aGlzLmFkYi5hZGJQb3J0KSB7XG4gICAgICBhcmdzID0gYXJncy5jb25jYXQoW2AtLWFkYi1wb3J0PSR7dGhpcy5hZGIuYWRiUG9ydH1gXSk7XG4gICAgfVxuICAgIGlmICh0aGlzLmNtZEFyZ3MpIHtcbiAgICAgIGFyZ3MgPSBhcmdzLmNvbmNhdCh0aGlzLmNtZEFyZ3MpO1xuICAgIH1cbiAgICBpZiAodGhpcy5sb2dQYXRoKSB7XG4gICAgICBhcmdzID0gYXJncy5jb25jYXQoW2AtLWxvZy1wYXRoPSR7dGhpcy5sb2dQYXRofWBdKTtcbiAgICB9XG4gICAgYXJncyA9IGFyZ3MuY29uY2F0KFsnLS12ZXJib3NlJ10pO1xuICAgIC8vIHdoYXQgYXJlIHRoZSBwcm9jZXNzIHN0ZG91dC9zdGRlcnIgY29uZGl0aW9ucyB3aGVyZWluIHdlIGtub3cgdGhhdFxuICAgIC8vIHRoZSBwcm9jZXNzIGhhcyBzdGFydGVkIHRvIG91ciBzYXRpc2ZhY3Rpb24/XG4gICAgY29uc3Qgc3RhcnREZXRlY3RvciA9IChzdGRvdXQpID0+IHtcbiAgICAgIHJldHVybiBzdGRvdXQuaW5kZXhPZignU3RhcnRpbmcgJykgPT09IDA7XG4gICAgfTtcblxuICAgIGxldCBwcm9jZXNzSXNBbGl2ZSA9IGZhbHNlO1xuICAgIGxldCB3ZWJ2aWV3VmVyc2lvbjtcbiAgICB0cnkge1xuICAgICAgYXdhaXQgdGhpcy5pbml0Q2hyb21lZHJpdmVyUGF0aCgpO1xuICAgICAgYXdhaXQgdGhpcy5raWxsQWxsKCk7XG5cbiAgICAgIC8vIHNldCB1cCBvdXIgc3VicHJvY2VzcyBvYmplY3RcbiAgICAgIHRoaXMucHJvYyA9IG5ldyBTdWJQcm9jZXNzKHRoaXMuY2hyb21lZHJpdmVyLCBhcmdzKTtcbiAgICAgIHByb2Nlc3NJc0FsaXZlID0gdHJ1ZTtcblxuICAgICAgLy8gaGFuZGxlIGxvZyBvdXRwdXRcbiAgICAgIHRoaXMucHJvYy5vbignb3V0cHV0JywgKHN0ZG91dCwgc3RkZXJyKSA9PiB7XG4gICAgICAgIC8vIGlmIHRoZSBjZCBvdXRwdXQgaXMgbm90IHByaW50ZWQsIGZpbmQgdGhlIGNocm9tZSB2ZXJzaW9uIGFuZCBwcmludFxuICAgICAgICAvLyB3aWxsIGdldCBhIHJlc3BvbnNlIGxpa2VcbiAgICAgICAgLy8gICBEZXZUb29scyByZXNwb25zZToge1xuICAgICAgICAvLyAgICAgIFwiQW5kcm9pZC1QYWNrYWdlXCI6IFwiaW8uYXBwaXVtLnNhbXBsZWFwcFwiLFxuICAgICAgICAvLyAgICAgIFwiQnJvd3NlclwiOiBcIkNocm9tZS81NS4wLjI4ODMuOTFcIixcbiAgICAgICAgLy8gICAgICBcIlByb3RvY29sLVZlcnNpb25cIjogXCIxLjJcIixcbiAgICAgICAgLy8gICAgICBcIlVzZXItQWdlbnRcIjogXCIuLi5cIixcbiAgICAgICAgLy8gICAgICBcIldlYktpdC1WZXJzaW9uXCI6IFwiNTM3LjM2XCJcbiAgICAgICAgLy8gICB9XG4gICAgICAgIGNvbnN0IG91dCA9IHN0ZG91dCArIHN0ZGVycjtcbiAgICAgICAgbGV0IG1hdGNoID0gL1wiQnJvd3NlclwiOiBcIiguKilcIi8uZXhlYyhvdXQpO1xuICAgICAgICBpZiAobWF0Y2gpIHtcbiAgICAgICAgICB3ZWJ2aWV3VmVyc2lvbiA9IG1hdGNoWzFdO1xuICAgICAgICAgIGxvZy5kZWJ1ZyhgV2VidmlldyB2ZXJzaW9uOiAnJHt3ZWJ2aWV3VmVyc2lvbn0nYCk7XG4gICAgICAgIH1cblxuICAgICAgICAvLyBhbHNvIHByaW50IGNocm9tZWRyaXZlciB2ZXJzaW9uIHRvIGxvZ3NcbiAgICAgICAgLy8gd2lsbCBvdXRwdXQgc29tZXRoaW5nIGxpa2VcbiAgICAgICAgLy8gIFN0YXJ0aW5nIENocm9tZURyaXZlciAyLjMzLjUwNjEwNiAoOGEwNmMzOWM0NTgyZmJmYmFiNjk2NmRiYjFjMzhhOTE3M2JmYjFhMikgb24gcG9ydCA5NTE1XG4gICAgICAgIG1hdGNoID0gL1N0YXJ0aW5nIENocm9tZURyaXZlciAoW1xcLlxcZF0rKS8uZXhlYyhvdXQpO1xuICAgICAgICBpZiAobWF0Y2gpIHtcbiAgICAgICAgICBsb2cuZGVidWcoYENocm9tZWRyaXZlciB2ZXJzaW9uOiAnJHttYXRjaFsxXX0nYCk7XG4gICAgICAgIH1cblxuICAgICAgICAvLyBnaXZlIHRoZSBvdXRwdXQgaWYgaXQgaXMgcmVxdWVzdGVkXG4gICAgICAgIGlmICh0aGlzLnZlcmJvc2UpIHtcbiAgICAgICAgICBmb3IgKGxldCBsaW5lIG9mIChzdGRvdXQgfHwgJycpLnRyaW0oKS5zcGxpdCgnXFxuJykpIHtcbiAgICAgICAgICAgIGlmICghbGluZS50cmltKCkubGVuZ3RoKSBjb250aW51ZTsgLy8gZXNsaW50LWRpc2FibGUtbGluZSBjdXJseVxuICAgICAgICAgICAgbG9nLmRlYnVnKGBbU1RET1VUXSAke2xpbmV9YCk7XG4gICAgICAgICAgfVxuICAgICAgICAgIGZvciAobGV0IGxpbmUgb2YgKHN0ZGVyciB8fCAnJykudHJpbSgpLnNwbGl0KCdcXG4nKSkge1xuICAgICAgICAgICAgaWYgKCFsaW5lLnRyaW0oKS5sZW5ndGgpIGNvbnRpbnVlOyAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIGN1cmx5XG4gICAgICAgICAgICBsb2cuZXJyb3IoYFtTVERFUlJdICR7bGluZX1gKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH0pO1xuXG4gICAgICAvLyBoYW5kbGUgb3V0LW9mLWJvdW5kIGV4aXQgYnkgc2ltcGx5IGVtaXR0aW5nIGEgc3RvcHBlZCBzdGF0ZVxuICAgICAgdGhpcy5wcm9jLm9uKCdleGl0JywgKGNvZGUsIHNpZ25hbCkgPT4ge1xuICAgICAgICBwcm9jZXNzSXNBbGl2ZSA9IGZhbHNlO1xuICAgICAgICBpZiAodGhpcy5zdGF0ZSAhPT0gQ2hyb21lZHJpdmVyLlNUQVRFX1NUT1BQRUQgJiZcbiAgICAgICAgICAgIHRoaXMuc3RhdGUgIT09IENocm9tZWRyaXZlci5TVEFURV9TVE9QUElORyAmJlxuICAgICAgICAgICAgdGhpcy5zdGF0ZSAhPT0gQ2hyb21lZHJpdmVyLlNUQVRFX1JFU1RBUlRJTkcpIHtcbiAgICAgICAgICBsZXQgbXNnID0gYENocm9tZWRyaXZlciBleGl0ZWQgdW5leHBlY3RlZGx5IHdpdGggY29kZSAke2NvZGV9LCBgICtcbiAgICAgICAgICAgICAgICAgICAgYHNpZ25hbCAke3NpZ25hbH1gO1xuICAgICAgICAgIGxvZy5lcnJvcihtc2cpO1xuICAgICAgICAgIHRoaXMuY2hhbmdlU3RhdGUoQ2hyb21lZHJpdmVyLlNUQVRFX1NUT1BQRUQpO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICAgIGxvZy5pbmZvKGBTcGF3bmluZyBjaHJvbWVkcml2ZXIgd2l0aDogJHt0aGlzLmNocm9tZWRyaXZlcn0gYCArXG4gICAgICAgICAgICAgICBgJHthcmdzLmpvaW4oJyAnKX1gKTtcbiAgICAgIC8vIHN0YXJ0IHN1YnByb2MgYW5kIHdhaXQgZm9yIHN0YXJ0RGV0ZWN0b3JcbiAgICAgIGF3YWl0IHRoaXMucHJvYy5zdGFydChzdGFydERldGVjdG9yKTtcbiAgICAgIGF3YWl0IHRoaXMud2FpdEZvck9ubGluZSgpO1xuICAgICAgYXdhaXQgdGhpcy5zdGFydFNlc3Npb24oKTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICB0aGlzLmVtaXQoQ2hyb21lZHJpdmVyLkVWRU5UX0VSUk9SLCBlKTtcbiAgICAgIC8vIGp1c3QgYmVjYXVzZSB3ZSBoYWQgYW4gZXJyb3IgZG9lc24ndCBtZWFuIHRoZSBjaHJvbWVkcml2ZXIgcHJvY2Vzc1xuICAgICAgLy8gZmluaXNoZWQ7IHdlIHNob3VsZCBjbGVhbiB1cCBpZiBuZWNlc3NhcnlcbiAgICAgIGlmIChwcm9jZXNzSXNBbGl2ZSkge1xuICAgICAgICBhd2FpdCB0aGlzLnByb2Muc3RvcCgpO1xuICAgICAgfVxuXG4gICAgICAvLyBvZnRlbiB0aGUgdXNlcidzIENocm9tZSB2ZXJzaW9uIGlzIHRvbyBsb3cgZm9yIHRoZSB2ZXJzaW9uIG9mIENocm9tZWRyaXZlclxuICAgICAgaWYgKGUubWVzc2FnZS5pbmRleE9mKCdDaHJvbWUgdmVyc2lvbiBtdXN0IGJlJykgIT09IC0xKSB7XG4gICAgICAgIGxvZy5lcnJvcignVW5hYmxlIHRvIGF1dG9tYXRlIENocm9tZSB2ZXJzaW9uIGJlY2F1c2UgaXQgaXMgdG9vIG9sZCBmb3IgdGhpcyB2ZXJzaW9uIG9mIENocm9tZWRyaXZlci4nKTtcbiAgICAgICAgaWYgKHdlYnZpZXdWZXJzaW9uKSB7XG4gICAgICAgICAgbG9nLmVycm9yKGBDaHJvbWUgdmVyc2lvbiBvbiBkZXZpY2U6ICR7d2Vidmlld1ZlcnNpb259YCk7XG4gICAgICAgIH1cbiAgICAgICAgbG9nLmVycm9yKGBQbGVhc2Ugc2VlICdodHRwczovL2dpdGh1Yi5jb20vYXBwaXVtL2FwcGl1bS9ibG9iL21hc3Rlci9kb2NzL2VuL3dyaXRpbmctcnVubmluZy1hcHBpdW0vd2ViL2Nocm9tZWRyaXZlci5tZCdgKTtcbiAgICAgIH1cbiAgICAgIGxvZy5lcnJvckFuZFRocm93KGUpO1xuICAgIH1cbiAgfVxuXG4gIHNlc3Npb25JZCAoKSB7XG4gICAgaWYgKHRoaXMuc3RhdGUgIT09IENocm9tZWRyaXZlci5TVEFURV9PTkxJTkUpIHtcbiAgICAgIHJldHVybiBudWxsO1xuICAgIH1cblxuICAgIHJldHVybiB0aGlzLmp3cHJveHkuc2Vzc2lvbklkO1xuICB9XG5cbiAgYXN5bmMgcmVzdGFydCAoKSB7XG4gICAgbG9nLmluZm8oXCJSZXN0YXJ0aW5nIGNocm9tZWRyaXZlclwiKTtcbiAgICBpZiAodGhpcy5zdGF0ZSAhPT0gQ2hyb21lZHJpdmVyLlNUQVRFX09OTElORSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFwiQ2FuJ3QgcmVzdGFydCB3aGVuIHdlJ3JlIG5vdCBvbmxpbmVcIik7XG4gICAgfVxuICAgIHRoaXMuY2hhbmdlU3RhdGUoQ2hyb21lZHJpdmVyLlNUQVRFX1JFU1RBUlRJTkcpO1xuICAgIGF3YWl0IHRoaXMuc3RvcChmYWxzZSk7XG4gICAgYXdhaXQgdGhpcy5zdGFydCh0aGlzLmNhcGFiaWxpdGllcywgZmFsc2UpO1xuICB9XG5cbiAgYXN5bmMgd2FpdEZvck9ubGluZSAoKSB7XG4gICAgLy8gd2UgbmVlZCB0byBtYWtlIHN1cmUgdGhhdCBDRCBoYXNuJ3QgY3Jhc2hlZFxuICAgIGxldCBjaHJvbWVkcml2ZXJTdG9wcGVkID0gZmFsc2U7XG4gICAgYXdhaXQgcmV0cnlJbnRlcnZhbCgyMCwgMjAwLCBhc3luYyAoKSA9PiB7XG4gICAgICBpZiAodGhpcy5zdGF0ZSA9PT0gQ2hyb21lZHJpdmVyLlNUQVRFX1NUT1BQRUQpIHtcbiAgICAgICAgLy8gd2UgYXJlIGVpdGhlciBzdG9wcGVkIG9yIHN0b3BwaW5nLCBzbyBzb21ldGhpbmcgd2VudCB3cm9uZ1xuICAgICAgICBjaHJvbWVkcml2ZXJTdG9wcGVkID0gdHJ1ZTtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuICAgICAgYXdhaXQgdGhpcy5nZXRTdGF0dXMoKTtcbiAgICB9KTtcbiAgICBpZiAoY2hyb21lZHJpdmVyU3RvcHBlZCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdDaHJvbWVEcml2ZXIgY3Jhc2hlZCBkdXJpbmcgc3RhcnR1cC4nKTtcbiAgICB9XG4gIH1cblxuICBhc3luYyBnZXRTdGF0dXMgKCkge1xuICAgIHJldHVybiBhd2FpdCB0aGlzLmp3cHJveHkuY29tbWFuZCgnL3N0YXR1cycsICdHRVQnKTtcbiAgfVxuXG4gIGFzeW5jIHN0YXJ0U2Vzc2lvbiAoKSB7XG4gICAgLy8gcmV0cnkgc2Vzc2lvbiBzdGFydCA0IHRpbWVzLCBzb21ldGltZXMgdGhpcyBmYWlscyBkdWUgdG8gYWRiXG4gICAgYXdhaXQgcmV0cnlJbnRlcnZhbCg0LCAyMDAsIGFzeW5jICgpID0+IHtcbiAgICAgIHRyeSB7XG4gICAgICAgIGxldCByZXMgPSBhd2FpdCB0aGlzLmp3cHJveHkuY29tbWFuZCgnL3Nlc3Npb24nLCAnUE9TVCcsIHtkZXNpcmVkQ2FwYWJpbGl0aWVzOiB0aGlzLmNhcGFiaWxpdGllc30pO1xuICAgICAgICAvLyBDaHJvbWVEcml2ZXIgY2FuIHJldHVybiBhIHBvc2l0aXZlIHN0YXR1cyBkZXNwaXRlIGZhaWxpbmdcbiAgICAgICAgaWYgKHJlcy5zdGF0dXMpIHtcbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IocmVzLnZhbHVlLm1lc3NhZ2UpO1xuICAgICAgICB9XG4gICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgbG9nLmVycm9yQW5kVGhyb3coYEZhaWxlZCB0byBzdGFydCBDaHJvbWVkcml2ZXIgc2Vzc2lvbjogJHtlcnIubWVzc2FnZX1gKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgICB0aGlzLmNoYW5nZVN0YXRlKENocm9tZWRyaXZlci5TVEFURV9PTkxJTkUpO1xuICB9XG5cbiAgYXN5bmMgc3RvcCAoZW1pdFN0YXRlcyA9IHRydWUpIHtcbiAgICBpZiAoZW1pdFN0YXRlcykge1xuICAgICAgdGhpcy5jaGFuZ2VTdGF0ZShDaHJvbWVkcml2ZXIuU1RBVEVfU1RPUFBJTkcpO1xuICAgIH1cbiAgICB0cnkge1xuICAgICAgYXdhaXQgdGhpcy5qd3Byb3h5LmNvbW1hbmQoJycsICdERUxFVEUnKTtcbiAgICAgIGF3YWl0IHRoaXMucHJvYy5zdG9wKCdTSUdURVJNJywgMjAwMDApO1xuICAgICAgaWYgKGVtaXRTdGF0ZXMpIHtcbiAgICAgICAgdGhpcy5jaGFuZ2VTdGF0ZShDaHJvbWVkcml2ZXIuU1RBVEVfU1RPUFBFRCk7XG4gICAgICB9XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgbG9nLmVycm9yKGUpO1xuICAgIH1cbiAgfVxuXG4gIGNoYW5nZVN0YXRlIChzdGF0ZSkge1xuICAgIHRoaXMuc3RhdGUgPSBzdGF0ZTtcbiAgICBsb2cuZGVidWcoYENoYW5nZWQgc3RhdGUgdG8gJyR7c3RhdGV9J2ApO1xuICAgIHRoaXMuZW1pdChDaHJvbWVkcml2ZXIuRVZFTlRfQ0hBTkdFRCwge3N0YXRlfSk7XG4gIH1cblxuICBhc3luYyBzZW5kQ29tbWFuZCAodXJsLCBtZXRob2QsIGJvZHkpIHtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5qd3Byb3h5LmNvbW1hbmQodXJsLCBtZXRob2QsIGJvZHkpO1xuICB9XG5cbiAgYXN5bmMgcHJveHlSZXEgKHJlcSwgcmVzKSB7XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMuandwcm94eS5wcm94eVJlcVJlcyhyZXEsIHJlcyk7XG4gIH1cblxuICBhc3luYyBraWxsQWxsICgpIHtcbiAgICBsZXQgY21kO1xuICAgIGlmIChzeXN0ZW0uaXNXaW5kb3dzKCkpIHtcbiAgICAgIC8vIGpzIGhpbnQgY2Fubm90IGhhbmRsZSBiYWNrdGlja3MsIGV2ZW4gZXNjYXBlZCwgd2l0aGluIHRlbXBsYXRlIGxpdGVyYWxzXG4gICAgICBjbWQgPSBcIkZPUiAvRiBcXFwidXNlYmFja3EgdG9rZW5zPTVcXFwiICVhIGluIChgbmV0c3RhdCAtbmFvIF58IFwiICtcbiAgICAgICAgICAgIFwiZmluZHN0ciAvUiAvQzpcXFwiXCIgKyB0aGlzLnByb3h5UG9ydCArIFwiIFxcXCJgKSBkbyAoXCIgK1xuICAgICAgICAgICAgXCJGT1IgL0YgXFxcInVzZWJhY2txXFxcIiAlYiBpbiAoYFRBU0tMSVNUIC9GSSBcXFwiUElEIGVxICVhXFxcIiBefCBcIiArXG4gICAgICAgICAgICBcImZpbmRzdHIgL0kgY2hyb21lZHJpdmVyLmV4ZWApIGRvIChJRiBOT1QgJWI9PVxcXCJcXFwiIFRBU0tLSUxMIFwiICtcbiAgICAgICAgICAgIFwiL0YgL1BJRCAlYSkpXCI7XG4gICAgfSBlbHNlIHtcbiAgICAgIGNtZCA9IGBwa2lsbCAtMTUgLWYgXCIke3RoaXMuY2hyb21lZHJpdmVyfS4qLS1wb3J0PSR7dGhpcy5wcm94eVBvcnR9XCJgO1xuICAgIH1cbiAgICBsb2cuZGVidWcoYEtpbGxpbmcgYW55IG9sZCBjaHJvbWVkcml2ZXJzLCBydW5uaW5nOiAke2NtZH1gKTtcbiAgICB0cnkge1xuICAgICAgYXdhaXQgKEIucHJvbWlzaWZ5KGNwLmV4ZWMpKShjbWQpO1xuICAgICAgbG9nLmRlYnVnKFwiU3VjY2Vzc2Z1bGx5IGNsZWFuZWQgdXAgb2xkIGNocm9tZWRyaXZlcnNcIik7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICBsb2cud2FybihcIk5vIG9sZCBjaHJvbWVkcml2ZXJzIHNlZW1lZCB0byBleGlzdFwiKTtcbiAgICB9XG5cbiAgICBpZiAodGhpcy5hZGIpIHtcbiAgICAgIGxvZy5kZWJ1ZyhgQ2xlYW5pbmcgYW55IG9sZCBhZGIgZm9yd2FyZGVkIHBvcnQgc29ja2V0IGNvbm5lY3Rpb25zYCk7XG4gICAgICB0cnkge1xuICAgICAgICBmb3IgKGxldCBjb25uIG9mIGF3YWl0IHRoaXMuYWRiLmdldEZvcndhcmRMaXN0KCkpIHtcbiAgICAgICAgICAvLyBjaHJvbWVkcml2ZXIgd2lsbCBhc2sgQURCIHRvIGZvcndhcmQgYSBwb3J0IGxpa2UgXCJkZXZpY2VJZCB0Y3A6cG9ydCBsb2NhbGFic3RyYWN0OndlYnZpZXdfZGV2dG9vbHNfcmVtb3RlX3BvcnRcIlxuICAgICAgICAgIGlmIChjb25uLmluZGV4T2YoJ3dlYnZpZXdfZGV2dG9vbHMnKSAhPT0gLTEpIHtcbiAgICAgICAgICAgIGxldCBwYXJhbXMgPSBjb25uLnNwbGl0KC9cXHMrLyk7XG4gICAgICAgICAgICBpZiAocGFyYW1zLmxlbmd0aCA+IDEpIHtcbiAgICAgICAgICAgICAgYXdhaXQgdGhpcy5hZGIucmVtb3ZlUG9ydEZvcndhcmQocGFyYW1zWzFdLnJlcGxhY2UoL1tcXERdKi8sICcnKSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgbG9nLndhcm4oYFVuYWJsZSB0byBjbGVhbiBmb3J3YXJkZWQgcG9ydHMuIEVycm9yOiAnJHtlcnIubWVzc2FnZX0nLiBDb250aW51aW5nLmApO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIGFzeW5jIGhhc1dvcmtpbmdXZWJ2aWV3ICgpIHtcbiAgICAvLyBzb21ldGltZXMgY2hyb21lZHJpdmVyIHN0b3BzIGF1dG9tYXRpbmcgd2Vidmlld3MuIHRoaXMgbWV0aG9kIHJ1bnMgYVxuICAgIC8vIHNpbXBsZSBjb21tYW5kIHRvIGRldGVybWluZSBvdXIgc3RhdGUsIGFuZCByZXNwb25kcyBhY2NvcmRpbmdseVxuICAgIHRyeSB7XG4gICAgICBhd2FpdCB0aGlzLmp3cHJveHkuY29tbWFuZCgnL3VybCcsICdHRVQnKTtcbiAgICAgIHJldHVybiB0cnVlO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG4gIH1cbn1cblxuQ2hyb21lZHJpdmVyLkVWRU5UX0VSUk9SID0gJ2Nocm9tZWRyaXZlcl9lcnJvcic7XG5DaHJvbWVkcml2ZXIuRVZFTlRfQ0hBTkdFRCA9ICdzdGF0ZUNoYW5nZWQnO1xuQ2hyb21lZHJpdmVyLlNUQVRFX1NUT1BQRUQgPSAnc3RvcHBlZCc7XG5DaHJvbWVkcml2ZXIuU1RBVEVfU1RBUlRJTkcgPSAnc3RhcnRpbmcnO1xuQ2hyb21lZHJpdmVyLlNUQVRFX09OTElORSA9ICdvbmxpbmUnO1xuQ2hyb21lZHJpdmVyLlNUQVRFX1NUT1BQSU5HID0gJ3N0b3BwaW5nJztcbkNocm9tZWRyaXZlci5TVEFURV9SRVNUQVJUSU5HID0gJ3Jlc3RhcnRpbmcnO1xuXG5leHBvcnQgZGVmYXVsdCBDaHJvbWVkcml2ZXI7XG4iXSwic291cmNlUm9vdCI6Ii4uLy4uIn0=

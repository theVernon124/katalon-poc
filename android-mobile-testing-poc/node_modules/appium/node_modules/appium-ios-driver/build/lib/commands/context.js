'use strict';

var _slicedToArray = require('babel-runtime/helpers/sliced-to-array')['default'];

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _getIterator = require('babel-runtime/core-js/get-iterator')['default'];

var _Object$assign = require('babel-runtime/core-js/object/assign')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _bluebird = require('bluebird');

var _bluebird2 = _interopRequireDefault(_bluebird);

var _asyncbox = require('asyncbox');

var _appiumRemoteDebugger = require('appium-remote-debugger');

var _deviceLogIosPerformanceLog = require('../device-log/ios-performance-log');

var _deviceLogIosPerformanceLog2 = _interopRequireDefault(_deviceLogIosPerformanceLog);

var _appiumBaseDriver = require('appium-base-driver');

var _logger = require('../logger');

var _logger2 = _interopRequireDefault(_logger);

var _appiumSupport = require('appium-support');

var NATIVE_WIN = 'NATIVE_APP';
var WEBVIEW_WIN = 'WEBVIEW';
var WEBVIEW_BASE = WEBVIEW_WIN + '_';

var commands = {},
    helpers = {},
    extensions = {};

commands.getCurrentContext = function callee$0$0() {
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (!(this.curContext && this.curContext !== NATIVE_WIN)) {
          context$1$0.next = 4;
          break;
        }

        return context$1$0.abrupt('return', '' + WEBVIEW_BASE + this.curContext);

      case 4:
        return context$1$0.abrupt('return', NATIVE_WIN);

      case 5:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

commands.getContexts = function callee$0$0() {
  var contexts, mapFn;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        _logger2['default'].debug('Getting list of available contexts');
        context$1$0.next = 3;
        return _regeneratorRuntime.awrap(this.getContextsAndViews(false));

      case 3:
        contexts = context$1$0.sent;

        mapFn = function mapFn(context) {
          return context.id.toString();
        };

        if (this.opts.fullContextList) {
          mapFn = function (context) {
            return {
              id: context.id.toString(),
              title: context.view.title,
              url: context.view.url
            };
          };
        }
        return context$1$0.abrupt('return', contexts.map(mapFn));

      case 7:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

commands.setContext = function callee$0$0(name, callback, skipReadyCheck) {
  var alreadyInContext, contextId, _$map, _$map2, appIdKey, pageIdKey;

  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        alreadyInContext = function alreadyInContext(desired, current) {
          return desired === current || desired === null && current === NATIVE_WIN || desired === NATIVE_WIN && current === null;
        };

        _logger2['default'].debug('Attempting to set context to \'' + name + '\'');

        if (!alreadyInContext(name, this.curContext)) {
          context$1$0.next = 5;
          break;
        }

        context$1$0.next = 33;
        break;

      case 5:
        if (!(name === NATIVE_WIN || name === null)) {
          context$1$0.next = 10;
          break;
        }

        // switching into the native context
        this.curContext = null;
        if (this.isRealDevice()) {
          this.remote.disconnect();
        }
        context$1$0.next = 33;
        break;

      case 10:
        if (!_lodash2['default'].isUndefined(this.contexts)) {
          context$1$0.next = 13;
          break;
        }

        context$1$0.next = 13;
        return _regeneratorRuntime.awrap(this.getContexts());

      case 13:
        contextId = name.replace(WEBVIEW_BASE, '');

        if (contextId === '') {
          // allow user to pass in "WEBVIEW" without an index
          // the second context will be the first webview as
          // the first is always NATIVE_APP
          contextId = this.contexts[1];
        }

        if (_lodash2['default'].includes(this.contexts, contextId)) {
          context$1$0.next = 17;
          break;
        }

        throw new _appiumBaseDriver.errors.NoSuchContextError();

      case 17:
        if (!this.isRealDevice()) {
          context$1$0.next = 26;
          break;
        }

        if (!this.remote) {
          context$1$0.next = 21;
          break;
        }

        context$1$0.next = 21;
        return _regeneratorRuntime.awrap(this.remote.disconnect());

      case 21:
        this.curContext = contextId;
        context$1$0.next = 24;
        return _regeneratorRuntime.awrap(this.remote.connect(contextId));

      case 24:
        context$1$0.next = 33;
        break;

      case 26:
        _$map = _lodash2['default'].map(contextId.split('.'), function (id) {
          return parseInt(id, 10);
        });
        _$map2 = _slicedToArray(_$map, 2);
        appIdKey = _$map2[0];
        pageIdKey = _$map2[1];
        context$1$0.next = 32;
        return _regeneratorRuntime.awrap(this.remote.selectPage(appIdKey, pageIdKey, skipReadyCheck));

      case 32:
        this.curContext = contextId;

      case 33:
        if (!(this.opts.enablePerformanceLogging && this.remote)) {
          context$1$0.next = 38;
          break;
        }

        _logger2['default'].debug('Starting performance log on \'' + this.curContext + '\'');
        this.logs.performance = new _deviceLogIosPerformanceLog2['default'](this.remote);
        context$1$0.next = 38;
        return _regeneratorRuntime.awrap(this.logs.performance.startCapture());

      case 38:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

commands.getWindowHandle = function callee$0$0() {
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (this.isWebContext()) {
          context$1$0.next = 2;
          break;
        }

        throw new _appiumBaseDriver.errors.NotImplementedError();

      case 2:
        return context$1$0.abrupt('return', this.curContext.toString());

      case 3:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

commands.getWindowHandles = function callee$0$0() {
  var pageArray, idArray;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (this.isWebContext()) {
          context$1$0.next = 2;
          break;
        }

        throw new _appiumBaseDriver.errors.NotImplementedError();

      case 2:
        context$1$0.next = 4;
        return _regeneratorRuntime.awrap(this.listWebFrames());

      case 4:
        pageArray = context$1$0.sent;

        this.windowHandleCache = _lodash2['default'].map(pageArray, this.massagePage);
        idArray = _lodash2['default'].map(this.windowHandleCache, 'id');

        // since we use this.contexts to manage selecting debugger pages, make
        // sure it gets populated even if someone did not use the
        // getContexts method
        if (!this.contexts) {
          this.contexts = idArray;
        }
        return context$1$0.abrupt('return', _lodash2['default'].map(idArray, function (id) {
          return id.toString();
        }));

      case 9:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

commands.setWindow = function callee$0$0(name, skipReadyCheck) {
  var pageIdKey;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (this.isWebContext()) {
          context$1$0.next = 2;
          break;
        }

        throw new _appiumBaseDriver.errors.NotImplementedError();

      case 2:
        if (_lodash2['default'].includes(_lodash2['default'].map(this.windowHandleCache, 'id'), name)) {
          context$1$0.next = 4;
          break;
        }

        throw new _appiumBaseDriver.errors.NoSuchWindowError();

      case 4:
        pageIdKey = parseInt(name, 10);

        if (this.isRealDevice()) {
          context$1$0.next = 11;
          break;
        }

        context$1$0.next = 8;
        return _regeneratorRuntime.awrap(this.remote.selectPage(pageIdKey, skipReadyCheck));

      case 8:
        this.curContext = this.curWindowHandle = name;
        context$1$0.next = 24;
        break;

      case 11:
        if (!(name === this.curWindowHandle)) {
          context$1$0.next = 15;
          break;
        }

        _logger2['default'].debug('Remote debugger is already connected to window \'' + name + '\'');
        context$1$0.next = 24;
        break;

      case 15:
        if (_lodash2['default'].includes(_lodash2['default'].map(this.windowHandleCache, 'id'), name)) {
          context$1$0.next = 19;
          break;
        }

        throw new _appiumBaseDriver.errors.NoSuchWindowError();

      case 19:
        context$1$0.next = 21;
        return _regeneratorRuntime.awrap(this.remote.disconnect());

      case 21:
        this.curContext = this.curWindowHandle = name;
        context$1$0.next = 24;
        return _regeneratorRuntime.awrap(this.remote.connect(name));

      case 24:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

helpers.webContextIndex = function () {
  return this.curContext.replace(WEBVIEW_BASE, '') - 1;
};

extensions.initAutoWebview = function callee$0$0() {
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (!this.opts.autoWebview) {
          context$1$0.next = 4;
          break;
        }

        _logger2['default'].debug('Setting auto webview');
        context$1$0.next = 4;
        return _regeneratorRuntime.awrap(this.navToInitialWebview(this));

      case 4:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

extensions.getContextsAndViews = function callee$0$0() {
  var useUrl = arguments.length <= 0 || arguments[0] === undefined ? true : arguments[0];

  var webviews, ctxs, _iteratorNormalCompletion, _didIteratorError, _iteratorError, _iterator, _step, view;

  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        _logger2['default'].debug('Retrieving contexts and views');
        context$1$0.next = 3;
        return _regeneratorRuntime.awrap(this.listWebFrames(useUrl));

      case 3:
        webviews = context$1$0.sent;
        ctxs = [{ id: NATIVE_WIN, view: {} }];

        this.contexts = [NATIVE_WIN];
        _iteratorNormalCompletion = true;
        _didIteratorError = false;
        _iteratorError = undefined;
        context$1$0.prev = 9;
        for (_iterator = _getIterator(webviews); !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {
          view = _step.value;

          ctxs.push({ id: '' + WEBVIEW_BASE + view.id, view: view });
          this.contexts.push(view.id.toString());
        }
        context$1$0.next = 17;
        break;

      case 13:
        context$1$0.prev = 13;
        context$1$0.t0 = context$1$0['catch'](9);
        _didIteratorError = true;
        _iteratorError = context$1$0.t0;

      case 17:
        context$1$0.prev = 17;
        context$1$0.prev = 18;

        if (!_iteratorNormalCompletion && _iterator['return']) {
          _iterator['return']();
        }

      case 20:
        context$1$0.prev = 20;

        if (!_didIteratorError) {
          context$1$0.next = 23;
          break;
        }

        throw _iteratorError;

      case 23:
        return context$1$0.finish(20);

      case 24:
        return context$1$0.finish(17);

      case 25:
        return context$1$0.abrupt('return', ctxs);

      case 26:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[9, 13, 17, 25], [18,, 20, 24]]);
};

extensions.getNewRemoteDebugger = function callee$0$0() {
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        return context$1$0.abrupt('return', new _appiumRemoteDebugger.RemoteDebugger({
          bundleId: this.opts.bundleId,
          useNewSafari: this.useNewSafari(),
          pageLoadMs: this.pageLoadMs,
          platformVersion: this.opts.platformVersion
        }));

      case 1:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

extensions.listWebFrames = function callee$0$0() {
  var useUrl = arguments.length <= 0 || arguments[0] === undefined ? true : arguments[0];
  var currentUrl, pageArray, appInfo, tryClosingAlert;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    var _this = this;

    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (!this.opts.bundleId) {
          _logger2['default'].errorAndThrow('Cannot enter web frame without a bundle ID');
        }

        useUrl = useUrl && !!this.getCurrentUrl();
        _logger2['default'].debug('Selecting by url: ' + useUrl + ' ' + (useUrl ? '(expected url: \'' + this.getCurrentUrl() + '\')' : ''));

        currentUrl = useUrl ? this.getCurrentUrl() : undefined;
        pageArray = undefined;

        if (!(this.isRealDevice() && this.remote && this.opts.bundleId)) {
          context$1$0.next = 11;
          break;
        }

        context$1$0.next = 8;
        return _regeneratorRuntime.awrap(this.remote.pageArrayFromJson(this.opts.ignoreAboutBlankUrl));

      case 8:
        pageArray = context$1$0.sent;
        context$1$0.next = 56;
        break;

      case 11:
        if (!(this.remote && this.remote.appIdKey)) {
          context$1$0.next = 17;
          break;
        }

        context$1$0.next = 14;
        return _regeneratorRuntime.awrap(this.remote.selectApp(currentUrl, this.opts.webviewConnectRetries, this.opts.ignoreAboutBlankUrl));

      case 14:
        pageArray = context$1$0.sent;
        context$1$0.next = 56;
        break;

      case 17:
        if (!this.isRealDevice()) {
          context$1$0.next = 34;
          break;
        }

        context$1$0.prev = 18;

        this.remote = new _appiumRemoteDebugger.WebKitRemoteDebugger({
          port: this.opts.webkitDebugProxyPort,
          webkitResponseTimeout: this.opts.webkitResponseTimeout
        });
        context$1$0.next = 22;
        return _regeneratorRuntime.awrap(this.remote.pageArrayFromJson(this.opts.ignoreAboutBlankUrl));

      case 22:
        pageArray = context$1$0.sent;
        context$1$0.next = 32;
        break;

      case 25:
        context$1$0.prev = 25;
        context$1$0.t0 = context$1$0['catch'](18);

        if (_lodash2['default'].includes(context$1$0.t0.message, 'connect ECONNREFUSED')) {
          context$1$0.next = 29;
          break;
        }

        throw context$1$0.t0;

      case 29:
        // eslint-disable-line curly

        _logger2['default'].warn('Attempted to get a list of webview contexts but could not connect to ' + 'ios-webkit-debug-proxy. If you expect to find webviews, please ensure ' + 'that the proxy is running and accessible');
        this.remote = null;
        pageArray = [];

      case 32:
        context$1$0.next = 56;
        break;

      case 34:
        context$1$0.next = 36;
        return _regeneratorRuntime.awrap(this.getNewRemoteDebugger());

      case 36:
        this.remote = context$1$0.sent;
        context$1$0.next = 39;
        return _regeneratorRuntime.awrap(this.remote.connect());

      case 39:
        appInfo = context$1$0.sent;

        if (appInfo) {
          context$1$0.next = 43;
          break;
        }

        _logger2['default'].debug('Unable to connect to the remote debugger.');
        return context$1$0.abrupt('return', []);

      case 43:
        context$1$0.next = 45;
        return _regeneratorRuntime.awrap(this.remote.selectApp(currentUrl, this.opts.webviewConnectRetries, this.opts.ignoreAboutBlankUrl));

      case 45:
        pageArray = context$1$0.sent;

        this.remote.on(_appiumRemoteDebugger.RemoteDebugger.EVENT_PAGE_CHANGE, this.onPageChange.bind(this));

        tryClosingAlert = function tryClosingAlert() {
          var didDismiss;
          return _regeneratorRuntime.async(function tryClosingAlert$(context$2$0) {
            while (1) switch (context$2$0.prev = context$2$0.next) {
              case 0:
                context$2$0.next = 2;
                return _regeneratorRuntime.awrap(this.closeAlertBeforeTest());

              case 2:
                didDismiss = context$2$0.sent;

                if (didDismiss) {
                  context$2$0.next = 5;
                  break;
                }

                throw new Error('Close alert failed. Retry.');

              case 5:
              case 'end':
                return context$2$0.stop();
            }
          }, null, _this);
        };

        context$1$0.prev = 48;
        context$1$0.next = 51;
        return _regeneratorRuntime.awrap((0, _asyncbox.retryInterval)(3, 4000, tryClosingAlert));

      case 51:
        context$1$0.next = 56;
        break;

      case 53:
        context$1$0.prev = 53;
        context$1$0.t1 = context$1$0['catch'](48);

        // if the loop to close alerts failed to dismiss, ignore,
        // otherwise log and throw the error
        if (context$1$0.t1.message !== 'Close alert failed. Retry.') {
          _logger2['default'].errorAndThrow(context$1$0.t1);
        }

      case 56:

        if (pageArray.length === 0) {
          // we have no web frames, but continue anyway
          _logger2['default'].debug('No web frames found.');
        }
        return context$1$0.abrupt('return', pageArray);

      case 58:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[18, 25], [48, 53]]);
};

extensions.onPageChange = function callee$0$0(pageChangeNotification) {
  var appIdKey, pageArray, newIds, newPages, keyId, _iteratorNormalCompletion2, _didIteratorError2, _iteratorError2, _iterator2, _step2, page, id, contextId, newPage, _curContext$split, _curContext$split2, curAppIdKey, curPageIdKey, needsPageLoad;

  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    var _this2 = this;

    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        _logger2['default'].debug('Remote debugger notified us of a new page listing: ' + JSON.stringify(pageChangeNotification));

        if (!this.selectingNewPage) {
          context$1$0.next = 4;
          break;
        }

        _logger2['default'].debug('We are in the middle of selecting a page, ignoring');
        return context$1$0.abrupt('return');

      case 4:
        if (this.remote.appIdKey) {
          context$1$0.next = 7;
          break;
        }

        _logger2['default'].debug('We have not yet connected, ignoring');
        return context$1$0.abrupt('return');

      case 7:
        appIdKey = pageChangeNotification.appIdKey;
        pageArray = pageChangeNotification.pageArray;
        newIds = [];
        newPages = [];
        keyId = null;
        _iteratorNormalCompletion2 = true;
        _didIteratorError2 = false;
        _iteratorError2 = undefined;
        context$1$0.prev = 15;

        for (_iterator2 = _getIterator(pageArray); !(_iteratorNormalCompletion2 = (_step2 = _iterator2.next()).done); _iteratorNormalCompletion2 = true) {
          page = _step2.value;
          id = page.id.toString();

          newIds.push(id);
          if (page.isKey) {
            keyId = id;
          }
          contextId = appIdKey + '.' + id;

          if (!_lodash2['default'].includes(this.contexts, contextId)) {
            newPages.push(id);
            this.contexts.push(contextId);
          }
        }

        context$1$0.next = 23;
        break;

      case 19:
        context$1$0.prev = 19;
        context$1$0.t0 = context$1$0['catch'](15);
        _didIteratorError2 = true;
        _iteratorError2 = context$1$0.t0;

      case 23:
        context$1$0.prev = 23;
        context$1$0.prev = 24;

        if (!_iteratorNormalCompletion2 && _iterator2['return']) {
          _iterator2['return']();
        }

      case 26:
        context$1$0.prev = 26;

        if (!_didIteratorError2) {
          context$1$0.next = 29;
          break;
        }

        throw _iteratorError2;

      case 29:
        return context$1$0.finish(26);

      case 30:
        return context$1$0.finish(23);

      case 31:
        if (!keyId) {
          // if there is no key id, pull the first id from the page array and use that
          // as a stand in
          _logger2['default'].debug('No key id found. Choosing first id from page array');
          keyId = newIds[0] || null;
        }

        newPage = null;

        if (!(this.curContext === null)) {
          context$1$0.next = 37;
          break;
        }

        _logger2['default'].debug('We do not appear to have window set yet, ignoring');
        context$1$0.next = 69;
        break;

      case 37:
        _curContext$split = this.curContext.split('.');
        _curContext$split2 = _slicedToArray(_curContext$split, 2);
        curAppIdKey = _curContext$split2[0];
        curPageIdKey = _curContext$split2[1];

        if (!(curAppIdKey !== appIdKey)) {
          context$1$0.next = 44;
          break;
        }

        _logger2['default'].debug('Page change not referring to currently selected app, ignoring.');
        return context$1$0.abrupt('return');

      case 44:
        if (!newPages.length) {
          context$1$0.next = 49;
          break;
        }

        newPage = _lodash2['default'].last(newPages);
        _logger2['default'].debug('We have new pages, going to select page \'' + newPage + '\'');
        context$1$0.next = 69;
        break;

      case 49:
        if (_lodash2['default'].includes(newIds, curPageIdKey)) {
          context$1$0.next = 62;
          break;
        }

        _logger2['default'].debug('New page listing from remote debugger does not contain ' + 'current window; assuming it is closed');

        if (!(keyId !== null)) {
          context$1$0.next = 55;
          break;
        }

        _logger2['default'].debug('Debugger already selected page \'' + keyId + '\', ' + 'confirming that choice.');
        context$1$0.next = 58;
        break;

      case 55:
        _logger2['default'].error('Do not have our current window anymore, and there ' + 'are not any more to load! Doing nothing...');
        this.setCurrentUrl(undefined);
        return context$1$0.abrupt('return');

      case 58:
        this.curContext = appIdKey + '.' + keyId;
        newPage = keyId;
        context$1$0.next = 69;
        break;

      case 62:
        _logger2['default'].debug('Checking if page needs to load');
        // If a window navigates to an anchor it doesn't always fire a page
        // callback event. Let's check if we wound up in such a situation.

        needsPageLoad = (function () {
          // need to map the page ids to context ids
          var contextArray = _lodash2['default'].map(pageArray, function (arr) {
            return appIdKey + '.' + arr.id;
          });
          return !_lodash2['default'].isEqual(_lodash2['default'].find(_this2.contexts, _this2.curContext), _lodash2['default'].find(contextArray, _this2.curContext));
        })();

        if (!needsPageLoad) {
          context$1$0.next = 68;
          break;
        }

        _logger2['default'].debug('Page load needed. Loading...');
        context$1$0.next = 68;
        return _regeneratorRuntime.awrap(this.remote.pageLoad());

      case 68:

        _logger2['default'].debug('New page listing is same as old, doing nothing');

      case 69:

        // make sure that the page listing isn't indicating a redirect
        if (_appiumSupport.util.hasValue(this.curContext)) {
          (function () {
            var currentPageId = parseInt(_lodash2['default'].last(_this2.curContext.split('.')), 10);
            var page = _lodash2['default'].find(pageArray, function (p) {
              return parseInt(p.id, 10) === currentPageId;
            });
            if (page && page.url !== _this2.getCurrentUrl()) {
              _logger2['default'].debug('Redirected from \'' + _this2.getCurrentUrl() + '\' to \'' + page.url + '\'');
              _this2.setCurrentUrl(page.url);
            }
          })();
        }

        if (!_appiumSupport.util.hasValue(newPage)) {
          context$1$0.next = 76;
          break;
        }

        this.selectingNewPage = true;
        context$1$0.next = 74;
        return _regeneratorRuntime.awrap(this.remote.selectPage(appIdKey, parseInt(newPage, 10)));

      case 74:
        this.selectingNewPage = false;
        this.curContext = appIdKey + '.' + newPage;

      case 76:
        this.windowHandleCache = _lodash2['default'].map(pageArray, this.massagePage);

      case 77:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[15, 19, 23, 31], [24,, 26, 30]]);
};

extensions.getLatestWebviewContextForTitle = function callee$0$0(regExp) {
  var contexts, matchingCtx, _iteratorNormalCompletion3, _didIteratorError3, _iteratorError3, _iterator3, _step3, ctx;

  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.next = 2;
        return _regeneratorRuntime.awrap(this.getContextsAndViews());

      case 2:
        contexts = context$1$0.sent;
        matchingCtx = undefined;
        _iteratorNormalCompletion3 = true;
        _didIteratorError3 = false;
        _iteratorError3 = undefined;
        context$1$0.prev = 7;
        _iterator3 = _getIterator(contexts);

      case 9:
        if (_iteratorNormalCompletion3 = (_step3 = _iterator3.next()).done) {
          context$1$0.next = 17;
          break;
        }

        ctx = _step3.value;

        if (!(ctx.view && (ctx.view.title && ctx.view.title.match(regExp) || ctx.view.url && ctx.view.url.match(regExp)))) {
          context$1$0.next = 14;
          break;
        }

        if (ctx.view.url !== 'about:blank') {
          matchingCtx = ctx;
        } else {
          // in the cases of Xcode < 5 (i.e., iOS SDK Version less than 7)
          // iOS 7.1, iOS 9.0 & iOS 9.1 in a webview (not in Safari)
          // we can have the url be `about:blank`
          if (parseFloat(this.iosSdkVersion) < 7 || parseFloat(this.iosSdkVersion) >= 9 || this.opts.platformVersion === '7.1' && this.opts.app && this.opts.app.toLowerCase() !== 'safari') {
            matchingCtx = ctx;
          }
        }
        return context$1$0.abrupt('break', 17);

      case 14:
        _iteratorNormalCompletion3 = true;
        context$1$0.next = 9;
        break;

      case 17:
        context$1$0.next = 23;
        break;

      case 19:
        context$1$0.prev = 19;
        context$1$0.t0 = context$1$0['catch'](7);
        _didIteratorError3 = true;
        _iteratorError3 = context$1$0.t0;

      case 23:
        context$1$0.prev = 23;
        context$1$0.prev = 24;

        if (!_iteratorNormalCompletion3 && _iterator3['return']) {
          _iterator3['return']();
        }

      case 26:
        context$1$0.prev = 26;

        if (!_didIteratorError3) {
          context$1$0.next = 29;
          break;
        }

        throw _iteratorError3;

      case 29:
        return context$1$0.finish(26);

      case 30:
        return context$1$0.finish(23);

      case 31:
        return context$1$0.abrupt('return', matchingCtx ? matchingCtx.id : undefined);

      case 32:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[7, 19, 23, 31], [24,, 26, 30]]);
};

// Right now we don't necessarily wait for webview
// and frame to load, which leads to race conditions and flakiness,
// let's see if we can transition to something better
extensions.useNewSafari = function () {
  return parseFloat(this.iosSdkVersion) >= 8.1 && parseFloat(this.opts.platformVersion) >= 8.1 && !this.isRealDevice() && this.opts.safari;
};

extensions.navToInitialWebview = function callee$0$0() {
  var timeout;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        timeout = 0;

        if (this.isRealDevice()) {
          timeout = 3000;
          _logger2['default'].debug('Waiting for ' + timeout + ' ms before navigating to view.');
        }
        context$1$0.next = 4;
        return _regeneratorRuntime.awrap(_bluebird2['default'].delay(timeout));

      case 4:
        if (!this.useNewSafari()) {
          context$1$0.next = 9;
          break;
        }

        context$1$0.next = 7;
        return _regeneratorRuntime.awrap(this.typeAndNavToUrl());

      case 7:
        context$1$0.next = 16;
        break;

      case 9:
        if (!(parseInt(this.iosSdkVersion, 10) >= 7 && !this.isRealDevice() && this.opts.safari)) {
          context$1$0.next = 14;
          break;
        }

        context$1$0.next = 12;
        return _regeneratorRuntime.awrap(this.navToViewThroughFavorites());

      case 12:
        context$1$0.next = 16;
        break;

      case 14:
        context$1$0.next = 16;
        return _regeneratorRuntime.awrap(this.navToViewWithTitle(/.*/));

      case 16:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

function openNewPage() {
  var newPageButton;
  return _regeneratorRuntime.async(function openNewPage$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.next = 2;
        return _regeneratorRuntime.awrap(this.findElement('xpath', "//UIAButton[contains(@name,'New page')]"));

      case 2:
        newPageButton = context$1$0.sent;
        context$1$0.next = 5;
        return _regeneratorRuntime.awrap(this.nativeTap(newPageButton.ELEMENT));

      case 5:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

extensions.typeAndNavToUrl = function callee$0$0() {
  var address, tries, MAX_TRIES, navigate;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    var _this4 = this;

    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        address = this.opts.address ? this.opts.address : '127.0.0.1';

        this.setCurrentUrl(this.caps.safariInitialUrl || 'http://' + address + ':' + this.opts.port + '/welcome');

        tries = 0;
        MAX_TRIES = 2;

        navigate = function navigate() {
          var oldImpWait, el, _el;

          return _regeneratorRuntime.async(function navigate$(context$2$0) {
            var _this3 = this;

            while (1) switch (context$2$0.prev = context$2$0.next) {
              case 0:
                oldImpWait = this.implicitWaitMs;

                this.implicitWaitMs = 7000;

                // find the url bar, and tap on it. retry to make sure we don't try
                // too soon while the view is still loading
                context$2$0.next = 4;
                return _regeneratorRuntime.awrap((0, _asyncbox.retryInterval)(3, 1000, function callee$2$0() {
                  return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
                    while (1) switch (context$3$0.prev = context$3$0.next) {
                      case 0:
                        context$3$0.next = 2;
                        return _regeneratorRuntime.awrap(this.findElement('accessibility id', 'URL'));

                      case 2:
                        return context$3$0.abrupt('return', context$3$0.sent);

                      case 3:
                      case 'end':
                        return context$3$0.stop();
                    }
                  }, null, _this3);
                }));

              case 4:
                el = context$2$0.sent;

                this.implicitWaitMs = oldImpWait;

                context$2$0.prev = 6;
                context$2$0.next = 9;
                return _regeneratorRuntime.awrap(this.nativeTap(el.ELEMENT));

              case 9:
                context$2$0.next = 24;
                break;

              case 11:
                context$2$0.prev = 11;
                context$2$0.t0 = context$2$0['catch'](6);

                if (!_lodash2['default'].includes(context$2$0.t0.message, 'could not be tapped')) {
                  context$2$0.next = 23;
                  break;
                }

                if (!(tries++ >= MAX_TRIES)) {
                  context$2$0.next = 16;
                  break;
                }

                throw context$2$0.t0;

              case 16:
                context$2$0.next = 18;
                return _regeneratorRuntime.awrap(openNewPage());

              case 18:
                context$2$0.next = 20;
                return _regeneratorRuntime.awrap(navigate());

              case 20:
                return context$2$0.abrupt('return', context$2$0.sent);

              case 23:
                throw context$2$0.t0;

              case 24:
                context$2$0.prev = 24;
                context$2$0.next = 27;
                return _regeneratorRuntime.awrap(this.findElement('class name', 'UIATextField'));

              case 27:
                _el = context$2$0.sent;
                context$2$0.next = 30;
                return _regeneratorRuntime.awrap(this.setValueImmediate(this.getCurrentUrl(), _el));

              case 30:
                context$2$0.next = 39;
                break;

              case 32:
                context$2$0.prev = 32;
                context$2$0.t1 = context$2$0['catch'](24);

                if (!(tries++ >= MAX_TRIES)) {
                  context$2$0.next = 36;
                  break;
                }

                throw context$2$0.t1;

              case 36:
                context$2$0.next = 38;
                return _regeneratorRuntime.awrap(navigate());

              case 38:
                return context$2$0.abrupt('return', context$2$0.sent);

              case 39:
                context$2$0.prev = 39;
                context$2$0.next = 42;
                return _regeneratorRuntime.awrap(this.findElement('accessibility id', 'Go'));

              case 42:
                el = context$2$0.sent;
                context$2$0.next = 45;
                return _regeneratorRuntime.awrap(this.nativeTap(el.ELEMENT));

              case 45:
                context$2$0.next = 51;
                break;

              case 47:
                context$2$0.prev = 47;
                context$2$0.t2 = context$2$0['catch'](39);

                if (_lodash2['default'].includes(context$2$0.t2.message, 'could not be tapped')) {
                  _logger2['default'].error('Unable to submit URL because \'Go\' button could not be tapped. ' + 'Please make sure your keyboard is toggled on.');
                }
                throw context$2$0.t2;

              case 51:
                context$2$0.next = 53;
                return _regeneratorRuntime.awrap(this.navToViewWithTitle(undefined, new RegExp(this.getCurrentUrl(), 'i')));

              case 53:
                context$2$0.next = 55;
                return _regeneratorRuntime.awrap(this.remote.pageUnload());

              case 55:
              case 'end':
                return context$2$0.stop();
            }
          }, null, _this4, [[6, 11], [24, 32], [39, 47]]);
        };

        context$1$0.next = 7;
        return _regeneratorRuntime.awrap(navigate());

      case 7:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

extensions.navToViewThroughFavorites = function callee$0$0() {
  var oldImpWait, el, msg;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        _logger2['default'].debug('We are on iOS7+ simulator: clicking apple button to get into a webview');
        oldImpWait = this.implicitWaitMs;

        this.implicitWaitMs = 7000; // wait 7s for apple button to exist

        el = undefined;
        context$1$0.prev = 4;
        context$1$0.next = 7;
        return _regeneratorRuntime.awrap(this.findElement('xpath', '//UIAScrollView[1]/UIAButton[1]'));

      case 7:
        el = context$1$0.sent;
        context$1$0.next = 18;
        break;

      case 10:
        context$1$0.prev = 10;
        context$1$0.t0 = context$1$0['catch'](4);
        msg = 'Could not find button to click to get into webview. ' + 'Proceeding on the assumption we have a working one.';

        _logger2['default'].error(msg);
        this.implicitWaitMs = oldImpWait;
        context$1$0.next = 17;
        return _regeneratorRuntime.awrap(this.navToViewWithTitle(/.*/i));

      case 17:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 18:
        this.implicitWaitMs = oldImpWait;
        context$1$0.prev = 19;
        context$1$0.next = 22;
        return _regeneratorRuntime.awrap(this.nativeTap(el.ELEMENT));

      case 22:
        context$1$0.next = 28;
        break;

      case 24:
        context$1$0.prev = 24;
        context$1$0.t1 = context$1$0['catch'](19);
        msg = 'Could not click button to get into webview. ' + 'Proceeding on the assumption we have a working one.';

        _logger2['default'].error(msg);

      case 28:
        context$1$0.next = 30;
        return _regeneratorRuntime.awrap(this.navToViewWithTitle(/apple/i));

      case 30:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[4, 10], [19, 24]]);
};

extensions.navToViewWithTitle = function callee$0$0(titleRegex, urlRegExp) {
  var start, spinTime, spinHandles;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    var _this5 = this;

    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        _logger2['default'].debug('Navigating to most recently opened webview');
        start = Date.now();
        spinTime = 500;

        spinHandles = function spinHandles() {
          var res, latestWindow, element;
          return _regeneratorRuntime.async(function spinHandles$(context$2$0) {
            while (1) switch (context$2$0.prev = context$2$0.next) {
              case 0:
                res = undefined;
                context$2$0.prev = 1;
                context$2$0.next = 4;
                return _regeneratorRuntime.awrap(this.getLatestWebviewContextForTitle(titleRegex || urlRegExp));

              case 4:
                res = context$2$0.sent;
                context$2$0.next = 12;
                break;

              case 7:
                context$2$0.prev = 7;
                context$2$0.t0 = context$2$0['catch'](1);

                if (!(context$2$0.t0.message.indexOf('Could not connect to a valid app after') === -1)) {
                  context$2$0.next = 11;
                  break;
                }

                throw new Error('Could not navigate to webview! Err: ' + context$2$0.t0.message);

              case 11:
                _logger2['default'].debug('Could not navigate to webview. Retrying if possible.');

              case 12:
                if (!res) {
                  context$2$0.next = 20;
                  break;
                }

                latestWindow = res;

                _logger2['default'].debug('Picking webview \'' + latestWindow + '\'');
                context$2$0.next = 17;
                return _regeneratorRuntime.awrap(this.setContext(latestWindow));

              case 17:
                context$2$0.next = 19;
                return _regeneratorRuntime.awrap(this.remote.cancelPageLoad());

              case 19:
                return context$2$0.abrupt('return');

              case 20:
                if (!(Date.now() - start >= 90000)) {
                  context$2$0.next = 22;
                  break;
                }

                throw new Error('Could not navigate to webview; there are none!');

              case 22:

                _logger2['default'].warn("Could not find any webviews yet, refreshing/retrying");

                if (!(this.isRealDevice() || !this.opts.safari)) {
                  context$2$0.next = 29;
                  break;
                }

                context$2$0.next = 26;
                return _regeneratorRuntime.awrap(_bluebird2['default'].delay(spinTime));

              case 26:
                context$2$0.next = 28;
                return _regeneratorRuntime.awrap(spinHandles());

              case 28:
                return context$2$0.abrupt('return', context$2$0.sent);

              case 29:
                element = undefined;
                context$2$0.prev = 30;

                _logger2['default'].debug('Finding and tapping reload button');
                context$2$0.next = 34;
                return _regeneratorRuntime.awrap(this.findUIElementOrElements('accessibility id', 'ReloadButton', '', false));

              case 34:
                element = context$2$0.sent;
                context$2$0.next = 37;
                return _regeneratorRuntime.awrap(this.nativeTap(element.ELEMENT));

              case 37:
                context$2$0.next = 45;
                break;

              case 39:
                context$2$0.prev = 39;
                context$2$0.t1 = context$2$0['catch'](30);

                _logger2['default'].warn('Error finding and tapping reload button: ' + context$2$0.t1.message);
                _logger2['default'].warn('Retrying.');
                context$2$0.next = 45;
                return _regeneratorRuntime.awrap(_bluebird2['default'].delay(spinTime));

              case 45:
                context$2$0.next = 47;
                return _regeneratorRuntime.awrap(spinHandles());

              case 47:
                return context$2$0.abrupt('return', context$2$0.sent);

              case 48:
              case 'end':
                return context$2$0.stop();
            }
          }, null, _this5, [[1, 7], [30, 39]]);
        };

        context$1$0.next = 6;
        return _regeneratorRuntime.awrap(spinHandles());

      case 6:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

helpers.closeAlertBeforeTest = function callee$0$0() {
  var present;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.next = 2;
        return _regeneratorRuntime.awrap(this.uiAutoClient.sendCommand('au.alertIsPresent()'));

      case 2:
        present = context$1$0.sent;

        if (present) {
          context$1$0.next = 5;
          break;
        }

        return context$1$0.abrupt('return', false);

      case 5:

        _logger2['default'].debug('Alert present before starting test, let us banish it');
        context$1$0.next = 8;
        return _regeneratorRuntime.awrap(this.uiAutoClient.sendCommand('au.dismissAlert()'));

      case 8:
        _logger2['default'].debug('Alert banished!');
        return context$1$0.abrupt('return', true);

      case 10:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

helpers.stopRemote = function callee$0$0() {
  var closeWindowBeforeDisconnecting = arguments.length <= 0 || arguments[0] === undefined ? false : arguments[0];
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (!this.remote) {
          _logger2['default'].errorAndThrow('Tried to leave a web frame but were not in one');
        }

        if (!closeWindowBeforeDisconnecting) {
          context$1$0.next = 4;
          break;
        }

        context$1$0.next = 4;
        return _regeneratorRuntime.awrap(this.closeWindow());

      case 4:
        context$1$0.next = 6;
        return _regeneratorRuntime.awrap(this.remote.disconnect());

      case 6:
        this.curContext = null;
        this.curWebFrames = [];
        this.curWebCoords = null;
        this.remote = null;

      case 10:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

helpers.isWebContext = function () {
  return !!this.curContext && this.curContext !== NATIVE_WIN;
};

helpers.setCurrentUrl = function (url) {
  this._currentUrl = url;
};

helpers.getCurrentUrl = function () {
  return this._currentUrl;
};

_Object$assign(extensions, commands, helpers);
exports.commands = commands;
exports.helpers = helpers;
exports.NATIVE_WIN = NATIVE_WIN;
exports.WEBVIEW_WIN = WEBVIEW_WIN;
exports.WEBVIEW_BASE = WEBVIEW_BASE;
exports['default'] = extensions;

// already in the named context, no need to do anything

// switching into a webview context

// if contexts have not already been retrieved, get them

// `contextId` will be in the form of `appId.pageId` in this case

// attempt to start performance logging, if requested

// real device, and already connected

// simulator, and already connected

// real device, and not connected

// it is reasonable to expect that this might be called when there is no
// webkit remote debugger to connect to

// simulator, and not connected
// eslint-disable-line curly

// generally this means that Safari is in page viewing mode
// so try to open a new page and then redo the navigation

// get the last address element and set the url

// this is flakey on certain systems so we retry until we get something
// ios sims: safari opens but the text field can't be found
// eslint-disable-line curly

// make it happen

// wait for page to finish loading.

// no webview was found

// too slow, get out

// on a real device, when not using Safari, we just want to try again

// find the reload button and tap it, if possible

// try it all again
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9jb21tYW5kcy9jb250ZXh0LmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7c0JBQWMsUUFBUTs7Ozt3QkFDUixVQUFVOzs7O3dCQUNNLFVBQVU7O29DQUNhLHdCQUF3Qjs7MENBQy9DLG1DQUFtQzs7OztnQ0FDMUMsb0JBQW9COztzQkFDeEIsV0FBVzs7Ozs2QkFDVCxnQkFBZ0I7O0FBR3JDLElBQU0sVUFBVSxHQUFHLFlBQVksQ0FBQztBQUNoQyxJQUFNLFdBQVcsR0FBRyxTQUFTLENBQUM7QUFDOUIsSUFBTSxZQUFZLEdBQU0sV0FBVyxNQUFHLENBQUM7O0FBRXZDLElBQUksUUFBUSxHQUFHLEVBQUU7SUFBRSxPQUFPLEdBQUcsRUFBRTtJQUFFLFVBQVUsR0FBRyxFQUFFLENBQUM7O0FBRWpELFFBQVEsQ0FBQyxpQkFBaUIsR0FBRzs7OztjQUN2QixJQUFJLENBQUMsVUFBVSxJQUFJLElBQUksQ0FBQyxVQUFVLEtBQUssVUFBVSxDQUFBOzs7OztpREFDekMsWUFBWSxHQUFHLElBQUksQ0FBQyxVQUFVOzs7NENBRWpDLFVBQVU7Ozs7Ozs7Q0FFcEIsQ0FBQzs7QUFFRixRQUFRLENBQUMsV0FBVyxHQUFHO01BRWpCLFFBQVEsRUFHUixLQUFLOzs7O0FBSlQsNEJBQU8sS0FBSyxDQUFDLG9DQUFvQyxDQUFDLENBQUM7O3lDQUM5QixJQUFJLENBQUMsbUJBQW1CLENBQUMsS0FBSyxDQUFDOzs7QUFBaEQsZ0JBQVE7O0FBR1IsYUFBSyxHQUFHLGVBQUMsT0FBTztpQkFBSyxPQUFPLENBQUMsRUFBRSxDQUFDLFFBQVEsRUFBRTtTQUFBOztBQUM5QyxZQUFJLElBQUksQ0FBQyxJQUFJLENBQUMsZUFBZSxFQUFFO0FBQzdCLGVBQUssR0FBRyxVQUFDLE9BQU8sRUFBSztBQUNuQixtQkFBTztBQUNMLGdCQUFFLEVBQUUsT0FBTyxDQUFDLEVBQUUsQ0FBQyxRQUFRLEVBQUU7QUFDekIsbUJBQUssRUFBRSxPQUFPLENBQUMsSUFB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QztRQUNwQyxRQUFRLEdBQVIsUUFBUTtRQUFFLE9BQU8sR0FBUCxPQUFPO1FBQUUsVUFBVSxHQUFWLFVBQVU7UUFBRSxXQUFXLEdBQVgsV0FBVztRQUFFLFlBQVksR0FBWixZQUFZO3FCQUNsRCxVQUFVIiwiZmlsZSI6ImxpYi9jb21tYW5kcy9jb250ZXh0LmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCBCIGZyb20gJ2JsdWViaXJkJztcbmltcG9ydCB7IHJldHJ5SW50ZXJ2YWwgfSBmcm9tICdhc3luY2JveCc7XG5pbXBvcnQgeyBSZW1vdGVEZWJ1Z2dlciwgV2ViS2l0UmVtb3RlRGVidWdnZXIgfSBmcm9tICdhcHBpdW0tcmVtb3RlLWRlYnVnZ2VyJztcbmltcG9ydCBJT1NQZXJmb3JtYW5jZUxvZyBmcm9tICcuLi9kZXZpY2UtbG9nL2lvcy1wZXJmb3JtYW5jZS1sb2cnO1xuaW1wb3J0IHsgZXJyb3JzIH0gZnJvbSAnYXBwaXVtLWJhc2UtZHJpdmVyJztcbmltcG9ydCBsb2dnZXIgZnJvbSAnLi4vbG9nZ2VyJztcbmltcG9ydCB7IHV0aWwgfSBmcm9tICdhcHBpdW0tc3VwcG9ydCc7XG5cblxuY29uc3QgTkFUSVZFX1dJTiA9ICdOQVRJVkVfQVBQJztcbmNvbnN0IFdFQlZJRVdfV0lOID0gJ1dFQlZJRVcnO1xuY29uc3QgV0VCVklFV19CQVNFID0gYCR7V0VCVklFV19XSU59X2A7XG5cbmxldCBjb21tYW5kcyA9IHt9LCBoZWxwZXJzID0ge30sIGV4dGVuc2lvbnMgPSB7fTtcblxuY29tbWFuZHMuZ2V0Q3VycmVudENvbnRleHQgPSBhc3luYyBmdW5jdGlvbiAoKSB7XG4gIGlmICh0aGlzLmN1ckNvbnRleHQgJiYgdGhpcy5jdXJDb250ZXh0ICE9PSBOQVRJVkVfV0lOKSB7XG4gICAgcmV0dXJuIGAke1dFQlZJRVdfQkFTRX0ke3RoaXMuY3VyQ29udGV4dH1gO1xuICB9IGVsc2Uge1xuICAgIHJldHVybiBOQVRJVkVfV0lOO1xuICB9XG59O1xuXG5jb21tYW5kcy5nZXRDb250ZXh0cyA9IGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgbG9nZ2VyLmRlYnVnKCdHZXR0aW5nIGxpc3Qgb2YgYXZhaWxhYmxlIGNvbnRleHRzJyk7XG4gIGxldCBjb250ZXh0cyA9IGF3YWl0IHRoaXMuZ2V0Q29udGV4dHNBbmRWaWV3cyhmYWxzZSk7XG5cblxuICBsZXQgbWFwRm4gPSAoY29udGV4dCkgPT4gY29udGV4dC5pZC50b1N0cmluZygpO1xuICBpZiAodGhpcy5vcHRzLmZ1bGxDb250ZXh0TGlzdCkge1xuICAgIG1hcEZuID0gKGNvbnRleHQpID0+IHtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIGlkOiBjb250ZXh0LmlkLnRvU3RyaW5nKCksXG4gICAgICAgIHRpdGxlOiBjb250ZXh0LnZpZXcudGl0bGUsXG4gICAgICAgIHVybDogY29udGV4dC52aWV3LnVybCxcbiAgICAgIH07XG4gICAgfTtcbiAgfVxuICByZXR1cm4gY29udGV4dHMubWFwKG1hcEZuKTtcbn07XG5cbmNvbW1hbmRzLnNldENvbnRleHQgPSBhc3luYyBmdW5jdGlvbiAobmFtZSwgY2FsbGJhY2ssIHNraXBSZWFkeUNoZWNrKSB7XG4gIGZ1bmN0aW9uIGFscmVhZHlJbkNvbnRleHQgKGRlc2lyZWQsIGN1cnJlbnQpIHtcbiAgICByZXR1cm4gKGRlc2lyZWQgPT09IGN1cnJlbnQgfHxcbiAgICAgICAgICAgKGRlc2lyZWQgPT09IG51bGwgJiYgY3VycmVudCA9PT0gTkFUSVZFX1dJTikgfHxcbiAgICAgICAgICAgKGRlc2lyZWQgPT09IE5BVElWRV9XSU4gJiYgY3VycmVudCA9PT0gbnVsbCkpO1xuICB9XG5cbiAgbG9nZ2VyLmRlYnVnKGBBdHRlbXB0aW5nIHRvIHNldCBjb250ZXh0IHRvICcke25hbWV9J2ApO1xuICBpZiAoYWxyZWFkeUluQ29udGV4dChuYW1lLCB0aGlzLmN1ckNvbnRleHQpKSB7XG4gICAgLy8gYWxyZWFkeSBpbiB0aGUgbmFtZWQgY29udGV4dCwgbm8gbmVlZCB0byBkbyBhbnl0aGluZ1xuICB9IGVsc2UgaWYgKG5hbWUgPT09IE5BVElWRV9XSU4gfHwgbmFtZSA9PT0gbnVsbCkge1xuICAgIC8vIHN3aXRjaGluZyBpbnRvIHRoZSBuYXRpdmUgY29udGV4dFxuICAgIHRoaXMuY3VyQ29udGV4dCA9IG51bGw7XG4gICAgaWYgKHRoaXMuaXNSZWFsRGV2aWNlKCkpIHtcbiAgICAgIHRoaXMucmVtb3RlLmRpc2Nvbm5lY3QoKTtcbiAgICB9XG4gIH0gZWxzZSB7XG4gICAgLy8gc3dpdGNoaW5nIGludG8gYSB3ZWJ2aWV3IGNvbnRleHRcblxuICAgIC8vIGlmIGNvbnRleHRzIGhhdmUgbm90IGFscmVhZHkgYmVlbiByZXRyaWV2ZWQsIGdldCB0aGVtXG4gICAgaWYgKF8uaXNVbmRlZmluZWQodGhpcy5jb250ZXh0cykpIHtcbiAgICAgIGF3YWl0IHRoaXMuZ2V0Q29udGV4dHMoKTtcbiAgICB9XG5cbiAgICBsZXQgY29udGV4dElkID0gbmFtZS5yZXBsYWNlKFdFQlZJRVdfQkFTRSwgJycpO1xuICAgIGlmIChjb250ZXh0SWQgPT09ICcnKSB7XG4gICAgICAvLyBhbGxvdyB1c2VyIHRvIHBhc3MgaW4gXCJXRUJWSUVXXCIgd2l0aG91dCBhbiBpbmRleFxuICAgICAgLy8gdGhlIHNlY29uZCBjb250ZXh0IHdpbGwgYmUgdGhlIGZpcnN0IHdlYnZpZXcgYXNcbiAgICAgIC8vIHRoZSBmaXJzdCBpcyBhbHdheXMgTkFUSVZFX0FQUFxuICAgICAgY29udGV4dElkID0gdGhpcy5jb250ZXh0c1sxXTtcbiAgICB9XG4gICAgaWYgKCFfLmluY2x1ZGVzKHRoaXMuY29udGV4dHMsIGNvbnRleHRJZCkpIHtcbiAgICAgIHRocm93IG5ldyBlcnJvcnMuTm9TdWNoQ29udGV4dEVycm9yKCk7XG4gICAgfVxuXG4gICAgaWYgKHRoaXMuaXNSZWFsRGV2aWNlKCkpIHtcbiAgICAgIGlmICh0aGlzLnJlbW90ZSkge1xuICAgICAgICBhd2FpdCB0aGlzLnJlbW90ZS5kaXNjb25uZWN0KCk7XG4gICAgICB9XG4gICAgICB0aGlzLmN1ckNvbnRleHQgPSBjb250ZXh0SWQ7XG4gICAgICBhd2FpdCB0aGlzLnJlbW90ZS5jb25uZWN0KGNvbnRleHRJZCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIC8vIGBjb250ZXh0SWRgIHdpbGwgYmUgaW4gdGhlIGZvcm0gb2YgYGFwcElkLnBhZ2VJZGAgaW4gdGhpcyBjYXNlXG4gICAgICBsZXQgW2FwcElkS2V5LCBwYWdlSWRLZXldID0gXy5tYXAoY29udGV4dElkLnNwbGl0KCcuJyksIChpZCkgPT4gcGFyc2VJbnQoaWQsIDEwKSk7XG4gICAgICBhd2FpdCB0aGlzLnJlbW90ZS5zZWxlY3RQYWdlKGFwcElkS2V5LCBwYWdlSWRLZXksIHNraXBSZWFkeUNoZWNrKTtcbiAgICAgIHRoaXMuY3VyQ29udGV4dCA9IGNvbnRleHRJZDtcbiAgICB9XG4gIH1cblxuICAvLyBhdHRlbXB0IHRvIHN0YXJ0IHBlcmZvcm1hbmNlIGxvZ2dpbmcsIGlmIHJlcXVlc3RlZFxuICBpZiAodGhpcy5vcHRzLmVuYWJsZVBlcmZvcm1hbmNlTG9nZ2luZyAmJiB0aGlzLnJlbW90ZSkge1xuICAgIGxvZ2dlci5kZWJ1ZyhgU3RhcnRpbmcgcGVyZm9ybWFuY2UgbG9nIG9uICcke3RoaXMuY3VyQ29udGV4dH0nYCk7XG4gICAgdGhpcy5sb2dzLnBlcmZvcm1hbmNlID0gbmV3IElPU1BlcmZvcm1hbmNlTG9nKHRoaXMucmVtb3RlKTtcbiAgICBhd2FpdCB0aGlzLmxvZ3MucGVyZm9ybWFuY2Uuc3RhcnRDYXB0dXJlKCk7XG4gIH1cbn07XG5cbmNvbW1hbmRzLmdldFdpbmRvd0hhbmRsZSA9IGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgaWYgKCF0aGlzLmlzV2ViQ29udGV4dCgpKSB7XG4gICAgdGhyb3cgbmV3IGVycm9ycy5Ob3RJbXBsZW1lbnRlZEVycm9yKCk7XG4gIH1cbiAgcmV0dXJuIHRoaXMuY3VyQ29udGV4dC50b1N0cmluZygpO1xufTtcblxuY29tbWFuZHMuZ2V0V2luZG93SGFuZGxlcyA9IGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgaWYgKCF0aGlzLmlzV2ViQ29udGV4dCgpKSB7XG4gICAgdGhyb3cgbmV3IGVycm9ycy5Ob3RJbXBsZW1lbnRlZEVycm9yKCk7XG4gIH1cblxuICBsZXQgcGFnZUFycmF5ID0gYXdhaXQgdGhpcy5saXN0V2ViRnJhbWVzKCk7XG4gIHRoaXMud2luZG93SGFuZGxlQ2FjaGUgPSBfLm1hcChwYWdlQXJyYXksIHRoaXMubWFzc2FnZVBhZ2UpO1xuICBsZXQgaWRBcnJheSA9IF8ubWFwKHRoaXMud2luZG93SGFuZGxlQ2FjaGUsICdpZCcpO1xuICAvLyBzaW5jZSB3ZSB1c2UgdGhpcy5jb250ZXh0cyB0byBtYW5hZ2Ugc2VsZWN0aW5nIGRlYnVnZ2VyIHBhZ2VzLCBtYWtlXG4gIC8vIHN1cmUgaXQgZ2V0cyBwb3B1bGF0ZWQgZXZlbiBpZiBzb21lb25lIGRpZCBub3QgdXNlIHRoZVxuICAvLyBnZXRDb250ZXh0cyBtZXRob2RcbiAgaWYgKCF0aGlzLmNvbnRleHRzKSB7XG4gICAgdGhpcy5jb250ZXh0cyA9IGlkQXJyYXk7XG4gIH1cbiAgcmV0dXJuIF8ubWFwKGlkQXJyYXksIChpZCkgPT4gaWQudG9TdHJpbmcoKSk7XG59O1xuXG5jb21tYW5kcy5zZXRXaW5kb3cgPSBhc3luYyBmdW5jdGlvbiAobmFtZSwgc2tpcFJlYWR5Q2hlY2spIHtcbiAgaWYgKCF0aGlzLmlzV2ViQ29udGV4dCgpKSB7XG4gICAgdGhyb3cgbmV3IGVycm9ycy5Ob3RJbXBsZW1lbnRlZEVycm9yKCk7XG4gIH1cblxuICBpZiAoIV8uaW5jbHVkZXMoXy5tYXAodGhpcy53aW5kb3dIYW5kbGVDYWNoZSwgJ2lkJyksIG5hbWUpKSB7XG4gICAgdGhyb3cgbmV3IGVycm9ycy5Ob1N1Y2hXaW5kb3dFcnJvcigpO1xuICB9XG4gIGxldCBwYWdlSWRLZXkgPSBwYXJzZUludChuYW1lLCAxMCk7XG4gIGlmICghdGhpcy5pc1JlYWxEZXZpY2UoKSkge1xuICAgIGF3YWl0IHRoaXMucmVtb3RlLnNlbGVjdFBhZ2UocGFnZUlkS2V5LCBza2lwUmVhZHlDaGVjayk7XG4gICAgdGhpcy5jdXJDb250ZXh0ID0gdGhpcy5jdXJXaW5kb3dIYW5kbGUgPSBuYW1lO1xuICB9IGVsc2Uge1xuICAgIGlmIChuYW1lID09PSB0aGlzLmN1cldpbmRvd0hhbmRsZSkge1xuICAgICAgbG9nZ2VyLmRlYnVnKGBSZW1vdGUgZGVidWdnZXIgaXMgYWxyZWFkeSBjb25uZWN0ZWQgdG8gd2luZG93ICcke25hbWV9J2ApO1xuICAgIH0gZWxzZSBpZiAoIV8uaW5jbHVkZXMoXy5tYXAodGhpcy53aW5kb3dIYW5kbGVDYWNoZSwgJ2lkJyksIG5hbWUpKSB7XG4gICAgICB0aHJvdyBuZXcgZXJyb3JzLk5vU3VjaFdpbmRvd0Vycm9yKCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGF3YWl0IHRoaXMucmVtb3RlLmRpc2Nvbm5lY3QoKTtcbiAgICAgIHRoaXMuY3VyQ29udGV4dCA9IHRoaXMuY3VyV2luZG93SGFuZGxlID0gbmFtZTtcbiAgICAgIGF3YWl0IHRoaXMucmVtb3RlLmNvbm5lY3QobmFtZSk7XG4gICAgfVxuICB9XG59O1xuXG5oZWxwZXJzLndlYkNvbnRleHRJbmRleCA9IGZ1bmN0aW9uICgpIHtcbiAgcmV0dXJuIHRoaXMuY3VyQ29udGV4dC5yZXBsYWNlKFdFQlZJRVdfQkFTRSwgJycpIC0gMTtcbn07XG5cbmV4dGVuc2lvbnMuaW5pdEF1dG9XZWJ2aWV3ID0gYXN5bmMgZnVuY3Rpb24gKCkge1xuICBpZiAodGhpcy5vcHRzLmF1dG9XZWJ2aWV3KSB7XG4gICAgbG9nZ2VyLmRlYnVnKCdTZXR0aW5nIGF1dG8gd2VidmlldycpO1xuICAgIGF3YWl0IHRoaXMubmF2VG9Jbml0aWFsV2Vidmlldyh0aGlzKTtcbiAgfVxufTtcblxuZXh0ZW5zaW9ucy5nZXRDb250ZXh0c0FuZFZpZXdzID0gYXN5bmMgZnVuY3Rpb24gKHVzZVVybCA9IHRydWUpIHtcbiAgbG9nZ2VyLmRlYnVnKCdSZXRyaWV2aW5nIGNvbnRleHRzIGFuZCB2aWV3cycpO1xuICBsZXQgd2Vidmlld3MgPSBhd2FpdCB0aGlzLmxpc3RXZWJGcmFtZXModXNlVXJsKTtcbiAgbGV0IGN0eHMgPSBbe2lkOiBOQVRJVkVfV0lOLCB2aWV3OiB7fX1dO1xuICB0aGlzLmNvbnRleHRzID0gW05BVElWRV9XSU5dO1xuICBmb3IgKGxldCB2aWV3IG9mIHdlYnZpZXdzKSB7XG4gICAgY3R4cy5wdXNoKHtpZDogYCR7V0VCVklFV19CQVNFfSR7dmlldy5pZH1gLCB2aWV3fSk7XG4gICAgdGhpcy5jb250ZXh0cy5wdXNoKHZpZXcuaWQudG9TdHJpbmcoKSk7XG4gIH1cbiAgcmV0dXJuIGN0eHM7XG59O1xuXG5leHRlbnNpb25zLmdldE5ld1JlbW90ZURlYnVnZ2VyID0gYXN5bmMgZnVuY3Rpb24gKCkge1xuICByZXR1cm4gbmV3IFJlbW90ZURlYnVnZ2VyKHtcbiAgICBidW5kbGVJZDogdGhpcy5vcHRzLmJ1bmRsZUlkLFxuICAgIHVzZU5ld1NhZmFyaTogdGhpcy51c2VOZXdTYWZhcmkoKSxcbiAgICBwYWdlTG9hZE1zOiB0aGlzLnBhZ2VMb2FkTXMsXG4gICAgcGxhdGZvcm1WZXJzaW9uOiB0aGlzLm9wdHMucGxhdGZvcm1WZXJzaW9uXG4gIH0pO1xufTtcblxuZXh0ZW5zaW9ucy5saXN0V2ViRnJhbWVzID0gYXN5bmMgZnVuY3Rpb24gKHVzZVVybCA9IHRydWUpIHtcbiAgaWYgKCF0aGlzLm9wdHMuYnVuZGxlSWQpIHtcbiAgICBsb2dnZXIuZXJyb3JBbmRUaHJvdygnQ2Fubm90IGVudGVyIHdlYiBmcmFtZSB3aXRob3V0IGEgYnVuZGxlIElEJyk7XG4gIH1cblxuICB1c2VVcmwgPSB1c2VVcmwgJiYgISF0aGlzLmdldEN1cnJlbnRVcmwoKTtcbiAgbG9nZ2VyLmRlYnVnKGBTZWxlY3RpbmcgYnkgdXJsOiAke3VzZVVybH0gJHt1c2VVcmwgPyBgKGV4cGVjdGVkIHVybDogJyR7dGhpcy5nZXRDdXJyZW50VXJsKCl9JylgIDogJyd9YCk7XG5cbiAgbGV0IGN1cnJlbnRVcmwgPSB1c2VVcmwgPyB0aGlzLmdldEN1cnJlbnRVcmwoKSA6IHVuZGVmaW5lZDtcbiAgbGV0IHBhZ2VBcnJheTtcbiAgaWYgKHRoaXMuaXNSZWFsRGV2aWNlKCkgJiYgdGhpcy5yZW1vdGUgJiYgdGhpcy5vcHRzLmJ1bmRsZUlkKSB7XG4gICAgLy8gcmVhbCBkZXZpY2UsIGFuZCBhbHJlYWR5IGNvbm5lY3RlZFxuICAgIHBhZ2VBcnJheSA9IGF3YWl0IHRoaXMucmVtb3RlLnBhZ2VBcnJheUZyb21Kc29uKHRoaXMub3B0cy5pZ25vcmVBYm91dEJsYW5rVXJsKTtcbiAgfSBlbHNlIGlmICh0aGlzLnJlbW90ZSAmJiB0aGlzLnJlbW90ZS5hcHBJZEtleSkge1xuICAgIC8vIHNpbXVsYXRvciwgYW5kIGFscmVhZHkgY29ubmVjdGVkXG4gICAgcGFnZUFycmF5ID0gYXdhaXQgdGhpcy5yZW1vdGUuc2VsZWN0QXBwKGN1cnJlbnRVcmwsIHRoaXMub3B0cy53ZWJ2aWV3Q29ubmVjdFJldHJpZXMsIHRoaXMub3B0cy5pZ25vcmVBYm91dEJsYW5rVXJsKTtcbiAgfSBlbHNlIGlmICh0aGlzLmlzUmVhbERldmljZSgpKSB7XG4gICAgLy8gcmVhbCBkZXZpY2UsIGFuZCBub3QgY29ubmVjdGVkXG4gICAgdHJ5IHtcbiAgICAgIHRoaXMucmVtb3RlID0gbmV3IFdlYktpdFJlbW90ZURlYnVnZ2VyKHtcbiAgICAgICAgcG9ydDogdGhpcy5vcHRzLndlYmtpdERlYnVnUHJveHlQb3J0LFxuICAgICAgICB3ZWJraXRSZXNwb25zZVRpbWVvdXQ6IHRoaXMub3B0cy53ZWJraXRSZXNwb25zZVRpbWVvdXQsXG4gICAgICB9KTtcbiAgICAgIHBhZ2VBcnJheSA9IGF3YWl0IHRoaXMucmVtb3RlLnBhZ2VBcnJheUZyb21Kc29uKHRoaXMub3B0cy5pZ25vcmVBYm91dEJsYW5rVXJsKTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIC8vIGl0IGlzIHJlYXNvbmFibGUgdG8gZXhwZWN0IHRoYXQgdGhpcyBtaWdodCBiZSBjYWxsZWQgd2hlbiB0aGVyZSBpcyBub1xuICAgICAgLy8gd2Via2l0IHJlbW90ZSBkZWJ1Z2dlciB0byBjb25uZWN0IHRvXG4gICAgICBpZiAoIV8uaW5jbHVkZXMoZXJyLm1lc3NhZ2UsICdjb25uZWN0IEVDT05OUkVGVVNFRCcpKSB0aHJvdyBlcnI7IC8vIGVzbGludC1kaXNhYmxlLWxpbmUgY3VybHlcblxuICAgICAgbG9nZ2VyLndhcm4oJ0F0dGVtcHRlZCB0byBnZXQgYSBsaXN0IG9mIHdlYnZpZXcgY29udGV4dHMgYnV0IGNvdWxkIG5vdCBjb25uZWN0IHRvICcgK1xuICAgICAgICAgICAgICAgICAgJ2lvcy13ZWJraXQtZGVidWctcHJveHkuIElmIHlvdSBleHBlY3QgdG8gZmluZCB3ZWJ2aWV3cywgcGxlYXNlIGVuc3VyZSAnICtcbiAgICAgICAgICAgICAgICAgICd0aGF0IHRoZSBwcm94eSBpcyBydW5uaW5nIGFuZCBhY2Nlc3NpYmxlJyk7XG4gICAgICB0aGlzLnJlbW90ZSA9IG51bGw7XG4gICAgICBwYWdlQXJyYXkgPSBbXTtcbiAgICB9XG4gIH0gZWxzZSB7XG4gICAgLy8gc2ltdWxhdG9yLCBhbmQgbm90IGNvbm5lY3RlZFxuICAgIHRoaXMucmVtb3RlID0gYXdhaXQgdGhpcy5nZXROZXdSZW1vdGVEZWJ1Z2dlcigpO1xuXG4gICAgbGV0IGFwcEluZm8gPSBhd2FpdCB0aGlzLnJlbW90ZS5jb25uZWN0KCk7XG4gICAgaWYgKCFhcHBJbmZvKSB7XG4gICAgICBsb2dnZXIuZGVidWcoJ1VuYWJsZSB0byBjb25uZWN0IHRvIHRoZSByZW1vdGUgZGVidWdnZXIuJyk7XG4gICAgICByZXR1cm4gW107XG4gICAgfVxuICAgIHBhZ2VBcnJheSA9IGF3YWl0IHRoaXMucmVtb3RlLnNlbGVjdEFwcChjdXJyZW50VXJsLCB0aGlzLm9wdHMud2Vidmlld0Nvbm5lY3RSZXRyaWVzLCB0aGlzLm9wdHMuaWdub3JlQWJvdXRCbGFua1VybCk7XG4gICAgdGhpcy5yZW1vdGUub24oUmVtb3RlRGVidWdnZXIuRVZFTlRfUEFHRV9DSEFOR0UsIHRoaXMub25QYWdlQ2hhbmdlLmJpbmQodGhpcykpO1xuXG4gICAgbGV0IHRyeUNsb3NpbmdBbGVydCA9IGFzeW5jICgpID0+IHtcbiAgICAgIGxldCBkaWREaXNtaXNzID0gYXdhaXQgdGhpcy5jbG9zZUFsZXJ0QmVmb3JlVGVzdCgpO1xuICAgICAgaWYgKCFkaWREaXNtaXNzKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignQ2xvc2UgYWxlcnQgZmFpbGVkLiBSZXRyeS4nKTtcbiAgICAgIH1cbiAgICB9O1xuICAgIHRyeSB7XG4gICAgICBhd2FpdCByZXRyeUludGVydmFsKDMsIDQwMDAsIHRyeUNsb3NpbmdBbGVydCk7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAvLyBpZiB0aGUgbG9vcCB0byBjbG9zZSBhbGVydHMgZmFpbGVkIHRvIGRpc21pc3MsIGlnbm9yZSxcbiAgICAgIC8vIG90aGVyd2lzZSBsb2cgYW5kIHRocm93IHRoZSBlcnJvclxuICAgICAgaWYgKGVyci5tZXNzYWdlICE9PSAnQ2xvc2UgYWxlcnQgZmFpbGVkLiBSZXRyeS4nKSB7XG4gICAgICAgIGxvZ2dlci5lcnJvckFuZFRocm93KGVycik7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgaWYgKHBhZ2VBcnJheS5sZW5ndGggPT09IDApIHtcbiAgICAvLyB3ZSBoYXZlIG5vIHdlYiBmcmFtZXMsIGJ1dCBjb250aW51ZSBhbnl3YXlcbiAgICBsb2dnZXIuZGVidWcoJ05vIHdlYiBmcmFtZXMgZm91bmQuJyk7XG4gIH1cbiAgcmV0dXJuIHBhZ2VBcnJheTtcbn07XG5cbmV4dGVuc2lvbnMub25QYWdlQ2hhbmdlID0gYXN5bmMgZnVuY3Rpb24gKHBhZ2VDaGFuZ2VOb3RpZmljYXRpb24pIHtcbiAgbG9nZ2VyLmRlYnVnKGBSZW1vdGUgZGVidWdnZXIgbm90aWZpZWQgdXMgb2YgYSBuZXcgcGFnZSBsaXN0aW5nOiAke0pTT04uc3RyaW5naWZ5KHBhZ2VDaGFuZ2VOb3RpZmljYXRpb24pfWApO1xuICBpZiAodGhpcy5zZWxlY3RpbmdOZXdQYWdlKSB7XG4gICAgbG9nZ2VyLmRlYnVnKCdXZSBhcmUgaW4gdGhlIG1pZGRsZSBvZiBzZWxlY3RpbmcgYSBwYWdlLCBpZ25vcmluZycpO1xuICAgIHJldHVybjtcbiAgfVxuICBpZiAoIXRoaXMucmVtb3RlLmFwcElkS2V5KSB7XG4gICAgbG9nZ2VyLmRlYnVnKCdXZSBoYXZlIG5vdCB5ZXQgY29ubmVjdGVkLCBpZ25vcmluZycpO1xuICAgIHJldHVybjtcbiAgfVxuXG4gIGxldCB7YXBwSWRLZXksIHBhZ2VBcnJheX0gPSBwYWdlQ2hhbmdlTm90aWZpY2F0aW9uO1xuXG4gIGxldCBuZXdJZHMgPSBbXTtcbiAgbGV0IG5ld1BhZ2VzID0gW107XG4gIGxldCBrZXlJZCA9IG51bGw7XG4gIGZvciAobGV0IHBhZ2Ugb2YgcGFnZUFycmF5KSB7XG4gICAgbGV0IGlkID0gcGFnZS5pZC50b1N0cmluZygpO1xuICAgIG5ld0lkcy5wdXNoKGlkKTtcbiAgICBpZiAocGFnZS5pc0tleSkge1xuICAgICAga2V5SWQgPSBpZDtcbiAgICB9XG4gICAgbGV0IGNvbnRleHRJZCA9IGAke2FwcElkS2V5fS4ke2lkfWA7XG4gICAgaWYgKCFfLmluY2x1ZGVzKHRoaXMuY29udGV4dHMsIGNvbnRleHRJZCkpIHtcbiAgICAgIG5ld1BhZ2VzLnB1c2goaWQpO1xuICAgICAgdGhpcy5jb250ZXh0cy5wdXNoKGNvbnRleHRJZCk7XG4gICAgfVxuICB9XG5cbiAgaWYgKCFrZXlJZCkge1xuICAgIC8vIGlmIHRoZXJlIGlzIG5vIGtleSBpZCwgcHVsbCB0aGUgZmlyc3QgaWQgZnJvbSB0aGUgcGFnZSBhcnJheSBhbmQgdXNlIHRoYXRcbiAgICAvLyBhcyBhIHN0YW5kIGluXG4gICAgbG9nZ2VyLmRlYnVnKCdObyBrZXkgaWQgZm91bmQuIENob29zaW5nIGZpcnN0IGlkIGZyb20gcGFnZSBhcnJheScpO1xuICAgIGtleUlkID0gbmV3SWRzWzBdIHx8IG51bGw7XG4gIH1cblxuICBsZXQgbmV3UGFnZSA9IG51bGw7XG4gIGlmICh0aGlzLmN1ckNvbnRleHQgPT09IG51bGwpIHtcbiAgICBsb2dnZXIuZGVidWcoJ1dlIGRvIG5vdCBhcHBlYXIgdG8gaGF2ZSB3aW5kb3cgc2V0IHlldCwgaWdub3JpbmcnKTtcbiAgfSBlbHNlIHtcbiAgICBsZXQgW2N1ckFwcElkS2V5LCBjdXJQYWdlSWRLZXldID0gdGhpcy5jdXJDb250ZXh0LnNwbGl0KCcuJyk7XG5cbiAgICBpZiAoY3VyQXBwSWRLZXkgIT09IGFwcElkS2V5KSB7XG4gICAgICBsb2dnZXIuZGVidWcoJ1BhZ2UgY2hhbmdlIG5vdCByZWZlcnJpbmcgdG8gY3VycmVudGx5IHNlbGVjdGVkIGFwcCwgaWdub3JpbmcuJyk7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgaWYgKG5ld1BhZ2VzLmxlbmd0aCkge1xuICAgICAgbmV3UGFnZSA9IF8ubGFzdChuZXdQYWdlcyk7XG4gICAgICBsb2dnZXIuZGVidWcoYFdlIGhhdmUgbmV3IHBhZ2VzLCBnb2luZyB0byBzZWxlY3QgcGFnZSAnJHtuZXdQYWdlfSdgKTtcbiAgICB9IGVsc2UgaWYgKCFfLmluY2x1ZGVzKG5ld0lkcywgY3VyUGFnZUlkS2V5KSkge1xuICAgICAgbG9nZ2VyLmRlYnVnKCdOZXcgcGFnZSBsaXN0aW5nIGZyb20gcmVtb3RlIGRlYnVnZ2VyIGRvZXMgbm90IGNvbnRhaW4gJyArXG4gICAgICAgICAgICAgICAgICAgJ2N1cnJlbnQgd2luZG93OyBhc3N1bWluZyBpdCBpcyBjbG9zZWQnKTtcbiAgICAgIGlmIChrZXlJZCAhPT0gbnVsbCkge1xuICAgICAgICBsb2dnZXIuZGVidWcoYERlYnVnZ2VyIGFscmVhZHkgc2VsZWN0ZWQgcGFnZSAnJHtrZXlJZH0nLCBgICtcbiAgICAgICAgICAgICAgICAgICAgIGBjb25maXJtaW5nIHRoYXQgY2hvaWNlLmApO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgbG9nZ2VyLmVycm9yKCdEbyBub3QgaGF2ZSBvdXIgY3VycmVudCB3aW5kb3cgYW55bW9yZSwgYW5kIHRoZXJlICcgK1xuICAgICAgICAgICAgICAgICAgICAgJ2FyZSBub3QgYW55IG1vcmUgdG8gbG9hZCEgRG9pbmcgbm90aGluZy4uLicpO1xuICAgICAgICB0aGlzLnNldEN1cnJlbnRVcmwodW5kZWZpbmVkKTtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuICAgICAgdGhpcy5jdXJDb250ZXh0ID0gYCR7YXBwSWRLZXl9LiR7a2V5SWR9YDtcbiAgICAgIG5ld1BhZ2UgPSBrZXlJZDtcbiAgICB9IGVsc2Uge1xuICAgICAgbG9nZ2VyLmRlYnVnKCdDaGVja2luZyBpZiBwYWdlIG5lZWRzIHRvIGxvYWQnKTtcbiAgICAgIC8vIElmIGEgd2luZG93IG5hdmlnYXRlcyB0byBhbiBhbmNob3IgaXQgZG9lc24ndCBhbHdheXMgZmlyZSBhIHBhZ2VcbiAgICAgIC8vIGNhbGxiYWNrIGV2ZW50LiBMZXQncyBjaGVjayBpZiB3ZSB3b3VuZCB1cCBpbiBzdWNoIGEgc2l0dWF0aW9uLlxuICAgICAgY29uc3QgbmVlZHNQYWdlTG9hZCA9ICgoKSA9PiB7XG4gICAgICAgIC8vIG5lZWQgdG8gbWFwIHRoZSBwYWdlIGlkcyB0byBjb250ZXh0IGlkc1xuICAgICAgICBjb25zdCBjb250ZXh0QXJyYXkgPSBfLm1hcChwYWdlQXJyYXksIChhcnIpID0+IHtcbiAgICAgICAgICByZXR1cm4gYCR7YXBwSWRLZXl9LiR7YXJyLmlkfWA7XG4gICAgICAgIH0pO1xuICAgICAgICByZXR1cm4gIV8uaXNFcXVhbChfLmZpbmQodGhpcy5jb250ZXh0cywgdGhpcy5jdXJDb250ZXh0KSwgXy5maW5kKGNvbnRleHRBcnJheSwgdGhpcy5jdXJDb250ZXh0KSk7XG4gICAgICB9KSgpO1xuXG4gICAgICBpZiAobmVlZHNQYWdlTG9hZCkge1xuICAgICAgICBsb2dnZXIuZGVidWcoJ1BhZ2UgbG9hZCBuZWVkZWQuIExvYWRpbmcuLi4nKTtcbiAgICAgICAgYXdhaXQgdGhpcy5yZW1vdGUucGFnZUxvYWQoKTtcbiAgICAgIH1cblxuICAgICAgbG9nZ2VyLmRlYnVnKCdOZXcgcGFnZSBsaXN0aW5nIGlzIHNhbWUgYXMgb2xkLCBkb2luZyBub3RoaW5nJyk7XG4gICAgfVxuICB9XG5cbiAgLy8gbWFrZSBzdXJlIHRoYXQgdGhlIHBhZ2UgbGlzdGluZyBpc24ndCBpbmRpY2F0aW5nIGEgcmVkaXJlY3RcbiAgaWYgKHV0aWwuaGFzVmFsdWUodGhpcy5jdXJDb250ZXh0KSkge1xuICAgIGxldCBjdXJyZW50UGFnZUlkID0gcGFyc2VJbnQoXy5sYXN0KHRoaXMuY3VyQ29udGV4dC5zcGxpdCgnLicpKSwgMTApO1xuICAgIGxldCBwYWdlID0gXy5maW5kKHBhZ2VBcnJheSwgKHApID0+IHBhcnNlSW50KHAuaWQsIDEwKSA9PT0gY3VycmVudFBhZ2VJZCk7XG4gICAgaWYgKHBhZ2UgJiYgcGFnZS51cmwgIT09IHRoaXMuZ2V0Q3VycmVudFVybCgpKSB7XG4gICAgICBsb2dnZXIuZGVidWcoYFJlZGlyZWN0ZWQgZnJvbSAnJHt0aGlzLmdldEN1cnJlbnRVcmwoKX0nIHRvICcke3BhZ2UudXJsfSdgKTtcbiAgICAgIHRoaXMuc2V0Q3VycmVudFVybChwYWdlLnVybCk7XG4gICAgfVxuICB9XG5cbiAgaWYgKHV0aWwuaGFzVmFsdWUobmV3UGFnZSkpIHtcbiAgICB0aGlzLnNlbGVjdGluZ05ld1BhZ2UgPSB0cnVlO1xuICAgIGF3YWl0IHRoaXMucmVtb3RlLnNlbGVjdFBhZ2UoYXBwSWRLZXksIHBhcnNlSW50KG5ld1BhZ2UsIDEwKSk7XG4gICAgdGhpcy5zZWxlY3RpbmdOZXdQYWdlID0gZmFsc2U7XG4gICAgdGhpcy5jdXJDb250ZXh0ID0gYCR7YXBwSWRLZXl9LiR7bmV3UGFnZX1gO1xuICB9XG4gIHRoaXMud2luZG93SGFuZGxlQ2FjaGUgPSBfLm1hcChwYWdlQXJyYXksIHRoaXMubWFzc2FnZVBhZ2UpO1xufTtcblxuZXh0ZW5zaW9ucy5nZXRMYXRlc3RXZWJ2aWV3Q29udGV4dEZvclRpdGxlID0gYXN5bmMgZnVuY3Rpb24gKHJlZ0V4cCkge1xuICBsZXQgY29udGV4dHMgPSBhd2FpdCB0aGlzLmdldENvbnRleHRzQW5kVmlld3MoKTtcbiAgbGV0IG1hdGNoaW5nQ3R4O1xuICBmb3IgKGxldCBjdHggb2YgY29udGV4dHMpIHtcbiAgICBpZiAoY3R4LnZpZXcgJiYgKChjdHgudmlldy50aXRsZSAmJiBjdHgudmlldy50aXRsZS5tYXRjaChyZWdFeHApKSB8fCAoY3R4LnZpZXcudXJsICYmIGN0eC52aWV3LnVybC5tYXRjaChyZWdFeHApKSkpIHtcbiAgICAgIGlmIChjdHgudmlldy51cmwgIT09ICdhYm91dDpibGFuaycpIHtcbiAgICAgICAgbWF0Y2hpbmdDdHggPSBjdHg7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICAvLyBpbiB0aGUgY2FzZXMgb2YgWGNvZGUgPCA1IChpLmUuLCBpT1MgU0RLIFZlcnNpb24gbGVzcyB0aGFuIDcpXG4gICAgICAgIC8vIGlPUyA3LjEsIGlPUyA5LjAgJiBpT1MgOS4xIGluIGEgd2VidmlldyAobm90IGluIFNhZmFyaSlcbiAgICAgICAgLy8gd2UgY2FuIGhhdmUgdGhlIHVybCBiZSBgYWJvdXQ6YmxhbmtgXG4gICAgICAgIGlmIChwYXJzZUZsb2F0KHRoaXMuaW9zU2RrVmVyc2lvbikgPCA3IHx8IHBhcnNlRmxvYXQodGhpcy5pb3NTZGtWZXJzaW9uKSA+PSA5IHx8XG4gICAgICAgICAgICAodGhpcy5vcHRzLnBsYXRmb3JtVmVyc2lvbiA9PT0gJzcuMScgJiYgdGhpcy5vcHRzLmFwcCAmJiB0aGlzLm9wdHMuYXBwLnRvTG93ZXJDYXNlKCkgIT09ICdzYWZhcmknKSkge1xuICAgICAgICAgIG1hdGNoaW5nQ3R4ID0gY3R4O1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICBicmVhaztcbiAgICB9XG4gIH1cbiAgcmV0dXJuIG1hdGNoaW5nQ3R4ID8gbWF0Y2hpbmdDdHguaWQgOiB1bmRlZmluZWQ7XG59O1xuXG4vLyBSaWdodCBub3cgd2UgZG9uJ3QgbmVjZXNzYXJpbHkgd2FpdCBmb3Igd2Vidmlld1xuLy8gYW5kIGZyYW1lIHRvIGxvYWQsIHdoaWNoIGxlYWRzIHRvIHJhY2UgY29uZGl0aW9ucyBhbmQgZmxha2luZXNzLFxuLy8gbGV0J3Mgc2VlIGlmIHdlIGNhbiB0cmFuc2l0aW9uIHRvIHNvbWV0aGluZyBiZXR0ZXJcbmV4dGVuc2lvbnMudXNlTmV3U2FmYXJpID0gZnVuY3Rpb24gKCkge1xuICByZXR1cm4gcGFyc2VGbG9hdCh0aGlzLmlvc1Nka1ZlcnNpb24pID49IDguMSAmJlxuICAgICAgICAgcGFyc2VGbG9hdCh0aGlzLm9wdHMucGxhdGZvcm1WZXJzaW9uKSA+PSA4LjEgJiZcbiAgICAgICAgICF0aGlzLmlzUmVhbERldmljZSgpICYmXG4gICAgICAgICB0aGlzLm9wdHMuc2FmYXJpO1xufTtcblxuZXh0ZW5zaW9ucy5uYXZUb0luaXRpYWxXZWJ2aWV3ID0gYXN5bmMgZnVuY3Rpb24gKCkge1xuICBsZXQgdGltZW91dCA9IDA7XG4gIGlmICh0aGlzLmlzUmVhbERldmljZSgpKSB7XG4gICAgdGltZW91dCA9IDMwMDA7XG4gICAgbG9nZ2VyLmRlYnVnKGBXYWl0aW5nIGZvciAke3RpbWVvdXR9IG1zIGJlZm9yZSBuYXZpZ2F0aW5nIHRvIHZpZXcuYCk7XG4gIH1cbiAgYXdhaXQgQi5kZWxheSh0aW1lb3V0KTtcbiAgaWYgKHRoaXMudXNlTmV3U2FmYXJpKCkpIHtcbiAgICBhd2FpdCB0aGlzLnR5cGVBbmROYXZUb1VybCgpO1xuICB9IGVsc2UgaWYgKHBhcnNlSW50KHRoaXMuaW9zU2RrVmVyc2lvbiwgMTApID49IDcgJiYgIXRoaXMuaXNSZWFsRGV2aWNlKCkgJiYgdGhpcy5vcHRzLnNhZmFyaSkge1xuICAgIGF3YWl0IHRoaXMubmF2VG9WaWV3VGhyb3VnaEZhdm9yaXRlcygpO1xuICB9IGVsc2Uge1xuICAgIGF3YWl0IHRoaXMubmF2VG9WaWV3V2l0aFRpdGxlKC8uKi8pO1xuICB9XG59O1xuXG5hc3luYyBmdW5jdGlvbiBvcGVuTmV3UGFnZSAoKSB7XG4gIGxldCBuZXdQYWdlQnV0dG9uID0gYXdhaXQgdGhpcy5maW5kRWxlbWVudCgneHBhdGgnLCBcIi8vVUlBQnV0dG9uW2NvbnRhaW5zKEBuYW1lLCdOZXcgcGFnZScpXVwiKTtcbiAgYXdhaXQgdGhpcy5uYXRpdmVUYXAobmV3UGFnZUJ1dHRvbi5FTEVNRU5UKTtcbn1cblxuZXh0ZW5zaW9ucy50eXBlQW5kTmF2VG9VcmwgPSBhc3luYyBmdW5jdGlvbiAoKSB7XG4gIGxldCBhZGRyZXNzID0gdGhpcy5vcHRzLmFkZHJlc3MgPyB0aGlzLm9wdHMuYWRkcmVzcyA6ICcxMjcuMC4wLjEnO1xuICB0aGlzLnNldEN1cnJlbnRVcmwodGhpcy5jYXBzLnNhZmFyaUluaXRpYWxVcmwgfHwgYGh0dHA6Ly8ke2FkZHJlc3N9OiR7dGhpcy5vcHRzLnBvcnR9L3dlbGNvbWVgKTtcblxuICBsZXQgdHJpZXMgPSAwO1xuICBjb25zdCBNQVhfVFJJRVMgPSAyO1xuICBsZXQgbmF2aWdhdGUgPSBhc3luYyAoKSA9PiB7XG4gICAgbGV0IG9sZEltcFdhaXQgPSB0aGlzLmltcGxpY2l0V2FpdE1zO1xuICAgIHRoaXMuaW1wbGljaXRXYWl0TXMgPSA3MDAwO1xuXG4gICAgLy8gZmluZCB0aGUgdXJsIGJhciwgYW5kIHRhcCBvbiBpdC4gcmV0cnkgdG8gbWFrZSBzdXJlIHdlIGRvbid0IHRyeVxuICAgIC8vIHRvbyBzb29uIHdoaWxlIHRoZSB2aWV3IGlzIHN0aWxsIGxvYWRpbmdcbiAgICBsZXQgZWwgPSBhd2FpdCByZXRyeUludGVydmFsKDMsIDEwMDAsIGFzeW5jICgpID0+IHtcbiAgICAgIHJldHVybiBhd2FpdCB0aGlzLmZpbmRFbGVtZW50KCdhY2Nlc3NpYmlsaXR5IGlkJywgJ1VSTCcpO1xuICAgIH0pO1xuICAgIHRoaXMuaW1wbGljaXRXYWl0TXMgPSBvbGRJbXBXYWl0O1xuXG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IHRoaXMubmF0aXZlVGFwKGVsLkVMRU1FTlQpO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgaWYgKF8uaW5jbHVkZXMoZXJyLm1lc3NhZ2UsICdjb3VsZCBub3QgYmUgdGFwcGVkJykpIHtcbiAgICAgICAgaWYgKHRyaWVzKysgPj0gTUFYX1RSSUVTKSB0aHJvdyBlcnI7IC8vIGVzbGludC1kaXNhYmxlLWxpbmUgY3VybHlcblxuICAgICAgICAvLyBnZW5lcmFsbHkgdGhpcyBtZWFucyB0aGF0IFNhZmFyaSBpcyBpbiBwYWdlIHZpZXdpbmcgbW9kZVxuICAgICAgICAvLyBzbyB0cnkgdG8gb3BlbiBhIG5ldyBwYWdlIGFuZCB0aGVuIHJlZG8gdGhlIG5hdmlnYXRpb25cbiAgICAgICAgYXdhaXQgb3Blbk5ld1BhZ2UoKTtcbiAgICAgICAgcmV0dXJuIGF3YWl0IG5hdmlnYXRlKCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aHJvdyBlcnI7XG4gICAgICB9XG4gICAgfVxuXG4gICAgLy8gZ2V0IHRoZSBsYXN0IGFkZHJlc3MgZWxlbWVudCBhbmQgc2V0IHRoZSB1cmxcbiAgICB0cnkge1xuICAgICAgbGV0IGVsID0gYXdhaXQgdGhpcy5maW5kRWxlbWVudCgnY2xhc3MgbmFtZScsICdVSUFUZXh0RmllbGQnKTtcbiAgICAgIGF3YWl0IHRoaXMuc2V0VmFsdWVJbW1lZGlhdGUodGhpcy5nZXRDdXJyZW50VXJsKCksIGVsKTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIC8vIHRoaXMgaXMgZmxha2V5IG9uIGNlcnRhaW4gc3lzdGVtcyBzbyB3ZSByZXRyeSB1bnRpbCB3ZSBnZXQgc29tZXRoaW5nXG4gICAgICAvLyBpb3Mgc2ltczogc2FmYXJpIG9wZW5zIGJ1dCB0aGUgdGV4dCBmaWVsZCBjYW4ndCBiZSBmb3VuZFxuICAgICAgaWYgKHRyaWVzKysgPj0gTUFYX1RSSUVTKSB0aHJvdyBlcnI7IC8vIGVzbGludC1kaXNhYmxlLWxpbmUgY3VybHlcbiAgICAgIHJldHVybiBhd2FpdCBuYXZpZ2F0ZSgpO1xuICAgIH1cblxuICAgIC8vIG1ha2UgaXQgaGFwcGVuXG4gICAgdHJ5IHtcbiAgICAgIGVsID0gYXdhaXQgdGhpcy5maW5kRWxlbWVudCgnYWNjZXNzaWJpbGl0eSBpZCcsICdHbycpO1xuICAgICAgYXdhaXQgdGhpcy5uYXRpdmVUYXAoZWwuRUxFTUVOVCk7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICBpZiAoXy5pbmNsdWRlcyhlcnIubWVzc2FnZSwgJ2NvdWxkIG5vdCBiZSB0YXBwZWQnKSkge1xuICAgICAgICBsb2dnZXIuZXJyb3IoJ1VuYWJsZSB0byBzdWJtaXQgVVJMIGJlY2F1c2UgXFwnR29cXCcgYnV0dG9uIGNvdWxkIG5vdCBiZSB0YXBwZWQuICcgK1xuICAgICAgICAgICAgICAgICAgICAgJ1BsZWFzZSBtYWtlIHN1cmUgeW91ciBrZXlib2FyZCBpcyB0b2dnbGVkIG9uLicpO1xuICAgICAgfVxuICAgICAgdGhyb3cgZXJyO1xuICAgIH1cbiAgICBhd2FpdCB0aGlzLm5hdlRvVmlld1dpdGhUaXRsZSh1bmRlZmluZWQsIG5ldyBSZWdFeHAodGhpcy5nZXRDdXJyZW50VXJsKCksICdpJykpO1xuXG4gICAgLy8gd2FpdCBmb3IgcGFnZSB0byBmaW5pc2ggbG9hZGluZy5cbiAgICBhd2FpdCB0aGlzLnJlbW90ZS5wYWdlVW5sb2FkKCk7XG4gIH07XG4gIGF3YWl0IG5hdmlnYXRlKCk7XG59O1xuXG5leHRlbnNpb25zLm5hdlRvVmlld1Rocm91Z2hGYXZvcml0ZXMgPSBhc3luYyBmdW5jdGlvbiAoKSB7XG4gIGxvZ2dlci5kZWJ1ZygnV2UgYXJlIG9uIGlPUzcrIHNpbXVsYXRvcjogY2xpY2tpbmcgYXBwbGUgYnV0dG9uIHRvIGdldCBpbnRvIGEgd2VidmlldycpO1xuICBsZXQgb2xkSW1wV2FpdCA9IHRoaXMuaW1wbGljaXRXYWl0TXM7XG4gIHRoaXMuaW1wbGljaXRXYWl0TXMgPSA3MDAwOyAvLyB3YWl0IDdzIGZvciBhcHBsZSBidXR0b24gdG8gZXhpc3RcblxuICBsZXQgZWw7XG4gIHRyeSB7XG4gICAgZWwgPSBhd2FpdCB0aGlzLmZpbmRFbGVtZW50KCd4cGF0aCcsICcvL1VJQVNjcm9sbFZpZXdbMV0vVUlBQnV0dG9uWzFdJyk7XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIGxldCBtc2cgPSAnQ291bGQgbm90IGZpbmQgYnV0dG9uIHRvIGNsaWNrIHRvIGdldCBpbnRvIHdlYnZpZXcuICcgK1xuICAgICAgICAgICAgICAnUHJvY2VlZGluZyBvbiB0aGUgYXNzdW1wdGlvbiB3ZSBoYXZlIGEgd29ya2luZyBvbmUuJztcbiAgICBsb2dnZXIuZXJyb3IobXNnKTtcbiAgICB0aGlzLmltcGxpY2l0V2FpdE1zID0gb2xkSW1wV2FpdDtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5uYXZUb1ZpZXdXaXRoVGl0bGUoLy4qL2kpO1xuICB9XG4gIHRoaXMuaW1wbGljaXRXYWl0TXMgPSBvbGRJbXBXYWl0O1xuICB0cnkge1xuICAgIGF3YWl0IHRoaXMubmF0aXZlVGFwKGVsLkVMRU1FTlQpO1xuICB9IGNhdGNoIChlcnIpIHtcbiAgICBsZXQgbXNnID0gJ0NvdWxkIG5vdCBjbGljayBidXR0b24gdG8gZ2V0IGludG8gd2Vidmlldy4gJyArXG4gICAgICAgICAgICAgICdQcm9jZWVkaW5nIG9uIHRoZSBhc3N1bXB0aW9uIHdlIGhhdmUgYSB3b3JraW5nIG9uZS4nO1xuICAgIGxvZ2dlci5lcnJvcihtc2cpO1xuICB9XG4gIGF3YWl0IHRoaXMubmF2VG9WaWV3V2l0aFRpdGxlKC9hcHBsZS9pKTtcbn07XG5cbmV4dGVuc2lvbnMubmF2VG9WaWV3V2l0aFRpdGxlID0gYXN5bmMgZnVuY3Rpb24gKHRpdGxlUmVnZXgsIHVybFJlZ0V4cCkge1xuICBsb2dnZXIuZGVidWcoJ05hdmlnYXRpbmcgdG8gbW9zdCByZWNlbnRseSBvcGVuZWQgd2VidmlldycpO1xuICBsZXQgc3RhcnQgPSBEYXRlLm5vdygpO1xuICBsZXQgc3BpblRpbWUgPSA1MDA7XG4gIGxldCBzcGluSGFuZGxlcyA9IGFzeW5jICgpID0+IHtcbiAgICBsZXQgcmVzO1xuICAgIHRyeSB7XG4gICAgICByZXMgPSBhd2FpdCB0aGlzLmdldExhdGVzdFdlYnZpZXdDb250ZXh0Rm9yVGl0bGUodGl0bGVSZWdleCB8fCB1cmxSZWdFeHApO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgaWYgKGVyci5tZXNzYWdlLmluZGV4T2YoJ0NvdWxkIG5vdCBjb25uZWN0IHRvIGEgdmFsaWQgYXBwIGFmdGVyJykgPT09IC0xKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgQ291bGQgbm90IG5hdmlnYXRlIHRvIHdlYnZpZXchIEVycjogJHtlcnIubWVzc2FnZX1gKTtcbiAgICAgIH1cbiAgICAgIGxvZ2dlci5kZWJ1ZygnQ291bGQgbm90IG5hdmlnYXRlIHRvIHdlYnZpZXcuIFJldHJ5aW5nIGlmIHBvc3NpYmxlLicpO1xuICAgIH1cbiAgICBpZiAocmVzKSB7XG4gICAgICBsZXQgbGF0ZXN0V2luZG93ID0gcmVzO1xuICAgICAgbG9nZ2VyLmRlYnVnKGBQaWNraW5nIHdlYnZpZXcgJyR7bGF0ZXN0V2luZG93fSdgKTtcbiAgICAgIGF3YWl0IHRoaXMuc2V0Q29udGV4dChsYXRlc3RXaW5kb3cpO1xuICAgICAgYXdhaXQgdGhpcy5yZW1vdGUuY2FuY2VsUGFnZUxvYWQoKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICAvLyBubyB3ZWJ2aWV3IHdhcyBmb3VuZFxuICAgIGlmICgoRGF0ZS5ub3coKSAtIHN0YXJ0KSA+PSA5MDAwMCkge1xuICAgICAgLy8gdG9vIHNsb3csIGdldCBvdXRcbiAgICAgIHRocm93IG5ldyBFcnJvcignQ291bGQgbm90IG5hdmlnYXRlIHRvIHdlYnZpZXc7IHRoZXJlIGFyZSBub25lIScpO1xuICAgIH1cblxuICAgIGxvZ2dlci53YXJuKFwiQ291bGQgbm90IGZpbmQgYW55IHdlYnZpZXdzIHlldCwgcmVmcmVzaGluZy9yZXRyeWluZ1wiKTtcbiAgICBpZiAodGhpcy5pc1JlYWxEZXZpY2UoKSB8fCAhdGhpcy5vcHRzLnNhZmFyaSkge1xuICAgICAgLy8gb24gYSByZWFsIGRldmljZSwgd2hlbiBub3QgdXNpbmcgU2FmYXJpLCB3ZSBqdXN0IHdhbnQgdG8gdHJ5IGFnYWluXG4gICAgICBhd2FpdCBCLmRlbGF5KHNwaW5UaW1lKTtcbiAgICAgIHJldHVybiBhd2FpdCBzcGluSGFuZGxlcygpO1xuICAgIH1cblxuICAgIC8vIGZpbmQgdGhlIHJlbG9hZCBidXR0b24gYW5kIHRhcCBpdCwgaWYgcG9zc2libGVcbiAgICBsZXQgZWxlbWVudDtcbiAgICB0cnkge1xuICAgICAgbG9nZ2VyLmRlYnVnKCdGaW5kaW5nIGFuZCB0YXBwaW5nIHJlbG9hZCBidXR0b24nKTtcbiAgICAgIGVsZW1lbnQgPSBhd2FpdCB0aGlzLmZpbmRVSUVsZW1lbnRPckVsZW1lbnRzKCdhY2Nlc3NpYmlsaXR5IGlkJywgJ1JlbG9hZEJ1dHRvbicsICcnLCBmYWxzZSk7XG4gICAgICBhd2FpdCB0aGlzLm5hdGl2ZVRhcChlbGVtZW50LkVMRU1FTlQpO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgbG9nZ2VyLndhcm4oYEVycm9yIGZpbmRpbmcgYW5kIHRhcHBpbmcgcmVsb2FkIGJ1dHRvbjogJHtlcnIubWVzc2FnZX1gKTtcbiAgICAgIGxvZ2dlci53YXJuKCdSZXRyeWluZy4nKTtcbiAgICAgIGF3YWl0IEIuZGVsYXkoc3BpblRpbWUpO1xuICAgIH1cblxuICAgIC8vIHRyeSBpdCBhbGwgYWdhaW5cbiAgICByZXR1cm4gYXdhaXQgc3BpbkhhbmRsZXMoKTtcbiAgfTtcbiAgYXdhaXQgc3BpbkhhbmRsZXMoKTtcbn07XG5cbmhlbHBlcnMuY2xvc2VBbGVydEJlZm9yZVRlc3QgPSBhc3luYyBmdW5jdGlvbiAoKSB7XG4gIGxldCBwcmVzZW50ID0gYXdhaXQgdGhpcy51aUF1dG9DbGllbnQuc2VuZENvbW1hbmQoJ2F1LmFsZXJ0SXNQcmVzZW50KCknKTtcbiAgaWYgKCFwcmVzZW50KSB7XG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG5cbiAgbG9nZ2VyLmRlYnVnKCdBbGVydCBwcmVzZW50IGJlZm9yZSBzdGFydGluZyB0ZXN0LCBsZXQgdXMgYmFuaXNoIGl0Jyk7XG4gIGF3YWl0IHRoaXMudWlBdXRvQ2xpZW50LnNlbmRDb21tYW5kKCdhdS5kaXNtaXNzQWxlcnQoKScpO1xuICBsb2dnZXIuZGVidWcoJ0FsZXJ0IGJhbmlzaGVkIScpO1xuICByZXR1cm4gdHJ1ZTtcbn07XG5cbmhlbHBlcnMuc3RvcFJlbW90ZSA9IGFzeW5jIGZ1bmN0aW9uIChjbG9zZVdpbmRvd0JlZm9yZURpc2Nvbm5lY3RpbmcgPSBmYWxzZSkge1xuICBpZiAoIXRoaXMucmVtb3RlKSB7XG4gICAgbG9nZ2VyLmVycm9yQW5kVGhyb3coJ1RyaWVkIHRvIGxlYXZlIGEgd2ViIGZyYW1lIGJ1dCB3ZXJlIG5vdCBpbiBvbmUnKTtcbiAgfVxuXG4gIGlmIChjbG9zZVdpbmRvd0JlZm9yZURpc2Nvbm5lY3RpbmcpIHtcbiAgICBhd2FpdCB0aGlzLmNsb3NlV2luZG93KCk7XG4gIH1cbiAgYXdhaXQgdGhpcy5yZW1vdGUuZGlzY29ubmVjdCgpO1xuICB0aGlzLmN1ckNvbnRleHQgPSBudWxsO1xuICB0aGlzLmN1cldlYkZyYW1lcyA9IFtdO1xuICB0aGlzLmN1cldlYkNvb3JkcyA9IG51bGw7XG4gIHRoaXMucmVtb3RlID0gbnVsbDtcbn07XG5cbmhlbHBlcnMuaXNXZWJDb250ZXh0ID0gZnVuY3Rpb24gKCkge1xuICByZXR1cm4gISF0aGlzLmN1ckNvbnRleHQgJiYgdGhpcy5jdXJDb250ZXh0ICE9PSBOQVRJVkVfV0lOO1xufTtcblxuaGVscGVycy5zZXRDdXJyZW50VXJsID0gZnVuY3Rpb24gKHVybCkge1xuICB0aGlzLl9jdXJyZW50VXJsID0gdXJsO1xufTtcblxuaGVscGVycy5nZXRDdXJyZW50VXJsID0gZnVuY3Rpb24gKCkge1xuICByZXR1cm4gdGhpcy5fY3VycmVudFVybDtcbn07XG5cblxuT2JqZWN0LmFzc2lnbihleHRlbnNpb25zLCBjb21tYW5kcywgaGVscGVycyk7XG5leHBvcnQgeyBjb21tYW5kcywgaGVscGVycywgTkFUSVZFX1dJTiwgV0VCVklFV19XSU4sIFdFQlZJRVdfQkFTRSB9O1xuZXhwb3J0IGRlZmF1bHQgZXh0ZW5zaW9ucztcbiJdLCJzb3VyY2VSb290IjoiLi4vLi4vLi4ifQ==

'use strict';

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _Object$assign = require('babel-runtime/core-js/object/assign')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _uuidJs = require('uuid-js');

var _uuidJs2 = _interopRequireDefault(_uuidJs);

var _bluebird = require('bluebird');

var _bluebird2 = _interopRequireDefault(_bluebird);

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

var _asyncbox = require('asyncbox');

var _appiumSupport = require('appium-support');

var _uiautoUtils = require('../uiauto/utils');

var _logger = require('../logger');

var _logger2 = _interopRequireDefault(_logger);

var _appiumBaseDriver = require('appium-base-driver');

var commands = {},
    helpers = {},
    extensions = {};

commands.getScreenshot = function callee$0$0() {
  var guid, shotFile, shotFolder, shotPath, takeScreenShot, data;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    var _this = this;

    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        guid = _uuidJs2['default'].create();
        shotFile = 'screenshot' + guid;
        shotFolder = _path2['default'].resolve(this.opts.tmpDir, 'appium-instruments/Run 1/');
        context$1$0.next = 5;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.exists(shotFolder));

      case 5:
        if (context$1$0.sent) {
          context$1$0.next = 9;
          break;
        }

        _logger2['default'].debug('Creating folder \'' + shotFolder + '\'');
        context$1$0.next = 9;
        return _regeneratorRuntime.awrap((0, _appiumSupport.mkdirp)(shotFolder));

      case 9:
        shotPath = _path2['default'].resolve(shotFolder, shotFile + '.png');

        _logger2['default'].debug('Taking screenshot: \'' + shotPath + '\'');

        takeScreenShot = function takeScreenShot() {
          var screenshotWaitTimeout, startMs, success;
          return _regeneratorRuntime.async(function takeScreenShot$(context$2$0) {
            while (1) switch (context$2$0.prev = context$2$0.next) {
              case 0:
                context$2$0.next = 2;
                return _regeneratorRuntime.awrap(this.uiAutoClient.sendCommand('au.capture(\'' + shotFile + '\')'));

              case 2:
                screenshotWaitTimeout = (this.opts.screenshotWaitTimeout || 10) * 1000;

                _logger2['default'].debug('Waiting ' + screenshotWaitTimeout + ' ms for screenshot to be generated.');
                startMs = Date.now();
                success = false;

              case 6:
                if (!(Date.now() - startMs < screenshotWaitTimeout)) {
                  context$2$0.next = 16;
                  break;
                }

                context$2$0.next = 9;
                return _regeneratorRuntime.awrap(_appiumSupport.fs.hasAccess(shotPath));

              case 9:
                if (!context$2$0.sent) {
                  context$2$0.next = 12;
                  break;
                }

                success = true;
                return context$2$0.abrupt('break', 16);

              case 12:
                context$2$0.next = 14;
                return _regeneratorRuntime.awrap(_bluebird2['default'].delay(300));

              case 14:
                context$2$0.next = 6;
                break;

              case 16:
                if (success) {
                  context$2$0.next = 18;
                  break;
                }

                throw new _appiumBaseDriver.errors.UnknownError('Timed out waiting for screenshot file');

              case 18:
                context$2$0.next = 20;
                return _regeneratorRuntime.awrap(this.getOrientation());

              case 20:
                context$2$0.t0 = context$2$0.sent;

                if (!(context$2$0.t0 === 'LANDSCAPE')) {
                  context$2$0.next = 25;
                  break;
                }

                _logger2['default'].debug('Rotating landscape screenshot');
                context$2$0.next = 25;
                return _regeneratorRuntime.awrap((0, _uiautoUtils.rotateImage)(shotPath, -90));

              case 25:
                context$2$0.next = 27;
                return _regeneratorRuntime.awrap(_appiumSupport.fs.readFile(shotPath));

              case 27:
                return context$2$0.abrupt('return', context$2$0.sent);

              case 28:
              case 'end':
                return context$2$0.stop();
            }
          }, null, _this);
        };

        context$1$0.next = 14;
        return _regeneratorRuntime.awrap((0, _asyncbox.retry)(3, takeScreenShot));

      case 14:
        data = context$1$0.sent;
        return context$1$0.abrupt('return', Buffer.from(data).toString('base64'));

      case 16:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

commands.getViewportScreenshot = function callee$0$0() {
  var windowSize, scale, statusBarHeight, screenshot, rect, newScreenshot;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.next = 2;
        return _regeneratorRuntime.awrap(this.getWindowSize());

      case 2:
        windowSize = context$1$0.sent;
        context$1$0.next = 5;
        return _regeneratorRuntime.awrap(this.getDevicePixelRatio());

      case 5:
        scale = context$1$0.sent;
        context$1$0.next = 8;
        return _regeneratorRuntime.awrap(this.getStatusBarHeight());

      case 8:
        context$1$0.t0 = context$1$0.sent;
        context$1$0.t1 = scale;
        statusBarHeight = context$1$0.t0 * context$1$0.t1;
        context$1$0.next = 13;
        return _regeneratorRuntime.awrap(this.getScreenshot());

      case 13:
        screenshot = context$1$0.sent;
        rect = {
          left: 0,
          top: statusBarHeight,
          width: windowSize.width * scale,
          height: windowSize.height * scale - statusBarHeight
        };
        context$1$0.next = 17;
        return _regeneratorRuntime.awrap(_appiumSupport.imageUtil.cropBase64Image(screenshot, rect));

      case 17:
        newScreenshot = context$1$0.sent;
        return context$1$0.abrupt('return', newScreenshot);

      case 19:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

_Object$assign(extensions, commands, helpers);
exports.commands = commands;
exports.helpers = helpers;
exports['default'] = extensions;

// check the rotation, and rotate if necessary

// Retrying the whole screenshot process for three times.

// status bar height comes in unscaled, so scale it
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9jb21tYW5kcy9zY3JlZW5zaG90LmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7OztzQkFBaUIsU0FBUzs7Ozt3QkFDWixVQUFVOzs7O29CQUNQLE1BQU07Ozs7d0JBQ0QsVUFBVTs7NkJBQ00sZ0JBQWdCOzsyQkFDMUIsaUJBQWlCOztzQkFDMUIsV0FBVzs7OztnQ0FDUCxvQkFBb0I7O0FBRzNDLElBQUksUUFBUSxHQUFHLEVBQUU7SUFBRSxPQUFPLEdBQUcsRUFBRTtJQUFFLFVBQVUsR0FBRyxFQUFFLENBQUM7O0FBRWpELFFBQVEsQ0FBQyxhQUFhLEdBQUc7TUFDbkIsSUFBSSxFQUNKLFFBQVEsRUFFUixVQUFVLEVBTVYsUUFBUSxFQUdSLGNBQWMsRUE0QmQsSUFBSTs7Ozs7O0FBeENKLFlBQUksR0FBRyxvQkFBSyxNQUFNLEVBQUU7QUFDcEIsZ0JBQVEsa0JBQWdCLElBQUk7QUFFNUIsa0JBQVUsR0FBRyxrQkFBSyxPQUFPLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxNQUFNLEVBQUUsMkJBQTJCLENBQUM7O3lDQUNoRSxrQkFBRyxNQUFNLENBQUMsVUFBVSxDQUFDOzs7Ozs7OztBQUMvQiw0QkFBTyxLQUFLLHdCQUFxQixVQUFVLFFBQUksQ0FBQzs7eUNBQzFDLDJCQUFPLFVBQVUsQ0FBQzs7O0FBR3RCLGdCQUFRLEdBQUcsa0JBQUssT0FBTyxDQUFDLFVBQVUsRUFBSyxRQUFRLFVBQU87O0FBQzFELDRCQUFPLEtBQUssMkJBQXdCLFFBQVEsUUFBSSxDQUFDOztBQUU3QyxzQkFBYyxHQUFHLFNBQWpCLGNBQWM7Y0FHWixxQkFBcUIsRUFFckIsT0FBTyxFQUVQLE9BQU87Ozs7O2lEQU5MLElBQUksQ0FBQyxZQUFZLENBQUMsV0FBVyxtQkFBZ0IsUUFBUSxTQUFLOzs7QUFFNUQscUNBQXFCLEdBQUcsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLHFCQUFxQixJQUFJLEVBQUUsQ0FBQSxHQUFJLElBQUk7O0FBQzFFLG9DQUFPLEtBQUssY0FBWSxxQkFBcUIseUNBQXNDLENBQUM7QUFDaEYsdUJBQU8sR0FBRyxJQUFJLENBQUMsR0FBRyxFQUFFO0FBRXBCLHVCQUFPLEdBQUcsS0FBSzs7O3NCQUNaLEFBQUMsSUFBSSxDQUFDLEdBQUcsRUFBRSxHQUFHLE9BQU8sR0FBSSxxQkFBcUIsQ0FBQTs7Ozs7O2lEQUN6QyxrQkFBRyxTQUFTLENBQUMsUUFBUSxDQUFDOzs7Ozs7OztBQUM5Qix1QkFBTyxHQUFHLElBQUksQ0FBQzs7Ozs7aURBR1gsc0JBQUUsS0FBSyxDQUFDLEdBQUcsQ0FBQzs7Ozs7OztvQkFFZixPQUFPOzs7OztzQkFDSixJQUFJLHlCQUFPLFlBQVksQ0FBQyx1Q0FBdUMsQ0FBQzs7OztpREFJOUQsSUFBSSxDQUFDLGNBQWMsRUFBRTs7Ozs7eUNBQUssV0FBVzs7Ozs7QUFDN0Msb0NBQU8sS0FBSyxDQUFDLCtCQUErQixDQUFDLENBQUM7O2lEQUN4Qyw4QkFBWSxRQUFRLEVBQUUsQ0FBQyxFQUFFLENBQUM7Ozs7aURBRXJCLGtCQUFHLFFBQVEsQ0FBQyxRQUFRLENBQUM7Ozs7Ozs7Ozs7U0FDbkM7Ozt5Q0FHZ0IscUJBQU0sQ0FBQyxFQUFFLGNBQWMsQ0FBQzs7O0FBQXJDLFlBQUk7NENBQ0QsTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxRQUFRLENBQUMsUUFBUSxDQUFDOzs7Ozs7O0NBQzVDLENBQUM7O0FBRUYsUUFBUSxDQUFDLHFCQUFxQixHQUFHO01BQ3pCLFVBQVUsRUFDVixLQUFLLEVBRUwsZUFBZSxFQUNmLFVBQVUsRUFDWixJQUFJLEVBTUosYUFBYTs7Ozs7eUNBWFEsSUFBSSxDQUFDLGFBQWEsRUFBRTs7O0FBQXZDLGtCQUFVOzt5Q0FDSSxJQUFJLENBQUMsbUJBQW1CLEVBQUU7OztBQUF4QyxhQUFLOzt5Q0FFbUIsSUFBSSxDQUFDLGtCQUFrQixFQUFFOzs7O3lCQUFHLEtBQUs7QUFBekQsdUJBQWU7O3lDQUNJLElBQUksQ0FBQyxhQUFhLEVBQUU7OztBQUF2QyxrQkFBVTtBQUNaLFlBQUksR0FBRztBQUNULGNBQUksRUFBRSxDQUFDO0FBQ1AsYUFBRyxFQUFFLGVBQWU7QUFDcEIsZUFBSyxFQUFFLFVBQVUsQ0FBQyxLQUFLLEdBQUcsS0FBSztBQUMvQixnQkFBTSxFQUFFLFVBQVUsQ0FBQyxNQUFNLEdBQUcsS0FBSyxHQUFHLGVBQWU7U0FDcEQ7O3lDQUN5Qix5QkFBVSxlQUFlLENBQUMsVUFBVSxFQUFFLElBQUksQ0FBQzs7O0FBQWpFLHFCQUFhOzRDQUNWLGFBQWE7Ozs7Ozs7Q0FDckIsQ0FBQzs7QUFFRixlQUFjLFVBQVUsRUFBRSxRQUFRLEVBQUUsT0FBTyxDQUFDLENBQUM7UUFDckMsUUFBUSxHQUFSLFFBQVE7UUFBRSxPQUFPLEdBQVAsT0FBTztxQkFDVixVQUFVIiwiZmlsZSI6ImxpYi9jb21tYW5kcy9zY3JlZW5zaG90LmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHV1aWQgZnJvbSAndXVpZC1qcyc7XG5pbXBvcnQgQiBmcm9tICdibHVlYmlyZCc7XG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCB7IHJldHJ5IH0gZnJvbSAnYXN5bmNib3gnO1xuaW1wb3J0IHsgZnMsIG1rZGlycCwgaW1hZ2VVdGlsIH0gZnJvbSAnYXBwaXVtLXN1cHBvcnQnO1xuaW1wb3J0IHsgcm90YXRlSW1hZ2UgfSBmcm9tICcuLi91aWF1dG8vdXRpbHMnO1xuaW1wb3J0IGxvZ2dlciBmcm9tICcuLi9sb2dnZXInO1xuaW1wb3J0IHsgZXJyb3JzIH0gZnJvbSAnYXBwaXVtLWJhc2UtZHJpdmVyJztcblxuXG5sZXQgY29tbWFuZHMgPSB7fSwgaGVscGVycyA9IHt9LCBleHRlbnNpb25zID0ge307XG5cbmNvbW1hbmRzLmdldFNjcmVlbnNob3QgPSBhc3luYyBmdW5jdGlvbiAoKSB7XG4gIGxldCBndWlkID0gdXVpZC5jcmVhdGUoKTtcbiAgbGV0IHNob3RGaWxlID0gYHNjcmVlbnNob3Qke2d1aWR9YDtcblxuICBsZXQgc2hvdEZvbGRlciA9IHBhdGgucmVzb2x2ZSh0aGlzLm9wdHMudG1wRGlyLCAnYXBwaXVtLWluc3RydW1lbnRzL1J1biAxLycpO1xuICBpZiAoIShhd2FpdCBmcy5leGlzdHMoc2hvdEZvbGRlcikpKSB7XG4gICAgbG9nZ2VyLmRlYnVnKGBDcmVhdGluZyBmb2xkZXIgJyR7c2hvdEZvbGRlcn0nYCk7XG4gICAgYXdhaXQgbWtkaXJwKHNob3RGb2xkZXIpO1xuICB9XG5cbiAgbGV0IHNob3RQYXRoID0gcGF0aC5yZXNvbHZlKHNob3RGb2xkZXIsIGAke3Nob3RGaWxlfS5wbmdgKTtcbiAgbG9nZ2VyLmRlYnVnKGBUYWtpbmcgc2NyZWVuc2hvdDogJyR7c2hvdFBhdGh9J2ApO1xuXG4gIGxldCB0YWtlU2NyZWVuU2hvdCA9IGFzeW5jICgpID0+IHtcbiAgICBhd2FpdCB0aGlzLnVpQXV0b0NsaWVudC5zZW5kQ29tbWFuZChgYXUuY2FwdHVyZSgnJHtzaG90RmlsZX0nKWApO1xuXG4gICAgbGV0IHNjcmVlbnNob3RXYWl0VGltZW91dCA9ICh0aGlzLm9wdHMuc2NyZWVuc2hvdFdhaXRUaW1lb3V0IHx8IDEwKSAqIDEwMDA7XG4gICAgbG9nZ2VyLmRlYnVnKGBXYWl0aW5nICR7c2NyZWVuc2hvdFdhaXRUaW1lb3V0fSBtcyBmb3Igc2NyZWVuc2hvdCB0byBiZSBnZW5lcmF0ZWQuYCk7XG4gICAgbGV0IHN0YXJ0TXMgPSBEYXRlLm5vdygpO1xuXG4gICAgbGV0IHN1Y2Nlc3MgPSBmYWxzZTtcbiAgICB3aGlsZSAoKERhdGUubm93KCkgLSBzdGFydE1zKSA8IHNjcmVlbnNob3RXYWl0VGltZW91dCkge1xuICAgICAgaWYgKGF3YWl0IGZzLmhhc0FjY2VzcyhzaG90UGF0aCkpIHtcbiAgICAgICAgc3VjY2VzcyA9IHRydWU7XG4gICAgICAgIGJyZWFrO1xuICAgICAgfVxuICAgICAgYXdhaXQgQi5kZWxheSgzMDApO1xuICAgIH1cbiAgICBpZiAoIXN1Y2Nlc3MpIHtcbiAgICAgIHRocm93IG5ldyBlcnJvcnMuVW5rbm93bkVycm9yKCdUaW1lZCBvdXQgd2FpdGluZyBmb3Igc2NyZWVuc2hvdCBmaWxlJyk7XG4gICAgfVxuXG4gICAgLy8gY2hlY2sgdGhlIHJvdGF0aW9uLCBhbmQgcm90YXRlIGlmIG5lY2Vzc2FyeVxuICAgIGlmIChhd2FpdCB0aGlzLmdldE9yaWVudGF0aW9uKCkgPT09ICdMQU5EU0NBUEUnKSB7XG4gICAgICBsb2dnZXIuZGVidWcoJ1JvdGF0aW5nIGxhbmRzY2FwZSBzY3JlZW5zaG90Jyk7XG4gICAgICBhd2FpdCByb3RhdGVJbWFnZShzaG90UGF0aCwgLTkwKTtcbiAgICB9XG4gICAgcmV0dXJuIGF3YWl0IGZzLnJlYWRGaWxlKHNob3RQYXRoKTtcbiAgfTtcblxuICAvLyBSZXRyeWluZyB0aGUgd2hvbGUgc2NyZWVuc2hvdCBwcm9jZXNzIGZvciB0aHJlZSB0aW1lcy5cbiAgbGV0IGRhdGEgPSBhd2FpdCByZXRyeSgzLCB0YWtlU2NyZWVuU2hvdCk7XG4gIHJldHVybiBCdWZmZXIuZnJvbShkYXRhKS50b1N0cmluZygnYmFzZTY0Jyk7XG59O1xuXG5jb21tYW5kcy5nZXRWaWV3cG9ydFNjcmVlbnNob3QgPSBhc3luYyBmdW5jdGlvbiAoKSB7XG4gIGNvbnN0IHdpbmRvd1NpemUgPSBhd2FpdCB0aGlzLmdldFdpbmRvd1NpemUoKTtcbiAgY29uc3Qgc2NhbGUgPSBhd2FpdCB0aGlzLmdldERldmljZVBpeGVsUmF0aW8oKTtcbiAgLy8gc3RhdHVzIGJhciBoZWlnaHQgY29tZXMgaW4gdW5zY2FsZWQsIHNvIHNjYWxlIGl0XG4gIGNvbnN0IHN0YXR1c0JhckhlaWdodCA9IGF3YWl0IHRoaXMuZ2V0U3RhdHVzQmFySGVpZ2h0KCkgKiBzY2FsZTtcbiAgY29uc3Qgc2NyZWVuc2hvdCA9IGF3YWl0IHRoaXMuZ2V0U2NyZWVuc2hvdCgpO1xuICBsZXQgcmVjdCA9IHtcbiAgICBsZWZ0OiAwLFxuICAgIHRvcDogc3RhdHVzQmFySGVpZ2h0LFxuICAgIHdpZHRoOiB3aW5kb3dTaXplLndpZHRoICogc2NhbGUsXG4gICAgaGVpZ2h0OiB3aW5kb3dTaXplLmhlaWdodCAqIHNjYWxlIC0gc3RhdHVzQmFySGVpZ2h0XG4gIH07XG4gIGxldCBuZXdTY3JlZW5zaG90ID0gYXdhaXQgaW1hZ2VVdGlsLmNyb3BCYXNlNjRJbWFnZShzY3JlZW5zaG90LCByZWN0KTtcbiAgcmV0dXJuIG5ld1NjcmVlbnNob3Q7XG59O1xuXG5PYmplY3QuYXNzaWduKGV4dGVuc2lvbnMsIGNvbW1hbmRzLCBoZWxwZXJzKTtcbmV4cG9ydCB7Y29tbWFuZHMsIGhlbHBlcnN9O1xuZXhwb3J0IGRlZmF1bHQgZXh0ZW5zaW9ucztcbiJdLCJzb3VyY2VSb290IjoiLi4vLi4vLi4ifQ==

'use strict';

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _Object$assign = require('babel-runtime/core-js/object/assign')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _appiumBaseDriver = require('appium-base-driver');

var _appiumSupport = require('appium-support');

var _logger = require('../logger');

var _logger2 = _interopRequireDefault(_logger);

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

var _teen_process = require('teen_process');

var commands = {},
    helpers = {},
    extensions = {};

// TODO: more explicit error message for all the file-movement commands

/*
 *  Get the full path to an iOS simulator file.
 *  Calls cb(err, fullFilePath)
 *  /Some/Path                           fetches a file relative to the root of the device's filesystem.
 *  /Applications/AppName.app/Some/Path  fetches a file relative to the root of that Application's .app directory, adding in the GUID.
 *  So it looks something like: /Applications/GUID-GUID-GUID-GUID/Some/Path
 */
helpers.getSimFileFullPath = function callee$0$0(remotePath) {
  var basePath, appName, appNameRegex, appNameMatches, findPath, _ref, stdout, appRoot, subPath;

  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        basePath = this.sim.getDir();
        appName = null;

        if (this.opts.app) {
          appNameRegex = new RegExp('\\' + _path2['default'].sep + '([\\w-]+\\.app)');
          appNameMatches = appNameRegex.exec(this.opts.app);

          if (appNameMatches) {
            appName = appNameMatches[1];
          }
        }
        // de-absolutize the path
        if (_appiumSupport.system.isWindows()) {
          if (remotePath.indexof("://") === 1) {
            remotePath = remotePath.slice(4);
          }
        } else {
          if (remotePath.indexOf("/") === 0) {
            remotePath = remotePath.slice(1);
          }
        }

        if (!(remotePath.indexOf(appName) === 0)) {
          context$1$0.next = 18;
          break;
        }

        _logger2['default'].debug("We want an app-relative file");

        findPath = basePath;

        if (this.opts.platformVersion >= 8) {
          // the .app file appears in /Containers/Data and /Containers/Bundle both. We only want /Bundle
          findPath = _path2['default'].resolve(basePath, "Containers", "Bundle");
        }
        findPath = findPath.replace(/\s/g, '\\ ');

        context$1$0.next = 11;
        return _regeneratorRuntime.awrap((0, _teen_process.exec)('find', [findPath, '-name', appName]));

      case 11:
        _ref = context$1$0.sent;
        stdout = _ref.stdout;
        appRoot = stdout.replace(/\n$/, '');
        subPath = remotePath.substring(appName.length + 1);
        return context$1$0.abrupt('return', _path2['default'].resolve(appRoot, subPath));

      case 18:
        _logger2['default'].debug("We want a sim-relative file");
        return context$1$0.abrupt('return', _path2['default'].resolve(basePath, remotePath));

      case 20:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

commands.pushFile = function callee$0$0(remotePath, base64Data) {
  var fullPath, content;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        _logger2['default'].debug('Pushing ' + remotePath + ' to iOS simulator');

        if (!this.isRealDevice()) {
          context$1$0.next = 4;
          break;
        }

        _logger2['default'].debug("Unsupported: cannot write files to physical device");
        throw new _appiumBaseDriver.errors.NotYetImplementedError();

      case 4:
        context$1$0.next = 6;
        return _regeneratorRuntime.awrap(this.getSimFileFullPath(remotePath));

      case 6:
        fullPath = context$1$0.sent;

        _logger2['default'].debug('Attempting to write ' + fullPath + '...');
        context$1$0.next = 10;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.exists(fullPath));

      case 10:
        if (!context$1$0.sent) {
          context$1$0.next = 14;
          break;
        }

        _logger2['default'].debug(fullPath + ' already exists, deleting...');
        context$1$0.next = 14;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.unlink(fullPath));

      case 14:
        context$1$0.next = 16;
        return _regeneratorRuntime.awrap((0, _appiumSupport.mkdirp)(_path2['default'].dirname(fullPath)));

      case 16:
        content = Buffer.from(base64Data, 'base64');
        context$1$0.next = 19;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.writeFile(fullPath, content));

      case 19:
        _logger2['default'].debug('Wrote ' + content.length + ' bytes to ' + fullPath);

      case 20:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

commands.pullFile = function callee$0$0(remotePath) {
  var fullPath, data;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        _logger2['default'].debug('Pulling ' + remotePath + ' from sim');

        if (!this.isRealDevice()) {
          context$1$0.next = 3;
          break;
        }

        throw new _appiumBaseDriver.errors.NotYetImplementedError();

      case 3:
        context$1$0.next = 5;
        return _regeneratorRuntime.awrap(this.getSimFileFullPath(remotePath));

      case 5:
        fullPath = context$1$0.sent;

        _logger2['default'].debug('Attempting to read ' + fullPath);
        context$1$0.next = 9;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.readFile(fullPath, { encoding: 'base64' }));

      case 9:
        data = context$1$0.sent;
        return context$1$0.abrupt('return', data);

      case 11:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

commands.pullFolder = function callee$0$0(remotePath) {
  var fullPath, buffer, data;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        _logger2['default'].debug('Pulling \'' + remotePath + '\' from sim');

        if (!this.isRealDevice()) {
          context$1$0.next = 3;
          break;
        }

        throw new _appiumBaseDriver.errors.NotYetImplementedError();

      case 3:
        context$1$0.next = 5;
        return _regeneratorRuntime.awrap(this.getSimFileFullPath(remotePath));

      case 5:
        fullPath = context$1$0.sent;

        _logger2['default'].debug('Adding ' + fullPath + ' to an in-memory zip archive');
        context$1$0.next = 9;
        return _regeneratorRuntime.awrap(_appiumSupport.zip.toInMemoryZip(fullPath));

      case 9:
        buffer = context$1$0.sent;

        _logger2['default'].debug("Converting in-memory zip file to base64 encoded string");
        data = buffer.toString('base64');

        _logger2['default'].debug("Returning in-memory zip file as base54 encoded string");
        return context$1$0.abrupt('return', data);

      case 14:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

_Object$assign(extensions, commands, helpers);
exports.commands = commands;
exports.helpers = helpers;
exports['default'] = extensions;
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9jb21tYW5kcy9maWxlLW1vdmVtZW50LmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7OztnQ0FBdUIsb0JBQW9COzs2QkFDSCxnQkFBZ0I7O3NCQUNyQyxXQUFXOzs7O29CQUNiLE1BQU07Ozs7NEJBQ0YsY0FBYzs7QUFFbkMsSUFBSSxRQUFRLEdBQUcsRUFBRTtJQUFFLE9BQU8sR0FBRyxFQUFFO0lBQUUsVUFBVSxHQUFHLEVBQUUsQ0FBQzs7Ozs7Ozs7Ozs7QUFXakQsT0FBTyxDQUFDLGtCQUFrQixHQUFHLG9CQUFnQixVQUFVO01BQ2pELFFBQVEsRUFDUixPQUFPLEVBR0wsWUFBWSxFQUNaLGNBQWMsRUFtQmQsUUFBUSxRQU9OLE1BQU0sRUFDUixPQUFPLEVBQ1AsT0FBTzs7Ozs7QUFqQ1QsZ0JBQVEsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLE1BQU0sRUFBRTtBQUM1QixlQUFPLEdBQUcsSUFBSTs7QUFFbEIsWUFBSSxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsRUFBRTtBQUNiLHNCQUFZLEdBQUcsSUFBSSxNQUFNLFFBQU0sa0JBQUssR0FBRyxxQkFBa0I7QUFDekQsd0JBQWMsR0FBRyxZQUFZLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDOztBQUNyRCxjQUFJLGNBQWMsRUFBRTtBQUNsQixtQkFBTyxHQUFHLGNBQWMsQ0FBQyxDQUFDLENBQUMsQ0FBQztXQUM3QjtTQUNGOztBQUVELFlBQUksc0JBQU8sU0FBUyxFQUFFLEVBQUU7QUFDdEIsY0FBSSxVQUFVLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsRUFBRTtBQUNuQyxzQkFBVSxHQUFHLFVBQVUsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUM7V0FDbEM7U0FDRixNQUFNO0FBQ0wsY0FBSSxVQUFVLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsRUFBRTtBQUNqQyxzQkFBVSxHQUFHLFVB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VSxpQkFBYSxDQUFDOzthQUU3QyxJQUFJLENBQUMsWUFBWSxFQUFFOzs7OztjQUNmLElBQUkseUJBQU8sc0JBQXNCLEVBQUU7Ozs7eUNBR3RCLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxVQUFVLENBQUM7OztBQUFwRCxnQkFBUTs7QUFFWiw0QkFBTyxLQUFLLGFBQVcsUUFBUSxrQ0FBK0IsQ0FBQzs7eUNBQzVDLG1CQUFJLGFBQWEsQ0FBQyxRQUFRLENBQUM7OztBQUExQyxjQUFNOztBQUVWLDRCQUFPLEtBQUssQ0FBQyx3REFBd0QsQ0FBQyxDQUFDO0FBQ25FLFlBQUksR0FBRyxNQUFNLENBQUMsUUFBUSxDQUFDLFFBQVEsQ0FBQzs7QUFDcEMsNEJBQU8sS0FBSyxDQUFDLHVEQUF1RCxDQUFDLENBQUM7NENBQy9ELElBQUk7Ozs7Ozs7Q0FDWixDQUFDOztBQUVGLGVBQWMsVUFBVSxFQUFFLFFBQVEsRUFBRSxPQUFPLENBQUMsQ0FBQztRQUNwQyxRQUFRLEdBQVIsUUFBUTtRQUFFLE9BQU8sR0FBUCxPQUFPO3FCQUNYLFVBQVUiLCJmaWxlIjoibGliL2NvbW1hbmRzL2ZpbGUtbW92ZW1lbnQuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBlcnJvcnMgfSBmcm9tICdhcHBpdW0tYmFzZS1kcml2ZXInO1xuaW1wb3J0IHsgZnMsIHN5c3RlbSwgbWtkaXJwLCB6aXAgfSBmcm9tICdhcHBpdW0tc3VwcG9ydCc7XG5pbXBvcnQgbG9nZ2VyIGZyb20gJy4uL2xvZ2dlcic7XG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCB7IGV4ZWMgfSBmcm9tICd0ZWVuX3Byb2Nlc3MnO1xuXG5sZXQgY29tbWFuZHMgPSB7fSwgaGVscGVycyA9IHt9LCBleHRlbnNpb25zID0ge307XG5cbi8vIFRPRE86IG1vcmUgZXhwbGljaXQgZXJyb3IgbWVzc2FnZSBmb3IgYWxsIHRoZSBmaWxlLW1vdmVtZW50IGNvbW1hbmRzXG5cbi8qXG4gKiAgR2V0IHRoZSBmdWxsIHBhdGggdG8gYW4gaU9TIHNpbXVsYXRvciBmaWxlLlxuICogIENhbGxzIGNiKGVyciwgZnVsbEZpbGVQYXRoKVxuICogIC9Tb21lL1BhdGggICAgICAgICAgICAgICAgICAgICAgICAgICBmZXRjaGVzIGEgZmlsZSByZWxhdGl2ZSB0byB0aGUgcm9vdCBvZiB0aGUgZGV2aWNlJ3MgZmlsZXN5c3RlbS5cbiAqICAvQXBwbGljYXRpb25zL0FwcE5hbWUuYXBwL1NvbWUvUGF0aCAgZmV0Y2hlcyBhIGZpbGUgcmVsYXRpdmUgdG8gdGhlIHJvb3Qgb2YgdGhhdCBBcHBsaWNhdGlvbidzIC5hcHAgZGlyZWN0b3J5LCBhZGRpbmcgaW4gdGhlIEdVSUQuXG4gKiAgU28gaXQgbG9va3Mgc29tZXRoaW5nIGxpa2U6IC9BcHBsaWNhdGlvbnMvR1VJRC1HVUlELUdVSUQtR1VJRC9Tb21lL1BhdGhcbiAqL1xuaGVscGVycy5nZXRTaW1GaWxlRnVsbFBhdGggPSBhc3luYyBmdW5jdGlvbiAocmVtb3RlUGF0aCkge1xuICBsZXQgYmFzZVBhdGggPSB0aGlzLnNpbS5nZXREaXIoKTtcbiAgbGV0IGFwcE5hbWUgPSBudWxsO1xuXG4gIGlmICh0aGlzLm9wdHMuYXBwKSB7XG4gICAgbGV0IGFwcE5hbWVSZWdleCA9IG5ldyBSZWdFeHAoYFxcXFwke3BhdGguc2VwfShbXFxcXHctXStcXFxcLmFwcClgKTtcbiAgICBsZXQgYXBwTmFtZU1hdGNoZXMgPSBhcHBOYW1lUmVnZXguZXhlYyh0aGlzLm9wdHMuYXBwKTtcbiAgICBpZiAoYXBwTmFtZU1hdGNoZXMpIHtcbiAgICAgIGFwcE5hbWUgPSBhcHBOYW1lTWF0Y2hlc1sxXTtcbiAgICB9XG4gIH1cbiAgLy8gZGUtYWJzb2x1dGl6ZSB0aGUgcGF0aFxuICBpZiAoc3lzdGVtLmlzV2luZG93cygpKSB7XG4gICAgaWYgKHJlbW90ZVBhdGguaW5kZXhvZihcIjovL1wiKSA9PT0gMSkge1xuICAgICAgcmVtb3RlUGF0aCA9IHJlbW90ZVBhdGguc2xpY2UoNCk7XG4gICAgfVxuICB9IGVsc2Uge1xuICAgIGlmIChyZW1vdGVQYXRoLmluZGV4T2YoXCIvXCIpID09PSAwKSB7XG4gICAgICByZW1vdGVQYXRoID0gcmVtb3RlUGF0aC5zbGljZSgxKTtcbiAgICB9XG4gIH1cblxuICBpZiAocmVtb3RlUGF0aC5pbmRleE9mKGFwcE5hbWUpID09PSAwKSB7XG4gICAgbG9nZ2VyLmRlYnVnKFwiV2Ugd2FudCBhbiBhcHAtcmVsYXRpdmUgZmlsZVwiKTtcblxuICAgIGxldCBmaW5kUGF0aCA9IGJhc2VQYXRoO1xuICAgIGlmICh0aGlzLm9wdHMucGxhdGZvcm1WZXJzaW9uID49IDgpIHtcbiAgICAgIC8vIHRoZSAuYXBwIGZpbGUgYXBwZWFycyBpbiAvQ29udGFpbmVycy9EYXRhIGFuZCAvQ29udGFpbmVycy9CdW5kbGUgYm90aC4gV2Ugb25seSB3YW50IC9CdW5kbGVcbiAgICAgIGZpbmRQYXRoID0gcGF0aC5yZXNvbHZlKGJhc2VQYXRoLCBcIkNvbnRhaW5lcnNcIiwgXCJCdW5kbGVcIik7XG4gICAgfVxuICAgIGZpbmRQYXRoID0gIGZpbmRQYXRoLnJlcGxhY2UoL1xccy9nLCAnXFxcXCAnKTtcblxuICAgIGxldCB7IHN0ZG91dCB9ID0gYXdhaXQgZXhlYygnZmluZCcsIFtmaW5kUGF0aCwgJy1uYW1lJywgYXBwTmFtZV0pO1xuICAgIGxldCBhcHBSb290ID0gc3Rkb3V0LnJlcGxhY2UoL1xcbiQvLCAnJyk7XG4gICAgbGV0IHN1YlBhdGggPSByZW1vdGVQYXRoLnN1YnN0cmluZyhhcHBOYW1lLmxlbmd0aCArIDEpO1xuICAgIHJldHVybiBwYXRoLnJlc29sdmUoYXBwUm9vdCwgc3ViUGF0aCk7XG4gIH0gZWxzZSB7XG4gICAgbG9nZ2VyLmRlYnVnKFwiV2Ugd2FudCBhIHNpbS1yZWxhdGl2ZSBmaWxlXCIpO1xuICAgIHJldHVybiBwYXRoLnJlc29sdmUoYmFzZVBhdGgsIHJlbW90ZVBhdGgpO1xuICB9XG59O1xuXG5jb21tYW5kcy5wdXNoRmlsZSA9IGFzeW5jIGZ1bmN0aW9uIChyZW1vdGVQYXRoLCBiYXNlNjREYXRhKSB7XG4gIGxvZ2dlci5kZWJ1ZyhgUHVzaGluZyAke3JlbW90ZVBhdGh9IHRvIGlPUyBzaW11bGF0b3JgKTtcblxuICBpZiAodGhpcy5pc1JlYWxEZXZpY2UoKSkge1xuICAgIGxvZ2dlci5kZWJ1ZyhcIlVuc3VwcG9ydGVkOiBjYW5ub3Qgd3JpdGUgZmlsZXMgdG8gcGh5c2ljYWwgZGV2aWNlXCIpO1xuICAgIHRocm93IG5ldyBlcnJvcnMuTm90WWV0SW1wbGVtZW50ZWRFcnJvcigpO1xuICB9XG5cbiAgbGV0IGZ1bGxQYXRoID0gYXdhaXQgdGhpcy5nZXRTaW1GaWxlRnVsbFBhdGgocmVtb3RlUGF0aCk7XG5cbiAgbG9nZ2VyLmRlYnVnKGBBdHRlbXB0aW5nIHRvIHdyaXRlICR7ZnVsbFBhdGh9Li4uYCk7XG4gIGlmIChhd2FpdCBmcy5leGlzdHMoZnVsbFBhdGgpKSB7XG4gICAgbG9nZ2VyLmRlYnVnKGAke2Z1bGxQYXRofSBhbHJlYWR5IGV4aXN0cywgZGVsZXRpbmcuLi5gKTtcbiAgICBhd2FpdCBmcy51bmxpbmsoZnVsbFBhdGgpO1xuICB9XG4gIGF3YWl0IG1rZGlycChwYXRoLmRpcm5hbWUoZnVsbFBhdGgpKTtcbiAgbGV0IGNvbnRlbnQgPSBCdWZmZXIuZnJvbShiYXNlNjREYXRhLCAnYmFzZTY0Jyk7XG4gIGF3YWl0IGZzLndyaXRlRmlsZShmdWxsUGF0aCwgY29udGVudCk7XG4gIGxvZ2dlci5kZWJ1ZyhgV3JvdGUgJHtjb250ZW50Lmxlbmd0aH0gYnl0ZXMgdG8gJHtmdWxsUGF0aH1gKTtcbn07XG5cbmNvbW1hbmRzLnB1bGxGaWxlID0gYXN5bmMgZnVuY3Rpb24gKHJlbW90ZVBhdGgpIHtcbiAgbG9nZ2VyLmRlYnVnKGBQdWxsaW5nICR7cmVtb3RlUGF0aH0gZnJvbSBzaW1gKTtcblxuICBpZiAodGhpcy5pc1JlYWxEZXZpY2UoKSkge1xuICAgIHRocm93IG5ldyBlcnJvcnMuTm90WWV0SW1wbGVtZW50ZWRFcnJvcigpO1xuICB9XG4gIGxldCBmdWxsUGF0aCA9IGF3YWl0IHRoaXMuZ2V0U2ltRmlsZUZ1bGxQYXRoKHJlbW90ZVBhdGgpO1xuXG4gIGxvZ2dlci5kZWJ1ZyhgQXR0ZW1wdGluZyB0byByZWFkICR7ZnVsbFBhdGh9YCk7XG4gIGxldCBkYXRhID0gYXdhaXQgZnMucmVhZEZpbGUoZnVsbFBhdGgsIHtlbmNvZGluZzogJ2Jhc2U2NCd9KTtcbiAgcmV0dXJuIGRhdGE7XG59O1xuXG5jb21tYW5kcy5wdWxsRm9sZGVyID0gYXN5bmMgZnVuY3Rpb24gKHJlbW90ZVBhdGgpIHtcbiAgbG9nZ2VyLmRlYnVnKGBQdWxsaW5nICcke3JlbW90ZVBhdGh9JyBmcm9tIHNpbWApO1xuXG4gIGlmICh0aGlzLmlzUmVhbERldmljZSgpKSB7XG4gICAgdGhyb3cgbmV3IGVycm9ycy5Ob3RZZXRJbXBsZW1lbnRlZEVycm9yKCk7XG4gIH1cblxuICBsZXQgZnVsbFBhdGggPSBhd2FpdCB0aGlzLmdldFNpbUZpbGVGdWxsUGF0aChyZW1vdGVQYXRoKTtcblxuICBsb2dnZXIuZGVidWcoYEFkZGluZyAke2Z1bGxQYXRofSB0byBhbiBpbi1tZW1vcnkgemlwIGFyY2hpdmVgKTtcbiAgbGV0IGJ1ZmZlciA9IGF3YWl0IHppcC50b0luTWVtb3J5WmlwKGZ1bGxQYXRoKTtcblxuICBsb2dnZXIuZGVidWcoXCJDb252ZXJ0aW5nIGluLW1lbW9yeSB6aXAgZmlsZSB0byBiYXNlNjQgZW5jb2RlZCBzdHJpbmdcIik7XG4gIGxldCBkYXRhID0gYnVmZmVyLnRvU3RyaW5nKCdiYXNlNjQnKTtcbiAgbG9nZ2VyLmRlYnVnKFwiUmV0dXJuaW5nIGluLW1lbW9yeSB6aXAgZmlsZSBhcyBiYXNlNTQgZW5jb2RlZCBzdHJpbmdcIik7XG4gIHJldHVybiBkYXRhO1xufTtcblxuT2JqZWN0LmFzc2lnbihleHRlbnNpb25zLCBjb21tYW5kcywgaGVscGVycyk7XG5leHBvcnQgeyBjb21tYW5kcywgaGVscGVycyB9O1xuZXhwb3J0IGRlZmF1bHQgZXh0ZW5zaW9ucztcbiJdLCJzb3VyY2VSb290IjoiLi4vLi4vLi4ifQ==

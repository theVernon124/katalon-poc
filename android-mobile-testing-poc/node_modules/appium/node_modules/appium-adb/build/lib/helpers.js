'use strict';

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _getIterator = require('babel-runtime/core-js/get-iterator')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

var _appiumSupport = require('appium-support');

var _loggerJs = require('./logger.js');

var _loggerJs2 = _interopRequireDefault(_loggerJs);

var _teen_process = require('teen_process');

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _bluebird = require('bluebird');

var _bluebird2 = _interopRequireDefault(_bluebird);

var _semver = require('semver');

var _semver2 = _interopRequireDefault(_semver);

var ZIP_MAGIC = 'PK';
var rootDir = _path2['default'].resolve(__dirname, process.env.NO_PRECOMPILE ? '..' : '../..');

/**
 * @typedef {Object} PlatformInfo
 * @property {?string} platform - The platform name, for example `android-24`
 *                                or `null` if it cannot be found
 * @property {?string} platformPath - Full path to the platform SDK folder
 *                                    or `null` if it cannot be found
 */

/**
 * Retrieve the path to the recent installed Android platform.
 *
 * @return {PlatformInfo} The resulting path to the newest installed platform.
 */
function getAndroidPlatformAndPath() {
  var androidHome, propsPaths, platformsMapping, _iteratorNormalCompletion, _didIteratorError, _iteratorError, _iterator, _step, propsPath, propsContent, platformPath, platform, match, recentSdkVersion, result;

  return _regeneratorRuntime.async(function getAndroidPlatformAndPath$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        androidHome = process.env.ANDROID_HOME;

        if (_lodash2['default'].isString(androidHome)) {
          context$1$0.next = 3;
          break;
        }

        throw new Error("ANDROID_HOME environment variable was not exported");

      case 3:
        context$1$0.next = 5;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.glob(_path2['default'].resolve(androidHome, 'platforms', '*', 'build.prop'), {
          absolute: true
        }));

      case 5:
        propsPaths = context$1$0.sent;
        platformsMapping = {};
        _iteratorNormalCompletion = true;
        _didIteratorError = false;
        _iteratorError = undefined;
        context$1$0.prev = 10;
        _iterator = _getIterator(propsPaths);

      case 12:
        if (_iteratorNormalCompletion = (_step = _iterator.next()).done) {
          context$1$0.next = 27;
          break;
        }

        propsPath = _step.value;
        context$1$0.next = 16;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.readFile(propsPath, 'utf-8'));

      case 16:
        propsContent = context$1$0.sent;
        platformPath = _path2['default'].dirname(propsPath);
        platform = _path2['default'].basename(platformPath);
        match = /ro\.build\.version\.sdk=(\d+)/.exec(propsContent);

        if (match) {
          context$1$0.next = 23;
          break;
        }

        _loggerJs2['default'].warn('Cannot read the SDK version from \'' + propsPath + '\'. Skipping \'' + platform + '\'');
        return context$1$0.abrupt('continue', 24);

      case 23:
        platformsMapping[parseInt(match[1], 10)] = {
          platform: platform,
          platformPath: platformPath
        };

      case 24:
        _iteratorNormalCompletion = true;
        context$1$0.next = 12;
        break;

      case 27:
        context$1$0.next = 33;
        break;

      case 29:
        context$1$0.prev = 29;
        context$1$0.t0 = context$1$0['catch'](10);
        _didIteratorError = true;
        _iteratorError = context$1$0.t0;

      case 33:
        context$1$0.prev = 33;
        context$1$0.prev = 34;

        if (!_iteratorNormalCompletion && _iterator['return']) {
          _iterator['return']();
        }

      case 36:
        context$1$0.prev = 36;

        if (!_didIteratorError) {
          context$1$0.next = 39;
          break;
        }

        throw _iteratorError;

      case 39:
        return context$1$0.finish(36);

      case 40:
        return context$1$0.finish(33);

      case 41:
        if (!_lodash2['default'].isEmpty(platformsMapping)) {
          context$1$0.next = 44;
          break;
        }

        _loggerJs2['default'].warn('Found zero platform folders at \'' + _path2['default'].resolve(androidHome, 'platforms') + '\'. ' + 'Do you have any Android SDKs installed?');
        return context$1$0.abrupt('return', {
          platform: null,
          platformPath: null
        });

      case 44:
        recentSdkVersion = _lodash2['default'].keys(platformsMapping).sort().reverse()[0];
        result = platformsMapping[recentSdkVersion];

        _loggerJs2['default'].debug('Found the most recent Android platform: ' + JSON.stringify(result));
        return context$1$0.abrupt('return', result);

      case 48:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[10, 29, 33, 41], [34,, 36, 40]]);
}

function unzipFile(zipPath) {
  return _regeneratorRuntime.async(function unzipFile$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        _loggerJs2['default'].debug('Unzipping ' + zipPath);
        context$1$0.prev = 1;
        context$1$0.next = 4;
        return _regeneratorRuntime.awrap(assertZipArchive(zipPath));

      case 4:
        if (!_appiumSupport.system.isWindows()) {
          context$1$0.next = 10;
          break;
        }

        context$1$0.next = 7;
        return _regeneratorRuntime.awrap(_appiumSupport.zip.extractAllTo(zipPath, _path2['default'].dirname(zipPath)));

      case 7:
        _loggerJs2['default'].debug("Unzip successful");
        context$1$0.next = 13;
        break;

      case 10:
        context$1$0.next = 12;
        return _regeneratorRuntime.awrap((0, _teen_process.exec)('unzip', ['-o', zipPath], { cwd: _path2['default'].dirname(zipPath) }));

      case 12:
        _loggerJs2['default'].debug("Unzip successful");

      case 13:
        context$1$0.next = 18;
        break;

      case 15:
        context$1$0.prev = 15;
        context$1$0.t0 = context$1$0['catch'](1);
        throw new Error('Error occurred while unzipping. Original error: ' + context$1$0.t0.message);

      case 18:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[1, 15]]);
}

function assertZipArchive(zipPath) {
  var _ref, size, fd, buffer;

  return _regeneratorRuntime.async(function assertZipArchive$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        _loggerJs2['default'].debug('Testing zip archive: \'' + zipPath + '\'');
        context$1$0.next = 3;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.exists(zipPath));

      case 3:
        if (context$1$0.sent) {
          context$1$0.next = 5;
          break;
        }

        throw new Error('Zip archive does not exist at \'' + zipPath + '\'');

      case 5:
        context$1$0.next = 7;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.stat(zipPath));

      case 7:
        _ref = context$1$0.sent;
        size = _ref.size;

        if (!(size < 4)) {
          context$1$0.next = 11;
          break;
        }

        throw new Error('The file at \'' + zipPath + '\' is too small to be a ZIP archive');

      case 11:
        context$1$0.next = 13;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.open(zipPath, 'r'));

      case 13:
        fd = context$1$0.sent;
        buffer = Buffer.alloc(ZIP_MAGIC.length);
        context$1$0.next = 17;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.read(fd, buffer, 0, ZIP_MAGIC.length, 0));

      case 17:
        if (!(buffer.toString('ascii') !== ZIP_MAGIC)) {
          context$1$0.next = 19;
          break;
        }

        throw new Error('The file signature \'' + buffer.toString('ascii') + '\' of \'' + zipPath + '\' ' + ('is not equal to the expected ZIP archive signature \'' + ZIP_MAGIC + '\''));

      case 19:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

function getIMEListFromOutput(stdout) {
  var engines = [];
  var _iteratorNormalCompletion2 = true;
  var _didIteratorError2 = false;
  var _iteratorError2 = undefined;

  try {
    for (var _iterator2 = _getIterator(stdout.split('\n')), _step2; !(_iteratorNormalCompletion2 = (_step2 = _iterator2.next()).done); _iteratorNormalCompletion2 = true) {
      var line = _step2.value;

      if (line.length > 0 && line[0] !== ' ') {
        // remove newline and trailing colon, and add to the list
        engines.push(line.trim().replace(/:$/, ''));
      }
    }
  } catch (err) {
    _didIteratorError2 = true;
    _iteratorError2 = err;
  } finally {
    try {
      if (!_iteratorNormalCompletion2 && _iterator2['return']) {
        _iterator2['return']();
      }
    } finally {
      if (_didIteratorError2) {
        throw _iteratorError2;
      }
    }
  }

  return engines;
}

var getJavaForOs = _lodash2['default'].memoize(function () {
  return _path2['default'].resolve(getJavaHome(), 'bin', 'java' + (_appiumSupport.system.isWindows() ? '.exe' : ''));
});

function getJavaHome() {
  if (process.env.JAVA_HOME) {
    return process.env.JAVA_HOME;
  }
  throw new Error("JAVA_HOME is not set currently. Please set JAVA_HOME.");
}

/**
 * Get the absolute path to apksigner tool
 *
 * @param {Object} sysHelpers - An instance containing systemCallMethods helper methods
 * @returns {string} An absolute path to apksigner tool.
 * @throws {Error} If the tool is not present on the local file system.
 */
function getApksignerForOs(sysHelpers) {
  return _regeneratorRuntime.async(function getApksignerForOs$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.next = 2;
        return _regeneratorRuntime.awrap(sysHelpers.getBinaryFromSdkRoot('apksigner'));

      case 2:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 3:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

/**
 * Get the absolute path to apkanalyzer tool.
 * https://developer.android.com/studio/command-line/apkanalyzer.html
 *
 * @param {Object} sysHelpers - An instance containing systemCallMethods helper methods
 * @returns {string} An absolute path to apkanalyzer tool.
 * @throws {Error} If the tool is not present on the local file system.
 */
function getApkanalyzerForOs(sysHelpers) {
  return _regeneratorRuntime.async(function getApkanalyzerForOs$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.next = 2;
        return _regeneratorRuntime.awrap(sysHelpers.getBinaryFromSdkRoot('apkanalyzer'));

      case 2:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 3:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

/**
 * Checks mShowingLockscreen or mDreamingLockscreen in dumpsys output to determine
 * if lock screen is showing
 *
 * @param {string} dumpsys - The output of dumpsys window command.
 * @return {boolean} True if lock screen is showing.
 */
function isShowingLockscreen(dumpsys) {
  return (/(mShowingLockscreen=true|mDreamingLockscreen=true)/gi.test(dumpsys)
  );
}

/*
 * Checks mCurrentFocus in dumpsys output to determine if Keyguard is activated
 */
function isCurrentFocusOnKeyguard(dumpsys) {
  var m = /mCurrentFocus.+Keyguard/gi.exec(dumpsys);
  return m && m.length && m[0] ? true : false;
}

/*
 * Reads SurfaceOrientation in dumpsys output
 */
function getSurfaceOrientation(dumpsys) {
  var m = /SurfaceOrientation: \d/gi.exec(dumpsys);
  return m && parseInt(m[0].split(':')[1], 10);
}

/*
 * Checks mScreenOnFully in dumpsys output to determine if screen is showing
 * Default is true
 */
function isScreenOnFully(dumpsys) {
  var m = /mScreenOnFully=\w+/gi.exec(dumpsys);
  return !m || // if information is missing we assume screen is fully on
  m && m.length > 0 && m[0].split('=')[1] === 'true' || false;
}

/**
 * Builds command line representation for the given
 * application startup options
 *
 * @param {StartAppOptions} startAppOptions - Application options mapping
 * @param {number} apiLevel - The actual OS API level
 * @returns {Array<String>} The actual command line array
 */
function buildStartCmd(startAppOptions, apiLevel) {
  var cmd = ['am', 'start'];
  if (_appiumSupport.util.hasValue(startAppOptions.user)) {
    cmd.push('--user', startAppOptions.user);
  }
  cmd.push('-W', '-n', startAppOptions.pkg + '/' + startAppOptions.activity);
  if (startAppOptions.stopApp && apiLevel >= 15) {
    cmd.push('-S');
  }
  if (startAppOptions.action) {
    cmd.push('-a', startAppOptions.action);
  }
  if (startAppOptions.category) {
    cmd.push('-c', startAppOptions.category);
  }
  if (startAppOptions.flags) {
    cmd.push('-f', startAppOptions.flags);
  }
  if (startAppOptions.optionalIntentArguments) {
    // expect optionalIntentArguments to be a single string of the form:
    //     "-flag key"
    //     "-flag key value"
    // or a combination of these (e.g., "-flag1 key1 -flag2 key2 value2")

    // take a string and parse out the part before any spaces, and anything after
    // the first space
    var parseKeyValue = function parseKeyValue(str) {
      str = str.trim();
      var space = str.indexOf(' ');
      if (space === -1) {
        return str.length ? [str] : [];
      } else {
        return [str.substring(0, space).trim(), str.substring(space + 1).trim()];
      }
    };

    // cycle through the optionalIntentArguments and pull out the arguments
    // add a space initially so flags can be distinguished from arguments that
    // have internal hyphens
    var optionalIntentArguments = ' ' + startAppOptions.optionalIntentArguments;
    var re = / (-[^\s]+) (.+)/;
    while (true) {
      // eslint-disable-line no-constant-condition
      var args = re.exec(optionalIntentArguments);
      if (!args) {
        if (optionalIntentArguments.length) {
          // no more flags, so the remainder can be treated as 'key' or 'key value'
          cmd.push.apply(cmd, parseKeyValue(optionalIntentArguments));
        }
        // we are done
        break;
      }

      // take the flag and see if it is at the beginning of the string
      // if it is not, then it means we have been through already, and
      // what is before the flag is the argument for the previous flag
      var flag = args[1];
      var flagPos = optionalIntentArguments.indexOf(flag);
      if (flagPos !== 0) {
        var prevArgs = optionalIntentArguments.substring(0, flagPos);
        cmd.push.apply(cmd, parseKeyValue(prevArgs));
      }

      // add the flag, as there are no more earlier arguments
      cmd.push(flag);

      // make optionalIntentArguments hold the remainder
      optionalIntentArguments = args[2];
    }
  }
  return cmd;
}

var getSdkToolsVersion = _lodash2['default'].memoize(function getSdkToolsVersion() {
  var androidHome, propertiesPath, propertiesContent, versionMatcher, match;
  return _regeneratorRuntime.async(function getSdkToolsVersion$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        androidHome = process.env.ANDROID_HOME;

        if (androidHome) {
          context$1$0.next = 3;
          break;
        }

        throw new Error('ANDROID_HOME environment variable is expected to be set');

      case 3:
        propertiesPath = _path2['default'].resolve(androidHome, 'tools', 'source.properties');
        context$1$0.next = 6;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.exists(propertiesPath));

      case 6:
        if (context$1$0.sent) {
          context$1$0.next = 9;
          break;
        }

        _loggerJs2['default'].warn('Cannot find ' + propertiesPath + ' file to read SDK version from');
        return context$1$0.abrupt('return');

      case 9:
        context$1$0.next = 11;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.readFile(propertiesPath, 'utf8'));

      case 11:
        propertiesContent = context$1$0.sent;
        versionMatcher = new RegExp(/Pkg\.Revision=(\d+)\.?(\d+)?\.?(\d+)?/);
        match = versionMatcher.exec(propertiesContent);

        if (!match) {
          context$1$0.next = 16;
          break;
        }

        return context$1$0.abrupt('return', {
          major: parseInt(match[1], 10),
          minor: match[2] ? parseInt(match[2], 10) : 0,
          build: match[3] ? parseInt(match[3], 10) : 0
        });

      case 16:
        _loggerJs2['default'].warn('Cannot parse "Pkg.Revision" value from ' + propertiesPath);

      case 17:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
});

/**
 * Retrieves full paths to all 'build-tools' subfolders under the particular
 * SDK root folder
 *
 * @param {string} sdkRoot - The full path to the Android SDK root folder
 * @returns {Array<string>} The full paths to the resulting folders sorted by
 * modification date (the newest comes first) or an empty list if no macthes were found
 */
var getBuildToolsDirs = _lodash2['default'].memoize(function getBuildToolsDirs(sdkRoot) {
  var buildToolsDirs, pairs, _iteratorNormalCompletion3, _didIteratorError3, _iteratorError3, _iterator3, _step3, dir;

  return _regeneratorRuntime.async(function getBuildToolsDirs$(context$1$0) {
    var _this = this;

    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.next = 2;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.glob(_path2['default'].resolve(sdkRoot, 'build-tools', '*'), { absolute: true }));

      case 2:
        buildToolsDirs = context$1$0.sent;
        context$1$0.prev = 3;

        buildToolsDirs = buildToolsDirs.map(function (dir) {
          return [_path2['default'].basename(dir), dir];
        }).sort(function (a, b) {
          return _semver2['default'].rcompare(a[0], b[0]);
        }).map(function (pair) {
          return pair[1];
        });
        context$1$0.next = 15;
        break;

      case 7:
        context$1$0.prev = 7;
        context$1$0.t0 = context$1$0['catch'](3);

        _loggerJs2['default'].warn('Cannot sort build-tools folders ' + JSON.stringify(buildToolsDirs.map(function (dir) {
          return _path2['default'].basename(dir);
        })) + ' ' + 'by semantic version names.');
        _loggerJs2['default'].warn('Falling back to sorting by modification date. Original error: ' + context$1$0.t0.message);
        context$1$0.next = 13;
        return _regeneratorRuntime.awrap(_bluebird2['default'].map(buildToolsDirs, function callee$2$0(dir) {
          return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
            while (1) switch (context$3$0.prev = context$3$0.next) {
              case 0:
                context$3$0.next = 2;
                return _regeneratorRuntime.awrap(_appiumSupport.fs.stat(dir));

              case 2:
                context$3$0.t0 = context$3$0.sent.mtime.valueOf();
                context$3$0.t1 = dir;
                return context$3$0.abrupt('return', [context$3$0.t0, context$3$0.t1]);

              case 5:
              case 'end':
                return context$3$0.stop();
            }
          }, null, _this);
        }));

      case 13:
        pairs = context$1$0.sent;

        buildToolsDirs = pairs.sort(function (a, b) {
          return a[0] < b[0];
        }).map(function (pair) {
          return pair[1];
        });

      case 15:
        _loggerJs2['default'].info('Found ' + buildToolsDirs.length + ' \'build-tools\' folders under \'' + sdkRoot + '\' (newest first):');
        _iteratorNormalCompletion3 = true;
        _didIteratorError3 = false;
        _iteratorError3 = undefined;
        context$1$0.prev = 19;
        for (_iterator3 = _getIterator(buildToolsDirs); !(_iteratorNormalCompletion3 = (_step3 = _iterator3.next()).done); _iteratorNormalCompletion3 = true) {
          dir = _step3.value;

          _loggerJs2['default'].info('    ' + dir);
        }
        context$1$0.next = 27;
        break;

      case 23:
        context$1$0.prev = 23;
        context$1$0.t1 = context$1$0['catch'](19);
        _didIteratorError3 = true;
        _iteratorError3 = context$1$0.t1;

      case 27:
        context$1$0.prev = 27;
        context$1$0.prev = 28;

        if (!_iteratorNormalCompletion3 && _iterator3['return']) {
          _iterator3['return']();
        }

      case 30:
        context$1$0.prev = 30;

        if (!_didIteratorError3) {
          context$1$0.next = 33;
          break;
        }

        throw _iteratorError3;

      case 33:
        return context$1$0.finish(30);

      case 34:
        return context$1$0.finish(27);

      case 35:
        return context$1$0.abrupt('return', buildToolsDirs);

      case 36:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[3, 7], [19, 23, 27, 35], [28,, 30, 34]]);
});

exports.getAndroidPlatformAndPath = getAndroidPlatformAndPath;
exports.unzipFile = unzipFile;
exports.assertZipArchive = assertZipArchive;
exports.getIMEListFromOutput = getIMEListFromOutput;
exports.getJavaForOs = getJavaForOs;
exports.isShowingLockscreen = isShowingLockscreen;
exports.isCurrentFocusOnKeyguard = isCurrentFocusOnKeyguard;
exports.getSurfaceOrientation = getSurfaceOrientation;
exports.isScreenOnFully = isScreenOnFully;
exports.buildStartCmd = buildStartCmd;
exports.getJavaHome = getJavaHome;
exports.rootDir = rootDir;
exports.getSdkToolsVersion = getSdkToolsVersion;
exports.getApksignerForOs = getApksignerForOs;
exports.getBuildToolsDirs = getBuildToolsDirs;
exports.getApkanalyzerForOs = getApkanalyzerForOs;
//# sourceMappingURL=data:application/json;charset=utf8;base64,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Q0FBQzs7Ozs7QUFDcEcsdUNBQWdCLGNBQWMseUdBQUU7QUFBdkIsYUFBRzs7QUFDVixnQ0FBSSxJQUFJLFVBQVEsR0FBRyxDQUFHLENBQUM7U0FDeEI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OzRDQUNNLGNBQWM7Ozs7Ozs7Q0FDdEIsQ0FBQyxDQUFDOztRQUVNLHlCQUF5QixHQUF6Qix5QkFBeUI7UUFBRSxTQUFTLEdBQVQsU0FBUztRQUFFLGdCQUFnQixHQUFoQixnQkFBZ0I7UUFDdEQsb0JBQW9CLEdBQXBCLG9CQUFvQjtRQUFFLFlBQVksR0FBWixZQUFZO1FBQUUsbUJBQW1CLEdBQW5CLG1CQUFtQjtRQUFFLHdCQUF3QixHQUF4Qix3QkFBd0I7UUFDakYscUJBQXFCLEdBQXJCLHFCQUFxQjtRQUFFLGVBQWUsR0FBZixlQUFlO1FBQUUsYUFBYSxHQUFiLGFBQWE7UUFBRSxXQUFXLEdBQVgsV0FBVztRQUNsRSxPQUFPLEdBQVAsT0FBTztRQUFFLGtCQUFrQixHQUFsQixrQkFBa0I7UUFBRSxpQkFBaUIsR0FBakIsaUJBQWlCO1FBQUUsaUJBQWlCLEdBQWpCLGlCQUFpQjtRQUNqRSxtQkFBbUIsR0FBbkIsbUJBQW1CIiwiZmlsZSI6ImxpYi9oZWxwZXJzLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgeyBzeXN0ZW0sIGZzLCB6aXAsIHV0aWwgfSBmcm9tICdhcHBpdW0tc3VwcG9ydCc7XG5pbXBvcnQgbG9nIGZyb20gJy4vbG9nZ2VyLmpzJztcbmltcG9ydCB7IGV4ZWMgfSBmcm9tICd0ZWVuX3Byb2Nlc3MnO1xuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCBCIGZyb20gJ2JsdWViaXJkJztcbmltcG9ydCBzZW12ZXIgZnJvbSAnc2VtdmVyJztcblxuY29uc3QgWklQX01BR0lDID0gJ1BLJztcbmNvbnN0IHJvb3REaXIgPSBwYXRoLnJlc29sdmUoX19kaXJuYW1lLCBwcm9jZXNzLmVudi5OT19QUkVDT01QSUxFID8gJy4uJyA6ICcuLi8uLicpO1xuXG4vKipcbiAqIEB0eXBlZGVmIHtPYmplY3R9IFBsYXRmb3JtSW5mb1xuICogQHByb3BlcnR5IHs/c3RyaW5nfSBwbGF0Zm9ybSAtIFRoZSBwbGF0Zm9ybSBuYW1lLCBmb3IgZXhhbXBsZSBgYW5kcm9pZC0yNGBcbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvciBgbnVsbGAgaWYgaXQgY2Fubm90IGJlIGZvdW5kXG4gKiBAcHJvcGVydHkgez9zdHJpbmd9IHBsYXRmb3JtUGF0aCAtIEZ1bGwgcGF0aCB0byB0aGUgcGxhdGZvcm0gU0RLIGZvbGRlclxuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvciBgbnVsbGAgaWYgaXQgY2Fubm90IGJlIGZvdW5kXG4gKi9cblxuLyoqXG4gKiBSZXRyaWV2ZSB0aGUgcGF0aCB0byB0aGUgcmVjZW50IGluc3RhbGxlZCBBbmRyb2lkIHBsYXRmb3JtLlxuICpcbiAqIEByZXR1cm4ge1BsYXRmb3JtSW5mb30gVGhlIHJlc3VsdGluZyBwYXRoIHRvIHRoZSBuZXdlc3QgaW5zdGFsbGVkIHBsYXRmb3JtLlxuICovXG5hc3luYyBmdW5jdGlvbiBnZXRBbmRyb2lkUGxhdGZvcm1BbmRQYXRoICgpIHtcbiAgY29uc3QgYW5kcm9pZEhvbWUgPSBwcm9jZXNzLmVudi5BTkRST0lEX0hPTUU7XG4gIGlmICghXy5pc1N0cmluZyhhbmRyb2lkSG9tZSkpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoXCJBTkRST0lEX0hPTUUgZW52aXJvbm1lbnQgdmFyaWFibGUgd2FzIG5vdCBleHBvcnRlZFwiKTtcbiAgfVxuXG4gIGxldCBwcm9wc1BhdGhzID0gYXdhaXQgZnMuZ2xvYihwYXRoLnJlc29sdmUoYW5kcm9pZEhvbWUsICdwbGF0Zm9ybXMnLCAnKicsICdidWlsZC5wcm9wJyksIHtcbiAgICBhYnNvbHV0ZTogdHJ1ZVxuICB9KTtcbiAgY29uc3QgcGxhdGZvcm1zTWFwcGluZyA9IHt9O1xuICBmb3IgKGNvbnN0IHByb3BzUGF0aCBvZiBwcm9wc1BhdGhzKSB7XG4gICAgY29uc3QgcHJvcHNDb250ZW50ID0gYXdhaXQgZnMucmVhZEZpbGUocHJvcHNQYXRoLCAndXRmLTgnKTtcbiAgICBjb25zdCBwbGF0Zm9ybVBhdGggPSBwYXRoLmRpcm5hbWUocHJvcHNQYXRoKTtcbiAgICBjb25zdCBwbGF0Zm9ybSA9IHBhdGguYmFzZW5hbWUocGxhdGZvcm1QYXRoKTtcbiAgICBjb25zdCBtYXRjaCA9IC9yb1xcLmJ1aWxkXFwudmVyc2lvblxcLnNkaz0oXFxkKykvLmV4ZWMocHJvcHNDb250ZW50KTtcbiAgICBpZiAoIW1hdGNoKSB7XG4gICAgICBsb2cud2FybihgQ2Fubm90IHJlYWQgdGhlIFNESyB2ZXJzaW9uIGZyb20gJyR7cHJvcHNQYXRofScuIFNraXBwaW5nICcke3BsYXRmb3JtfSdgKTtcbiAgICAgIGNvbnRpbnVlO1xuICAgIH1cbiAgICBwbGF0Zm9ybXNNYXBwaW5nW3BhcnNlSW50KG1hdGNoWzFdLCAxMCldID0ge1xuICAgICAgcGxhdGZvcm0sXG4gICAgICBwbGF0Zm9ybVBhdGgsXG4gICAgfTtcbiAgfVxuICBpZiAoXy5pc0VtcHR5KHBsYXRmb3Jtc01hcHBpbmcpKSB7XG4gICAgbG9nLndhcm4oYEZvdW5kIHplcm8gcGxhdGZvcm0gZm9sZGVycyBhdCAnJHtwYXRoLnJlc29sdmUoYW5kcm9pZEhvbWUsICdwbGF0Zm9ybXMnKX0nLiBgICtcbiAgICAgICAgICAgICBgRG8geW91IGhhdmUgYW55IEFuZHJvaWQgU0RLcyBpbnN0YWxsZWQ/YCk7XG4gICAgcmV0dXJuIHtcbiAgICAgIHBsYXRmb3JtOiBudWxsLFxuICAgICAgcGxhdGZvcm1QYXRoOiBudWxsLFxuICAgIH07XG4gIH1cblxuICBjb25zdCByZWNlbnRTZGtWZXJzaW9uID0gXy5rZXlzKHBsYXRmb3Jtc01hcHBpbmcpLnNvcnQoKS5yZXZlcnNlKClbMF07XG4gIGNvbnN0IHJlc3VsdCA9IHBsYXRmb3Jtc01hcHBpbmdbcmVjZW50U2RrVmVyc2lvbl07XG4gIGxvZy5kZWJ1ZyhgRm91bmQgdGhlIG1vc3QgcmVjZW50IEFuZHJvaWQgcGxhdGZvcm06ICR7SlNPTi5zdHJpbmdpZnkocmVzdWx0KX1gKTtcbiAgcmV0dXJuIHJlc3VsdDtcbn1cblxuYXN5bmMgZnVuY3Rpb24gdW56aXBGaWxlICh6aXBQYXRoKSB7XG4gIGxvZy5kZWJ1ZyhgVW56aXBwaW5nICR7emlwUGF0aH1gKTtcbiAgdHJ5IHtcbiAgICBhd2FpdCBhc3NlcnRaaXBBcmNoaXZlKHppcFBhdGgpO1xuICAgIGlmIChzeXN0ZW0uaXNXaW5kb3dzKCkpIHtcbiAgICAgIGF3YWl0IHppcC5leHRyYWN0QWxsVG8oemlwUGF0aCwgcGF0aC5kaXJuYW1lKHppcFBhdGgpKTtcbiAgICAgIGxvZy5kZWJ1ZyhcIlVuemlwIHN1Y2Nlc3NmdWxcIik7XG4gICAgfSBlbHNlIHtcbiAgICAgIGF3YWl0IGV4ZWMoJ3VuemlwJywgWyctbycsIHppcFBhdGhdLCB7Y3dkOiBwYXRoLmRpcm5hbWUoemlwUGF0aCl9KTtcbiAgICAgIGxvZy5kZWJ1ZyhcIlVuemlwIHN1Y2Nlc3NmdWxcIik7XG4gICAgfVxuICB9IGNhdGNoIChlKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKGBFcnJvciBvY2N1cnJlZCB3aGlsZSB1bnppcHBpbmcuIE9yaWdpbmFsIGVycm9yOiAke2UubWVzc2FnZX1gKTtcbiAgfVxufVxuXG5hc3luYyBmdW5jdGlvbiBhc3NlcnRaaXBBcmNoaXZlICh6aXBQYXRoKSB7XG4gIGxvZy5kZWJ1ZyhgVGVzdGluZyB6aXAgYXJjaGl2ZTogJyR7emlwUGF0aH0nYCk7XG4gIGlmICghYXdhaXQgZnMuZXhpc3RzKHppcFBhdGgpKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKGBaaXAgYXJjaGl2ZSBkb2VzIG5vdCBleGlzdCBhdCAnJHt6aXBQYXRofSdgKTtcbiAgfVxuXG4gIGNvbnN0IHtzaXplfSA9IGF3YWl0IGZzLnN0YXQoemlwUGF0aCk7XG4gIGlmIChzaXplIDwgNCkge1xuICAgIHRocm93IG5ldyBFcnJvcihgVGhlIGZpbGUgYXQgJyR7emlwUGF0aH0nIGlzIHRvbyBzbWFsbCB0byBiZSBhIFpJUCBhcmNoaXZlYCk7XG4gIH1cbiAgY29uc3QgZmQgPSBhd2FpdCBmcy5vcGVuKHppcFBhdGgsICdyJyk7XG4gIGNvbnN0IGJ1ZmZlciA9IEJ1ZmZlci5hbGxvYyhaSVBfTUFHSUMubGVuZ3RoKTtcbiAgYXdhaXQgZnMucmVhZChmZCwgYnVmZmVyLCAwLCBaSVBfTUFHSUMubGVuZ3RoLCAwKTtcbiAgaWYgKGJ1ZmZlci50b1N0cmluZygnYXNjaWknKSAhPT0gWklQX01BR0lDKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKGBUaGUgZmlsZSBzaWduYXR1cmUgJyR7YnVmZmVyLnRvU3RyaW5nKCdhc2NpaScpfScgb2YgJyR7emlwUGF0aH0nIGAgK1xuICAgICAgICAgICAgICAgICAgICBgaXMgbm90IGVxdWFsIHRvIHRoZSBleHBlY3RlZCBaSVAgYXJjaGl2ZSBzaWduYXR1cmUgJyR7WklQX01BR0lDfSdgKTtcbiAgfVxufVxuXG5mdW5jdGlvbiBnZXRJTUVMaXN0RnJvbU91dHB1dCAoc3Rkb3V0KSB7XG4gIGxldCBlbmdpbmVzID0gW107XG4gIGZvciAobGV0IGxpbmUgb2Ygc3Rkb3V0LnNwbGl0KCdcXG4nKSkge1xuICAgIGlmIChsaW5lLmxlbmd0aCA+IDAgJiYgbGluZVswXSAhPT0gJyAnKSB7XG4gICAgICAvLyByZW1vdmUgbmV3bGluZSBhbmQgdHJhaWxpbmcgY29sb24sIGFuZCBhZGQgdG8gdGhlIGxpc3RcbiAgICAgIGVuZ2luZXMucHVzaChsaW5lLnRyaW0oKS5yZXBsYWNlKC86JC8sICcnKSk7XG4gICAgfVxuICB9XG4gIHJldHVybiBlbmdpbmVzO1xufVxuXG5jb25zdCBnZXRKYXZhRm9yT3MgPSBfLm1lbW9pemUoKCkgPT4ge1xuICByZXR1cm4gcGF0aC5yZXNvbHZlKGdldEphdmFIb21lKCksICdiaW4nLCBgamF2YSR7c3lzdGVtLmlzV2luZG93cygpID8gJy5leGUnIDogJyd9YCk7XG59KTtcblxuZnVuY3Rpb24gZ2V0SmF2YUhvbWUgKCkge1xuICBpZiAocHJvY2Vzcy5lbnYuSkFWQV9IT01FKSB7XG4gICAgcmV0dXJuIHByb2Nlc3MuZW52LkpBVkFfSE9NRTtcbiAgfVxuICB0aHJvdyBuZXcgRXJyb3IoXCJKQVZBX0hPTUUgaXMgbm90IHNldCBjdXJyZW50bHkuIFBsZWFzZSBzZXQgSkFWQV9IT01FLlwiKTtcbn1cblxuLyoqXG4gKiBHZXQgdGhlIGFic29sdXRlIHBhdGggdG8gYXBrc2lnbmVyIHRvb2xcbiAqXG4gKiBAcGFyYW0ge09iamVjdH0gc3lzSGVscGVycyAtIEFuIGluc3RhbmNlIGNvbnRhaW5pbmcgc3lzdGVtQ2FsbE1ldGhvZHMgaGVscGVyIG1ldGhvZHNcbiAqIEByZXR1cm5zIHtzdHJpbmd9IEFuIGFic29sdXRlIHBhdGggdG8gYXBrc2lnbmVyIHRvb2wuXG4gKiBAdGhyb3dzIHtFcnJvcn0gSWYgdGhlIHRvb2wgaXMgbm90IHByZXNlbnQgb24gdGhlIGxvY2FsIGZpbGUgc3lzdGVtLlxuICovXG5hc3luYyBmdW5jdGlvbiBnZXRBcGtzaWduZXJGb3JPcyAoc3lzSGVscGVycykge1xuICByZXR1cm4gYXdhaXQgc3lzSGVscGVycy5nZXRCaW5hcnlGcm9tU2RrUm9vdCgnYXBrc2lnbmVyJyk7XG59XG5cbi8qKlxuICogR2V0IHRoZSBhYnNvbHV0ZSBwYXRoIHRvIGFwa2FuYWx5emVyIHRvb2wuXG4gKiBodHRwczovL2RldmVsb3Blci5hbmRyb2lkLmNvbS9zdHVkaW8vY29tbWFuZC1saW5lL2Fwa2FuYWx5emVyLmh0bWxcbiAqXG4gKiBAcGFyYW0ge09iamVjdH0gc3lzSGVscGVycyAtIEFuIGluc3RhbmNlIGNvbnRhaW5pbmcgc3lzdGVtQ2FsbE1ldGhvZHMgaGVscGVyIG1ldGhvZHNcbiAqIEByZXR1cm5zIHtzdHJpbmd9IEFuIGFic29sdXRlIHBhdGggdG8gYXBrYW5hbHl6ZXIgdG9vbC5cbiAqIEB0aHJvd3Mge0Vycm9yfSBJZiB0aGUgdG9vbCBpcyBub3QgcHJlc2VudCBvbiB0aGUgbG9jYWwgZmlsZSBzeXN0ZW0uXG4gKi9cbmFzeW5jIGZ1bmN0aW9uIGdldEFwa2FuYWx5emVyRm9yT3MgKHN5c0hlbHBlcnMpIHtcbiAgcmV0dXJuIGF3YWl0IHN5c0hlbHBlcnMuZ2V0QmluYXJ5RnJvbVNka1Jvb3QoJ2Fwa2FuYWx5emVyJyk7XG59XG5cbiAvKipcbiAgKiBDaGVja3MgbVNob3dpbmdMb2Nrc2NyZWVuIG9yIG1EcmVhbWluZ0xvY2tzY3JlZW4gaW4gZHVtcHN5cyBvdXRwdXQgdG8gZGV0ZXJtaW5lXG4gICogaWYgbG9jayBzY3JlZW4gaXMgc2hvd2luZ1xuICAqXG4gICogQHBhcmFtIHtzdHJpbmd9IGR1bXBzeXMgLSBUaGUgb3V0cHV0IG9mIGR1bXBzeXMgd2luZG93IGNvbW1hbmQuXG4gICogQHJldHVybiB7Ym9vbGVhbn0gVHJ1ZSBpZiBsb2NrIHNjcmVlbiBpcyBzaG93aW5nLlxuICAqL1xuZnVuY3Rpb24gaXNTaG93aW5nTG9ja3NjcmVlbiAoZHVtcHN5cykge1xuICByZXR1cm4gLyhtU2hvd2luZ0xvY2tzY3JlZW49dHJ1ZXxtRHJlYW1pbmdMb2Nrc2NyZWVuPXRydWUpL2dpLnRlc3QoZHVtcHN5cyk7XG59XG5cbi8qXG4gKiBDaGVja3MgbUN1cnJlbnRGb2N1cyBpbiBkdW1wc3lzIG91dHB1dCB0byBkZXRlcm1pbmUgaWYgS2V5Z3VhcmQgaXMgYWN0aXZhdGVkXG4gKi9cbmZ1bmN0aW9uIGlzQ3VycmVudEZvY3VzT25LZXlndWFyZCAoZHVtcHN5cykge1xuICBsZXQgbSA9IC9tQ3VycmVudEZvY3VzLitLZXlndWFyZC9naS5leGVjKGR1bXBzeXMpO1xuICByZXR1cm4gKG0gJiYgbS5sZW5ndGggJiYgbVswXSkgPyB0cnVlIDogZmFsc2U7XG59XG5cbi8qXG4gKiBSZWFkcyBTdXJmYWNlT3JpZW50YXRpb24gaW4gZHVtcHN5cyBvdXRwdXRcbiAqL1xuZnVuY3Rpb24gZ2V0U3VyZmFjZU9yaWVudGF0aW9uIChkdW1wc3lzKSB7XG4gIGxldCBtID0gL1N1cmZhY2VPcmllbnRhdGlvbjogXFxkL2dpLmV4ZWMoZHVtcHN5cyk7XG4gIHJldHVybiBtICYmIHBhcnNlSW50KG1bMF0uc3BsaXQoJzonKVsxXSwgMTApO1xufVxuXG4vKlxuICogQ2hlY2tzIG1TY3JlZW5PbkZ1bGx5IGluIGR1bXBzeXMgb3V0cHV0IHRvIGRldGVybWluZSBpZiBzY3JlZW4gaXMgc2hvd2luZ1xuICogRGVmYXVsdCBpcyB0cnVlXG4gKi9cbmZ1bmN0aW9uIGlzU2NyZWVuT25GdWxseSAoZHVtcHN5cykge1xuICBsZXQgbSA9IC9tU2NyZWVuT25GdWxseT1cXHcrL2dpLmV4ZWMoZHVtcHN5cyk7XG4gIHJldHVybiAhbSB8fCAvLyBpZiBpbmZvcm1hdGlvbiBpcyBtaXNzaW5nIHdlIGFzc3VtZSBzY3JlZW4gaXMgZnVsbHkgb25cbiAgICAgICAgIChtICYmIG0ubGVuZ3RoID4gMCAmJiBtWzBdLnNwbGl0KCc9JylbMV0gPT09ICd0cnVlJykgfHwgZmFsc2U7XG59XG5cbi8qKlxuICogQnVpbGRzIGNvbW1hbmQgbGluZSByZXByZXNlbnRhdGlvbiBmb3IgdGhlIGdpdmVuXG4gKiBhcHBsaWNhdGlvbiBzdGFydHVwIG9wdGlvbnNcbiAqXG4gKiBAcGFyYW0ge1N0YXJ0QXBwT3B0aW9uc30gc3RhcnRBcHBPcHRpb25zIC0gQXBwbGljYXRpb24gb3B0aW9ucyBtYXBwaW5nXG4gKiBAcGFyYW0ge251bWJlcn0gYXBpTGV2ZWwgLSBUaGUgYWN0dWFsIE9TIEFQSSBsZXZlbFxuICogQHJldHVybnMge0FycmF5PFN0cmluZz59IFRoZSBhY3R1YWwgY29tbWFuZCBsaW5lIGFycmF5XG4gKi9cbmZ1bmN0aW9uIGJ1aWxkU3RhcnRDbWQgKHN0YXJ0QXBwT3B0aW9ucywgYXBpTGV2ZWwpIHtcbiAgbGV0IGNtZCA9IFsnYW0nLCAnc3RhcnQnXTtcbiAgaWYgKHV0aWwuaGFzVmFsdWUoc3RhcnRBcHBPcHRpb25zLnVzZXIpKSB7XG4gICAgY21kLnB1c2goJy0tdXNlcicsIHN0YXJ0QXBwT3B0aW9ucy51c2VyKTtcbiAgfVxuICBjbWQucHVzaCgnLVcnLCAnLW4nLCBgJHtzdGFydEFwcE9wdGlvbnMucGtnfS8ke3N0YXJ0QXBwT3B0aW9ucy5hY3Rpdml0eX1gKTtcbiAgaWYgKHN0YXJ0QXBwT3B0aW9ucy5zdG9wQXBwICYmIGFwaUxldmVsID49IDE1KSB7XG4gICAgY21kLnB1c2goJy1TJyk7XG4gIH1cbiAgaWYgKHN0YXJ0QXBwT3B0aW9ucy5hY3Rpb24pIHtcbiAgICBjbWQucHVzaCgnLWEnLCBzdGFydEFwcE9wdGlvbnMuYWN0aW9uKTtcbiAgfVxuICBpZiAoc3RhcnRBcHBPcHRpb25zLmNhdGVnb3J5KSB7XG4gICAgY21kLnB1c2goJy1jJywgc3RhcnRBcHBPcHRpb25zLmNhdGVnb3J5KTtcbiAgfVxuICBpZiAoc3RhcnRBcHBPcHRpb25zLmZsYWdzKSB7XG4gICAgY21kLnB1c2goJy1mJywgc3RhcnRBcHBPcHRpb25zLmZsYWdzKTtcbiAgfVxuICBpZiAoc3RhcnRBcHBPcHRpb25zLm9wdGlvbmFsSW50ZW50QXJndW1lbnRzKSB7XG4gICAgLy8gZXhwZWN0IG9wdGlvbmFsSW50ZW50QXJndW1lbnRzIHRvIGJlIGEgc2luZ2xlIHN0cmluZyBvZiB0aGUgZm9ybTpcbiAgICAvLyAgICAgXCItZmxhZyBrZXlcIlxuICAgIC8vICAgICBcIi1mbGFnIGtleSB2YWx1ZVwiXG4gICAgLy8gb3IgYSBjb21iaW5hdGlvbiBvZiB0aGVzZSAoZS5nLiwgXCItZmxhZzEga2V5MSAtZmxhZzIga2V5MiB2YWx1ZTJcIilcblxuICAgIC8vIHRha2UgYSBzdHJpbmcgYW5kIHBhcnNlIG91dCB0aGUgcGFydCBiZWZvcmUgYW55IHNwYWNlcywgYW5kIGFueXRoaW5nIGFmdGVyXG4gICAgLy8gdGhlIGZpcnN0IHNwYWNlXG4gICAgbGV0IHBhcnNlS2V5VmFsdWUgPSBmdW5jdGlvbiAoc3RyKSB7XG4gICAgICBzdHIgPSBzdHIudHJpbSgpO1xuICAgICAgbGV0IHNwYWNlID0gc3RyLmluZGV4T2YoJyAnKTtcbiAgICAgIGlmIChzcGFjZSA9PT0gLTEpIHtcbiAgICAgICAgcmV0dXJuIHN0ci5sZW5ndGggPyBbc3RyXSA6IFtdO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmV0dXJuIFtzdHIuc3Vic3RyaW5nKDAsIHNwYWNlKS50cmltKCksIHN0ci5zdWJzdHJpbmcoc3BhY2UgKyAxKS50cmltKCldO1xuICAgICAgfVxuICAgIH07XG5cbiAgICAvLyBjeWNsZSB0aHJvdWdoIHRoZSBvcHRpb25hbEludGVudEFyZ3VtZW50cyBhbmQgcHVsbCBvdXQgdGhlIGFyZ3VtZW50c1xuICAgIC8vIGFkZCBhIHNwYWNlIGluaXRpYWxseSBzbyBmbGFncyBjYW4gYmUgZGlzdGluZ3Vpc2hlZCBmcm9tIGFyZ3VtZW50cyB0aGF0XG4gICAgLy8gaGF2ZSBpbnRlcm5hbCBoeXBoZW5zXG4gICAgbGV0IG9wdGlvbmFsSW50ZW50QXJndW1lbnRzID0gYCAke3N0YXJ0QXBwT3B0aW9ucy5vcHRpb25hbEludGVudEFyZ3VtZW50c31gO1xuICAgIGxldCByZSA9IC8gKC1bXlxcc10rKSAoLispLztcbiAgICB3aGlsZSAodHJ1ZSkgeyAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIG5vLWNvbnN0YW50LWNvbmRpdGlvblxuICAgICAgbGV0IGFyZ3MgPSByZS5leGVjKG9wdGlvbmFsSW50ZW50QXJndW1lbnRzKTtcbiAgICAgIGlmICghYXJncykge1xuICAgICAgICBpZiAob3B0aW9uYWxJbnRlbnRBcmd1bWVudHMubGVuZ3RoKSB7XG4gICAgICAgICAgLy8gbm8gbW9yZSBmbGFncywgc28gdGhlIHJlbWFpbmRlciBjYW4gYmUgdHJlYXRlZCBhcyAna2V5JyBvciAna2V5IHZhbHVlJ1xuICAgICAgICAgIGNtZC5wdXNoLmFwcGx5KGNtZCwgcGFyc2VLZXlWYWx1ZShvcHRpb25hbEludGVudEFyZ3VtZW50cykpO1xuICAgICAgICB9XG4gICAgICAgIC8vIHdlIGFyZSBkb25lXG4gICAgICAgIGJyZWFrO1xuICAgICAgfVxuXG4gICAgICAvLyB0YWtlIHRoZSBmbGFnIGFuZCBzZWUgaWYgaXQgaXMgYXQgdGhlIGJlZ2lubmluZyBvZiB0aGUgc3RyaW5nXG4gICAgICAvLyBpZiBpdCBpcyBub3QsIHRoZW4gaXQgbWVhbnMgd2UgaGF2ZSBiZWVuIHRocm91Z2ggYWxyZWFkeSwgYW5kXG4gICAgICAvLyB3aGF0IGlzIGJlZm9yZSB0aGUgZmxhZyBpcyB0aGUgYXJndW1lbnQgZm9yIHRoZSBwcmV2aW91cyBmbGFnXG4gICAgICBsZXQgZmxhZyA9IGFyZ3NbMV07XG4gICAgICBsZXQgZmxhZ1BvcyA9IG9wdGlvbmFsSW50ZW50QXJndW1lbnRzLmluZGV4T2YoZmxhZyk7XG4gICAgICBpZiAoZmxhZ1BvcyAhPT0gMCkge1xuICAgICAgICBsZXQgcHJldkFyZ3MgPSBvcHRpb25hbEludGVudEFyZ3VtZW50cy5zdWJzdHJpbmcoMCwgZmxhZ1Bvcyk7XG4gICAgICAgIGNtZC5wdXNoLmFwcGx5KGNtZCwgcGFyc2VLZXlWYWx1ZShwcmV2QXJncykpO1xuICAgICAgfVxuXG4gICAgICAvLyBhZGQgdGhlIGZsYWcsIGFzIHRoZXJlIGFyZSBubyBtb3JlIGVhcmxpZXIgYXJndW1lbnRzXG4gICAgICBjbWQucHVzaChmbGFnKTtcblxuICAgICAgLy8gbWFrZSBvcHRpb25hbEludGVudEFyZ3VtZW50cyBob2xkIHRoZSByZW1haW5kZXJcbiAgICAgIG9wdGlvbmFsSW50ZW50QXJndW1lbnRzID0gYXJnc1syXTtcbiAgICB9XG4gIH1cbiAgcmV0dXJuIGNtZDtcbn1cblxuY29uc3QgZ2V0U2RrVG9vbHNWZXJzaW9uID0gXy5tZW1vaXplKGFzeW5jIGZ1bmN0aW9uIGdldFNka1Rvb2xzVmVyc2lvbiAoKSB7XG4gIGNvbnN0IGFuZHJvaWRIb21lID0gcHJvY2Vzcy5lbnYuQU5EUk9JRF9IT01FO1xuICBpZiAoIWFuZHJvaWRIb21lKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKCdBTkRST0lEX0hPTUUgZW52aXJvbm1lbnQgdmFyaWFibGUgaXMgZXhwZWN0ZWQgdG8gYmUgc2V0Jyk7XG4gIH1cbiAgY29uc3QgcHJvcGVydGllc1BhdGggPSBwYXRoLnJlc29sdmUoYW5kcm9pZEhvbWUsICd0b29scycsICdzb3VyY2UucHJvcGVydGllcycpO1xuICBpZiAoIWF3YWl0IGZzLmV4aXN0cyhwcm9wZXJ0aWVzUGF0aCkpIHtcbiAgICBsb2cud2FybihgQ2Fubm90IGZpbmQgJHtwcm9wZXJ0aWVzUGF0aH0gZmlsZSB0byByZWFkIFNESyB2ZXJzaW9uIGZyb21gKTtcbiAgICByZXR1cm47XG4gIH1cbiAgY29uc3QgcHJvcGVydGllc0NvbnRlbnQgPSBhd2FpdCBmcy5yZWFkRmlsZShwcm9wZXJ0aWVzUGF0aCwgJ3V0ZjgnKTtcbiAgY29uc3QgdmVyc2lvbk1hdGNoZXIgPSBuZXcgUmVnRXhwKC9Qa2dcXC5SZXZpc2lvbj0oXFxkKylcXC4/KFxcZCspP1xcLj8oXFxkKyk/Lyk7XG4gIGNvbnN0IG1hdGNoID0gdmVyc2lvbk1hdGNoZXIuZXhlYyhwcm9wZXJ0aWVzQ29udGVudCk7XG4gIGlmIChtYXRjaCkge1xuICAgIHJldHVybiB7XG4gICAgICBtYWpvcjogcGFyc2VJbnQobWF0Y2hbMV0sIDEwKSxcbiAgICAgIG1pbm9yOiBtYXRjaFsyXSA/IHBhcnNlSW50KG1hdGNoWzJdLCAxMCkgOiAwLFxuICAgICAgYnVpbGQ6IG1hdGNoWzNdID8gcGFyc2VJbnQobWF0Y2hbM10sIDEwKSA6IDBcbiAgICB9O1xuICB9XG4gIGxvZy53YXJuKGBDYW5ub3QgcGFyc2UgXCJQa2cuUmV2aXNpb25cIiB2YWx1ZSBmcm9tICR7cHJvcGVydGllc1BhdGh9YCk7XG59KTtcblxuLyoqXG4gKiBSZXRyaWV2ZXMgZnVsbCBwYXRocyB0byBhbGwgJ2J1aWxkLXRvb2xzJyBzdWJmb2xkZXJzIHVuZGVyIHRoZSBwYXJ0aWN1bGFyXG4gKiBTREsgcm9vdCBmb2xkZXJcbiAqXG4gKiBAcGFyYW0ge3N0cmluZ30gc2RrUm9vdCAtIFRoZSBmdWxsIHBhdGggdG8gdGhlIEFuZHJvaWQgU0RLIHJvb3QgZm9sZGVyXG4gKiBAcmV0dXJucyB7QXJyYXk8c3RyaW5nPn0gVGhlIGZ1bGwgcGF0aHMgdG8gdGhlIHJlc3VsdGluZyBmb2xkZXJzIHNvcnRlZCBieVxuICogbW9kaWZpY2F0aW9uIGRhdGUgKHRoZSBuZXdlc3QgY29tZXMgZmlyc3QpIG9yIGFuIGVtcHR5IGxpc3QgaWYgbm8gbWFjdGhlcyB3ZXJlIGZvdW5kXG4gKi9cbmNvbnN0IGdldEJ1aWxkVG9vbHNEaXJzID0gXy5tZW1vaXplKGFzeW5jIGZ1bmN0aW9uIGdldEJ1aWxkVG9vbHNEaXJzIChzZGtSb290KSB7XG4gIGxldCBidWlsZFRvb2xzRGlycyA9IGF3YWl0IGZzLmdsb2IocGF0aC5yZXNvbHZlKHNka1Jvb3QsICdidWlsZC10b29scycsICcqJyksIHthYnNvbHV0ZTogdHJ1ZX0pO1xuICB0cnkge1xuICAgIGJ1aWxkVG9vbHNEaXJzID0gYnVpbGRUb29sc0RpcnNcbiAgICAgIC5tYXAoKGRpcikgPT4gW3BhdGguYmFzZW5hbWUoZGlyKSwgZGlyXSlcbiAgICAgIC5zb3J0KChhLCBiKSA9PiBzZW12ZXIucmNvbXBhcmUoYVswXSwgYlswXSkpXG4gICAgICAubWFwKChwYWlyKSA9PiBwYWlyWzFdKTtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgbG9nLndhcm4oYENhbm5vdCBzb3J0IGJ1aWxkLXRvb2xzIGZvbGRlcnMgJHtKU09OLnN0cmluZ2lmeShidWlsZFRvb2xzRGlycy5tYXAoKGRpcikgPT4gcGF0aC5iYXNlbmFtZShkaXIpKSl9IGAgK1xuICAgICAgICAgICAgIGBieSBzZW1hbnRpYyB2ZXJzaW9uIG5hbWVzLmApO1xuICAgIGxvZy53YXJuKGBGYWxsaW5nIGJhY2sgdG8gc29ydGluZyBieSBtb2RpZmljYXRpb24gZGF0ZS4gT3JpZ2luYWwgZXJyb3I6ICR7ZXJyLm1lc3NhZ2V9YCk7XG4gICAgY29uc3QgcGFpcnMgPSBhd2FpdCBCLm1hcChidWlsZFRvb2xzRGlycywgYXN5bmMgKGRpcikgPT4gWyhhd2FpdCBmcy5zdGF0KGRpcikpLm10aW1lLnZhbHVlT2YoKSwgZGlyXSk7XG4gICAgYnVpbGRUb29sc0RpcnMgPSBwYWlyc1xuICAgICAgLnNvcnQoKGEsIGIpID0+IGFbMF0gPCBiWzBdKVxuICAgICAgLm1hcCgocGFpcikgPT4gcGFpclsxXSk7XG4gIH1cbiAgbG9nLmluZm8oYEZvdW5kICR7YnVpbGRUb29sc0RpcnMubGVuZ3RofSAnYnVpbGQtdG9vbHMnIGZvbGRlcnMgdW5kZXIgJyR7c2RrUm9vdH0nIChuZXdlc3QgZmlyc3QpOmApO1xuICBmb3IgKGxldCBkaXIgb2YgYnVpbGRUb29sc0RpcnMpIHtcbiAgICBsb2cuaW5mbyhgICAgICR7ZGlyfWApO1xuICB9XG4gIHJldHVybiBidWlsZFRvb2xzRGlycztcbn0pO1xuXG5leHBvcnQgeyBnZXRBbmRyb2lkUGxhdGZvcm1BbmRQYXRoLCB1bnppcEZpbGUsIGFzc2VydFppcEFyY2hpdmUsXG4gICAgICAgICBnZXRJTUVMaXN0RnJvbU91dHB1dCwgZ2V0SmF2YUZvck9zLCBpc1Nob3dpbmdMb2Nrc2NyZWVuLCBpc0N1cnJlbnRGb2N1c09uS2V5Z3VhcmQsXG4gICAgICAgICBnZXRTdXJmYWNlT3JpZW50YXRpb24sIGlzU2NyZWVuT25GdWxseSwgYnVpbGRTdGFydENtZCwgZ2V0SmF2YUhvbWUsXG4gICAgICAgICByb290RGlyLCBnZXRTZGtUb29sc1ZlcnNpb24sIGdldEFwa3NpZ25lckZvck9zLCBnZXRCdWlsZFRvb2xzRGlycyxcbiAgICAgICAgIGdldEFwa2FuYWx5emVyRm9yT3MgfTtcbiJdLCJzb3VyY2VSb290IjoiLi4vLi4ifQ==
